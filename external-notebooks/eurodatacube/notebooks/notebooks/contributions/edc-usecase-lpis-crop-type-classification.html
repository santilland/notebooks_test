<!DOCTYPE html><html lang="en" class="" style="scroll-padding:60px"><head><meta charSet="utf-8"/><meta name="viewport" content="width=device-width,initial-scale=1"/><title>Important notes - Location for eodashboard notebooks</title><meta property="og:title" content="Important notes - Location for eodashboard notebooks"/><meta name="generator" content="mystmd"/><meta name="keywords" content=""/><link rel="stylesheet" href="/notebooks_test/build/_assets/app-HG4THSM4.css"/><link rel="stylesheet" href="/notebooks_test/build/_assets/thebe-core-VKVHG5VY.css"/><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/jupyter-matplotlib@0.11.3/css/mpl_widget.css"/><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.css"/><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.15.2/dist/katex.min.css" integrity="sha384-MlJdn/WNKDGXveldHDdyRP1R4CTHr3FeuDNfhsLPYrq2t0UBkUdK2jyTnXPEK1NQ" crossorigin="anonymous"/><link rel="icon" href="/notebooks_test/favicon.ico"/><link rel="stylesheet" href="/notebooks_test/myst-theme.css"/><script>
  const savedTheme = localStorage.getItem("myst:theme");
  const theme = window.matchMedia("(prefers-color-scheme: light)").matches ? 'light' : 'dark';
  const classes = document.documentElement.classList;
  const hasAnyTheme = classes.contains('light') || classes.contains('dark');
  if (!hasAnyTheme) classes.add(savedTheme ?? theme);
</script></head><body class="m-0 transition-colors duration-500 bg-white dark:bg-stone-900"><div class="fixed top-1 left-1 h-[0px] w-[0px] focus-within:z-40 focus-within:h-auto focus-within:w-auto bg-white overflow-hidden focus-within:p-2 focus-within:ring-1" aria-label="skip to content options"><a href="#skip-to-frontmatter" class="block px-2 py-1 text-black underline">Skip to article frontmatter</a><a href="#skip-to-article" class="block px-2 py-1 text-black underline">Skip to article content</a></div><div class="bg-white/80 backdrop-blur dark:bg-stone-900/80 shadow dark:shadow-stone-700 p-3 md:px-8 sticky w-screen top-0 z-30 h-[60px]"><nav class="flex items-center justify-between flex-nowrap max-w-[1440px] mx-auto"><div class="flex flex-row xl:min-w-[19.5rem] mr-2 sm:mr-7 justify-start items-center shrink-0"><a class="flex items-center ml-3 dark:text-white w-fit md:ml-5 xl:ml-7" href="/notebooks_test/"><span class="text-md sm:text-xl tracking-tight sm:mr-5">Made with MyST</span></a></div><div class="flex items-center flex-grow w-auto"><div class="flex-grow hidden text-md lg:block"></div><div class="flex-grow block"></div><button type="button" aria-haspopup="dialog" aria-expanded="false" aria-controls="radix-:R3iop:" data-state="closed" class="flex items-center h-10 aspect-square sm:w-64 text-left text-gray-400 border border-gray-300 dark:border-gray-600 rounded-lg bg-gray-50 dark:bg-gray-700 hover:ring-blue-500 dark:hover:ring-blue-500 hover:border-blue-500 dark:hover:border-blue-500"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" aria-hidden="true" data-slot="icon" class="p-2.5 h-10 w-10 aspect-square"><path fill-rule="evenodd" d="M10.5 3.75a6.75 6.75 0 1 0 0 13.5 6.75 6.75 0 0 0 0-13.5ZM2.25 10.5a8.25 8.25 0 1 1 14.59 5.28l4.69 4.69a.75.75 0 1 1-1.06 1.06l-4.69-4.69A8.25 8.25 0 0 1 2.25 10.5Z" clip-rule="evenodd"></path></svg><span class="hidden sm:block grow">Search</span><div aria-hidden="true" class="items-center hidden mx-1 font-mono text-sm text-gray-400 sm:flex gap-x-1"><kbd class="px-2 py-1 border border-gray-300 dark:border-gray-600 rounded-md shadow-[0px_2px_0px_0px_rgba(0,0,0,0.08)] dark:shadow-none hide-mac">CTRL</kbd><kbd class="px-2 py-1 border border-gray-300 dark:border-gray-600 rounded-md shadow-[0px_2px_0px_0px_rgba(0,0,0,0.08)] dark:shadow-none show-mac">⌘</kbd><kbd class="px-2 py-1 border border-gray-300 dark:border-gray-600 rounded-md shadow-[0px_2px_0px_0px_rgba(0,0,0,0.08)] dark:shadow-none ">K</kbd><script>
;(() => {
const script = document.currentScript;
const root = script.parentElement;

const isMac = /mac/i.test(
      window.navigator.userAgentData?.platform ?? window.navigator.userAgent,
    );
root.querySelectorAll(".hide-mac").forEach(node => {node.classList.add(isMac ? "hidden" : "block")});
root.querySelectorAll(".show-mac").forEach(node => {node.classList.add(!isMac ? "hidden" : "block")});
})()</script></div></button><button class="theme rounded-full aspect-square border border-stone-700 dark:border-white hover:bg-neutral-100 border-solid overflow-hidden text-stone-700 dark:text-white hover:text-stone-500 dark:hover:text-neutral-800 w-8 h-8 mx-3" title="Toggle theme between light and dark mode." aria-label="Toggle theme between light and dark mode."><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" aria-hidden="true" data-slot="icon" class="h-full w-full p-0.5 hidden dark:block"><path fill-rule="evenodd" d="M9.528 1.718a.75.75 0 0 1 .162.819A8.97 8.97 0 0 0 9 6a9 9 0 0 0 9 9 8.97 8.97 0 0 0 3.463-.69.75.75 0 0 1 .981.98 10.503 10.503 0 0 1-9.694 6.46c-5.799 0-10.5-4.7-10.5-10.5 0-4.368 2.667-8.112 6.46-9.694a.75.75 0 0 1 .818.162Z" clip-rule="evenodd"></path></svg><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" aria-hidden="true" data-slot="icon" class="h-full w-full p-0.5 dark:hidden"><path stroke-linecap="round" stroke-linejoin="round" d="M12 3v2.25m6.364.386-1.591 1.591M21 12h-2.25m-.386 6.364-1.591-1.591M12 18.75V21m-4.773-4.227-1.591 1.591M5.25 12H3m4.227-4.773L5.636 5.636M15.75 12a3.75 3.75 0 1 1-7.5 0 3.75 3.75 0 0 1 7.5 0Z"></path></svg></button><div class="block sm:hidden"></div><div class="hidden sm:block"></div></div></nav></div><article class="article content article-grid grid-gap"><main class="article-grid subgrid-gap col-screen"><div class="hidden"></div><div id="skip-to-frontmatter" aria-label="article frontmatter" class="mb-8 pt-9"><div class="flex items-center h-6 mb-5 text-sm font-light"><div class="flex-grow"></div><a href="https://github.com/eoxhub-workspaces/documentation/" title="GitHub Repository: eoxhub-workspaces/documentation/" target="_blank" rel="noopener noreferrer" class="text-inherit hover:text-inherit"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" aria-hidden="true" width="1.25rem" height="1.25rem" class="inline-block mr-1 opacity-60 hover:opacity-100"><path d="M12 2.5c-5.4 0-9.8 4.4-9.8 9.7 0 4.3 2.8 8 6.7 9.2.5.1.7-.2.7-.5v-1.8c-2.4.5-3.1-.6-3.3-1.1-.1-.3-.6-1.1-1-1.4-.3-.2-.8-.6 0-.6s1.3.7 1.5 1c.9 1.5 2.3 1.1 2.8.8.1-.6.3-1.1.6-1.3-2.2-.2-4.4-1.1-4.4-4.8 0-1.1.4-1.9 1-2.6-.1-.2-.4-1.2.1-2.6 0 0 .8-.3 2.7 1 .8-.2 1.6-.3 2.4-.3.8 0 1.7.1 2.4.3 1.9-1.3 2.7-1 2.7-1 .5 1.3.2 2.3.1 2.6.6.7 1 1.5 1 2.6 0 3.7-2.3 4.6-4.4 4.8.4.3.7.9.7 1.8V21c0 .3.2.6.7.5 3.9-1.3 6.6-4.9 6.6-9.2 0-5.4-4.4-9.8-9.8-9.8z"></path></svg></a><div class="inline-block mr-1"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" aria-hidden="true" width="1.25rem" height="1.25rem" class="inline-block"><title>Jupyter Notebook</title><path d="M20.2 1.7c0 .8-.5 1.4-1.3 1.5-.8 0-1.4-.5-1.5-1.3 0-.8.5-1.4 1.3-1.5.8-.1 1.5.5 1.5 1.3zM12 17.9c-3.7 0-7-1.3-8.7-3.3 1.8 4.8 7.1 7.3 11.9 5.5 2.5-.9 4.5-2.9 5.5-5.5-1.7 2-4.9 3.3-8.7 3.3zM12 5.1c3.7 0 7 1.3 8.7 3.3-1.8-4.8-7.1-7.3-11.9-5.5-2.5.9-4.5 2.9-5.5 5.5 1.7-2 5-3.3 8.7-3.3zM6.9 21.8c.1 1-.7 1.8-1.7 1.9-1 .1-1.8-.7-1.9-1.7 0-1 .7-1.8 1.7-1.9 1-.1 1.8.7 1.9 1.7zM3.7 4.6c-.6 0-1-.4-1-1s.4-1 1-1 1 .4 1 1c0 .5-.4 1-1 1z"></path></svg></div><div class="relative flex inline-block mx-1 grow-0" data-headlessui-state=""><button class="relative ml-2 -mr-1" id="headlessui-menu-button-:Rd4fop:" type="button" aria-haspopup="menu" aria-expanded="false" data-headlessui-state=""><span class="sr-only">Downloads</span><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" aria-hidden="true" data-slot="icon" width="1.25rem" height="1.25rem"><path stroke-linecap="round" stroke-linejoin="round" d="M3 16.5v2.25A2.25 2.25 0 0 0 5.25 21h13.5A2.25 2.25 0 0 0 21 18.75V16.5M16.5 12 12 16.5m0 0L7.5 12m4.5 4.5V3"></path></svg></button></div></div><h1 class="mb-0">Important notes</h1></div><div class="block my-10 lg:sticky lg:z-10 lg:h-0 lg:pt-0 lg:my-0 lg:ml-10 lg:col-margin-right" style="top:60px"><nav></nav></div><div id="skip-to-article"></div><div id="fFw5iX7MOM" class="relative group/block"><div class="flex sticky top-[80px] z-10 opacity-70 group-hover/block:opacity-100 group-hover/block:hidden"><div class="absolute top-0 -right-[28px] flex md:flex-col"></div></div><div class="hidden sticky top-[80px] z-10 opacity-70 group-hover/block:opacity-100 group-hover/block:flex"><div class="absolute top-0 -right-[28px] flex md:flex-col"></div></div><div class="relative group not-prose overflow-auto shadow hover:shadow-md dark:shadow-2xl dark:shadow-neutral-900 my-5 text-sm border border-l-4 border-l-blue-400 border-gray-200 dark:border-l-blue-400 dark:border-gray-800"><pre class="block p-3 hljs" style="background-color:unset"><code class="language-python" style="white-space:pre">from edc import setup_environment_variables
setup_environment_variables()</code></pre><button title="Copy to Clipboard" class="inline-flex items-center opacity-0 group-hover:opacity-100 hover:opacity-100 focus:opacity-100 active:opacity-100 cursor-pointer ml-2 transition-color duration-200 ease-in-out text-blue-400 hover:text-blue-500 absolute right-1 top-1" aria-pressed="false" aria-label="Copy code to clipboard"><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" aria-hidden="true" data-slot="icon" width="24" height="24"><path stroke-linecap="round" stroke-linejoin="round" d="M15.75 17.25v3.375c0 .621-.504 1.125-1.125 1.125h-9.75a1.125 1.125 0 0 1-1.125-1.125V7.875c0-.621.504-1.125 1.125-1.125H6.75a9.06 9.06 0 0 1 1.5.124m7.5 10.376h3.375c.621 0 1.125-.504 1.125-1.125V11.25c0-4.46-3.243-8.161-7.5-8.876a9.06 9.06 0 0 0-1.5-.124H9.375c-.621 0-1.125.504-1.125 1.125v3.5m7.5 10.375H9.375a1.125 1.125 0 0 1-1.125-1.125v-9.25m12 6.625v-1.875a3.375 3.375 0 0 0-3.375-3.375h-1.5a1.125 1.125 0 0 1-1.125-1.125v-1.5a3.375 3.375 0 0 0-3.375-3.375H9.75"></path></svg></button></div><div data-mdast-node-id="yExUpHMLN3szwMxqDyPHN" class="max-w-full overflow-y-visible overflow-x-auto m-0 group not-prose relative text-left mb-5"><div><div class="p-2.5">Loading...</div></div></div></div><div id="GazEmzmWW1" class="relative group/block"><h1 id="important-notes" class="relative group"><span class="heading-text">Important notes</span><a class="no-underline text-inherit hover:text-inherit inline-block w-0 px-0 translate-x-[10px] font-normal select-none transition-opacity opacity-0 focus:opacity-100 group-hover:opacity-70" href="#important-notes" title="Link to this Section" aria-label="Link to this Section">¶</a></h1><p>This notebook requires:</p><ul><li>POSTGIS database (with access information exposed as environment variables) having sample LPIS data ingested -&gt; please find further information <a target="_blank" rel="noreferrer" href="https://github.com/eurodatacube/notebooks/tree/master/artifacts" class="">here</a></li></ul></div><div id="T9OdxmRv5f" class="relative group/block"><h1 id="lpis-use-case-crop-type-classification-aut" class="relative group"><span class="heading-text">LPIS Use case: Crop-type classification (AUT)</span><a class="no-underline text-inherit hover:text-inherit inline-block w-0 px-0 translate-x-[10px] font-normal select-none transition-opacity opacity-0 focus:opacity-100 group-hover:opacity-70" href="#lpis-use-case-crop-type-classification-aut" title="Link to this Section" aria-label="Link to this Section">¶</a></h1><p>This notebook demonstrates how Euro Data Cube (EDC) tools can be utilized for exploratory analysis and manipulation of data in Land Parcel Identification System (LPIS). The most important part is the example of using satellite imagery and machine learning algorithms for crop type classification, which should be a valuable support for decisions related with LPIS controls.
The described workflow consists of several parts:</p><ol start="1"><li>Prepare and explore LPIS data and satellite imagery</li><li>Run Machine Learning and create a model for crop type classification</li><li>Visualize results and extract information to support LPIS controls</li><li>Classify on parcel level per LPIS ID</li><li>Persist results in database</li></ol></div><div id="wwSJ5EbPBu" class="relative group/block"><div class="flex sticky top-[80px] z-10 opacity-70 group-hover/block:opacity-100 group-hover/block:hidden"><div class="absolute top-0 -right-[28px] flex md:flex-col"></div></div><div class="hidden sticky top-[80px] z-10 opacity-70 group-hover/block:opacity-100 group-hover/block:flex"><div class="absolute top-0 -right-[28px] flex md:flex-col"></div></div><div class="relative group not-prose overflow-auto shadow hover:shadow-md dark:shadow-2xl dark:shadow-neutral-900 my-5 text-sm border border-l-4 border-l-blue-400 border-gray-200 dark:border-l-blue-400 dark:border-gray-800"><pre class="block p-3 hljs" style="background-color:unset"><code class="language-python" style="white-space:pre"># This notebook uses the EO-Learn ML library which requires configuration passed via the &#x27;sentinel.config&#x27; tool
!sentinelhub.config --sh_base_url &#x27;https://services.sentinel-hub.com&#x27;
!sentinelhub.config --sh_client_id $SH_CLIENT_ID
!sentinelhub.config --sh_client_secret $SH_CLIENT_SECRET
!sentinelhub.config --instance_id $SH_INSTANCE_ID</code></pre><button title="Copy to Clipboard" class="inline-flex items-center opacity-0 group-hover:opacity-100 hover:opacity-100 focus:opacity-100 active:opacity-100 cursor-pointer ml-2 transition-color duration-200 ease-in-out text-blue-400 hover:text-blue-500 absolute right-1 top-1" aria-pressed="false" aria-label="Copy code to clipboard"><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" aria-hidden="true" data-slot="icon" width="24" height="24"><path stroke-linecap="round" stroke-linejoin="round" d="M15.75 17.25v3.375c0 .621-.504 1.125-1.125 1.125h-9.75a1.125 1.125 0 0 1-1.125-1.125V7.875c0-.621.504-1.125 1.125-1.125H6.75a9.06 9.06 0 0 1 1.5.124m7.5 10.376h3.375c.621 0 1.125-.504 1.125-1.125V11.25c0-4.46-3.243-8.161-7.5-8.876a9.06 9.06 0 0 0-1.5-.124H9.375c-.621 0-1.125.504-1.125 1.125v3.5m7.5 10.375H9.375a1.125 1.125 0 0 1-1.125-1.125v-9.25m12 6.625v-1.875a3.375 3.375 0 0 0-3.375-3.375h-1.5a1.125 1.125 0 0 1-1.125-1.125v-1.5a3.375 3.375 0 0 0-3.375-3.375H9.75"></path></svg></button></div><div data-mdast-node-id="oODOuJYU8Mx8bP4ijLhhx" class="max-w-full overflow-y-visible overflow-x-auto m-0 group not-prose relative text-left"></div></div><div id="MnmWaN6PMw" class="relative group/block"><div class="flex sticky top-[80px] z-10 opacity-70 group-hover/block:opacity-100 group-hover/block:hidden"><div class="absolute top-0 -right-[28px] flex md:flex-col"></div></div><div class="hidden sticky top-[80px] z-10 opacity-70 group-hover/block:opacity-100 group-hover/block:flex"><div class="absolute top-0 -right-[28px] flex md:flex-col"></div></div><div class="relative group not-prose overflow-auto shadow hover:shadow-md dark:shadow-2xl dark:shadow-neutral-900 my-5 text-sm border border-l-4 border-l-blue-400 border-gray-200 dark:border-l-blue-400 dark:border-gray-800"><pre class="block p-3 hljs" style="background-color:unset"><code class="language-python" style="white-space:pre"># see section Important Notes above
import os
db_conn_params = {
    &#x27;host&#x27;: os.getenv(&#x27;DB_HOST&#x27;),
    &#x27;database&#x27;: os.getenv(&#x27;DB_NAME&#x27;),
    &#x27;user&#x27;: os.getenv(&#x27;DB_USER&#x27;),
    &#x27;password&#x27;: os.getenv(&#x27;DB_PASSWORD&#x27;)
}</code></pre><button title="Copy to Clipboard" class="inline-flex items-center opacity-0 group-hover:opacity-100 hover:opacity-100 focus:opacity-100 active:opacity-100 cursor-pointer ml-2 transition-color duration-200 ease-in-out text-blue-400 hover:text-blue-500 absolute right-1 top-1" aria-pressed="false" aria-label="Copy code to clipboard"><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" aria-hidden="true" data-slot="icon" width="24" height="24"><path stroke-linecap="round" stroke-linejoin="round" d="M15.75 17.25v3.375c0 .621-.504 1.125-1.125 1.125h-9.75a1.125 1.125 0 0 1-1.125-1.125V7.875c0-.621.504-1.125 1.125-1.125H6.75a9.06 9.06 0 0 1 1.5.124m7.5 10.376h3.375c.621 0 1.125-.504 1.125-1.125V11.25c0-4.46-3.243-8.161-7.5-8.876a9.06 9.06 0 0 0-1.5-.124H9.375c-.621 0-1.125.504-1.125 1.125v3.5m7.5 10.375H9.375a1.125 1.125 0 0 1-1.125-1.125v-9.25m12 6.625v-1.875a3.375 3.375 0 0 0-3.375-3.375h-1.5a1.125 1.125 0 0 1-1.125-1.125v-1.5a3.375 3.375 0 0 0-3.375-3.375H9.75"></path></svg></button></div><div data-mdast-node-id="zBv3ckQLD30BepVpz26Uw" class="max-w-full overflow-y-visible overflow-x-auto m-0 group not-prose relative text-left"></div></div><div id="ZStr9wdOaS" class="relative group/block"><h2 id="import-packages" class="relative group"><span class="heading-text">Import packages</span><a class="no-underline text-inherit hover:text-inherit inline-block w-0 px-0 translate-x-[10px] font-normal select-none transition-opacity opacity-0 focus:opacity-100 group-hover:opacity-70" href="#import-packages" title="Link to this Section" aria-label="Link to this Section">¶</a></h2></div><div id="xvbcMuR09h" class="relative group/block"><div class="flex sticky top-[80px] z-10 opacity-70 group-hover/block:opacity-100 group-hover/block:hidden"><div class="absolute top-0 -right-[28px] flex md:flex-col"></div></div><div class="hidden sticky top-[80px] z-10 opacity-70 group-hover/block:opacity-100 group-hover/block:flex"><div class="absolute top-0 -right-[28px] flex md:flex-col"></div></div><div class="relative group not-prose overflow-auto shadow hover:shadow-md dark:shadow-2xl dark:shadow-neutral-900 my-5 text-sm border border-l-4 border-l-blue-400 border-gray-200 dark:border-l-blue-400 dark:border-gray-800"><pre class="block p-3 hljs" style="background-color:unset"><code class="language-python" style="white-space:pre">import warnings
warnings.filterwarnings(&#x27;ignore&#x27;)

# Jupyter notebook related
%reload_ext autoreload
%autoreload 2
%matplotlib inline

# Built-in modules
import pickle
import sys
import datetime
import time
import itertools
import math
import subprocess
import fiona
import fiona.crs
from enum import Enum

# Basics of Python data handling and visualization
import numpy as np
import pandas as pd
import geopandas as gpd
import matplotlib as mpl
import matplotlib.pyplot as plt
import matplotlib.gridspec as gridspec
from mpl_toolkits.axes_grid1 import make_axes_locatable
from shapely.geometry import Polygon
from tqdm import tqdm_notebook as tqdm

# Machine learning 
import lightgbm as lgb
from sklearn.externals import joblib
from sklearn import metrics
from sklearn import preprocessing

# Imports from eo-learn and sentinelhub-py
from eolearn.core import EOTask, EOPatch, LinearWorkflow, FeatureType, OverwritePermission, \
    LoadTask, SaveTask, EOExecutor
from eolearn.core.core_tasks import AddFeature
from eolearn.io import S2L1CWCSInput, ExportToTiff
from eolearn.mask import AddCloudMaskTask, get_s2_pixel_cloud_detector, AddValidDataMaskTask
from eolearn.geometry import VectorToRaster, PointSamplingTask, ErosionTask
from eolearn.features import LinearInterpolation, SimpleFilterTask
from sentinelhub import BBoxSplitter, BBox, CRS, CustomUrlParam, UtmGridSplitter

# OAuth2
from oauthlib.oauth2 import BackendApplicationClient
from requests_oauthlib import OAuth2Session

# DB and raw geometry
import psycopg2
from psycopg2._psycopg import AsIs
from psycopg2.extensions import register_adapter
import shapely.wkt
from shapely.geometry import Polygon, MultiPolygon
from geopandas import GeoDataFrame


# imports for xcube
import xarray as xr
from shapely.ops import cascaded_union

from xcube_sh.cube import open_cube
from xcube_sh.observers import Observers
from xcube_sh.config import CubeConfig

from xcube.core.geom import mask_dataset_by_geometry

# Amazon S3
import boto3</code></pre><button title="Copy to Clipboard" class="inline-flex items-center opacity-0 group-hover:opacity-100 hover:opacity-100 focus:opacity-100 active:opacity-100 cursor-pointer ml-2 transition-color duration-200 ease-in-out text-blue-400 hover:text-blue-500 absolute right-1 top-1" aria-pressed="false" aria-label="Copy code to clipboard"><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" aria-hidden="true" data-slot="icon" width="24" height="24"><path stroke-linecap="round" stroke-linejoin="round" d="M15.75 17.25v3.375c0 .621-.504 1.125-1.125 1.125h-9.75a1.125 1.125 0 0 1-1.125-1.125V7.875c0-.621.504-1.125 1.125-1.125H6.75a9.06 9.06 0 0 1 1.5.124m7.5 10.376h3.375c.621 0 1.125-.504 1.125-1.125V11.25c0-4.46-3.243-8.161-7.5-8.876a9.06 9.06 0 0 0-1.5-.124H9.375c-.621 0-1.125.504-1.125 1.125v3.5m7.5 10.375H9.375a1.125 1.125 0 0 1-1.125-1.125v-9.25m12 6.625v-1.875a3.375 3.375 0 0 0-3.375-3.375h-1.5a1.125 1.125 0 0 1-1.125-1.125v-1.5a3.375 3.375 0 0 0-3.375-3.375H9.75"></path></svg></button></div><div data-mdast-node-id="oZQWLfshA1W8yD8jD19jb" class="max-w-full overflow-y-visible overflow-x-auto m-0 group not-prose relative text-left mb-5"><div><pre class="text-sm font-thin font-system"><code><span>/opt/conda/lib/python3.7/site-packages/xcube_sh/cube.py:22: DeprecationWarning: Using or importing the ABCs from &#x27;collections&#x27; instead of from &#x27;collections.abc&#x27; is deprecated since Python 3.3,and in 3.9 it will stop working
  from collections import Callable
/opt/conda/lib/python3.7/site-packages/xcube_sh/store.py:26: DeprecationWarning: Using or importing the ABCs from &#x27;collections&#x27; instead of from &#x27;collections.abc&#x27; is deprecated since Python 3.3,and in 3.9 it will stop working
  from collections import MutableMapping
</span></code></pre></div></div></div><div id="pzKtkX9s2S" class="relative group/block"><h1 id="database-loading-and-mapping-functionality" class="relative group"><span class="heading-text">Database loading and mapping functionality</span><a class="no-underline text-inherit hover:text-inherit inline-block w-0 px-0 translate-x-[10px] font-normal select-none transition-opacity opacity-0 focus:opacity-100 group-hover:opacity-70" href="#database-loading-and-mapping-functionality" title="Link to this Section" aria-label="Link to this Section">¶</a></h1></div><div id="f3zaoamrjo" class="relative group/block"><div class="flex sticky top-[80px] z-10 opacity-70 group-hover/block:opacity-100 group-hover/block:hidden"><div class="absolute top-0 -right-[28px] flex md:flex-col"></div></div><div class="hidden sticky top-[80px] z-10 opacity-70 group-hover/block:opacity-100 group-hover/block:flex"><div class="absolute top-0 -right-[28px] flex md:flex-col"></div></div><div class="relative group not-prose overflow-auto shadow hover:shadow-md dark:shadow-2xl dark:shadow-neutral-900 my-5 text-sm border border-l-4 border-l-blue-400 border-gray-200 dark:border-l-blue-400 dark:border-gray-800"><pre class="block p-3 hljs" style="background-color:unset"><code class="language-python" style="white-space:pre">## mapping of crop type groups into 24 classes that are to be predicted

# AT: vector to raster needs uint8 values 
ctToctnuml4aMapping = {
    1: [1010], #SOMMERGETREIDE
    2: [1020], #WINTERGETREIDE
    3: [1030], #MENGGETREIDE_AEHNLICHES
    4: [1040], #MAIS_AEHNLICHES
    5: [1050], #SOMMERRAPS_AEHNLICHES
    6: [1060], #WINTERRAPS_AEHNLICHES
    7: [1070], #SONNENBLUME
    8: [1080], #HANF
    9: [1090], #LEGUMINOSEN_AEHNLICHES
    10: [1100], #WINTERLEGUMINOSE
    11: [1110], #KARTOFFELN_AEHNLICHES
    12: [1120], #RUEBEN
    13: [1130], #GEMUESE_AEHNLICHES
    14: [1140], #GEWUERZE_AEHNLICHES
    15: [1150], #WINTERGEWUERZE_AEHNLICHES   
    16: [1160], #KUERBIS
    17: [1170], #BRACHE
    18: [1180], #DAUERKULTUR
    19: [1190], #GEWAECHSHAUS
    20: [1200], #WEIN
    21: [1210], #GRUENLAND
    22: [1220], #PRO_RATA
    23: [1230], #LAGERFLAECHEN
    24: [1240] #SONSTIGES
}
ctnuml4aToctMapping = {ctnuml4a: ctid for ctid, ctnuml4aList in ctToctnuml4aMapping.items() for ctnuml4a in ctnuml4aList}

# needed for DB mapping
register_adapter(np.int64, AsIs)
register_adapter(Polygon, AsIs)
register_adapter(MultiPolygon, AsIs)

def loadFromDatabase(db_conn, taskName, tableName, bbox, dateFilterMin, dateFilterMax, mappedColumnName = None, mappingLambdaFunc = None):
    columns = [&quot;ogd_id&quot;, &quot;ctnuml4a&quot;, &quot;geometry&quot;]
    geometries = []

    if (mappedColumnName and mappingLambdaFunc):
        columns.append(mappedColumnName)
    
    with db_conn.cursor() as cur:
        sql = &#x27;&#x27;&#x27;
            SELECT ogd_id, ctnuml4a, ST_AsText(ST_Transform(geometry, {targetCrs})) 
            FROM {tableName}
            WHERE ST_Intersects(geometry, ST_Transform(ST_GeomFromText(&#x27;{bbox}&#x27;, {targetCrs}), 31287))
                AND ref_date &gt;= &#x27;{dateFilterMin}&#x27; AND ref_date &lt;= &#x27;{dateFilterMax}&#x27;
            &#x27;&#x27;&#x27;
        
        sql = sql.format(tableName = tableName, targetCrs = bbox.crs.value, 
            dateFilterMin = dateFilterMin, dateFilterMax = dateFilterMax,
            bbox = bbox.geometry.wkt)
        #print(sql)

        cur.execute(sql)
        for row in cur:
            properties = {&quot;ogd_id&quot;: row[0], &quot;ctnuml4a_id&quot;: row[1]}
            if (mappedColumnName and mappingLambdaFunc):
                properties[mappedColumnName] = mappingLambdaFunc(row[1])

            geometry = shapely.wkt.loads(row[2]);
            geometries.append({&quot;geometry&quot;: geometry, &quot;properties&quot;: properties})
        print(taskName + &quot;: &quot; + str(len(geometries)) + &#x27; DB records for bbox = &#x27; + str(bbox) + &#x27; &#x27; + str(bbox.crs.value))        
        crs = {&quot;init&quot;: &quot;epsg:{}&quot;.format(bbox.crs.value)}
        gdf = GeoDataFrame.from_features(geometries, crs = crs, columns = columns)
        return gdf</code></pre><button title="Copy to Clipboard" class="inline-flex items-center opacity-0 group-hover:opacity-100 hover:opacity-100 focus:opacity-100 active:opacity-100 cursor-pointer ml-2 transition-color duration-200 ease-in-out text-blue-400 hover:text-blue-500 absolute right-1 top-1" aria-pressed="false" aria-label="Copy code to clipboard"><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" aria-hidden="true" data-slot="icon" width="24" height="24"><path stroke-linecap="round" stroke-linejoin="round" d="M15.75 17.25v3.375c0 .621-.504 1.125-1.125 1.125h-9.75a1.125 1.125 0 0 1-1.125-1.125V7.875c0-.621.504-1.125 1.125-1.125H6.75a9.06 9.06 0 0 1 1.5.124m7.5 10.376h3.375c.621 0 1.125-.504 1.125-1.125V11.25c0-4.46-3.243-8.161-7.5-8.876a9.06 9.06 0 0 0-1.5-.124H9.375c-.621 0-1.125.504-1.125 1.125v3.5m7.5 10.375H9.375a1.125 1.125 0 0 1-1.125-1.125v-9.25m12 6.625v-1.875a3.375 3.375 0 0 0-3.375-3.375h-1.5a1.125 1.125 0 0 1-1.125-1.125v-1.5a3.375 3.375 0 0 0-3.375-3.375H9.75"></path></svg></button></div><div data-mdast-node-id="Vv76reHlAaCblNLCt2Gww" class="max-w-full overflow-y-visible overflow-x-auto m-0 group not-prose relative text-left"></div></div><div id="cf8J3082kl" class="relative group/block"><h1 id="part-1-exploratory-analysis" class="relative group"><span class="heading-text">Part 1: Exploratory Analysis</span><a class="no-underline text-inherit hover:text-inherit inline-block w-0 px-0 translate-x-[10px] font-normal select-none transition-opacity opacity-0 focus:opacity-100 group-hover:opacity-70" href="#part-1-exploratory-analysis" title="Link to this Section" aria-label="Link to this Section">¶</a></h1><h2 id="define-the-area-of-interest-aoi" class="relative group"><span class="heading-text">Define the Area-of-Interest (AOI):</span><a class="no-underline text-inherit hover:text-inherit inline-block w-0 px-0 translate-x-[10px] font-normal select-none transition-opacity opacity-0 focus:opacity-100 group-hover:opacity-70" href="#define-the-area-of-interest-aoi" title="Link to this Section" aria-label="Link to this Section">¶</a></h2><p>The whole territory of a country is splited into patches which makes the processing more efficient. The process is run on are of 3x3 patches for demonstration purposes.  AOI can be selected as the id of the patch in the middle.</p><p>Main steps in this part of the notebook:</p><ul><li>Load a geographical shape of Austria</li><li>Convert it to selected CRS: taken to be the CRS of central UTM tile (UTM_33N)</li><li>Split it into smaller, manageable, non-overlapping rectangular tiles (patches)</li><li>Select a small 3x3 area for classification</li></ul><p>Be sure that your choice of CRS is the same as the CRS of your reference data.</p><p>In the case that you are having problems with empty data being downloaded, try changing the CRS to something that suits the location of the AOI better.</p></div><div id="JHIspQGRtP" class="relative group/block"><div class="flex sticky top-[80px] z-10 opacity-70 group-hover/block:opacity-100 group-hover/block:hidden"><div class="absolute top-0 -right-[28px] flex md:flex-col"></div></div><div class="hidden sticky top-[80px] z-10 opacity-70 group-hover/block:opacity-100 group-hover/block:flex"><div class="absolute top-0 -right-[28px] flex md:flex-col"></div></div><div class="relative group not-prose overflow-auto shadow hover:shadow-md dark:shadow-2xl dark:shadow-neutral-900 my-5 text-sm border border-l-4 border-l-blue-400 border-gray-200 dark:border-l-blue-400 dark:border-gray-800"><pre class="block p-3 hljs" style="background-color:unset"><code class="language-python" style="white-space:pre"># Folder where data for running the notebook is stored
DATA_FOLDER = os.path.join(&#x27;example_data&#x27;)

# Load geojson file containing the outline of the country
country = gpd.read_file(os.path.join(DATA_FOLDER, &#x27;at_not_buffered.geojson&#x27;))

# Convert CRS to UTM_33N
country_crs = CRS.UTM_33N
country = country.to_crs(crs={&#x27;init&#x27;: CRS.ogc_string(country_crs)})

# Get the country&#x27;s shape in polygon format
country_shape = country.geometry.values[-1]

# Define bounds and select middle patch ID
use_smaller_patches = True

ID = 13311 if use_smaller_patches else 1606

bounds = [15.5242, 48.7574, 15.5391, 48.7698]  if use_smaller_patches else [15.4191, 48.653, 15.7335, 48.8102]

bbox_splitter_large = BBoxSplitter([country_shape], country_crs, (25 * 3, 17 * 3))
bbox_splitter_small = BBoxSplitter([country_shape], country_crs, (25 * 9, 17 * 9))

bbox_splitter = bbox_splitter_small if use_smaller_patches else bbox_splitter_large
bbox_list_aligned = [BBox((10 * math.floor(bbox.min_x / 10), 10 * math.floor(bbox.min_y / 10), 
                           10 * math.floor(bbox.max_x / 10), 10 * math.floor(bbox.max_y / 10)), country_crs) 
                     for bbox in bbox_splitter.get_bbox_list()]

bbox_list = np.array(bbox_list_aligned)
info_list = np.array(bbox_splitter.get_info_list())

all_patches_gdf = gpd.GeoDataFrame(
    {
        &quot;index_x&quot;: [info[&#x27;index_x&#x27;] for info in info_list],
        &quot;index_y&quot;: [info[&#x27;index_y&#x27;] for info in info_list],
    },
    crs={&#x27;init&#x27;: CRS.ogc_string(country_crs)},
    geometry=[Polygon(bbox.get_polygon()) for bbox in bbox_list]
)</code></pre><button title="Copy to Clipboard" class="inline-flex items-center opacity-0 group-hover:opacity-100 hover:opacity-100 focus:opacity-100 active:opacity-100 cursor-pointer ml-2 transition-color duration-200 ease-in-out text-blue-400 hover:text-blue-500 absolute right-1 top-1" aria-pressed="false" aria-label="Copy code to clipboard"><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" aria-hidden="true" data-slot="icon" width="24" height="24"><path stroke-linecap="round" stroke-linejoin="round" d="M15.75 17.25v3.375c0 .621-.504 1.125-1.125 1.125h-9.75a1.125 1.125 0 0 1-1.125-1.125V7.875c0-.621.504-1.125 1.125-1.125H6.75a9.06 9.06 0 0 1 1.5.124m7.5 10.376h3.375c.621 0 1.125-.504 1.125-1.125V11.25c0-4.46-3.243-8.161-7.5-8.876a9.06 9.06 0 0 0-1.5-.124H9.375c-.621 0-1.125.504-1.125 1.125v3.5m7.5 10.375H9.375a1.125 1.125 0 0 1-1.125-1.125v-9.25m12 6.625v-1.875a3.375 3.375 0 0 0-3.375-3.375h-1.5a1.125 1.125 0 0 1-1.125-1.125v-1.5a3.375 3.375 0 0 0-3.375-3.375H9.75"></path></svg></button></div><div data-mdast-node-id="WTvoTP1Z4mJeSbsnIyoEA" class="max-w-full overflow-y-visible overflow-x-auto m-0 group not-prose relative text-left"></div></div><div id="ywGps0fKcs" class="relative group/block"><div class="flex sticky top-[80px] z-10 opacity-70 group-hover/block:opacity-100 group-hover/block:hidden"><div class="absolute top-0 -right-[28px] flex md:flex-col"></div></div><div class="hidden sticky top-[80px] z-10 opacity-70 group-hover/block:opacity-100 group-hover/block:flex"><div class="absolute top-0 -right-[28px] flex md:flex-col"></div></div><div class="relative group not-prose overflow-auto shadow hover:shadow-md dark:shadow-2xl dark:shadow-neutral-900 my-5 text-sm border border-l-4 border-l-blue-400 border-gray-200 dark:border-l-blue-400 dark:border-gray-800"><pre class="block p-3 hljs" style="background-color:unset"><code class="language-python" style="white-space:pre"># Obtain surrounding patches
patchIDs = []
for idx, [bbox, info] in enumerate(zip(bbox_list, info_list)):
    if (abs(info[&#x27;index_x&#x27;] - info_list[ID][&#x27;index_x&#x27;]) &lt;= 1 and
        abs(info[&#x27;index_y&#x27;] - info_list[ID][&#x27;index_y&#x27;]) &lt;= 1):
        patchIDs.append(idx)

# Check if final size is 3x3
if len(patchIDs) != 9:
    print(&#x27;Warning! Use a different central patch ID, this one is on the border.&#x27;)
    
# Change the order of the patches (used for plotting later)
patchIDs = np.transpose(np.fliplr(np.array(patchIDs).reshape(3, 3))).ravel()
    
# Prepare info of selected EOPatches
geometry = [Polygon(bbox.get_polygon()) for bbox in bbox_list[patchIDs]]
idxs_x = [info[&#x27;index_x&#x27;] for info in info_list[patchIDs]]
idxs_y = [info[&#x27;index_y&#x27;] for info in info_list[patchIDs]]

gdf = gpd.GeoDataFrame({&#x27;index_x&#x27;: idxs_x, &#x27;index_y&#x27;: idxs_y}, 
                       crs={&#x27;init&#x27;: CRS.ogc_string(country_crs)}, 
                       geometry=geometry)

# save to shapefile
shapefile_name = &#x27;./selected_3x3_bboxes_at_small.shp&#x27; if use_smaller_patches \
    else &#x27;./selected_3x3_bboxes_at_large.shp&#x27;
gdf.to_file(shapefile_name)

# Visualize the selection
poly = gdf[&#x27;geometry&#x27;][0]
x1, y1, x2, y2 = poly.bounds
aspect_ratio = (y1 - y2) / (x1 - x2)

fontdict = {&#x27;family&#x27;: &#x27;monospace&#x27;, &#x27;weight&#x27;: &#x27;normal&#x27;, &#x27;size&#x27;: 11}

# if bboxes have all same size, estimate offset
xl, yl, xu, yu = gdf.geometry[0].bounds
xoff, yoff = (xu - xl) / 3, (yu - yl) / 5

# figure
fig, ax = plt.subplots(figsize=(20, 20));
gdf.plot(ax=ax,facecolor=&#x27;w&#x27;,edgecolor=&#x27;r&#x27;,alpha=0.5);
country.plot(ax=ax, facecolor=&#x27;w&#x27;,edgecolor=&#x27;b&#x27;,alpha=0.5);
ax.set_title(&#x27;Selected 3x3 patches within the border of Austria&#x27;);
plt.axis(&#x27;off&#x27;);</code></pre><button title="Copy to Clipboard" class="inline-flex items-center opacity-0 group-hover:opacity-100 hover:opacity-100 focus:opacity-100 active:opacity-100 cursor-pointer ml-2 transition-color duration-200 ease-in-out text-blue-400 hover:text-blue-500 absolute right-1 top-1" aria-pressed="false" aria-label="Copy code to clipboard"><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" aria-hidden="true" data-slot="icon" width="24" height="24"><path stroke-linecap="round" stroke-linejoin="round" d="M15.75 17.25v3.375c0 .621-.504 1.125-1.125 1.125h-9.75a1.125 1.125 0 0 1-1.125-1.125V7.875c0-.621.504-1.125 1.125-1.125H6.75a9.06 9.06 0 0 1 1.5.124m7.5 10.376h3.375c.621 0 1.125-.504 1.125-1.125V11.25c0-4.46-3.243-8.161-7.5-8.876a9.06 9.06 0 0 0-1.5-.124H9.375c-.621 0-1.125.504-1.125 1.125v3.5m7.5 10.375H9.375a1.125 1.125 0 0 1-1.125-1.125v-9.25m12 6.625v-1.875a3.375 3.375 0 0 0-3.375-3.375h-1.5a1.125 1.125 0 0 1-1.125-1.125v-1.5a3.375 3.375 0 0 0-3.375-3.375H9.75"></path></svg></button></div><div data-mdast-node-id="_nbxDlur1X0sOBdNITTBo" class="max-w-full overflow-y-visible overflow-x-auto m-0 group not-prose relative text-left mb-5"><img src="/notebooks_test/build/69ed8651d431e96cb283a99227826b73.png" alt="&lt;Figure size 1440x1440 with 1 Axes&gt;"/></div></div><div id="qv9R3MpaGi" class="relative group/block"><div class="flex sticky top-[80px] z-10 opacity-70 group-hover/block:opacity-100 group-hover/block:hidden"><div class="absolute top-0 -right-[28px] flex md:flex-col"></div></div><div class="hidden sticky top-[80px] z-10 opacity-70 group-hover/block:opacity-100 group-hover/block:flex"><div class="absolute top-0 -right-[28px] flex md:flex-col"></div></div><div class="relative group not-prose overflow-auto shadow hover:shadow-md dark:shadow-2xl dark:shadow-neutral-900 my-5 text-sm border border-l-4 border-l-blue-400 border-gray-200 dark:border-l-blue-400 dark:border-gray-800"><pre class="block p-3 hljs" style="background-color:unset"><code class="language-python" style="white-space:pre"># Rearange selected EOPatches into bbox, which can be used for xcube definition
patches_geometries = [Polygon(bbox.transform(CRS.WGS84).get_polygon()) for bbox in bbox_list[patchIDs]]
bbox_of_patches = gpd.GeoSeries(cascaded_union(patches_geometries))

x1 = bbox_of_patches.bounds[&#x27;minx&#x27;][0].item()
y1 = bbox_of_patches.bounds[&#x27;miny&#x27;][0].item()
x2 = bbox_of_patches.bounds[&#x27;maxx&#x27;][0].item()
y2 = bbox_of_patches.bounds[&#x27;maxy&#x27;][0].item()
bbox_wgs84 = x1, y1, x2, y2</code></pre><button title="Copy to Clipboard" class="inline-flex items-center opacity-0 group-hover:opacity-100 hover:opacity-100 focus:opacity-100 active:opacity-100 cursor-pointer ml-2 transition-color duration-200 ease-in-out text-blue-400 hover:text-blue-500 absolute right-1 top-1" aria-pressed="false" aria-label="Copy code to clipboard"><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" aria-hidden="true" data-slot="icon" width="24" height="24"><path stroke-linecap="round" stroke-linejoin="round" d="M15.75 17.25v3.375c0 .621-.504 1.125-1.125 1.125h-9.75a1.125 1.125 0 0 1-1.125-1.125V7.875c0-.621.504-1.125 1.125-1.125H6.75a9.06 9.06 0 0 1 1.5.124m7.5 10.376h3.375c.621 0 1.125-.504 1.125-1.125V11.25c0-4.46-3.243-8.161-7.5-8.876a9.06 9.06 0 0 0-1.5-.124H9.375c-.621 0-1.125.504-1.125 1.125v3.5m7.5 10.375H9.375a1.125 1.125 0 0 1-1.125-1.125v-9.25m12 6.625v-1.875a3.375 3.375 0 0 0-3.375-3.375h-1.5a1.125 1.125 0 0 1-1.125-1.125v-1.5a3.375 3.375 0 0 0-3.375-3.375H9.75"></path></svg></button></div><div data-mdast-node-id="BKB3lC9QY3SgFgzWQJpZD" class="max-w-full overflow-y-visible overflow-x-auto m-0 group not-prose relative text-left"></div></div><div id="VRnKhki0vm" class="relative group/block"><div class="flex sticky top-[80px] z-10 opacity-70 group-hover/block:opacity-100 group-hover/block:hidden"><div class="absolute top-0 -right-[28px] flex md:flex-col"></div></div><div class="hidden sticky top-[80px] z-10 opacity-70 group-hover/block:opacity-100 group-hover/block:flex"><div class="absolute top-0 -right-[28px] flex md:flex-col"></div></div><div class="relative group not-prose overflow-auto shadow hover:shadow-md dark:shadow-2xl dark:shadow-neutral-900 my-5 text-sm border border-l-4 border-l-blue-400 border-gray-200 dark:border-l-blue-400 dark:border-gray-800"><pre class="block p-3 hljs" style="background-color:unset"><code class="language-python" style="white-space:pre">## Plot time series of satellite images for bbox
x1, y1, x2, y2 = bbox
spatial_res_meters = 10
pixx = (x2-x1)/spatial_res_meters; pixy = (y2-y1)/spatial_res_meters;
x1, y1, x2, y2 = bbox_wgs84
spatial_res = float(np.mean([(x2-x1)/pixx, (y2-y1)/pixy]))

cube_config = CubeConfig(dataset_name=&#x27;S2L1C&#x27;,
                         band_names=[&quot;B02&quot;, &quot;B03&quot;, &quot;B04&quot;, &quot;B08&quot;, &quot;B11&quot;, &quot;B12&quot;],
                         chunk_size=[512, 512],
                         geometry=bbox_wgs84,
                         spatial_res=spatial_res,
                         time_range=[&#x27;2018-01-01&#x27;, &#x27;2018-09-30&#x27;],
                         time_period=&#x27;4D&#x27;)  

# So we can print some SentinelHub usage stats
request_collector = Observers.request_collector()
cube = open_cube(cube_config, request_collector)

# Add Indecies
## NDVI
b_red = cube.B04
b_nir = cube.B08
ndvi = (b_nir - b_red) / (b_nir + b_red)
ndvi.attrs[&#x27;long_name&#x27;] = &#x27;Normalized Difference Vegetation Index&#x27;
ndvi.attrs[&#x27;units&#x27;] = &#x27;unitless&#x27;
cube[&quot;ndvi&quot;] = ndvi

## NDWI
b_green = cube.B03
b_nir = cube.B08
ndwi = (b_green - b_nir) / (b_green + b_nir)
ndwi.attrs[&#x27;long_name&#x27;] = &#x27;Normalized Difference Water Index&#x27;
ndwi.attrs[&#x27;units&#x27;] = &#x27;unitless&#x27;
cube[&quot;ndwi&quot;] = ndwi

cube.time</code></pre><button title="Copy to Clipboard" class="inline-flex items-center opacity-0 group-hover:opacity-100 hover:opacity-100 focus:opacity-100 active:opacity-100 cursor-pointer ml-2 transition-color duration-200 ease-in-out text-blue-400 hover:text-blue-500 absolute right-1 top-1" aria-pressed="false" aria-label="Copy code to clipboard"><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" aria-hidden="true" data-slot="icon" width="24" height="24"><path stroke-linecap="round" stroke-linejoin="round" d="M15.75 17.25v3.375c0 .621-.504 1.125-1.125 1.125h-9.75a1.125 1.125 0 0 1-1.125-1.125V7.875c0-.621.504-1.125 1.125-1.125H6.75a9.06 9.06 0 0 1 1.5.124m7.5 10.376h3.375c.621 0 1.125-.504 1.125-1.125V11.25c0-4.46-3.243-8.161-7.5-8.876a9.06 9.06 0 0 0-1.5-.124H9.375c-.621 0-1.125.504-1.125 1.125v3.5m7.5 10.375H9.375a1.125 1.125 0 0 1-1.125-1.125v-9.25m12 6.625v-1.875a3.375 3.375 0 0 0-3.375-3.375h-1.5a1.125 1.125 0 0 1-1.125-1.125v-1.5a3.375 3.375 0 0 0-3.375-3.375H9.75"></path></svg></button></div><div data-mdast-node-id="CXFxVixmq8jVtIusCwlc6" class="max-w-full overflow-y-visible overflow-x-auto m-0 group not-prose relative text-left mb-5"><div><div class="p-2.5">Loading...</div></div></div></div><div id="wdLGpfa50r" class="relative group/block"><div class="flex sticky top-[80px] z-10 opacity-70 group-hover/block:opacity-100 group-hover/block:hidden"><div class="absolute top-0 -right-[28px] flex md:flex-col"></div></div><div class="hidden sticky top-[80px] z-10 opacity-70 group-hover/block:opacity-100 group-hover/block:flex"><div class="absolute top-0 -right-[28px] flex md:flex-col"></div></div><div class="relative group not-prose overflow-auto shadow hover:shadow-md dark:shadow-2xl dark:shadow-neutral-900 my-5 text-sm border border-l-4 border-l-blue-400 border-gray-200 dark:border-l-blue-400 dark:border-gray-800"><pre class="block p-3 hljs" style="background-color:unset"><code class="language-python" style="white-space:pre">selected_time = &#x27;2018-08-03&#x27; #User&#x27;s input. Must be a value in cube.time

# True color image

factor = 2.5
R = cube.B04.sel(time=selected_time)*factor
G = cube.B03.sel(time=selected_time)*factor
B = cube.B02.sel(time=selected_time)*factor
RGB = np.dstack([R, G, B])
rgb_array = xr.DataArray(RGB, dims=(&#x27;lat&#x27;, &#x27;lon&#x27;, &#x27;b&#x27;), coords=dict(lat=cube.B04.lat, lon=cube.B04.lon))
rgb_array.plot.imshow(rgb=&#x27;b&#x27;, figsize=(16, 16))</code></pre><button title="Copy to Clipboard" class="inline-flex items-center opacity-0 group-hover:opacity-100 hover:opacity-100 focus:opacity-100 active:opacity-100 cursor-pointer ml-2 transition-color duration-200 ease-in-out text-blue-400 hover:text-blue-500 absolute right-1 top-1" aria-pressed="false" aria-label="Copy code to clipboard"><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" aria-hidden="true" data-slot="icon" width="24" height="24"><path stroke-linecap="round" stroke-linejoin="round" d="M15.75 17.25v3.375c0 .621-.504 1.125-1.125 1.125h-9.75a1.125 1.125 0 0 1-1.125-1.125V7.875c0-.621.504-1.125 1.125-1.125H6.75a9.06 9.06 0 0 1 1.5.124m7.5 10.376h3.375c.621 0 1.125-.504 1.125-1.125V11.25c0-4.46-3.243-8.161-7.5-8.876a9.06 9.06 0 0 0-1.5-.124H9.375c-.621 0-1.125.504-1.125 1.125v3.5m7.5 10.375H9.375a1.125 1.125 0 0 1-1.125-1.125v-9.25m12 6.625v-1.875a3.375 3.375 0 0 0-3.375-3.375h-1.5a1.125 1.125 0 0 1-1.125-1.125v-1.5a3.375 3.375 0 0 0-3.375-3.375H9.75"></path></svg></button></div><div data-mdast-node-id="Hil6C3Ld-KkDSlXtqYjkR" class="max-w-full overflow-y-visible overflow-x-auto m-0 group not-prose relative text-left mb-5"><div><pre class="text-sm font-thin font-system"><code><span>Clipping input data to the valid range for imshow with RGB data ([0..1] for floats or [0..255] for integers).
</span></code></pre></div><img src="/notebooks_test/build/2f36ca2e36531dc736bea3d7cfd06609.png" alt="&lt;Figure size 1152x1152 with 1 Axes&gt;"/></div></div><div id="AnPe0nHQsa" class="relative group/block"><h1 id="part-2-crop-type-prediction-with-machine-learning" class="relative group"><span class="heading-text">Part 2: Crop Type prediction with Machine Learning</span><a class="no-underline text-inherit hover:text-inherit inline-block w-0 px-0 translate-x-[10px] font-normal select-none transition-opacity opacity-0 focus:opacity-100 group-hover:opacity-70" href="#part-2-crop-type-prediction-with-machine-learning" title="Link to this Section" aria-label="Link to this Section">¶</a></h1></div><div id="CAGXqVew2m" class="relative group/block"><h2 id="set-some-of-the-inputs-for-prediction-with-ml" class="relative group"><span class="heading-text">Set some of the inputs for prediction with ML</span><a class="no-underline text-inherit hover:text-inherit inline-block w-0 px-0 translate-x-[10px] font-normal select-none transition-opacity opacity-0 focus:opacity-100 group-hover:opacity-70" href="#set-some-of-the-inputs-for-prediction-with-ml" title="Link to this Section" aria-label="Link to this Section">¶</a></h2></div><div id="wxDNEA0dOT" class="relative group/block"><div class="flex sticky top-[80px] z-10 opacity-70 group-hover/block:opacity-100 group-hover/block:hidden"><div class="absolute top-0 -right-[28px] flex md:flex-col"></div></div><div class="hidden sticky top-[80px] z-10 opacity-70 group-hover/block:opacity-100 group-hover/block:flex"><div class="absolute top-0 -right-[28px] flex md:flex-col"></div></div><div class="relative group not-prose overflow-auto shadow hover:shadow-md dark:shadow-2xl dark:shadow-neutral-900 my-5 text-sm border border-l-4 border-l-blue-400 border-gray-200 dark:border-l-blue-400 dark:border-gray-800"><pre class="block p-3 hljs" style="background-color:unset"><code class="language-python" style="white-space:pre">selected_date_for_reference_data = &#x27;2018-06-30&#x27;
selected_date_interval_for_satellite_imagery = [&#x27;2018-01-01&#x27;, &#x27;2018-09-30&#x27;]
selected_max_cc = 0.8</code></pre><button title="Copy to Clipboard" class="inline-flex items-center opacity-0 group-hover:opacity-100 hover:opacity-100 focus:opacity-100 active:opacity-100 cursor-pointer ml-2 transition-color duration-200 ease-in-out text-blue-400 hover:text-blue-500 absolute right-1 top-1" aria-pressed="false" aria-label="Copy code to clipboard"><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" aria-hidden="true" data-slot="icon" width="24" height="24"><path stroke-linecap="round" stroke-linejoin="round" d="M15.75 17.25v3.375c0 .621-.504 1.125-1.125 1.125h-9.75a1.125 1.125 0 0 1-1.125-1.125V7.875c0-.621.504-1.125 1.125-1.125H6.75a9.06 9.06 0 0 1 1.5.124m7.5 10.376h3.375c.621 0 1.125-.504 1.125-1.125V11.25c0-4.46-3.243-8.161-7.5-8.876a9.06 9.06 0 0 0-1.5-.124H9.375c-.621 0-1.125.504-1.125 1.125v3.5m7.5 10.375H9.375a1.125 1.125 0 0 1-1.125-1.125v-9.25m12 6.625v-1.875a3.375 3.375 0 0 0-3.375-3.375h-1.5a1.125 1.125 0 0 1-1.125-1.125v-1.5a3.375 3.375 0 0 0-3.375-3.375H9.75"></path></svg></button></div><div data-mdast-node-id="n8nceH1xzjo7T1jFHwxSJ" class="max-w-full overflow-y-visible overflow-x-auto m-0 group not-prose relative text-left"></div></div><div id="XBt747Gi0F" class="relative group/block"><h2 id="fill-eopatches-with-data" class="relative group"><span class="heading-text">Fill EOPatches with data:</span><a class="no-underline text-inherit hover:text-inherit inline-block w-0 px-0 translate-x-[10px] font-normal select-none transition-opacity opacity-0 focus:opacity-100 group-hover:opacity-70" href="#fill-eopatches-with-data" title="Link to this Section" aria-label="Link to this Section">¶</a></h2><p>Now it’s time to create EOPatches and fill them with Sentinel-2 data using Sentinel Hub services. We will add the following data to each EOPatch:</p><ul><li><p>L1C custom list of bands [B02, B03, B04, B08, B11, B12], which corresponds to [B, G, R, NIR, SWIR1, SWIR2] wavelengths.</p></li><li><p>SentinelHub’s cloud probability map and cloud mask</p></li></ul><p>Additionally, we will add:</p><ul><li><p>Calculated NDVI, NDWI, euclidean NORM information</p></li><li><p>A mask of validity, based on acquired data from Sentinel and cloud coverage. Valid pixel is if:</p><ol start="1"><li>IS_DATA == True</li><li>CLOUD_MASK == 0 (1 indicates that pixel was identified to be covered with cloud)</li></ol></li></ul><p>An EOPatch is created and manipulated using EOTasks, which are chained in an EOWorkflow. In this example the final workflow is executed on all patches, which are saved to the specified directory.</p></div><div id="zSuFJeW6gC" class="relative group/block"><h3 id="define-some-needed-custom-eotasks" class="relative group"><span class="heading-text">Define some needed custom EOTasks</span><a class="no-underline text-inherit hover:text-inherit inline-block w-0 px-0 translate-x-[10px] font-normal select-none transition-opacity opacity-0 focus:opacity-100 group-hover:opacity-70" href="#define-some-needed-custom-eotasks" title="Link to this Section" aria-label="Link to this Section">¶</a></h3></div><div id="M5R0fTMmhH" class="relative group/block"><div class="flex sticky top-[80px] z-10 opacity-70 group-hover/block:opacity-100 group-hover/block:hidden"><div class="absolute top-0 -right-[28px] flex md:flex-col"></div></div><div class="hidden sticky top-[80px] z-10 opacity-70 group-hover/block:opacity-100 group-hover/block:flex"><div class="absolute top-0 -right-[28px] flex md:flex-col"></div></div><div class="relative group not-prose overflow-auto shadow hover:shadow-md dark:shadow-2xl dark:shadow-neutral-900 my-5 text-sm border border-l-4 border-l-blue-400 border-gray-200 dark:border-l-blue-400 dark:border-gray-800"><pre class="block p-3 hljs" style="background-color:unset"><code class="language-python" style="white-space:pre">class SentinelHubValidData:
    &quot;&quot;&quot;
    Combine Sen2Cor&#x27;s classification map with `IS_DATA` to define a `VALID_DATA_SH` mask
    The SentinelHub&#x27;s cloud mask is asumed to be found in eopatch.mask[&#x27;CLM&#x27;]
    &quot;&quot;&quot;
    def __call__(self, eopatch):        
        return np.logical_and(eopatch.mask[&#x27;IS_DATA&#x27;].astype(np.bool), 
                              np.logical_not(eopatch.mask[&#x27;CLM&#x27;].astype(np.bool)))
    
class CountValid(EOTask):   
    &quot;&quot;&quot;
    The task counts number of valid observations in time-series and stores the results in the timeless mask.
    &quot;&quot;&quot;
    def __init__(self, count_what, feature_name):
        self.what = count_what
        self.name = feature_name
        
    def execute(self, eopatch):
        eopatch.add_feature(FeatureType.MASK_TIMELESS, self.name, np.count_nonzero(eopatch.mask[self.what],axis=0))
        
        return eopatch


class NormalizedDifferenceIndex(EOTask):   
    &quot;&quot;&quot;
    The tasks calculates user defined Normalised Difference Index (NDI) between two bands A and B as:
    NDI = (A-B)/(A+B).
    &quot;&quot;&quot;
    def __init__(self, feature_name, band_a, band_b):
        self.feature_name = feature_name
        self.band_a_fetaure_name = band_a.split(&#x27;/&#x27;)[0]
        self.band_b_fetaure_name = band_b.split(&#x27;/&#x27;)[0]
        self.band_a_fetaure_idx = int(band_a.split(&#x27;/&#x27;)[-1])
        self.band_b_fetaure_idx = int(band_b.split(&#x27;/&#x27;)[-1])
        
    def execute(self, eopatch):
        band_a = eopatch.data[self.band_a_fetaure_name][..., self.band_a_fetaure_idx]
        band_b = eopatch.data[self.band_b_fetaure_name][..., self.band_b_fetaure_idx]
        
        ndi = (band_a - band_b) / (band_a  + band_b)
        
        eopatch.add_feature(FeatureType.DATA, self.feature_name, ndi[..., np.newaxis])
        
        return eopatch

    
class EuclideanNorm(EOTask):   
    &quot;&quot;&quot;
    The tasks calculates Euclidian Norm of all bands within an array:
    norm = sqrt(sum_i Bi**2),
    where Bi are the individual bands within user-specified feature array.
    &quot;&quot;&quot;
    def __init__(self, feature_name, in_feature_name):
        self.feature_name = feature_name
        self.in_feature_name = in_feature_name
    
    def execute(self, eopatch):
        arr = eopatch.data[self.in_feature_name]
        norm = np.sqrt(np.sum(arr**2, axis=-1))
        
        eopatch.add_feature(FeatureType.DATA, self.feature_name, norm[..., np.newaxis])
        return eopatch</code></pre><button title="Copy to Clipboard" class="inline-flex items-center opacity-0 group-hover:opacity-100 hover:opacity-100 focus:opacity-100 active:opacity-100 cursor-pointer ml-2 transition-color duration-200 ease-in-out text-blue-400 hover:text-blue-500 absolute right-1 top-1" aria-pressed="false" aria-label="Copy code to clipboard"><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" aria-hidden="true" data-slot="icon" width="24" height="24"><path stroke-linecap="round" stroke-linejoin="round" d="M15.75 17.25v3.375c0 .621-.504 1.125-1.125 1.125h-9.75a1.125 1.125 0 0 1-1.125-1.125V7.875c0-.621.504-1.125 1.125-1.125H6.75a9.06 9.06 0 0 1 1.5.124m7.5 10.376h3.375c.621 0 1.125-.504 1.125-1.125V11.25c0-4.46-3.243-8.161-7.5-8.876a9.06 9.06 0 0 0-1.5-.124H9.375c-.621 0-1.125.504-1.125 1.125v3.5m7.5 10.375H9.375a1.125 1.125 0 0 1-1.125-1.125v-9.25m12 6.625v-1.875a3.375 3.375 0 0 0-3.375-3.375h-1.5a1.125 1.125 0 0 1-1.125-1.125v-1.5a3.375 3.375 0 0 0-3.375-3.375H9.75"></path></svg></button></div><div data-mdast-node-id="Jk35cVVdLQW_aQbW5glc6" class="max-w-full overflow-y-visible overflow-x-auto m-0 group not-prose relative text-left"></div></div><div id="da3ByiFF2n" class="relative group/block"><h3 id="define-the-workflow-tasks" class="relative group"><span class="heading-text">Define the workflow tasks</span><a class="no-underline text-inherit hover:text-inherit inline-block w-0 px-0 translate-x-[10px] font-normal select-none transition-opacity opacity-0 focus:opacity-100 group-hover:opacity-70" href="#define-the-workflow-tasks" title="Link to this Section" aria-label="Link to this Section">¶</a></h3></div><div id="OK6BPMlncF" class="relative group/block"><div class="flex sticky top-[80px] z-10 opacity-70 group-hover/block:opacity-100 group-hover/block:hidden"><div class="absolute top-0 -right-[28px] flex md:flex-col"></div></div><div class="hidden sticky top-[80px] z-10 opacity-70 group-hover/block:opacity-100 group-hover/block:flex"><div class="absolute top-0 -right-[28px] flex md:flex-col"></div></div><div class="relative group not-prose overflow-auto shadow hover:shadow-md dark:shadow-2xl dark:shadow-neutral-900 my-5 text-sm border border-l-4 border-l-blue-400 border-gray-200 dark:border-l-blue-400 dark:border-gray-800"><pre class="block p-3 hljs" style="background-color:unset"><code class="language-python" style="white-space:pre"># TASK FOR BAND DATA
# add a request for B(B02), G(B03), R(B04), NIR (B08), SWIR1(B11), SWIR2(B12) 
# from default layer &#x27;ALL_BANDS&#x27; at 10m resolution
# Here we also do a simple filter of cloudy scenes. A detailed cloud cover 
# detection is performed in the next step
custom_script = &#x27;return [B02, B03, B04, B08, B11, B12];&#x27;
add_data = S2L1CWCSInput(
    layer=&#x27;BANDS-S2-L1C&#x27;, 
    feature=(FeatureType.DATA, &#x27;BANDS&#x27;), # save under name &#x27;BANDS&#x27;
    custom_url_params={CustomUrlParam.EVALSCRIPT: custom_script}, # custom url for 6 specific bands
    resx=&#x27;10m&#x27;, # resolution x
    resy=&#x27;10m&#x27;, # resolution y
    maxcc=selected_max_cc # maximum allowed cloud cover of original ESA tiles
)

# TASK FOR CLOUD INFO
# cloud detection is performed at 80m resolution 
# and the resulting cloud probability map and mask 
# are scaled to EOPatch&#x27;s resolution
cloud_classifier = get_s2_pixel_cloud_detector(average_over=2, dilation_size=1, all_bands=False)
add_clm = AddCloudMaskTask(cloud_classifier, &#x27;BANDS-S2CLOUDLESS&#x27;, cm_size_y=&#x27;80m&#x27;, cm_size_x=&#x27;80m&#x27;, 
                           cmask_feature=&#x27;CLM&#x27;, # cloud mask name
                           cprobs_feature=&#x27;CLP&#x27; # cloud prob. map name
                          )

# TASKS FOR CALCULATING NEW FEATURES
# NDVI: (B08 - B04)/(B08 + B04)
# NDWI: (B03 - B08)/(B03 + B08)
# NORM: sqrt(B02^2 + B03^2 + B04^2 + B08^2 + B11^2 + B12^2)
ndvi = NormalizedDifferenceIndex(&#x27;NDVI&#x27;, &#x27;BANDS/3&#x27;, &#x27;BANDS/2&#x27;)
ndwi = NormalizedDifferenceIndex(&#x27;NDWI&#x27;, &#x27;BANDS/1&#x27;, &#x27;BANDS/3&#x27;)
norm = EuclideanNorm(&#x27;NORM&#x27;,&#x27;BANDS&#x27;)

# TASK FOR VALID MASK
# validate pixels using SentinelHub&#x27;s cloud detection mask and region of acquisition 
add_sh_valmask = AddValidDataMaskTask(SentinelHubValidData(), 
                                      &#x27;IS_VALID&#x27; # name of output mask
                                     )

# TASK FOR COUNTING VALID PIXELS
# count number of valid observations per pixel using valid data mask 
count_val_sh = CountValid(&#x27;IS_VALID&#x27;, # name of existing mask
                          &#x27;VALID_COUNT&#x27; # name of output scalar
                         )

# TASK FOR SAVING TO OUTPUT (if needed)
path_out = &#x27;./eopatches_small&#x27; if use_smaller_patches else &#x27;./eopatches_large&#x27;
if not os.path.isdir(path_out):
    os.makedirs(path_out)
save = SaveTask(path_out, overwrite_permission=OverwritePermission.OVERWRITE_PATCH)</code></pre><button title="Copy to Clipboard" class="inline-flex items-center opacity-0 group-hover:opacity-100 hover:opacity-100 focus:opacity-100 active:opacity-100 cursor-pointer ml-2 transition-color duration-200 ease-in-out text-blue-400 hover:text-blue-500 absolute right-1 top-1" aria-pressed="false" aria-label="Copy code to clipboard"><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" aria-hidden="true" data-slot="icon" width="24" height="24"><path stroke-linecap="round" stroke-linejoin="round" d="M15.75 17.25v3.375c0 .621-.504 1.125-1.125 1.125h-9.75a1.125 1.125 0 0 1-1.125-1.125V7.875c0-.621.504-1.125 1.125-1.125H6.75a9.06 9.06 0 0 1 1.5.124m7.5 10.376h3.375c.621 0 1.125-.504 1.125-1.125V11.25c0-4.46-3.243-8.161-7.5-8.876a9.06 9.06 0 0 0-1.5-.124H9.375c-.621 0-1.125.504-1.125 1.125v3.5m7.5 10.375H9.375a1.125 1.125 0 0 1-1.125-1.125v-9.25m12 6.625v-1.875a3.375 3.375 0 0 0-3.375-3.375h-1.5a1.125 1.125 0 0 1-1.125-1.125v-1.5a3.375 3.375 0 0 0-3.375-3.375H9.75"></path></svg></button></div><div data-mdast-node-id="0h3zP5HRhe8prXmRWbhFB" class="max-w-full overflow-y-visible overflow-x-auto m-0 group not-prose relative text-left"></div></div><div id="R8IIDQ5uU2" class="relative group/block"><h3 id="reference-map-task" class="relative group"><span class="heading-text">Reference map task</span><a class="no-underline text-inherit hover:text-inherit inline-block w-0 px-0 translate-x-[10px] font-normal select-none transition-opacity opacity-0 focus:opacity-100 group-hover:opacity-70" href="#reference-map-task" title="Link to this Section" aria-label="Link to this Section">¶</a></h3><p>For this example the LPIS Data from the austrian Open Government Data portal <a target="_blank" rel="noreferrer" href="http://data.gv.at" class="">data.gv.at</a> is used: <a target="_blank" rel="noreferrer" href="https://www.data.gv.at/katalog/dataset/e21a731f-9e08-4dd3-b9e5-cd460438a5d9" class="">INVEKOS Schläge Österreich</a>
The crop types are grouped into 23 groups for classification:</p></div><div id="im0eXt4FZC" class="relative group/block"><div class="flex sticky top-[80px] z-10 opacity-70 group-hover/block:opacity-100 group-hover/block:hidden"><div class="absolute top-0 -right-[28px] flex md:flex-col"></div></div><div class="hidden sticky top-[80px] z-10 opacity-70 group-hover/block:opacity-100 group-hover/block:flex"><div class="absolute top-0 -right-[28px] flex md:flex-col"></div></div><div class="relative group not-prose overflow-auto shadow hover:shadow-md dark:shadow-2xl dark:shadow-neutral-900 my-5 text-sm border border-l-4 border-l-blue-400 border-gray-200 dark:border-l-blue-400 dark:border-gray-800"><pre class="block p-3 hljs" style="background-color:unset"><code class="language-python" style="white-space:pre">class CTGROUPS(Enum):
    NO_DATA                   = (0, &quot;NO_DATA&quot;, &quot;#ffffff&quot;)
    SOMMERGETREIDE            = (1, &quot;SOMMERGETREIDE&quot;, &quot;#7bf500&quot;)
    WINTERGETREIDE            = (2, &quot;WINTERGETREIDE&quot;, &quot;#a8ff2b&quot;)
    MENGGETREIDE_AEHNLICHES   = (3, &quot;MENGGETREIDE_AEHNLICHES&quot;, &quot;#daff1f&quot;)
    MAIS_AEHNLICHES           = (4, &quot;MAIS_AEHNLICHES&quot;, &quot;#fff200&quot;)
    SOMMERRAPS_AEHNLICHES     = (5, &quot;SOMMERRAPS_AEHNLICHES&quot;, &quot;#ffd701&quot;)
    WINTERRAPS_AEHNLICHES     = (6, &quot;WINTERRAPS_AEHNLICHES&quot;, &quot;#ffbc0c&quot;)
    SONNENBLUME               = (7, &quot;SONNENBLUME&quot;, &quot;#ff7005&quot;)
    HANF                      = (8, &quot;HANF&quot;, &quot;#ff2a00&quot;)
    LEGUMINOSEN_AEHNLICHES    = (9, &quot;LEGUMINOSEN_AEHNLICHES&quot;, &quot;#ff0046&quot;)
    WINTERLEGUMINOSE          = (10, &quot;WINTERLEGUMINOSE&quot;, &quot;#ff00f8&quot;)
    KARTOFFELN_AEHNLICHES     = (11, &quot;KARTOFFELN_AEHNLICHES&quot;, &quot;#b325ff&quot;)
    RUEBEN                    = (12, &quot;RUEBEN&quot;, &quot;#cd61f4&quot;)
    GEMUESE_AEHNLICHES        = (13, &quot;GEMUESE_AEHNLICHES&quot;, &quot;#ef96f1&quot;)
    GEWUERZE_AEHNLICHES       = (14, &quot;GEWUERZE_AEHNLICHES&quot;, &quot;#f6c9f7&quot;)
    WINTERGEWUERZE_AEHNLICHES = (15, &quot;WINTERGEWUERZE_AEHNLICHES&quot;, &quot;#000080&quot;)
    KUERBIS                   = (16, &quot;KUERBIS&quot;, &quot;#004821&quot;)
    BRACHE                    = (17, &quot;BRACHE&quot;, &quot;#00288a&quot;)
    DAUERKULTUR               = (18, &quot;DAUERKULTUR&quot;, &quot;#0046ff&quot;)
    GEWAECHSHAUS              = (19, &quot;GEWAECHSHAUS&quot;, &quot;#00c5ff&quot;)
    WEIN                      = (20, &quot;WEIN&quot;, &quot;#00f6f8&quot;)
    GRUENLAND                 = (21, &quot;GRUENLAND&quot;, &quot;#26ef00&quot;)
    PRO_RATA                  = (22, &quot;PRO_RATA&quot;, &quot;#67d400&quot;)
    LAGERFLAECHEN             = (23, &quot;LAGERFLAECHEN&quot;, &quot;#aaaaaa&quot;)
    SONSTIGES                 = (24, &quot;SONSTIGES&quot;, &quot;#555555&quot;)

    
    def __init__(self, val1, val2, val3):
        self.id = val1
        self.class_name = val2
        self.color = val3


#Reference colormap things
ct_cmap = mpl.colors.ListedColormap([entry.color for entry in CTGROUPS])
ct_norm = mpl.colors.BoundaryNorm(np.arange(-0.5, 24, 1), ct_cmap.N)</code></pre><button title="Copy to Clipboard" class="inline-flex items-center opacity-0 group-hover:opacity-100 hover:opacity-100 focus:opacity-100 active:opacity-100 cursor-pointer ml-2 transition-color duration-200 ease-in-out text-blue-400 hover:text-blue-500 absolute right-1 top-1" aria-pressed="false" aria-label="Copy code to clipboard"><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" aria-hidden="true" data-slot="icon" width="24" height="24"><path stroke-linecap="round" stroke-linejoin="round" d="M15.75 17.25v3.375c0 .621-.504 1.125-1.125 1.125h-9.75a1.125 1.125 0 0 1-1.125-1.125V7.875c0-.621.504-1.125 1.125-1.125H6.75a9.06 9.06 0 0 1 1.5.124m7.5 10.376h3.375c.621 0 1.125-.504 1.125-1.125V11.25c0-4.46-3.243-8.161-7.5-8.876a9.06 9.06 0 0 0-1.5-.124H9.375c-.621 0-1.125.504-1.125 1.125v3.5m7.5 10.375H9.375a1.125 1.125 0 0 1-1.125-1.125v-9.25m12 6.625v-1.875a3.375 3.375 0 0 0-3.375-3.375h-1.5a1.125 1.125 0 0 1-1.125-1.125v-1.5a3.375 3.375 0 0 0-3.375-3.375H9.75"></path></svg></button></div><div data-mdast-node-id="slhzwBhckwhprValha3hd" class="max-w-full overflow-y-visible overflow-x-auto m-0 group not-prose relative text-left"></div></div><div id="p9r2G6VjDl" class="relative group/block"><p>The main point of this task is to create a raster mask from the vector polygons and add it to the eopatch. With this procedure, any kind of a labeled shapefile can be transformed into a raster reference map. This result is achieved with the existing task <code>VectorToRaster</code> from the <code>eolearn.geometry</code> package. All polygons belonging to the each of the classes are separately burned to the raster mask.</p></div><div id="jzvY8hnwNV" class="relative group/block"><div class="flex sticky top-[80px] z-10 opacity-70 group-hover/block:opacity-100 group-hover/block:hidden"><div class="absolute top-0 -right-[28px] flex md:flex-col"></div></div><div class="hidden sticky top-[80px] z-10 opacity-70 group-hover/block:opacity-100 group-hover/block:flex"><div class="absolute top-0 -right-[28px] flex md:flex-col"></div></div><div class="relative group not-prose overflow-auto shadow hover:shadow-md dark:shadow-2xl dark:shadow-neutral-900 my-5 text-sm border border-l-4 border-l-blue-400 border-gray-200 dark:border-l-blue-400 dark:border-gray-800"><pre class="block p-3 hljs" style="background-color:unset"><code class="language-python" style="white-space:pre"># user param
LPISRecordsDateMin = selected_date_for_reference_data 
LPISRecordsDateMax = selected_date_for_reference_data

class LoadFromDatabaseTask(EOTask):
    def __init__(self, feature, taskName, crs, tableName, dateFilterMin, dateFilterMax, mappedColumnName = None, mappingLambdaFunc = None):
        self.feature_type, self.feature_name = next(self._parse_features(feature)())
        self.taskName = taskName
        self.crs = crs
        self.tableName = tableName
        self.dateFilterMin = dateFilterMin
        self.dateFilterMax = dateFilterMax
        self.mappedColumnName = mappedColumnName
        self.mappingLambdaFunc = mappingLambdaFunc

    def execute(self, eopatch, db_conn):
        eopatch[self.feature_type][self.feature_name] = loadFromDatabase(db_conn, 
            self.taskName, self.tableName, eopatch.bbox, 
            self.dateFilterMin, self.dateFilterMax, 
            self.mappedColumnName, self.mappingLambdaFunc)
        return eopatch
    

# LPIS
ct_use_db_task = LoadFromDatabaseTask((FeatureType.VECTOR_TIMELESS, &#x27;CROP_TYPE_GDF&#x27;), 
    &quot;crop type&quot;, CRS.UTM_33N, &quot;lpis_at&quot;, LPISRecordsDateMin, LPISRecordsDateMax, 
    &quot;ct&quot;, lambda ct_id: ctnuml4aToctMapping[ct_id] if ct_id in ctnuml4aToctMapping else 0)


ct_rasterization_task = VectorToRaster((FeatureType.VECTOR_TIMELESS, &#x27;CROP_TYPE_GDF&#x27;), (FeatureType.MASK_TIMELESS, &#x27;CROP_TYPE&#x27;),
    values_column=&#x27;ct&#x27;, raster_shape=(FeatureType.MASK, &#x27;IS_VALID&#x27;),
    raster_dtype=np.uint8)

ct_export_tiff = ExportToTiff((FeatureType.MASK_TIMELESS, &#x27;CROP_TYPE&#x27;))</code></pre><button title="Copy to Clipboard" class="inline-flex items-center opacity-0 group-hover:opacity-100 hover:opacity-100 focus:opacity-100 active:opacity-100 cursor-pointer ml-2 transition-color duration-200 ease-in-out text-blue-400 hover:text-blue-500 absolute right-1 top-1" aria-pressed="false" aria-label="Copy code to clipboard"><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" aria-hidden="true" data-slot="icon" width="24" height="24"><path stroke-linecap="round" stroke-linejoin="round" d="M15.75 17.25v3.375c0 .621-.504 1.125-1.125 1.125h-9.75a1.125 1.125 0 0 1-1.125-1.125V7.875c0-.621.504-1.125 1.125-1.125H6.75a9.06 9.06 0 0 1 1.5.124m7.5 10.376h3.375c.621 0 1.125-.504 1.125-1.125V11.25c0-4.46-3.243-8.161-7.5-8.876a9.06 9.06 0 0 0-1.5-.124H9.375c-.621 0-1.125.504-1.125 1.125v3.5m7.5 10.375H9.375a1.125 1.125 0 0 1-1.125-1.125v-9.25m12 6.625v-1.875a3.375 3.375 0 0 0-3.375-3.375h-1.5a1.125 1.125 0 0 1-1.125-1.125v-1.5a3.375 3.375 0 0 0-3.375-3.375H9.75"></path></svg></button></div><div data-mdast-node-id="hZaffuifWrRfG-zGhgdCi" class="max-w-full overflow-y-visible overflow-x-auto m-0 group not-prose relative text-left"></div></div><div id="oUYYZola6w" class="relative group/block"><h3 id="define-the-workflow" class="relative group"><span class="heading-text">Define the workflow</span><a class="no-underline text-inherit hover:text-inherit inline-block w-0 px-0 translate-x-[10px] font-normal select-none transition-opacity opacity-0 focus:opacity-100 group-hover:opacity-70" href="#define-the-workflow" title="Link to this Section" aria-label="Link to this Section">¶</a></h3><p>All the tasks that were defined so far create and fill the EOPatches. The tasks need to be put in some order and executed one by one. This can be achieved by manually executing the tasks, or more conveniently, defining an <code>EOWorkflow</code> which does this for you.</p><p>The following workflow is created and executed:</p><ol start="1"><li>Create EOPatches with band data</li><li>Add cloud info</li><li>Calculate and add NDVI, NDWI, NORM</li><li>Add mask of valid pixels</li><li>Add scalar feature representing the cound of valid pixels</li><li>Save eopatches</li></ol><p>An EOWorkflow can be linear or more complex, but it should be acyclic. Here we will use the linear case of the EOWorkflow, available as <code>LinearWorkflow</code></p></div><div id="Ugnr3N3fHq" class="relative group/block"><p>Define the workflow</p></div><div id="ULeZlFkmlu" class="relative group/block"><div class="flex sticky top-[80px] z-10 opacity-70 group-hover/block:opacity-100 group-hover/block:hidden"><div class="absolute top-0 -right-[28px] flex md:flex-col"></div></div><div class="hidden sticky top-[80px] z-10 opacity-70 group-hover/block:opacity-100 group-hover/block:flex"><div class="absolute top-0 -right-[28px] flex md:flex-col"></div></div><div class="relative group not-prose overflow-auto shadow hover:shadow-md dark:shadow-2xl dark:shadow-neutral-900 my-5 text-sm border border-l-4 border-l-blue-400 border-gray-200 dark:border-l-blue-400 dark:border-gray-800"><pre class="block p-3 hljs" style="background-color:unset"><code class="language-python" style="white-space:pre"># Define the workflow
workflow = LinearWorkflow(
    add_data,
    add_clm,
    ndvi,
    ndwi,
    norm,
    add_sh_valmask,
    count_val_sh,
    ct_use_db_task,
    ct_rasterization_task,
    ct_export_tiff,
    save
)

# Let&#x27;s visualize it
workflow.dependency_graph()</code></pre><button title="Copy to Clipboard" class="inline-flex items-center opacity-0 group-hover:opacity-100 hover:opacity-100 focus:opacity-100 active:opacity-100 cursor-pointer ml-2 transition-color duration-200 ease-in-out text-blue-400 hover:text-blue-500 absolute right-1 top-1" aria-pressed="false" aria-label="Copy code to clipboard"><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" aria-hidden="true" data-slot="icon" width="24" height="24"><path stroke-linecap="round" stroke-linejoin="round" d="M15.75 17.25v3.375c0 .621-.504 1.125-1.125 1.125h-9.75a1.125 1.125 0 0 1-1.125-1.125V7.875c0-.621.504-1.125 1.125-1.125H6.75a9.06 9.06 0 0 1 1.5.124m7.5 10.376h3.375c.621 0 1.125-.504 1.125-1.125V11.25c0-4.46-3.243-8.161-7.5-8.876a9.06 9.06 0 0 0-1.5-.124H9.375c-.621 0-1.125.504-1.125 1.125v3.5m7.5 10.375H9.375a1.125 1.125 0 0 1-1.125-1.125v-9.25m12 6.625v-1.875a3.375 3.375 0 0 0-3.375-3.375h-1.5a1.125 1.125 0 0 1-1.125-1.125v-1.5a3.375 3.375 0 0 0-3.375-3.375H9.75"></path></svg></button></div><div data-mdast-node-id="dThoFHbOCBVIcYn1OuHSb" class="max-w-full overflow-y-visible overflow-x-auto m-0 group not-prose relative text-left mb-5"><div><div class="p-2.5">Loading...</div></div></div></div><div id="PkuV9OhNu6" class="relative group/block"><p><em>This may take some time, so go grab a cup of coffee ...</em></p></div><div id="TE9XQDd3yA" class="relative group/block"><div class="flex sticky top-[80px] z-10 opacity-70 group-hover/block:opacity-100 group-hover/block:hidden"><div class="absolute top-0 -right-[28px] flex md:flex-col"></div></div><div class="hidden sticky top-[80px] z-10 opacity-70 group-hover/block:opacity-100 group-hover/block:flex"><div class="absolute top-0 -right-[28px] flex md:flex-col"></div></div><div class="relative group not-prose overflow-auto shadow hover:shadow-md dark:shadow-2xl dark:shadow-neutral-900 my-5 text-sm border border-l-4 border-l-blue-400 border-gray-200 dark:border-l-blue-400 dark:border-gray-800"><pre class="block p-3 hljs" style="background-color:unset"><code class="language-python" style="white-space:pre">%%time

# Execute the workflow

source_tiff_location = &#x27;./source_tiff&#x27;
if not os.path.isdir(source_tiff_location):
    os.makedirs(source_tiff_location)

# define additional parameters of the workflow
with psycopg2.connect(**db_conn_params) as db_conn: # must use single DB connection for all the tasks
    execution_args = []
    for idx, bbox in enumerate(bbox_list[patchIDs]):       
        execution_args.append({
            add_data: {&#x27;bbox&#x27;: bbox, &#x27;time_interval&#x27;: selected_date_interval_for_satellite_imagery},
            ct_use_db_task: {&#x27;db_conn&#x27;: db_conn},
            ct_export_tiff: {&#x27;filename&#x27;: &#x27;{}/crop_type_eopatch_{}_original.tiff&#x27;.format(source_tiff_location, idx)},
            save: {&#x27;eopatch_folder&#x27;: &#x27;eopatch_{}&#x27;.format(idx)}
        })

executor = EOExecutor(workflow, execution_args, save_logs=True)
executor.run(workers=9, multiprocess=False)

executor.make_report()</code></pre><button title="Copy to Clipboard" class="inline-flex items-center opacity-0 group-hover:opacity-100 hover:opacity-100 focus:opacity-100 active:opacity-100 cursor-pointer ml-2 transition-color duration-200 ease-in-out text-blue-400 hover:text-blue-500 absolute right-1 top-1" aria-pressed="false" aria-label="Copy code to clipboard"><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" aria-hidden="true" data-slot="icon" width="24" height="24"><path stroke-linecap="round" stroke-linejoin="round" d="M15.75 17.25v3.375c0 .621-.504 1.125-1.125 1.125h-9.75a1.125 1.125 0 0 1-1.125-1.125V7.875c0-.621.504-1.125 1.125-1.125H6.75a9.06 9.06 0 0 1 1.5.124m7.5 10.376h3.375c.621 0 1.125-.504 1.125-1.125V11.25c0-4.46-3.243-8.161-7.5-8.876a9.06 9.06 0 0 0-1.5-.124H9.375c-.621 0-1.125.504-1.125 1.125v3.5m7.5 10.375H9.375a1.125 1.125 0 0 1-1.125-1.125v-9.25m12 6.625v-1.875a3.375 3.375 0 0 0-3.375-3.375h-1.5a1.125 1.125 0 0 1-1.125-1.125v-1.5a3.375 3.375 0 0 0-3.375-3.375H9.75"></path></svg></button></div><div data-mdast-node-id="9RVjiO-rO-2pL_6Xyr5VM" class="max-w-full overflow-y-visible overflow-x-auto m-0 group not-prose relative text-left mb-5"><div><div class="p-2.5">Loading...</div></div></div></div><div id="U4PGT3Vo9n" class="relative group/block"><p>In this case, all patches come from a small region, so all of them have the same dates of acquisition for at least a few dates, so we can inspect the area without interpolation at this point.</p></div><div id="ZOIaWeZD7F" class="relative group/block"><h2 id="visualize-the-true-color-image" class="relative group"><span class="heading-text">Visualize the true color image</span><a class="no-underline text-inherit hover:text-inherit inline-block w-0 px-0 translate-x-[10px] font-normal select-none transition-opacity opacity-0 focus:opacity-100 group-hover:opacity-70" href="#visualize-the-true-color-image" title="Link to this Section" aria-label="Link to this Section">¶</a></h2></div><div id="bUTHrsDTbY" class="relative group/block"><div class="flex sticky top-[80px] z-10 opacity-70 group-hover/block:opacity-100 group-hover/block:hidden"><div class="absolute top-0 -right-[28px] flex md:flex-col"></div></div><div class="hidden sticky top-[80px] z-10 opacity-70 group-hover/block:opacity-100 group-hover/block:flex"><div class="absolute top-0 -right-[28px] flex md:flex-col"></div></div><div class="relative group not-prose overflow-auto shadow hover:shadow-md dark:shadow-2xl dark:shadow-neutral-900 my-5 text-sm border border-l-4 border-l-blue-400 border-gray-200 dark:border-l-blue-400 dark:border-gray-800"><pre class="block p-3 hljs" style="background-color:unset"><code class="language-python" style="white-space:pre"># Draw the RGB image
path_out = &#x27;./eopatches_small&#x27; if use_smaller_patches else &#x27;./eopatches_large/&#x27;
fig = plt.figure(figsize=(20, 20 * aspect_ratio))

pbar = tqdm(total=9)
for i in range(9):
    eopatch = EOPatch.load(&#x27;{}/eopatch_{}&#x27;.format(path_out, i), lazy_loading=True)
    ax = plt.subplot(3, 3, i + 1)
    plt.imshow(np.clip(eopatch.data[&#x27;BANDS&#x27;][0][..., [2, 1, 0]] * 3.5, 0, 1))
    plt.xticks([])
    plt.yticks([])
    ax.set_aspect(&quot;auto&quot;)
    pbar.update(1)
    del eopatch

fig.subplots_adjust(wspace=0, hspace=0)</code></pre><button title="Copy to Clipboard" class="inline-flex items-center opacity-0 group-hover:opacity-100 hover:opacity-100 focus:opacity-100 active:opacity-100 cursor-pointer ml-2 transition-color duration-200 ease-in-out text-blue-400 hover:text-blue-500 absolute right-1 top-1" aria-pressed="false" aria-label="Copy code to clipboard"><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" aria-hidden="true" data-slot="icon" width="24" height="24"><path stroke-linecap="round" stroke-linejoin="round" d="M15.75 17.25v3.375c0 .621-.504 1.125-1.125 1.125h-9.75a1.125 1.125 0 0 1-1.125-1.125V7.875c0-.621.504-1.125 1.125-1.125H6.75a9.06 9.06 0 0 1 1.5.124m7.5 10.376h3.375c.621 0 1.125-.504 1.125-1.125V11.25c0-4.46-3.243-8.161-7.5-8.876a9.06 9.06 0 0 0-1.5-.124H9.375c-.621 0-1.125.504-1.125 1.125v3.5m7.5 10.375H9.375a1.125 1.125 0 0 1-1.125-1.125v-9.25m12 6.625v-1.875a3.375 3.375 0 0 0-3.375-3.375h-1.5a1.125 1.125 0 0 1-1.125-1.125v-1.5a3.375 3.375 0 0 0-3.375-3.375H9.75"></path></svg></button></div><div data-mdast-node-id="hBmkD5roNuwl6DqYlN5PS" class="max-w-full overflow-y-visible overflow-x-auto m-0 group not-prose relative text-left mb-5"><div><div class="p-2.5">Loading...</div></div></div></div><div id="qLtQl6TDg6" class="relative group/block"><h2 id="visualize-the-reference-map" class="relative group"><span class="heading-text">Visualize the reference map</span><a class="no-underline text-inherit hover:text-inherit inline-block w-0 px-0 translate-x-[10px] font-normal select-none transition-opacity opacity-0 focus:opacity-100 group-hover:opacity-70" href="#visualize-the-reference-map" title="Link to this Section" aria-label="Link to this Section">¶</a></h2></div><div id="iaeqJYyO9v" class="relative group/block"><div class="flex sticky top-[80px] z-10 opacity-70 group-hover/block:opacity-100 group-hover/block:hidden"><div class="absolute top-0 -right-[28px] flex md:flex-col"></div></div><div class="hidden sticky top-[80px] z-10 opacity-70 group-hover/block:opacity-100 group-hover/block:flex"><div class="absolute top-0 -right-[28px] flex md:flex-col"></div></div><div class="relative group not-prose overflow-auto shadow hover:shadow-md dark:shadow-2xl dark:shadow-neutral-900 my-5 text-sm border border-l-4 border-l-blue-400 border-gray-200 dark:border-l-blue-400 dark:border-gray-800"><pre class="block p-3 hljs" style="background-color:unset"><code class="language-python" style="white-space:pre">path_out = &#x27;./eopatches_small/&#x27; if use_smaller_patches else &#x27;./eopatches_large/&#x27;

fig, axes = plt.subplots(figsize=(20, 20 * aspect_ratio), nrows=3, ncols=3)

pbar = tqdm(total=9)
for i, ax in enumerate(axes.flat):
    eopatch = EOPatch.load(&#x27;{}/eopatch_{}&#x27;.format(path_out, i), lazy_loading=True)
    im = ax.imshow(eopatch.mask_timeless[&#x27;CROP_TYPE&#x27;].squeeze(), cmap=ct_cmap, norm=ct_norm)
    ax.set_xticks([])
    ax.set_yticks([])
    ax.set_aspect(&quot;auto&quot;)
    pbar.update(1)
    del eopatch

fig.subplots_adjust(wspace=0, hspace=0)

cb = fig.colorbar(im, ax=axes.ravel().tolist(), orientation=&#x27;horizontal&#x27;, pad=0.01, aspect=100)
cb.ax.tick_params(labelsize=20) 
cb.set_ticks([entry.id for entry in CTGROUPS])
cb.ax.set_xticklabels([entry.class_name for entry in CTGROUPS], rotation=90, fontsize=15)
plt.show()</code></pre><button title="Copy to Clipboard" class="inline-flex items-center opacity-0 group-hover:opacity-100 hover:opacity-100 focus:opacity-100 active:opacity-100 cursor-pointer ml-2 transition-color duration-200 ease-in-out text-blue-400 hover:text-blue-500 absolute right-1 top-1" aria-pressed="false" aria-label="Copy code to clipboard"><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" aria-hidden="true" data-slot="icon" width="24" height="24"><path stroke-linecap="round" stroke-linejoin="round" d="M15.75 17.25v3.375c0 .621-.504 1.125-1.125 1.125h-9.75a1.125 1.125 0 0 1-1.125-1.125V7.875c0-.621.504-1.125 1.125-1.125H6.75a9.06 9.06 0 0 1 1.5.124m7.5 10.376h3.375c.621 0 1.125-.504 1.125-1.125V11.25c0-4.46-3.243-8.161-7.5-8.876a9.06 9.06 0 0 0-1.5-.124H9.375c-.621 0-1.125.504-1.125 1.125v3.5m7.5 10.375H9.375a1.125 1.125 0 0 1-1.125-1.125v-9.25m12 6.625v-1.875a3.375 3.375 0 0 0-3.375-3.375h-1.5a1.125 1.125 0 0 1-1.125-1.125v-1.5a3.375 3.375 0 0 0-3.375-3.375H9.75"></path></svg></button></div><div data-mdast-node-id="g3gi8N7xd072-8xlHNe2d" class="max-w-full overflow-y-visible overflow-x-auto m-0 group not-prose relative text-left mb-5"><div><div class="p-2.5">Loading...</div></div></div></div><div id="RHuIl3QdeT" class="relative group/block"><h2 id="prepare-the-training-data" class="relative group"><span class="heading-text">Prepare the training data</span><a class="no-underline text-inherit hover:text-inherit inline-block w-0 px-0 translate-x-[10px] font-normal select-none transition-opacity opacity-0 focus:opacity-100 group-hover:opacity-70" href="#prepare-the-training-data" title="Link to this Section" aria-label="Link to this Section">¶</a></h2><p>We will create a new workflow that processes the data:</p><ol start="1"><li>Remove too cloudy scenes<ul><li>Check the ratio of the valid data for each patch and for each time frame</li><li>Keep only time frames with &gt; 80 % valid coverage (no clouds)</li></ul></li><li>Concatenate BAND, NDVI, NDWI, NORM info into a single feature called FEATURES</li><li>Perform temporal interpolation (filling gaps and resampling to the same dates)<ul><li>Create a task for linear interpolation in the temporal dimension</li><li>Provide the cloud mask to tell the interpolating function which values to update</li></ul></li><li>Perform erosion<ul><li>This removes artefacts with a width of 1 px, and also removes the edges between polygons of different classes</li></ul></li><li>Random spatial sampling of the EOPatches<ul><li>Randomly take a subset of pixels from a patch to use in the machine learning training</li></ul></li><li>Split patches for training/validation<ul><li>Split the patches into a training and validation set</li></ul></li></ol></div><div id="brQiVZV51B" class="relative group/block"><h3 id="define-eotasks" class="relative group"><span class="heading-text">Define EOTasks</span><a class="no-underline text-inherit hover:text-inherit inline-block w-0 px-0 translate-x-[10px] font-normal select-none transition-opacity opacity-0 focus:opacity-100 group-hover:opacity-70" href="#define-eotasks" title="Link to this Section" aria-label="Link to this Section">¶</a></h3></div><div id="yiN2UwZ2HW" class="relative group/block"><div class="flex sticky top-[80px] z-10 opacity-70 group-hover/block:opacity-100 group-hover/block:hidden"><div class="absolute top-0 -right-[28px] flex md:flex-col"></div></div><div class="hidden sticky top-[80px] z-10 opacity-70 group-hover/block:opacity-100 group-hover/block:flex"><div class="absolute top-0 -right-[28px] flex md:flex-col"></div></div><div class="relative group not-prose overflow-auto shadow hover:shadow-md dark:shadow-2xl dark:shadow-neutral-900 my-5 text-sm border border-l-4 border-l-blue-400 border-gray-200 dark:border-l-blue-400 dark:border-gray-800"><pre class="block p-3 hljs" style="background-color:unset"><code class="language-python" style="white-space:pre">class ConcatenateData(EOTask):
    &quot;&quot;&quot; Task to concatenate data arrays along the last dimension
    &quot;&quot;&quot;
    def __init__(self, feature_name, feature_names_to_concatenate):
        self.feature_name = feature_name
        self.feature_names_to_concatenate = feature_names_to_concatenate

    def execute(self, eopatch):
        arrays = [eopatch.data[name] for name in self.feature_names_to_concatenate]

        eopatch.add_feature(FeatureType.DATA, self.feature_name, np.concatenate(arrays, axis=-1))

        return eopatch
    
    
class ValidDataFractionPredicate:
    &quot;&quot;&quot; Predicate that defines if a frame from EOPatch&#x27;s time-series is valid or not. Frame is valid, if the 
    valid data fraction is above the specified threshold.
    &quot;&quot;&quot;
    def __init__(self, threshold):
        self.threshold = threshold
        
    def __call__(self, array):
        coverage = np.sum(array.astype(np.uint8)) / np.prod(array.shape)
        return coverage &gt; self.threshold
    
# TASK TO LOAD EXISTING EOPATCHES
load = LoadTask(path_out)

# TASK FOR CONCATENATION
concatenate = ConcatenateData(&#x27;FEATURES&#x27;, [&#x27;BANDS&#x27;, &#x27;NDVI&#x27;, &#x27;NDWI&#x27;, &#x27;NORM&#x27;])

# TASK FOR FILTERING OUT TOO CLOUDY SCENES
# keep frames with &gt; 80 % valid coverage
valid_data_predicate = ValidDataFractionPredicate(0.8)
filter_task = SimpleFilterTask((FeatureType.MASK, &#x27;IS_VALID&#x27;), valid_data_predicate)

# TASK FOR LINEAR INTERPOLATION
# linear interpolation of full time-series and date resampling
selected_date_interval_for_interpolation = selected_date_interval_for_satellite_imagery + [16] 
# TODO: replace fixed number of times with fixed time difference
#resampled_range = tuple(selected_date_interval_for_satellite_imagery)
resampled_range = (
    selected_date_interval_for_interpolation[0].replace(&quot;-&quot;, &quot;&quot;),
    selected_date_interval_for_interpolation[1].replace(&quot;-&quot;, &quot;&quot;),
    selected_date_interval_for_interpolation[2]
)
linear_interp = LinearInterpolation(
    &#x27;FEATURES&#x27;, # name of field to interpolate
    mask_feature=(FeatureType.MASK, &#x27;IS_VALID&#x27;), # mask to be used in interpolation
    copy_features=[(FeatureType.MASK_TIMELESS, &#x27;CROP_TYPE&#x27;)], # features to keep
    resample_range=resampled_range, # set the resampling range
    bounds_error=False # extrapolate with NaN&#x27;s
)

# TASK FOR EROSION
# erode each class of the reference map
erosion = ErosionTask(mask_feature=(FeatureType.MASK_TIMELESS,&#x27;CROP_TYPE&#x27;,&#x27;CROP_TYPE_ERODED&#x27;), disk_radius=1)

# TASK FOR SPATIAL SAMPLING
# Uniformly sample about pixels from patches
n_samples = int(4e4) if use_smaller_patches else int(1e5) # no. of pixels to sample
ref_labels = list(range(11)) # reference labels to take into account when sampling
spatial_sampling = PointSamplingTask(
    n_samples=n_samples, 
    ref_mask_feature=&#x27;CROP_TYPE_ERODED&#x27;, 
    ref_labels=ref_labels, 
    sample_features=[  # tag fields to sample
        (FeatureType.DATA, &#x27;FEATURES&#x27;),
        (FeatureType.MASK_TIMELESS, &#x27;CROP_TYPE_ERODED&#x27;)
    ])

path_out_sampled = &#x27;./eopatches_sampled_small/&#x27; if use_smaller_patches else &#x27;./eopatches_sampled_large/&#x27;
if not os.path.isdir(path_out_sampled):
    os.makedirs(path_out_sampled)
save = SaveTask(path_out_sampled, overwrite_permission=OverwritePermission.OVERWRITE_PATCH)

# Define the workflow
workflow = LinearWorkflow(
    load,
    concatenate,
    filter_task,
    linear_interp,
    erosion,
    spatial_sampling,
    save
)</code></pre><button title="Copy to Clipboard" class="inline-flex items-center opacity-0 group-hover:opacity-100 hover:opacity-100 focus:opacity-100 active:opacity-100 cursor-pointer ml-2 transition-color duration-200 ease-in-out text-blue-400 hover:text-blue-500 absolute right-1 top-1" aria-pressed="false" aria-label="Copy code to clipboard"><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" aria-hidden="true" data-slot="icon" width="24" height="24"><path stroke-linecap="round" stroke-linejoin="round" d="M15.75 17.25v3.375c0 .621-.504 1.125-1.125 1.125h-9.75a1.125 1.125 0 0 1-1.125-1.125V7.875c0-.621.504-1.125 1.125-1.125H6.75a9.06 9.06 0 0 1 1.5.124m7.5 10.376h3.375c.621 0 1.125-.504 1.125-1.125V11.25c0-4.46-3.243-8.161-7.5-8.876a9.06 9.06 0 0 0-1.5-.124H9.375c-.621 0-1.125.504-1.125 1.125v3.5m7.5 10.375H9.375a1.125 1.125 0 0 1-1.125-1.125v-9.25m12 6.625v-1.875a3.375 3.375 0 0 0-3.375-3.375h-1.5a1.125 1.125 0 0 1-1.125-1.125v-1.5a3.375 3.375 0 0 0-3.375-3.375H9.75"></path></svg></button></div><div data-mdast-node-id="LbJ_S4GamwwJxkDQ2L1-v" class="max-w-full overflow-y-visible overflow-x-auto m-0 group not-prose relative text-left"></div></div><div id="pLlY4iO2Ii" class="relative group/block"><h3 id="run-the-eoworkflow-over-all-eopatches" class="relative group"><span class="heading-text">Run the EOWorkflow over all EOPatches</span><a class="no-underline text-inherit hover:text-inherit inline-block w-0 px-0 translate-x-[10px] font-normal select-none transition-opacity opacity-0 focus:opacity-100 group-hover:opacity-70" href="#run-the-eoworkflow-over-all-eopatches" title="Link to this Section" aria-label="Link to this Section">¶</a></h3></div><div id="M7ZUNlFZVp" class="relative group/block"><div class="flex sticky top-[80px] z-10 opacity-70 group-hover/block:opacity-100 group-hover/block:hidden"><div class="absolute top-0 -right-[28px] flex md:flex-col"></div></div><div class="hidden sticky top-[80px] z-10 opacity-70 group-hover/block:opacity-100 group-hover/block:flex"><div class="absolute top-0 -right-[28px] flex md:flex-col"></div></div><div class="relative group not-prose overflow-auto shadow hover:shadow-md dark:shadow-2xl dark:shadow-neutral-900 my-5 text-sm border border-l-4 border-l-blue-400 border-gray-200 dark:border-l-blue-400 dark:border-gray-800"><pre class="block p-3 hljs" style="background-color:unset"><code class="language-python" style="white-space:pre">%%time
   
execution_args = []
for idx in range(len(patchIDs)):
    execution_args.append({
        load: {&#x27;eopatch_folder&#x27;: &#x27;eopatch_{}&#x27;.format(idx)},
        save: {&#x27;eopatch_folder&#x27;: &#x27;eopatch_{}&#x27;.format(idx)}
    })
    
executor = EOExecutor(workflow, execution_args, save_logs=True)
executor.run(workers=1, multiprocess=True)

executor.make_report()</code></pre><button title="Copy to Clipboard" class="inline-flex items-center opacity-0 group-hover:opacity-100 hover:opacity-100 focus:opacity-100 active:opacity-100 cursor-pointer ml-2 transition-color duration-200 ease-in-out text-blue-400 hover:text-blue-500 absolute right-1 top-1" aria-pressed="false" aria-label="Copy code to clipboard"><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" aria-hidden="true" data-slot="icon" width="24" height="24"><path stroke-linecap="round" stroke-linejoin="round" d="M15.75 17.25v3.375c0 .621-.504 1.125-1.125 1.125h-9.75a1.125 1.125 0 0 1-1.125-1.125V7.875c0-.621.504-1.125 1.125-1.125H6.75a9.06 9.06 0 0 1 1.5.124m7.5 10.376h3.375c.621 0 1.125-.504 1.125-1.125V11.25c0-4.46-3.243-8.161-7.5-8.876a9.06 9.06 0 0 0-1.5-.124H9.375c-.621 0-1.125.504-1.125 1.125v3.5m7.5 10.375H9.375a1.125 1.125 0 0 1-1.125-1.125v-9.25m12 6.625v-1.875a3.375 3.375 0 0 0-3.375-3.375h-1.5a1.125 1.125 0 0 1-1.125-1.125v-1.5a3.375 3.375 0 0 0-3.375-3.375H9.75"></path></svg></button></div><div data-mdast-node-id="12ZB3hsI323NCQ3H8Y8rN" class="max-w-full overflow-y-visible overflow-x-auto m-0 group not-prose relative text-left mb-5"><div><div class="p-2.5">Loading...</div></div></div></div><div id="Hw3OinS0Ie" class="relative group/block"><h2 id="model-construction-and-training" class="relative group"><span class="heading-text">Model construction and training</span><a class="no-underline text-inherit hover:text-inherit inline-block w-0 px-0 translate-x-[10px] font-normal select-none transition-opacity opacity-0 focus:opacity-100 group-hover:opacity-70" href="#model-construction-and-training" title="Link to this Section" aria-label="Link to this Section">¶</a></h2><p>The patches are split into a train and test subset, where we take the patch with ID = 1 for testing, since it seems a good representative of the area.</p><p>The test sample is hand picked because of the small set of patches, otherwise with a larged overall set, the training and testing patches should be randomly chosen.</p><p>The sampled features and labels are loaded and reshaped into <span><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>n</mi><mo>×</mo><mi>m</mi></mrow><annotation encoding="application/x-tex">n \times m</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6667em;vertical-align:-0.0833em;"></span><span class="mord mathnormal">n</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">×</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:0.4306em;"></span><span class="mord mathnormal">m</span></span></span></span></span>, where <span><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>n</mi></mrow><annotation encoding="application/x-tex">n</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.4306em;"></span><span class="mord mathnormal">n</span></span></span></span></span> represents the number of training pixels, and <span><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>m</mi><mo>=</mo><mi>f</mi><mo>×</mo><mi>t</mi></mrow><annotation encoding="application/x-tex">m = f \times t</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.4306em;"></span><span class="mord mathnormal">m</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:0.8889em;vertical-align:-0.1944em;"></span><span class="mord mathnormal" style="margin-right:0.10764em;">f</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">×</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:0.6151em;"></span><span class="mord mathnormal">t</span></span></span></span></span> the number of all features, with <span><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>f</mi></mrow><annotation encoding="application/x-tex">f</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8889em;vertical-align:-0.1944em;"></span><span class="mord mathnormal" style="margin-right:0.10764em;">f</span></span></span></span></span> the size of bands and band combinations (in this example 9) and <span><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>t</mi></mrow><annotation encoding="application/x-tex">t</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6151em;"></span><span class="mord mathnormal">t</span></span></span></span></span> the length of the resampled time-series</p><p><a target="_blank" rel="noreferrer" href="https://github.com/Microsoft/LightGBM" class="">LightGBM</a> is used as a ML model. It is a fast, distributed, high performance gradient boosting framework based on decision tree algorithms, used for many machine learning tasks.</p><p>The default hyper-parameters are used in this example. For more info on parameter tuning, check the <a target="_blank" rel="noreferrer" href="https://lightgbm.readthedocs.io/en/latest/Parameters-Tuning.html" class="">ReadTheDocs</a> of the package.</p></div><div id="osqey4MTtl" class="relative group/block"><div class="flex sticky top-[80px] z-10 opacity-70 group-hover/block:opacity-100 group-hover/block:hidden"><div class="absolute top-0 -right-[28px] flex md:flex-col"></div></div><div class="hidden sticky top-[80px] z-10 opacity-70 group-hover/block:opacity-100 group-hover/block:flex"><div class="absolute top-0 -right-[28px] flex md:flex-col"></div></div><div class="relative group not-prose overflow-auto shadow hover:shadow-md dark:shadow-2xl dark:shadow-neutral-900 my-5 text-sm border border-l-4 border-l-blue-400 border-gray-200 dark:border-l-blue-400 dark:border-gray-800"><pre class="block p-3 hljs" style="background-color:unset"><code class="language-python" style="white-space:pre"># load sampled eopatches
eopatches = []
path_out_sampled = &#x27;./eopatches_sampled_small/&#x27; if use_smaller_patches else &#x27;./eopatches_sampled_large/&#x27;

for i in range(9):
    eopatches.append(EOPatch.load(&#x27;{}/eopatch_{}&#x27;.format(path_out_sampled, i), lazy_loading=True))    

eopatches = np.array(eopatches)</code></pre><button title="Copy to Clipboard" class="inline-flex items-center opacity-0 group-hover:opacity-100 hover:opacity-100 focus:opacity-100 active:opacity-100 cursor-pointer ml-2 transition-color duration-200 ease-in-out text-blue-400 hover:text-blue-500 absolute right-1 top-1" aria-pressed="false" aria-label="Copy code to clipboard"><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" aria-hidden="true" data-slot="icon" width="24" height="24"><path stroke-linecap="round" stroke-linejoin="round" d="M15.75 17.25v3.375c0 .621-.504 1.125-1.125 1.125h-9.75a1.125 1.125 0 0 1-1.125-1.125V7.875c0-.621.504-1.125 1.125-1.125H6.75a9.06 9.06 0 0 1 1.5.124m7.5 10.376h3.375c.621 0 1.125-.504 1.125-1.125V11.25c0-4.46-3.243-8.161-7.5-8.876a9.06 9.06 0 0 0-1.5-.124H9.375c-.621 0-1.125.504-1.125 1.125v3.5m7.5 10.375H9.375a1.125 1.125 0 0 1-1.125-1.125v-9.25m12 6.625v-1.875a3.375 3.375 0 0 0-3.375-3.375h-1.5a1.125 1.125 0 0 1-1.125-1.125v-1.5a3.375 3.375 0 0 0-3.375-3.375H9.75"></path></svg></button></div><div data-mdast-node-id="2OiBq5-zk7RnE7Qz_y96T" class="max-w-full overflow-y-visible overflow-x-auto m-0 group not-prose relative text-left"></div></div><div id="RRk4cA4oyt" class="relative group/block"><div class="flex sticky top-[80px] z-10 opacity-70 group-hover/block:opacity-100 group-hover/block:hidden"><div class="absolute top-0 -right-[28px] flex md:flex-col"></div></div><div class="hidden sticky top-[80px] z-10 opacity-70 group-hover/block:opacity-100 group-hover/block:flex"><div class="absolute top-0 -right-[28px] flex md:flex-col"></div></div><div class="relative group not-prose overflow-auto shadow hover:shadow-md dark:shadow-2xl dark:shadow-neutral-900 my-5 text-sm border border-l-4 border-l-blue-400 border-gray-200 dark:border-l-blue-400 dark:border-gray-800"><pre class="block p-3 hljs" style="background-color:unset"><code class="language-python" style="white-space:pre"># Definition of the train and test patch IDs
train_ID = [0,2,3,4,5,6,7,8] if use_smaller_patches else [0,1,3,4,5,6,7,8]
test_ID = [1] if use_smaller_patches else [2]

# Set the features and the labels for train and test sets
features_train = np.array([eopatch.data[&#x27;FEATURES_SAMPLED&#x27;] for eopatch in eopatches[train_ID]])
labels_train = np.array([eopatch.mask_timeless[&#x27;CROP_TYPE_ERODED_SAMPLED&#x27;] for eopatch in eopatches[train_ID]])
features_test = np.array([eopatch.data[&#x27;FEATURES_SAMPLED&#x27;] for eopatch in eopatches[test_ID]])
labels_test = np.array([eopatch.mask_timeless[&#x27;CROP_TYPE_ERODED_SAMPLED&#x27;] for eopatch in eopatches[test_ID]])

# get shape
p1, t, w, h, f = features_train.shape
p2, t, w, h, f = features_test.shape
p = p1 + p2

# reshape to n x m
features_train = np.moveaxis(features_train, 1, 3).reshape(p1 * w * h, t * f)
labels_train = np.moveaxis(labels_train, 1, 2).reshape(p1 * w * h, 1).squeeze()
features_test = np.moveaxis(features_test, 1, 3).reshape(p2 * w * h, t * f)
labels_test = np.moveaxis(labels_test, 1, 2).reshape(p2 * w * h, 1).squeeze()

# remove points with no reference from training (so we dont train to recognize &quot;no data&quot;)
mask_train = labels_train == 0
features_train = features_train[~mask_train]
labels_train = labels_train[~mask_train]

# remove points with no reference from test (so we dont validate on &quot;no data&quot;, which doesn&#x27;t make sense)
mask_test = labels_test == 0
features_test = features_test[~mask_test]
labels_test = labels_test[~mask_test]</code></pre><button title="Copy to Clipboard" class="inline-flex items-center opacity-0 group-hover:opacity-100 hover:opacity-100 focus:opacity-100 active:opacity-100 cursor-pointer ml-2 transition-color duration-200 ease-in-out text-blue-400 hover:text-blue-500 absolute right-1 top-1" aria-pressed="false" aria-label="Copy code to clipboard"><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" aria-hidden="true" data-slot="icon" width="24" height="24"><path stroke-linecap="round" stroke-linejoin="round" d="M15.75 17.25v3.375c0 .621-.504 1.125-1.125 1.125h-9.75a1.125 1.125 0 0 1-1.125-1.125V7.875c0-.621.504-1.125 1.125-1.125H6.75a9.06 9.06 0 0 1 1.5.124m7.5 10.376h3.375c.621 0 1.125-.504 1.125-1.125V11.25c0-4.46-3.243-8.161-7.5-8.876a9.06 9.06 0 0 0-1.5-.124H9.375c-.621 0-1.125.504-1.125 1.125v3.5m7.5 10.375H9.375a1.125 1.125 0 0 1-1.125-1.125v-9.25m12 6.625v-1.875a3.375 3.375 0 0 0-3.375-3.375h-1.5a1.125 1.125 0 0 1-1.125-1.125v-1.5a3.375 3.375 0 0 0-3.375-3.375H9.75"></path></svg></button></div><div data-mdast-node-id="ZbRYl1gNHVDJLNI3fIXOP" class="max-w-full overflow-y-visible overflow-x-auto m-0 group not-prose relative text-left"></div></div><div id="LnvVDsIpK4" class="relative group/block"><div class="flex sticky top-[80px] z-10 opacity-70 group-hover/block:opacity-100 group-hover/block:hidden"><div class="absolute top-0 -right-[28px] flex md:flex-col"></div></div><div class="hidden sticky top-[80px] z-10 opacity-70 group-hover/block:opacity-100 group-hover/block:flex"><div class="absolute top-0 -right-[28px] flex md:flex-col"></div></div><div class="relative group not-prose overflow-auto shadow hover:shadow-md dark:shadow-2xl dark:shadow-neutral-900 my-5 text-sm border border-l-4 border-l-blue-400 border-gray-200 dark:border-l-blue-400 dark:border-gray-800"><pre class="block p-3 hljs" style="background-color:unset"><code class="language-python" style="white-space:pre"># Set up training classes
labels_unique = np.unique(labels_train)</code></pre><button title="Copy to Clipboard" class="inline-flex items-center opacity-0 group-hover:opacity-100 hover:opacity-100 focus:opacity-100 active:opacity-100 cursor-pointer ml-2 transition-color duration-200 ease-in-out text-blue-400 hover:text-blue-500 absolute right-1 top-1" aria-pressed="false" aria-label="Copy code to clipboard"><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" aria-hidden="true" data-slot="icon" width="24" height="24"><path stroke-linecap="round" stroke-linejoin="round" d="M15.75 17.25v3.375c0 .621-.504 1.125-1.125 1.125h-9.75a1.125 1.125 0 0 1-1.125-1.125V7.875c0-.621.504-1.125 1.125-1.125H6.75a9.06 9.06 0 0 1 1.5.124m7.5 10.376h3.375c.621 0 1.125-.504 1.125-1.125V11.25c0-4.46-3.243-8.161-7.5-8.876a9.06 9.06 0 0 0-1.5-.124H9.375c-.621 0-1.125.504-1.125 1.125v3.5m7.5 10.375H9.375a1.125 1.125 0 0 1-1.125-1.125v-9.25m12 6.625v-1.875a3.375 3.375 0 0 0-3.375-3.375h-1.5a1.125 1.125 0 0 1-1.125-1.125v-1.5a3.375 3.375 0 0 0-3.375-3.375H9.75"></path></svg></button></div><div data-mdast-node-id="JNcKdV1YqYGzEaJ79kzHK" class="max-w-full overflow-y-visible overflow-x-auto m-0 group not-prose relative text-left"></div></div><div id="JLcWsfkCUU" class="relative group/block"><div class="flex sticky top-[80px] z-10 opacity-70 group-hover/block:opacity-100 group-hover/block:hidden"><div class="absolute top-0 -right-[28px] flex md:flex-col"></div></div><div class="hidden sticky top-[80px] z-10 opacity-70 group-hover/block:opacity-100 group-hover/block:flex"><div class="absolute top-0 -right-[28px] flex md:flex-col"></div></div><div class="relative group not-prose overflow-auto shadow hover:shadow-md dark:shadow-2xl dark:shadow-neutral-900 my-5 text-sm border border-l-4 border-l-blue-400 border-gray-200 dark:border-l-blue-400 dark:border-gray-800"><pre class="block p-3 hljs" style="background-color:unset"><code class="language-python" style="white-space:pre">%%time

# Set up training classes
labels_unique = np.unique(labels_train)

# Set up the model
model = lgb.LGBMClassifier(
    objective=&#x27;multiclass&#x27;, 
    num_class=len(labels_unique), 
    metric=&#x27;multi_logloss&#x27;
)

# train the model
model.fit(features_train, labels_train)

# uncomment to save the model
model_base_name = &#x27;model_AT_CT_smaller&#x27; if use_smaller_patches else &#x27;model_AT_CT_larger&#x27;
joblib.dump(model, &#x27;./{}.pkl&#x27;.format(model_base_name))</code></pre><button title="Copy to Clipboard" class="inline-flex items-center opacity-0 group-hover:opacity-100 hover:opacity-100 focus:opacity-100 active:opacity-100 cursor-pointer ml-2 transition-color duration-200 ease-in-out text-blue-400 hover:text-blue-500 absolute right-1 top-1" aria-pressed="false" aria-label="Copy code to clipboard"><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" aria-hidden="true" data-slot="icon" width="24" height="24"><path stroke-linecap="round" stroke-linejoin="round" d="M15.75 17.25v3.375c0 .621-.504 1.125-1.125 1.125h-9.75a1.125 1.125 0 0 1-1.125-1.125V7.875c0-.621.504-1.125 1.125-1.125H6.75a9.06 9.06 0 0 1 1.5.124m7.5 10.376h3.375c.621 0 1.125-.504 1.125-1.125V11.25c0-4.46-3.243-8.161-7.5-8.876a9.06 9.06 0 0 0-1.5-.124H9.375c-.621 0-1.125.504-1.125 1.125v3.5m7.5 10.375H9.375a1.125 1.125 0 0 1-1.125-1.125v-9.25m12 6.625v-1.875a3.375 3.375 0 0 0-3.375-3.375h-1.5a1.125 1.125 0 0 1-1.125-1.125v-1.5a3.375 3.375 0 0 0-3.375-3.375H9.75"></path></svg></button></div><div data-mdast-node-id="MPHX5xXU2_UQuNrWqzY4J" class="max-w-full overflow-y-visible overflow-x-auto m-0 group not-prose relative text-left mb-5"><div><pre class="text-sm font-thin font-system"><code><span>CPU times: user 2min 44s, sys: 0 ns, total: 2min 44s
Wall time: 1min 6s
</span></code></pre></div><div class="font-mono text-sm whitespace-pre-wrap"><code><span>[&#x27;./model_AT_CT_smaller.pkl&#x27;]</span></code></div></div></div><div id="vqoDRBpm3j" class="relative group/block"><h2 id="validation" class="relative group"><span class="heading-text">Validation</span><a class="no-underline text-inherit hover:text-inherit inline-block w-0 px-0 translate-x-[10px] font-normal select-none transition-opacity opacity-0 focus:opacity-100 group-hover:opacity-70" href="#validation" title="Link to this Section" aria-label="Link to this Section">¶</a></h2></div><div id="uCQtzcGWKO" class="relative group/block"><p>Validation of the model is a crucial step in data science. All models are wrong, but some are less wrong than others, so model evaluation is important.</p><p>In order to validate the model, we use the training set to predict the classes, and then compare the predicted set of labels to the “ground truth”.</p><p>Unfortunately, ground truth in the scope of EO is a term that should be taken lightly. Usually, it is not 100 % reliable due to several reasons:</p><ul><li>Labels are determined at specific time, but crop types change.</li><li>Some classes can have an overlap or similar definitions (<em>part of a continuum, and not discrete distributions</em>)</li><li>Human error (_mistakes made within the decleration)</li></ul><p>The validation is performed by evaluating various metrics, such as accuracy, precision, recall, <span><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>F</mi><mn>1</mn></msub></mrow><annotation encoding="application/x-tex">F_1</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8333em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.13889em;">F</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:-0.1389em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span></span> score, some of which are nicely described <a target="_blank" rel="noreferrer" href="https://medium.com/greyatom/performance-metrics-for-classification-problems-in-machine-learning-part-i-b085d432082b" class="">in this blog post</a></p></div><div id="mfqQY6ubrM" class="relative group/block"><div class="flex sticky top-[80px] z-10 opacity-70 group-hover/block:opacity-100 group-hover/block:hidden"><div class="absolute top-0 -right-[28px] flex md:flex-col"></div></div><div class="hidden sticky top-[80px] z-10 opacity-70 group-hover/block:opacity-100 group-hover/block:flex"><div class="absolute top-0 -right-[28px] flex md:flex-col"></div></div><div class="relative group not-prose overflow-auto shadow hover:shadow-md dark:shadow-2xl dark:shadow-neutral-900 my-5 text-sm border border-l-4 border-l-blue-400 border-gray-200 dark:border-l-blue-400 dark:border-gray-800"><pre class="block p-3 hljs" style="background-color:unset"><code class="language-python" style="white-space:pre"># uncomment to load the model and replace with your file, usually just correct the date
model_path = &#x27;./model_AT_CT_smaller.pkl&#x27; if use_smaller_patches else &#x27;./model_AT_CT_larger.pkl&#x27;
model = joblib.load(model_path)</code></pre><button title="Copy to Clipboard" class="inline-flex items-center opacity-0 group-hover:opacity-100 hover:opacity-100 focus:opacity-100 active:opacity-100 cursor-pointer ml-2 transition-color duration-200 ease-in-out text-blue-400 hover:text-blue-500 absolute right-1 top-1" aria-pressed="false" aria-label="Copy code to clipboard"><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" aria-hidden="true" data-slot="icon" width="24" height="24"><path stroke-linecap="round" stroke-linejoin="round" d="M15.75 17.25v3.375c0 .621-.504 1.125-1.125 1.125h-9.75a1.125 1.125 0 0 1-1.125-1.125V7.875c0-.621.504-1.125 1.125-1.125H6.75a9.06 9.06 0 0 1 1.5.124m7.5 10.376h3.375c.621 0 1.125-.504 1.125-1.125V11.25c0-4.46-3.243-8.161-7.5-8.876a9.06 9.06 0 0 0-1.5-.124H9.375c-.621 0-1.125.504-1.125 1.125v3.5m7.5 10.375H9.375a1.125 1.125 0 0 1-1.125-1.125v-9.25m12 6.625v-1.875a3.375 3.375 0 0 0-3.375-3.375h-1.5a1.125 1.125 0 0 1-1.125-1.125v-1.5a3.375 3.375 0 0 0-3.375-3.375H9.75"></path></svg></button></div><div data-mdast-node-id="d2TWbP0GgfDsQigBGncGf" class="max-w-full overflow-y-visible overflow-x-auto m-0 group not-prose relative text-left"></div></div><div id="FvTx4vAPdr" class="relative group/block"><div class="flex sticky top-[80px] z-10 opacity-70 group-hover/block:opacity-100 group-hover/block:hidden"><div class="absolute top-0 -right-[28px] flex md:flex-col"></div></div><div class="hidden sticky top-[80px] z-10 opacity-70 group-hover/block:opacity-100 group-hover/block:flex"><div class="absolute top-0 -right-[28px] flex md:flex-col"></div></div><div class="relative group not-prose overflow-auto shadow hover:shadow-md dark:shadow-2xl dark:shadow-neutral-900 my-5 text-sm border border-l-4 border-l-blue-400 border-gray-200 dark:border-l-blue-400 dark:border-gray-800"><pre class="block p-3 hljs" style="background-color:unset"><code class="language-python" style="white-space:pre"># predict the test labels
plabels_test = model.predict(features_test)</code></pre><button title="Copy to Clipboard" class="inline-flex items-center opacity-0 group-hover:opacity-100 hover:opacity-100 focus:opacity-100 active:opacity-100 cursor-pointer ml-2 transition-color duration-200 ease-in-out text-blue-400 hover:text-blue-500 absolute right-1 top-1" aria-pressed="false" aria-label="Copy code to clipboard"><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" aria-hidden="true" data-slot="icon" width="24" height="24"><path stroke-linecap="round" stroke-linejoin="round" d="M15.75 17.25v3.375c0 .621-.504 1.125-1.125 1.125h-9.75a1.125 1.125 0 0 1-1.125-1.125V7.875c0-.621.504-1.125 1.125-1.125H6.75a9.06 9.06 0 0 1 1.5.124m7.5 10.376h3.375c.621 0 1.125-.504 1.125-1.125V11.25c0-4.46-3.243-8.161-7.5-8.876a9.06 9.06 0 0 0-1.5-.124H9.375c-.621 0-1.125.504-1.125 1.125v3.5m7.5 10.375H9.375a1.125 1.125 0 0 1-1.125-1.125v-9.25m12 6.625v-1.875a3.375 3.375 0 0 0-3.375-3.375h-1.5a1.125 1.125 0 0 1-1.125-1.125v-1.5a3.375 3.375 0 0 0-3.375-3.375H9.75"></path></svg></button></div><div data-mdast-node-id="V82_W62CYWM8piYp2qaGP" class="max-w-full overflow-y-visible overflow-x-auto m-0 group not-prose relative text-left"></div></div><div id="dzLFrapg13" class="relative group/block"><p>Get the overall accuracy (OA) and the weighted <span><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>F</mi><mn>1</mn></msub></mrow><annotation encoding="application/x-tex">F_1</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8333em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.13889em;">F</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:-0.1389em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span></span> score</p></div><div id="eQTtPDEHdZ" class="relative group/block"><div class="flex sticky top-[80px] z-10 opacity-70 group-hover/block:opacity-100 group-hover/block:hidden"><div class="absolute top-0 -right-[28px] flex md:flex-col"></div></div><div class="hidden sticky top-[80px] z-10 opacity-70 group-hover/block:opacity-100 group-hover/block:flex"><div class="absolute top-0 -right-[28px] flex md:flex-col"></div></div><div class="relative group not-prose overflow-auto shadow hover:shadow-md dark:shadow-2xl dark:shadow-neutral-900 my-5 text-sm border border-l-4 border-l-blue-400 border-gray-200 dark:border-l-blue-400 dark:border-gray-800"><pre class="block p-3 hljs" style="background-color:unset"><code class="language-python" style="white-space:pre">print(&#x27;Classification accuracy {:.1f}%&#x27;.format(100 * metrics.accuracy_score(labels_test, plabels_test)))
print(&#x27;Classification F1-score {:.1f}%&#x27;.format(100 * metrics.f1_score(labels_test, plabels_test, average=&#x27;weighted&#x27;)))</code></pre><button title="Copy to Clipboard" class="inline-flex items-center opacity-0 group-hover:opacity-100 hover:opacity-100 focus:opacity-100 active:opacity-100 cursor-pointer ml-2 transition-color duration-200 ease-in-out text-blue-400 hover:text-blue-500 absolute right-1 top-1" aria-pressed="false" aria-label="Copy code to clipboard"><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" aria-hidden="true" data-slot="icon" width="24" height="24"><path stroke-linecap="round" stroke-linejoin="round" d="M15.75 17.25v3.375c0 .621-.504 1.125-1.125 1.125h-9.75a1.125 1.125 0 0 1-1.125-1.125V7.875c0-.621.504-1.125 1.125-1.125H6.75a9.06 9.06 0 0 1 1.5.124m7.5 10.376h3.375c.621 0 1.125-.504 1.125-1.125V11.25c0-4.46-3.243-8.161-7.5-8.876a9.06 9.06 0 0 0-1.5-.124H9.375c-.621 0-1.125.504-1.125 1.125v3.5m7.5 10.375H9.375a1.125 1.125 0 0 1-1.125-1.125v-9.25m12 6.625v-1.875a3.375 3.375 0 0 0-3.375-3.375h-1.5a1.125 1.125 0 0 1-1.125-1.125v-1.5a3.375 3.375 0 0 0-3.375-3.375H9.75"></path></svg></button></div><div data-mdast-node-id="tCBeLdZnyXlBJ1hFIdPOp" class="max-w-full overflow-y-visible overflow-x-auto m-0 group not-prose relative text-left mb-5"><div><pre class="text-sm font-thin font-system"><code><span>Classification accuracy 87.8%
Classification F1-score 89.0%
</span></code></pre></div></div></div><div id="DlLEVDBw05" class="relative group/block"><p><span><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>F</mi><mn>1</mn></msub></mrow><annotation encoding="application/x-tex">F_1</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8333em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.13889em;">F</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:-0.1389em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span></span> score, precision, and recall for each class separately</p></div><div id="GLUKH5PJW4" class="relative group/block"><div class="flex sticky top-[80px] z-10 opacity-70 group-hover/block:opacity-100 group-hover/block:hidden"><div class="absolute top-0 -right-[28px] flex md:flex-col"></div></div><div class="hidden sticky top-[80px] z-10 opacity-70 group-hover/block:opacity-100 group-hover/block:flex"><div class="absolute top-0 -right-[28px] flex md:flex-col"></div></div><div class="relative group not-prose overflow-auto shadow hover:shadow-md dark:shadow-2xl dark:shadow-neutral-900 my-5 text-sm border border-l-4 border-l-blue-400 border-gray-200 dark:border-l-blue-400 dark:border-gray-800"><pre class="block p-3 hljs" style="background-color:unset"><code class="language-python" style="white-space:pre">class_labels_test = set(np.unique(labels_test))
class_labels_train = set(np.unique(labels_train))
class_labels = list(class_labels_test.union(class_labels_train))
class_names = [entry.class_name for entry in CTGROUPS]

f1_scores = metrics.f1_score(labels_test, plabels_test, labels=class_labels, average=None)
recall = metrics.recall_score(labels_test, plabels_test, labels=class_labels, average=None)
precision = metrics.precision_score(labels_test, plabels_test, labels=class_labels, average=None) 

print(&#x27;             Class              =  F1  | Recall | Precision&#x27;)
print(&#x27;         --------------------------------------------------&#x27;)
for idx, ct in enumerate([class_names[idx] for idx in class_labels]):
    print(&#x27;         * {0:30s} = {1:2.1f} |  {2:2.1f}  | {3:2.1f}&#x27;.format(ct, 
                                                                         f1_scores[idx] * 100, 
                                                                         recall[idx] * 100, 
                                                                         precision[idx] * 100))</code></pre><button title="Copy to Clipboard" class="inline-flex items-center opacity-0 group-hover:opacity-100 hover:opacity-100 focus:opacity-100 active:opacity-100 cursor-pointer ml-2 transition-color duration-200 ease-in-out text-blue-400 hover:text-blue-500 absolute right-1 top-1" aria-pressed="false" aria-label="Copy code to clipboard"><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" aria-hidden="true" data-slot="icon" width="24" height="24"><path stroke-linecap="round" stroke-linejoin="round" d="M15.75 17.25v3.375c0 .621-.504 1.125-1.125 1.125h-9.75a1.125 1.125 0 0 1-1.125-1.125V7.875c0-.621.504-1.125 1.125-1.125H6.75a9.06 9.06 0 0 1 1.5.124m7.5 10.376h3.375c.621 0 1.125-.504 1.125-1.125V11.25c0-4.46-3.243-8.161-7.5-8.876a9.06 9.06 0 0 0-1.5-.124H9.375c-.621 0-1.125.504-1.125 1.125v3.5m7.5 10.375H9.375a1.125 1.125 0 0 1-1.125-1.125v-9.25m12 6.625v-1.875a3.375 3.375 0 0 0-3.375-3.375h-1.5a1.125 1.125 0 0 1-1.125-1.125v-1.5a3.375 3.375 0 0 0-3.375-3.375H9.75"></path></svg></button></div><div data-mdast-node-id="rg6O2qoaHmSuKDLJszEhj" class="max-w-full overflow-y-visible overflow-x-auto m-0 group not-prose relative text-left mb-5"><div><pre class="text-sm font-thin font-system"><code><span>             Class              =  F1  | Recall | Precision
         --------------------------------------------------
         * SOMMERGETREIDE                 = 68.1 |  56.1  | 86.6
         * WINTERGETREIDE                 = 95.2 |  93.8  | 96.6
         * MENGGETREIDE_AEHNLICHES        = 11.8 |  18.7  | 8.7
         * MAIS_AEHNLICHES                = 93.2 |  96.7  | 90.0
         * SOMMERRAPS_AEHNLICHES          = 0.0 |  0.0  | 0.0
         * WINTERRAPS_AEHNLICHES          = 90.1 |  92.6  | 87.7
         * SONNENBLUME                    = 0.0 |  0.0  | 0.0
         * LEGUMINOSEN_AEHNLICHES         = 21.1 |  51.2  | 13.3
         * WINTERLEGUMINOSE               = 0.0 |  0.0  | 0.0
</span></code></pre></div></div></div><div id="hUTsVKl2L8" class="relative group/block"><h2 id="plot-the-standard-and-transposed-confusion-matrix" class="relative group"><span class="heading-text">Plot the standard and transposed Confusion Matrix</span><a class="no-underline text-inherit hover:text-inherit inline-block w-0 px-0 translate-x-[10px] font-normal select-none transition-opacity opacity-0 focus:opacity-100 group-hover:opacity-70" href="#plot-the-standard-and-transposed-confusion-matrix" title="Link to this Section" aria-label="Link to this Section">¶</a></h2></div><div id="fCzMPdPyek" class="relative group/block"><div class="flex sticky top-[80px] z-10 opacity-70 group-hover/block:opacity-100 group-hover/block:hidden"><div class="absolute top-0 -right-[28px] flex md:flex-col"></div></div><div class="hidden sticky top-[80px] z-10 opacity-70 group-hover/block:opacity-100 group-hover/block:flex"><div class="absolute top-0 -right-[28px] flex md:flex-col"></div></div><div class="relative group not-prose overflow-auto shadow hover:shadow-md dark:shadow-2xl dark:shadow-neutral-900 my-5 text-sm border border-l-4 border-l-blue-400 border-gray-200 dark:border-l-blue-400 dark:border-gray-800"><pre class="block p-3 hljs" style="background-color:unset"><code class="language-python" style="white-space:pre"># Define the plotting function
def plot_confusion_matrix(cm, classes,
                          normalize=False,
                          title=&#x27;Confusion matrix&#x27;,
                          cmap=plt.cm.Blues, ylabel=&#x27;True label&#x27;, xlabel=&#x27;Predicted label&#x27;, filename=None):
    &quot;&quot;&quot;
    This function prints and plots the confusion matrix.
    Normalization can be applied by setting `normalize=True`.
    &quot;&quot;&quot;
    np.set_printoptions(precision=2, suppress=True)
    
    if normalize:
        cm = cm.astype(&#x27;float&#x27;) / (cm.sum(axis=1)[:, np.newaxis] + np.finfo(np.float).eps)

        plt.imshow(cm, interpolation=&#x27;nearest&#x27;, cmap=cmap, vmin=0, vmax=1)
    plt.title(title, fontsize=20)
    # plt.colorbar()
    tick_marks = np.arange(len(classes)+1)-0.5
    plt.xticks(tick_marks, classes, rotation=90, fontsize=15)
    plt.yticks(tick_marks, classes, fontsize=15)
    
    
    fmt = &#x27;.2f&#x27; if normalize else &#x27;d&#x27;
    thresh = cm.max() / 2.
    for i, j in itertools.product(range(cm.shape[0]), range(cm.shape[1])):
        plt.text(j, i, format(cm[i, j], fmt),
                 horizontalalignment=&quot;center&quot;,
                 color=&quot;white&quot; if cm[i, j] &gt; thresh else &quot;black&quot;,
                 fontsize=12)

    plt.tight_layout()
    plt.ylabel(ylabel, fontsize=15)
    plt.xlabel(xlabel, fontsize=15)</code></pre><button title="Copy to Clipboard" class="inline-flex items-center opacity-0 group-hover:opacity-100 hover:opacity-100 focus:opacity-100 active:opacity-100 cursor-pointer ml-2 transition-color duration-200 ease-in-out text-blue-400 hover:text-blue-500 absolute right-1 top-1" aria-pressed="false" aria-label="Copy code to clipboard"><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" aria-hidden="true" data-slot="icon" width="24" height="24"><path stroke-linecap="round" stroke-linejoin="round" d="M15.75 17.25v3.375c0 .621-.504 1.125-1.125 1.125h-9.75a1.125 1.125 0 0 1-1.125-1.125V7.875c0-.621.504-1.125 1.125-1.125H6.75a9.06 9.06 0 0 1 1.5.124m7.5 10.376h3.375c.621 0 1.125-.504 1.125-1.125V11.25c0-4.46-3.243-8.161-7.5-8.876a9.06 9.06 0 0 0-1.5-.124H9.375c-.621 0-1.125.504-1.125 1.125v3.5m7.5 10.375H9.375a1.125 1.125 0 0 1-1.125-1.125v-9.25m12 6.625v-1.875a3.375 3.375 0 0 0-3.375-3.375h-1.5a1.125 1.125 0 0 1-1.125-1.125v-1.5a3.375 3.375 0 0 0-3.375-3.375H9.75"></path></svg></button></div><div data-mdast-node-id="lPZDkeFuDmJ-x1uwIpYN7" class="max-w-full overflow-y-visible overflow-x-auto m-0 group not-prose relative text-left"></div></div><div id="c0AM50LeJN" class="relative group/block"><div class="flex sticky top-[80px] z-10 opacity-70 group-hover/block:opacity-100 group-hover/block:hidden"><div class="absolute top-0 -right-[28px] flex md:flex-col"></div></div><div class="hidden sticky top-[80px] z-10 opacity-70 group-hover/block:opacity-100 group-hover/block:flex"><div class="absolute top-0 -right-[28px] flex md:flex-col"></div></div><div class="relative group not-prose overflow-auto shadow hover:shadow-md dark:shadow-2xl dark:shadow-neutral-900 my-5 text-sm border border-l-4 border-l-blue-400 border-gray-200 dark:border-l-blue-400 dark:border-gray-800"><pre class="block p-3 hljs" style="background-color:unset"><code class="language-python" style="white-space:pre">fig = plt.figure(figsize=(20, 20))

plt.subplot(1, 2, 1)
conf_matrix_gbm = metrics.confusion_matrix(labels_test, plabels_test)
plot_confusion_matrix(conf_matrix_gbm, 
                      classes=[name for idx, name in enumerate(class_names) if idx in class_labels], 
                      normalize=True, 
                      ylabel=&#x27;Truth (crop type group)&#x27;, 
                      xlabel=&#x27;Predicted (GBM)&#x27;,
                      title=&#x27;Confusion matrix&#x27;);

plt.subplot(1, 2, 2)
conf_matrix_gbm = metrics.confusion_matrix(plabels_test, labels_test)
plot_confusion_matrix(conf_matrix_gbm, 
                      classes=[name for idx, name in enumerate(class_names) if idx in class_labels], 
                      normalize=True, 
                      xlabel=&#x27;Truth (crop type group)&#x27;, 
                      ylabel=&#x27;Predicted (GBM)&#x27;,
                      title=&#x27;Transposed Confusion matrix&#x27;);

plt.tight_layout()</code></pre><button title="Copy to Clipboard" class="inline-flex items-center opacity-0 group-hover:opacity-100 hover:opacity-100 focus:opacity-100 active:opacity-100 cursor-pointer ml-2 transition-color duration-200 ease-in-out text-blue-400 hover:text-blue-500 absolute right-1 top-1" aria-pressed="false" aria-label="Copy code to clipboard"><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" aria-hidden="true" data-slot="icon" width="24" height="24"><path stroke-linecap="round" stroke-linejoin="round" d="M15.75 17.25v3.375c0 .621-.504 1.125-1.125 1.125h-9.75a1.125 1.125 0 0 1-1.125-1.125V7.875c0-.621.504-1.125 1.125-1.125H6.75a9.06 9.06 0 0 1 1.5.124m7.5 10.376h3.375c.621 0 1.125-.504 1.125-1.125V11.25c0-4.46-3.243-8.161-7.5-8.876a9.06 9.06 0 0 0-1.5-.124H9.375c-.621 0-1.125.504-1.125 1.125v3.5m7.5 10.375H9.375a1.125 1.125 0 0 1-1.125-1.125v-9.25m12 6.625v-1.875a3.375 3.375 0 0 0-3.375-3.375h-1.5a1.125 1.125 0 0 1-1.125-1.125v-1.5a3.375 3.375 0 0 0-3.375-3.375H9.75"></path></svg></button></div><div data-mdast-node-id="cZQcYdbrnhFMRztHgZqpT" class="max-w-full overflow-y-visible overflow-x-auto m-0 group not-prose relative text-left mb-5"><img src="/notebooks_test/build/b2bad3a800543658005df7424666819a.png" alt="&lt;Figure size 1440x1440 with 2 Axes&gt;"/></div></div><div id="mRJMonMA5d" class="relative group/block"><div class="flex sticky top-[80px] z-10 opacity-70 group-hover/block:opacity-100 group-hover/block:hidden"><div class="absolute top-0 -right-[28px] flex md:flex-col"></div></div><div class="hidden sticky top-[80px] z-10 opacity-70 group-hover/block:opacity-100 group-hover/block:flex"><div class="absolute top-0 -right-[28px] flex md:flex-col"></div></div><div class="relative group not-prose overflow-auto shadow hover:shadow-md dark:shadow-2xl dark:shadow-neutral-900 my-5 text-sm border border-l-4 border-l-blue-400 border-gray-200 dark:border-l-blue-400 dark:border-gray-800"><pre class="block p-3 hljs" style="background-color:unset"><code class="language-python" style="white-space:pre">fig = plt.figure(figsize=(20, 5))
label_ids, label_counts = np.unique(labels_train, return_counts=True)

plt.bar(range(len(label_ids)), label_counts/100)
plt.xticks(range(len(label_ids)), [class_names[i] for i in label_ids], rotation=90, fontsize=20);
plt.yticks(fontsize=20);
plt.ylabel(&quot;Area [ha] &quot;, size=18)</code></pre><button title="Copy to Clipboard" class="inline-flex items-center opacity-0 group-hover:opacity-100 hover:opacity-100 focus:opacity-100 active:opacity-100 cursor-pointer ml-2 transition-color duration-200 ease-in-out text-blue-400 hover:text-blue-500 absolute right-1 top-1" aria-pressed="false" aria-label="Copy code to clipboard"><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" aria-hidden="true" data-slot="icon" width="24" height="24"><path stroke-linecap="round" stroke-linejoin="round" d="M15.75 17.25v3.375c0 .621-.504 1.125-1.125 1.125h-9.75a1.125 1.125 0 0 1-1.125-1.125V7.875c0-.621.504-1.125 1.125-1.125H6.75a9.06 9.06 0 0 1 1.5.124m7.5 10.376h3.375c.621 0 1.125-.504 1.125-1.125V11.25c0-4.46-3.243-8.161-7.5-8.876a9.06 9.06 0 0 0-1.5-.124H9.375c-.621 0-1.125.504-1.125 1.125v3.5m7.5 10.375H9.375a1.125 1.125 0 0 1-1.125-1.125v-9.25m12 6.625v-1.875a3.375 3.375 0 0 0-3.375-3.375h-1.5a1.125 1.125 0 0 1-1.125-1.125v-1.5a3.375 3.375 0 0 0-3.375-3.375H9.75"></path></svg></button></div><div data-mdast-node-id="-nyuUGXPGB_3Ief5utRtX" class="max-w-full overflow-y-visible overflow-x-auto m-0 group not-prose relative text-left mb-5"><img src="/notebooks_test/build/c44eb822c2efa650f78f247809eec57d.png" alt="&lt;Figure size 1440x360 with 1 Axes&gt;"/></div></div><div id="yFpO02tkYO" class="relative group/block"><h2 id="predict-crop-type" class="relative group"><span class="heading-text">Predict Crop Type</span><a class="no-underline text-inherit hover:text-inherit inline-block w-0 px-0 translate-x-[10px] font-normal select-none transition-opacity opacity-0 focus:opacity-100 group-hover:opacity-70" href="#predict-crop-type" title="Link to this Section" aria-label="Link to this Section">¶</a></h2></div><div id="afQcCT8EmR" class="relative group/block"><div class="flex sticky top-[80px] z-10 opacity-70 group-hover/block:opacity-100 group-hover/block:hidden"><div class="absolute top-0 -right-[28px] flex md:flex-col"></div></div><div class="hidden sticky top-[80px] z-10 opacity-70 group-hover/block:opacity-100 group-hover/block:flex"><div class="absolute top-0 -right-[28px] flex md:flex-col"></div></div><div class="relative group not-prose overflow-auto shadow hover:shadow-md dark:shadow-2xl dark:shadow-neutral-900 my-5 text-sm border border-l-4 border-l-blue-400 border-gray-200 dark:border-l-blue-400 dark:border-gray-800"><pre class="block p-3 hljs" style="background-color:unset"><code class="language-python" style="white-space:pre"># Define Tasks

class PredictPatch(EOTask):
    &quot;&quot;&quot;
    Task to make model predictions on a patch. Provide the model and the feature, 
    and the output names of labels and scores (optional)
    &quot;&quot;&quot;
    def __init__(self, model, features_feature, predicted_labels_name, predicted_scores_name=None):
        self.model = model
        self.features_feature = features_feature
        self.predicted_labels_name = predicted_labels_name
        self.predicted_scores_name = predicted_scores_name
        
    def execute(self, eopatch):
        ftrs = eopatch[self.features_feature[0]][self.features_feature[1]]
        
        t, w, h, f = ftrs.shape
        ftrs = np.moveaxis(ftrs, 0, 2).reshape(w * h, t * f)
        
        plabels = self.model.predict(ftrs)
        plabels = plabels.reshape(w, h)
        plabels = plabels[..., np.newaxis]

        eopatch.add_feature(FeatureType.MASK_TIMELESS, self.predicted_labels_name, plabels)
        
        if self.predicted_scores_name:
            pscores = self.model.predict_proba(ftrs)
            _, d = pscores.shape
            pscores = pscores.reshape(w, h, d)
            eopatch.add_feature(FeatureType.DATA_TIMELESS, self.predicted_scores_name, pscores)
        
        return eopatch

class MaskNoDataInPrediction(EOTask):
    &quot;&quot;&quot;
    Mask No Data in prediction
    &quot;&quot;&quot;
    
    def __init__(self, src_layer, no_data_value, predicted_labels_name):
        self.src_layer = src_layer
        self.no_data_value = no_data_value
        self.predicted_labels_name = predicted_labels_name
    
    def execute(self, eopatch):
        NO_DATA = eopatch.mask_timeless[self.src_layer] == self.no_data_value
        eopatch.mask_timeless[self.predicted_labels_name][NO_DATA] = self.no_data_value
        
        return eopatch</code></pre><button title="Copy to Clipboard" class="inline-flex items-center opacity-0 group-hover:opacity-100 hover:opacity-100 focus:opacity-100 active:opacity-100 cursor-pointer ml-2 transition-color duration-200 ease-in-out text-blue-400 hover:text-blue-500 absolute right-1 top-1" aria-pressed="false" aria-label="Copy code to clipboard"><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" aria-hidden="true" data-slot="icon" width="24" height="24"><path stroke-linecap="round" stroke-linejoin="round" d="M15.75 17.25v3.375c0 .621-.504 1.125-1.125 1.125h-9.75a1.125 1.125 0 0 1-1.125-1.125V7.875c0-.621.504-1.125 1.125-1.125H6.75a9.06 9.06 0 0 1 1.5.124m7.5 10.376h3.375c.621 0 1.125-.504 1.125-1.125V11.25c0-4.46-3.243-8.161-7.5-8.876a9.06 9.06 0 0 0-1.5-.124H9.375c-.621 0-1.125.504-1.125 1.125v3.5m7.5 10.375H9.375a1.125 1.125 0 0 1-1.125-1.125v-9.25m12 6.625v-1.875a3.375 3.375 0 0 0-3.375-3.375h-1.5a1.125 1.125 0 0 1-1.125-1.125v-1.5a3.375 3.375 0 0 0-3.375-3.375H9.75"></path></svg></button></div><div data-mdast-node-id="RhBrSt09tsczWccSAZxXC" class="max-w-full overflow-y-visible overflow-x-auto m-0 group not-prose relative text-left"></div></div><div id="IvvCXqE7tB" class="relative group/block"><div class="flex sticky top-[80px] z-10 opacity-70 group-hover/block:opacity-100 group-hover/block:hidden"><div class="absolute top-0 -right-[28px] flex md:flex-col"></div></div><div class="hidden sticky top-[80px] z-10 opacity-70 group-hover/block:opacity-100 group-hover/block:flex"><div class="absolute top-0 -right-[28px] flex md:flex-col"></div></div><div class="relative group not-prose overflow-auto shadow hover:shadow-md dark:shadow-2xl dark:shadow-neutral-900 my-5 text-sm border border-l-4 border-l-blue-400 border-gray-200 dark:border-l-blue-400 dark:border-gray-800"><pre class="block p-3 hljs" style="background-color:unset"><code class="language-python" style="white-space:pre"># TASK TO LOAD EXISTING EOPATCHES
load = LoadTask(path_out_sampled)

# TASK FOR PREDICTION
predict = PredictPatch(model, (FeatureType.DATA, &#x27;FEATURES&#x27;), &#x27;LBL_GBM&#x27;, &#x27;SCR_GBM&#x27;)

# Mask No Data in Prediction
mask_no_data = MaskNoDataInPrediction(&quot;CROP_TYPE&quot;, 0, &quot;LBL_GBM&quot;)

# TASK FOR SAVING
save = SaveTask(str(path_out_sampled), overwrite_permission=OverwritePermission.OVERWRITE_PATCH)

# TASK TO EXPORT TIFF
export_tiff = ExportToTiff((FeatureType.MASK_TIMELESS, &#x27;LBL_GBM&#x27;))
tiff_location = &#x27;./predicted_tiff&#x27;
if not os.path.isdir(tiff_location):
    os.makedirs(tiff_location)

workflow = LinearWorkflow(
    load,
    predict,
    mask_no_data,
    export_tiff,
    save
)</code></pre><button title="Copy to Clipboard" class="inline-flex items-center opacity-0 group-hover:opacity-100 hover:opacity-100 focus:opacity-100 active:opacity-100 cursor-pointer ml-2 transition-color duration-200 ease-in-out text-blue-400 hover:text-blue-500 absolute right-1 top-1" aria-pressed="false" aria-label="Copy code to clipboard"><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" aria-hidden="true" data-slot="icon" width="24" height="24"><path stroke-linecap="round" stroke-linejoin="round" d="M15.75 17.25v3.375c0 .621-.504 1.125-1.125 1.125h-9.75a1.125 1.125 0 0 1-1.125-1.125V7.875c0-.621.504-1.125 1.125-1.125H6.75a9.06 9.06 0 0 1 1.5.124m7.5 10.376h3.375c.621 0 1.125-.504 1.125-1.125V11.25c0-4.46-3.243-8.161-7.5-8.876a9.06 9.06 0 0 0-1.5-.124H9.375c-.621 0-1.125.504-1.125 1.125v3.5m7.5 10.375H9.375a1.125 1.125 0 0 1-1.125-1.125v-9.25m12 6.625v-1.875a3.375 3.375 0 0 0-3.375-3.375h-1.5a1.125 1.125 0 0 1-1.125-1.125v-1.5a3.375 3.375 0 0 0-3.375-3.375H9.75"></path></svg></button></div><div data-mdast-node-id="fJwgc_RNSb92Vfu0oLoDt" class="max-w-full overflow-y-visible overflow-x-auto m-0 group not-prose relative text-left"></div></div><div id="mAfmUwDMuI" class="relative group/block"><div class="flex sticky top-[80px] z-10 opacity-70 group-hover/block:opacity-100 group-hover/block:hidden"><div class="absolute top-0 -right-[28px] flex md:flex-col"></div></div><div class="hidden sticky top-[80px] z-10 opacity-70 group-hover/block:opacity-100 group-hover/block:flex"><div class="absolute top-0 -right-[28px] flex md:flex-col"></div></div><div class="relative group not-prose overflow-auto shadow hover:shadow-md dark:shadow-2xl dark:shadow-neutral-900 my-5 text-sm border border-l-4 border-l-blue-400 border-gray-200 dark:border-l-blue-400 dark:border-gray-800"><pre class="block p-3 hljs" style="background-color:unset"><code class="language-python" style="white-space:pre"># create a list of execution arguments for each patch
execution_args = []
for i in range(len(patchIDs)):
    execution_args.append(
        {
            load: {&#x27;eopatch_folder&#x27;: &#x27;eopatch_{}&#x27;.format(i)},
            export_tiff: {&#x27;filename&#x27;: &#x27;{}/prediction_eopatch_{}_original.tiff&#x27;.format(tiff_location, i)},
            save: {&#x27;eopatch_folder&#x27;: &#x27;eopatch_{}&#x27;.format(i)}
        }
    )

# run the executor on 2 cores
executor = EOExecutor(workflow, execution_args)

# uncomment below save the logs in the current directory and produce a report!
#executor = EOExecutor(workflow, execution_args, save_logs=True)

executor.run(workers=1, multiprocess=False)
executor.make_report()</code></pre><button title="Copy to Clipboard" class="inline-flex items-center opacity-0 group-hover:opacity-100 hover:opacity-100 focus:opacity-100 active:opacity-100 cursor-pointer ml-2 transition-color duration-200 ease-in-out text-blue-400 hover:text-blue-500 absolute right-1 top-1" aria-pressed="false" aria-label="Copy code to clipboard"><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" aria-hidden="true" data-slot="icon" width="24" height="24"><path stroke-linecap="round" stroke-linejoin="round" d="M15.75 17.25v3.375c0 .621-.504 1.125-1.125 1.125h-9.75a1.125 1.125 0 0 1-1.125-1.125V7.875c0-.621.504-1.125 1.125-1.125H6.75a9.06 9.06 0 0 1 1.5.124m7.5 10.376h3.375c.621 0 1.125-.504 1.125-1.125V11.25c0-4.46-3.243-8.161-7.5-8.876a9.06 9.06 0 0 0-1.5-.124H9.375c-.621 0-1.125.504-1.125 1.125v3.5m7.5 10.375H9.375a1.125 1.125 0 0 1-1.125-1.125v-9.25m12 6.625v-1.875a3.375 3.375 0 0 0-3.375-3.375h-1.5a1.125 1.125 0 0 1-1.125-1.125v-1.5a3.375 3.375 0 0 0-3.375-3.375H9.75"></path></svg></button></div><div data-mdast-node-id="7rtWT7wWnQR6oZZBCnr2X" class="max-w-full overflow-y-visible overflow-x-auto m-0 group not-prose relative text-left mb-5"><div><div class="p-2.5">Loading...</div></div></div></div><div id="qmz8XSmrrK" class="relative group/block"><h1 id="part-3-visualize-the-prediction" class="relative group"><span class="heading-text">Part 3: Visualize the prediction</span><a class="no-underline text-inherit hover:text-inherit inline-block w-0 px-0 translate-x-[10px] font-normal select-none transition-opacity opacity-0 focus:opacity-100 group-hover:opacity-70" href="#part-3-visualize-the-prediction" title="Link to this Section" aria-label="Link to this Section">¶</a></h1></div><div id="De9actgC25" class="relative group/block"><div class="flex sticky top-[80px] z-10 opacity-70 group-hover/block:opacity-100 group-hover/block:hidden"><div class="absolute top-0 -right-[28px] flex md:flex-col"></div></div><div class="hidden sticky top-[80px] z-10 opacity-70 group-hover/block:opacity-100 group-hover/block:flex"><div class="absolute top-0 -right-[28px] flex md:flex-col"></div></div><div class="relative group not-prose overflow-auto shadow hover:shadow-md dark:shadow-2xl dark:shadow-neutral-900 my-5 text-sm border border-l-4 border-l-blue-400 border-gray-200 dark:border-l-blue-400 dark:border-gray-800"><pre class="block p-3 hljs" style="background-color:unset"><code class="language-python" style="white-space:pre">path_out_sampled = &#x27;./eopatches_sampled_small/&#x27; if use_smaller_patches else &#x27;./eopatches_sampled_large/&#x27;

fig, axes = plt.subplots(figsize=(20, 20 * aspect_ratio), nrows=3, ncols=3)

pbar = tqdm(total=9)
for i, ax in enumerate(axes.flat):
    eopatch = EOPatch.load(&#x27;{}/eopatch_{}&#x27;.format(path_out_sampled, i), lazy_loading=True)
    im = ax.imshow(eopatch.mask_timeless[&#x27;LBL_GBM&#x27;].squeeze(), cmap=ct_cmap, norm=ct_norm)
    ax.set_xticks([])
    ax.set_yticks([])
    ax.set_aspect(&quot;auto&quot;)
    pbar.update(1)

fig.subplots_adjust(wspace=0, hspace=0)

cb = fig.colorbar(im, ax=axes.ravel().tolist(), orientation=&#x27;horizontal&#x27;, pad=0.01, aspect=100)
cb.ax.tick_params(labelsize=20) 
cb.set_ticks([entry.id for entry in CTGROUPS])
cb.ax.set_xticklabels([entry.class_name for entry in CTGROUPS], rotation=90, fontsize=15)
plt.show()</code></pre><button title="Copy to Clipboard" class="inline-flex items-center opacity-0 group-hover:opacity-100 hover:opacity-100 focus:opacity-100 active:opacity-100 cursor-pointer ml-2 transition-color duration-200 ease-in-out text-blue-400 hover:text-blue-500 absolute right-1 top-1" aria-pressed="false" aria-label="Copy code to clipboard"><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" aria-hidden="true" data-slot="icon" width="24" height="24"><path stroke-linecap="round" stroke-linejoin="round" d="M15.75 17.25v3.375c0 .621-.504 1.125-1.125 1.125h-9.75a1.125 1.125 0 0 1-1.125-1.125V7.875c0-.621.504-1.125 1.125-1.125H6.75a9.06 9.06 0 0 1 1.5.124m7.5 10.376h3.375c.621 0 1.125-.504 1.125-1.125V11.25c0-4.46-3.243-8.161-7.5-8.876a9.06 9.06 0 0 0-1.5-.124H9.375c-.621 0-1.125.504-1.125 1.125v3.5m7.5 10.375H9.375a1.125 1.125 0 0 1-1.125-1.125v-9.25m12 6.625v-1.875a3.375 3.375 0 0 0-3.375-3.375h-1.5a1.125 1.125 0 0 1-1.125-1.125v-1.5a3.375 3.375 0 0 0-3.375-3.375H9.75"></path></svg></button></div><div data-mdast-node-id="up7vHzZ70TClp6gTy2WgC" class="max-w-full overflow-y-visible overflow-x-auto m-0 group not-prose relative text-left mb-5"><div><div class="p-2.5">Loading...</div></div></div></div><div id="wXHkIMn4Hq" class="relative group/block"><h2 id="visual-inspection-of-patches" class="relative group"><span class="heading-text">Visual inspection of patches</span><a class="no-underline text-inherit hover:text-inherit inline-block w-0 px-0 translate-x-[10px] font-normal select-none transition-opacity opacity-0 focus:opacity-100 group-hover:opacity-70" href="#visual-inspection-of-patches" title="Link to this Section" aria-label="Link to this Section">¶</a></h2><p>Here is just a simple piece of code that allows a closer inspection of the predicted labels.</p><p>Random subsets of patches are chosen, where prediction and ground truth are compared. For visual aid the mask of differences and the true color image are also provided.</p><p>In majority of the cases, differences seem to lie on the border of different structures.</p></div><div id="MEdvNgdMxf" class="relative group/block"><div class="flex sticky top-[80px] z-10 opacity-70 group-hover/block:opacity-100 group-hover/block:hidden"><div class="absolute top-0 -right-[28px] flex md:flex-col"></div></div><div class="hidden sticky top-[80px] z-10 opacity-70 group-hover/block:opacity-100 group-hover/block:flex"><div class="absolute top-0 -right-[28px] flex md:flex-col"></div></div><div class="relative group not-prose overflow-auto shadow hover:shadow-md dark:shadow-2xl dark:shadow-neutral-900 my-5 text-sm border border-l-4 border-l-blue-400 border-gray-200 dark:border-l-blue-400 dark:border-gray-800"><pre class="block p-3 hljs" style="background-color:unset"><code class="language-python" style="white-space:pre"># Draw the Reference map

fig = plt.figure(figsize=(20, 20))
idx = np.random.choice(range(9))
inspect_size = 100

eopatch = EOPatch.load(&#x27;{}/eopatch_{}&#x27;.format(path_out_sampled, idx), lazy_loading=True)

w, h = eopatch.mask_timeless[&#x27;CROP_TYPE&#x27;].squeeze().shape

w_min = np.random.choice(range(w - inspect_size))
h_min = np.random.choice(range(h - inspect_size))

ax = plt.subplot(2, 2, 1)
plt.imshow(eopatch.mask_timeless[&#x27;CROP_TYPE&#x27;].squeeze()[w_min: w_min + inspect_size, h_min : h_min + inspect_size],
           cmap=ct_cmap, norm=ct_norm)
plt.xticks([])
plt.yticks([])
ax.set_aspect(&quot;auto&quot;)
plt.title(&#x27;Ground Truth&#x27;, fontsize=20)

ax = plt.subplot(2, 2, 2)
plt.imshow(eopatch.mask_timeless[&#x27;LBL_GBM&#x27;].squeeze()[w_min: w_min + inspect_size, h_min: h_min + inspect_size],
           cmap=ct_cmap, norm=ct_norm)
plt.xticks([])
plt.yticks([])
ax.set_aspect(&quot;auto&quot;)
plt.title(&#x27;Prediction&#x27;, fontsize=20)

ax = plt.subplot(2, 2, 3)
mask = eopatch.mask_timeless[&#x27;LBL_GBM&#x27;].squeeze() != eopatch.mask_timeless[&#x27;CROP_TYPE&#x27;].squeeze()
plt.imshow(mask[w_min: w_min + inspect_size, h_min: h_min + inspect_size], cmap=&#x27;gray&#x27;)
plt.xticks([])
plt.yticks([]);
ax.set_aspect(&quot;auto&quot;)
plt.title(&#x27;Difference&#x27;, fontsize=20)

ax = plt.subplot(2, 2, 4)
image = np.clip(eopatch.data[&#x27;FEATURES&#x27;][8][..., [2, 1, 0]] * 3.5, 0, 1)
plt.imshow(image[w_min: w_min + inspect_size, h_min: h_min + inspect_size])
plt.xticks([])
plt.yticks([]);
ax.set_aspect(&quot;auto&quot;)
plt.title(&#x27;True Color&#x27;, fontsize=20)

fig.subplots_adjust(wspace=0.1, hspace=0.1)</code></pre><button title="Copy to Clipboard" class="inline-flex items-center opacity-0 group-hover:opacity-100 hover:opacity-100 focus:opacity-100 active:opacity-100 cursor-pointer ml-2 transition-color duration-200 ease-in-out text-blue-400 hover:text-blue-500 absolute right-1 top-1" aria-pressed="false" aria-label="Copy code to clipboard"><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" aria-hidden="true" data-slot="icon" width="24" height="24"><path stroke-linecap="round" stroke-linejoin="round" d="M15.75 17.25v3.375c0 .621-.504 1.125-1.125 1.125h-9.75a1.125 1.125 0 0 1-1.125-1.125V7.875c0-.621.504-1.125 1.125-1.125H6.75a9.06 9.06 0 0 1 1.5.124m7.5 10.376h3.375c.621 0 1.125-.504 1.125-1.125V11.25c0-4.46-3.243-8.161-7.5-8.876a9.06 9.06 0 0 0-1.5-.124H9.375c-.621 0-1.125.504-1.125 1.125v3.5m7.5 10.375H9.375a1.125 1.125 0 0 1-1.125-1.125v-9.25m12 6.625v-1.875a3.375 3.375 0 0 0-3.375-3.375h-1.5a1.125 1.125 0 0 1-1.125-1.125v-1.5a3.375 3.375 0 0 0-3.375-3.375H9.75"></path></svg></button></div><div data-mdast-node-id="qfjzWDotsAdkjOyqOcwmf" class="max-w-full overflow-y-visible overflow-x-auto m-0 group not-prose relative text-left mb-5"><img src="/notebooks_test/build/199b99469b001b21225f039359d06aa5.png" alt="&lt;Figure size 1440x1440 with 4 Axes&gt;"/></div></div><div id="e67O8ggal1" class="relative group/block"><h1 id="part-4-classification-per-lpis-id" class="relative group"><span class="heading-text">Part 4: Classification per LPIS ID</span><a class="no-underline text-inherit hover:text-inherit inline-block w-0 px-0 translate-x-[10px] font-normal select-none transition-opacity opacity-0 focus:opacity-100 group-hover:opacity-70" href="#part-4-classification-per-lpis-id" title="Link to this Section" aria-label="Link to this Section">¶</a></h1><p>Here classification for a specific parcel identified with the unique ID from the OGD Dataset can be carried out.</p><p>LPIS reference dates and time intervall for satellite imagery have to correspond to the timestamps used for classification.</p></div><div id="fJZVrDFxYW" class="relative group/block"><div class="flex sticky top-[80px] z-10 opacity-70 group-hover/block:opacity-100 group-hover/block:hidden"><div class="absolute top-0 -right-[28px] flex md:flex-col"></div></div><div class="hidden sticky top-[80px] z-10 opacity-70 group-hover/block:opacity-100 group-hover/block:flex"><div class="absolute top-0 -right-[28px] flex md:flex-col"></div></div><div class="relative group not-prose overflow-auto shadow hover:shadow-md dark:shadow-2xl dark:shadow-neutral-900 my-5 text-sm border border-l-4 border-l-blue-400 border-gray-200 dark:border-l-blue-400 dark:border-gray-800"><pre class="block p-3 hljs" style="background-color:unset"><code class="language-python" style="white-space:pre"># Specify OGD ID

lpis_id = 126939

model_path = &#x27;./model_AT_CT_smaller.pkl&#x27;
model = joblib.load(model_path)


# LPIS reference date
dateFilterMin = &#x27;2018-06-30&#x27;
dateFilterMax = &#x27;2018-06-30&#x27;

# Satellite imagery time series
selected_date_interval_for_satellite_imagery = [&#x27;2018-01-01&#x27;, &#x27;2018-09-30&#x27;]

target_crs = CRS.UTM_33N.epsg
tableName = &quot;lpis_at&quot;</code></pre><button title="Copy to Clipboard" class="inline-flex items-center opacity-0 group-hover:opacity-100 hover:opacity-100 focus:opacity-100 active:opacity-100 cursor-pointer ml-2 transition-color duration-200 ease-in-out text-blue-400 hover:text-blue-500 absolute right-1 top-1" aria-pressed="false" aria-label="Copy code to clipboard"><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" aria-hidden="true" data-slot="icon" width="24" height="24"><path stroke-linecap="round" stroke-linejoin="round" d="M15.75 17.25v3.375c0 .621-.504 1.125-1.125 1.125h-9.75a1.125 1.125 0 0 1-1.125-1.125V7.875c0-.621.504-1.125 1.125-1.125H6.75a9.06 9.06 0 0 1 1.5.124m7.5 10.376h3.375c.621 0 1.125-.504 1.125-1.125V11.25c0-4.46-3.243-8.161-7.5-8.876a9.06 9.06 0 0 0-1.5-.124H9.375c-.621 0-1.125.504-1.125 1.125v3.5m7.5 10.375H9.375a1.125 1.125 0 0 1-1.125-1.125v-9.25m12 6.625v-1.875a3.375 3.375 0 0 0-3.375-3.375h-1.5a1.125 1.125 0 0 1-1.125-1.125v-1.5a3.375 3.375 0 0 0-3.375-3.375H9.75"></path></svg></button></div><div data-mdast-node-id="4a_PX_HiJIfxOpEtHkL81" class="max-w-full overflow-y-visible overflow-x-auto m-0 group not-prose relative text-left"></div></div><div id="nH72JRlWIW" class="relative group/block"><h2 id="load-parcel" class="relative group"><span class="heading-text">Load Parcel</span><a class="no-underline text-inherit hover:text-inherit inline-block w-0 px-0 translate-x-[10px] font-normal select-none transition-opacity opacity-0 focus:opacity-100 group-hover:opacity-70" href="#load-parcel" title="Link to this Section" aria-label="Link to this Section">¶</a></h2></div><div id="UJVNPGsszl" class="relative group/block"><div class="flex sticky top-[80px] z-10 opacity-70 group-hover/block:opacity-100 group-hover/block:hidden"><div class="absolute top-0 -right-[28px] flex md:flex-col"></div></div><div class="hidden sticky top-[80px] z-10 opacity-70 group-hover/block:opacity-100 group-hover/block:flex"><div class="absolute top-0 -right-[28px] flex md:flex-col"></div></div><div class="relative group not-prose overflow-auto shadow hover:shadow-md dark:shadow-2xl dark:shadow-neutral-900 my-5 text-sm border border-l-4 border-l-blue-400 border-gray-200 dark:border-l-blue-400 dark:border-gray-800"><pre class="block p-3 hljs" style="background-color:unset"><code class="language-python" style="white-space:pre">def lpis_geom_by_id(tableName, lpis_id, target_crs, dateFilterMin, dateFilterMax):

    with psycopg2.connect(**db_conn_params) as db_conn:
        sql = &#x27;&#x27;&#x27;
            SELECT 
                ctnuml4a, 
                ST_Transform(geometry, {targetCrs}) as geometry
            FROM {tableName}
            WHERE 
                ogd_id = {lpis_id}
            AND 
                ref_date &gt;= &#x27;{dateFilterMin}&#x27; 
            AND ref_date &lt;= &#x27;{dateFilterMax}&#x27;
            &#x27;&#x27;&#x27;

        sql = sql.format(tableName = tableName, 
                         targetCrs = target_crs,
                         lpis_id = lpis_id,
                         dateFilterMin = dateFilterMin, 
                         dateFilterMax = dateFilterMax)
        return gpd.GeoDataFrame.from_postgis(sql, db_conn, geom_col=&#x27;geometry&#x27;)</code></pre><button title="Copy to Clipboard" class="inline-flex items-center opacity-0 group-hover:opacity-100 hover:opacity-100 focus:opacity-100 active:opacity-100 cursor-pointer ml-2 transition-color duration-200 ease-in-out text-blue-400 hover:text-blue-500 absolute right-1 top-1" aria-pressed="false" aria-label="Copy code to clipboard"><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" aria-hidden="true" data-slot="icon" width="24" height="24"><path stroke-linecap="round" stroke-linejoin="round" d="M15.75 17.25v3.375c0 .621-.504 1.125-1.125 1.125h-9.75a1.125 1.125 0 0 1-1.125-1.125V7.875c0-.621.504-1.125 1.125-1.125H6.75a9.06 9.06 0 0 1 1.5.124m7.5 10.376h3.375c.621 0 1.125-.504 1.125-1.125V11.25c0-4.46-3.243-8.161-7.5-8.876a9.06 9.06 0 0 0-1.5-.124H9.375c-.621 0-1.125.504-1.125 1.125v3.5m7.5 10.375H9.375a1.125 1.125 0 0 1-1.125-1.125v-9.25m12 6.625v-1.875a3.375 3.375 0 0 0-3.375-3.375h-1.5a1.125 1.125 0 0 1-1.125-1.125v-1.5a3.375 3.375 0 0 0-3.375-3.375H9.75"></path></svg></button></div><div data-mdast-node-id="MpgjxAAO74kMhpnBY2IKz" class="max-w-full overflow-y-visible overflow-x-auto m-0 group not-prose relative text-left"></div></div><div id="TrudKTpiaD" class="relative group/block"><div class="flex sticky top-[80px] z-10 opacity-70 group-hover/block:opacity-100 group-hover/block:hidden"><div class="absolute top-0 -right-[28px] flex md:flex-col"></div></div><div class="hidden sticky top-[80px] z-10 opacity-70 group-hover/block:opacity-100 group-hover/block:flex"><div class="absolute top-0 -right-[28px] flex md:flex-col"></div></div><div class="relative group not-prose overflow-auto shadow hover:shadow-md dark:shadow-2xl dark:shadow-neutral-900 my-5 text-sm border border-l-4 border-l-blue-400 border-gray-200 dark:border-l-blue-400 dark:border-gray-800"><pre class="block p-3 hljs" style="background-color:unset"><code class="language-python" style="white-space:pre"># load parcel
lpis_df = lpis_geom_by_id(tableName, lpis_id, target_crs, dateFilterMin, dateFilterMax)

# remap ids
lpis_df[&quot;ct&quot;] = lpis_df[&quot;ctnuml4a&quot;].apply(lambda x: ctnuml4aToctMapping[x])

# Visualize the parcel shape
lpis_df.plot()</code></pre><button title="Copy to Clipboard" class="inline-flex items-center opacity-0 group-hover:opacity-100 hover:opacity-100 focus:opacity-100 active:opacity-100 cursor-pointer ml-2 transition-color duration-200 ease-in-out text-blue-400 hover:text-blue-500 absolute right-1 top-1" aria-pressed="false" aria-label="Copy code to clipboard"><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" aria-hidden="true" data-slot="icon" width="24" height="24"><path stroke-linecap="round" stroke-linejoin="round" d="M15.75 17.25v3.375c0 .621-.504 1.125-1.125 1.125h-9.75a1.125 1.125 0 0 1-1.125-1.125V7.875c0-.621.504-1.125 1.125-1.125H6.75a9.06 9.06 0 0 1 1.5.124m7.5 10.376h3.375c.621 0 1.125-.504 1.125-1.125V11.25c0-4.46-3.243-8.161-7.5-8.876a9.06 9.06 0 0 0-1.5-.124H9.375c-.621 0-1.125.504-1.125 1.125v3.5m7.5 10.375H9.375a1.125 1.125 0 0 1-1.125-1.125v-9.25m12 6.625v-1.875a3.375 3.375 0 0 0-3.375-3.375h-1.5a1.125 1.125 0 0 1-1.125-1.125v-1.5a3.375 3.375 0 0 0-3.375-3.375H9.75"></path></svg></button></div><div data-mdast-node-id="M9Jd9rxL7XrKApvjNQ7Xx" class="max-w-full overflow-y-visible overflow-x-auto m-0 group not-prose relative text-left mb-5"><img src="/notebooks_test/build/a5b703584129929d1927e539bf0e0240.png" alt="&lt;Figure size 432x288 with 1 Axes&gt;"/></div></div><div id="zGvGnWDej8" class="relative group/block"><h2 id="define-workflow" class="relative group"><span class="heading-text">Define workflow</span><a class="no-underline text-inherit hover:text-inherit inline-block w-0 px-0 translate-x-[10px] font-normal select-none transition-opacity opacity-0 focus:opacity-100 group-hover:opacity-70" href="#define-workflow" title="Link to this Section" aria-label="Link to this Section">¶</a></h2><p>Workflow for classifiaction of the single parcel:</p></div><div id="S6Yqotz6MS" class="relative group/block"><div class="flex sticky top-[80px] z-10 opacity-70 group-hover/block:opacity-100 group-hover/block:hidden"><div class="absolute top-0 -right-[28px] flex md:flex-col"></div></div><div class="hidden sticky top-[80px] z-10 opacity-70 group-hover/block:opacity-100 group-hover/block:flex"><div class="absolute top-0 -right-[28px] flex md:flex-col"></div></div><div class="relative group not-prose overflow-auto shadow hover:shadow-md dark:shadow-2xl dark:shadow-neutral-900 my-5 text-sm border border-l-4 border-l-blue-400 border-gray-200 dark:border-l-blue-400 dark:border-gray-800"><pre class="block p-3 hljs" style="background-color:unset"><code class="language-python" style="white-space:pre">path_out = &#x27;./eopatches_lpis&#x27;

if not os.path.isdir(path_out):
    os.makedirs(path_out)

bbox = BBox(lpis_df.iloc[0].geometry.bounds, crs=target_crs)    
add_parcel = AddFeature((FeatureType.VECTOR_TIMELESS, &quot;CROP_TYPE_GDF&quot;))
mask_no_data = MaskNoDataInPrediction(&quot;CROP_TYPE_ERODED&quot;, 0, &quot;LBL_GBM&quot;)
erosion = ErosionTask(mask_feature=(FeatureType.MASK_TIMELESS,&#x27;CROP_TYPE&#x27;,&#x27;CROP_TYPE_ERODED&#x27;), disk_radius=1)
predict = PredictPatch(model, (FeatureType.DATA, &#x27;FEATURES&#x27;), &#x27;LBL_GBM&#x27;, &#x27;SCR_GBM&#x27;)
save = SaveTask(path_out, overwrite_permission=OverwritePermission.OVERWRITE_PATCH)

workflow = LinearWorkflow(
    add_data,
    add_clm,
    ndvi,
    ndwi,
    norm,
    add_sh_valmask,
    add_parcel,
    ct_rasterization_task,
    concatenate,
    filter_task,
    linear_interp,
    erosion,
    predict,
    mask_no_data,
    save
)</code></pre><button title="Copy to Clipboard" class="inline-flex items-center opacity-0 group-hover:opacity-100 hover:opacity-100 focus:opacity-100 active:opacity-100 cursor-pointer ml-2 transition-color duration-200 ease-in-out text-blue-400 hover:text-blue-500 absolute right-1 top-1" aria-pressed="false" aria-label="Copy code to clipboard"><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" aria-hidden="true" data-slot="icon" width="24" height="24"><path stroke-linecap="round" stroke-linejoin="round" d="M15.75 17.25v3.375c0 .621-.504 1.125-1.125 1.125h-9.75a1.125 1.125 0 0 1-1.125-1.125V7.875c0-.621.504-1.125 1.125-1.125H6.75a9.06 9.06 0 0 1 1.5.124m7.5 10.376h3.375c.621 0 1.125-.504 1.125-1.125V11.25c0-4.46-3.243-8.161-7.5-8.876a9.06 9.06 0 0 0-1.5-.124H9.375c-.621 0-1.125.504-1.125 1.125v3.5m7.5 10.375H9.375a1.125 1.125 0 0 1-1.125-1.125v-9.25m12 6.625v-1.875a3.375 3.375 0 0 0-3.375-3.375h-1.5a1.125 1.125 0 0 1-1.125-1.125v-1.5a3.375 3.375 0 0 0-3.375-3.375H9.75"></path></svg></button></div><div data-mdast-node-id="enye3u0OwIzVMIiqIx12r" class="max-w-full overflow-y-visible overflow-x-auto m-0 group not-prose relative text-left"></div></div><div id="vgGEZn74ay" class="relative group/block"><h2 id="execute-workflow" class="relative group"><span class="heading-text">Execute workflow</span><a class="no-underline text-inherit hover:text-inherit inline-block w-0 px-0 translate-x-[10px] font-normal select-none transition-opacity opacity-0 focus:opacity-100 group-hover:opacity-70" href="#execute-workflow" title="Link to this Section" aria-label="Link to this Section">¶</a></h2></div><div id="DR9UPhl3mO" class="relative group/block"><div class="flex sticky top-[80px] z-10 opacity-70 group-hover/block:opacity-100 group-hover/block:hidden"><div class="absolute top-0 -right-[28px] flex md:flex-col"></div></div><div class="hidden sticky top-[80px] z-10 opacity-70 group-hover/block:opacity-100 group-hover/block:flex"><div class="absolute top-0 -right-[28px] flex md:flex-col"></div></div><div class="relative group not-prose overflow-auto shadow hover:shadow-md dark:shadow-2xl dark:shadow-neutral-900 my-5 text-sm border border-l-4 border-l-blue-400 border-gray-200 dark:border-l-blue-400 dark:border-gray-800"><pre class="block p-3 hljs" style="background-color:unset"><code class="language-python" style="white-space:pre">%%time

execution_args = []

execution_args.append({
    add_data: {&#x27;bbox&#x27;: bbox, &#x27;time_interval&#x27;: selected_date_interval_for_satellite_imagery},
    add_parcel: {&#x27;data&#x27;: lpis_df},
    save: {&#x27;eopatch_folder&#x27;: &#x27;eopatch_{}&#x27;.format(lpis_id)}
})
    
executor = EOExecutor(workflow, execution_args, save_logs=True)
executor.run(workers=1, multiprocess=True)

executor.make_report()</code></pre><button title="Copy to Clipboard" class="inline-flex items-center opacity-0 group-hover:opacity-100 hover:opacity-100 focus:opacity-100 active:opacity-100 cursor-pointer ml-2 transition-color duration-200 ease-in-out text-blue-400 hover:text-blue-500 absolute right-1 top-1" aria-pressed="false" aria-label="Copy code to clipboard"><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" aria-hidden="true" data-slot="icon" width="24" height="24"><path stroke-linecap="round" stroke-linejoin="round" d="M15.75 17.25v3.375c0 .621-.504 1.125-1.125 1.125h-9.75a1.125 1.125 0 0 1-1.125-1.125V7.875c0-.621.504-1.125 1.125-1.125H6.75a9.06 9.06 0 0 1 1.5.124m7.5 10.376h3.375c.621 0 1.125-.504 1.125-1.125V11.25c0-4.46-3.243-8.161-7.5-8.876a9.06 9.06 0 0 0-1.5-.124H9.375c-.621 0-1.125.504-1.125 1.125v3.5m7.5 10.375H9.375a1.125 1.125 0 0 1-1.125-1.125v-9.25m12 6.625v-1.875a3.375 3.375 0 0 0-3.375-3.375h-1.5a1.125 1.125 0 0 1-1.125-1.125v-1.5a3.375 3.375 0 0 0-3.375-3.375H9.75"></path></svg></button></div><div data-mdast-node-id="2HxSroT9BpBQ7SivphHyG" class="max-w-full overflow-y-visible overflow-x-auto m-0 group not-prose relative text-left mb-5"><div><div class="p-2.5">Loading...</div></div></div></div><div id="OB4ZB9eBzO" class="relative group/block"><h2 id="classification-result" class="relative group"><span class="heading-text">Classification Result</span><a class="no-underline text-inherit hover:text-inherit inline-block w-0 px-0 translate-x-[10px] font-normal select-none transition-opacity opacity-0 focus:opacity-100 group-hover:opacity-70" href="#classification-result" title="Link to this Section" aria-label="Link to this Section">¶</a></h2></div><div id="LV7wvKKqXV" class="relative group/block"><div class="flex sticky top-[80px] z-10 opacity-70 group-hover/block:opacity-100 group-hover/block:hidden"><div class="absolute top-0 -right-[28px] flex md:flex-col"></div></div><div class="hidden sticky top-[80px] z-10 opacity-70 group-hover/block:opacity-100 group-hover/block:flex"><div class="absolute top-0 -right-[28px] flex md:flex-col"></div></div><div class="relative group not-prose overflow-auto shadow hover:shadow-md dark:shadow-2xl dark:shadow-neutral-900 my-5 text-sm border border-l-4 border-l-blue-400 border-gray-200 dark:border-l-blue-400 dark:border-gray-800"><pre class="block p-3 hljs" style="background-color:unset"><code class="language-python" style="white-space:pre">eopatch = EOPatch.load(&#x27;./eopatches_lpis/eopatch_{}&#x27;.format(lpis_id))</code></pre><button title="Copy to Clipboard" class="inline-flex items-center opacity-0 group-hover:opacity-100 hover:opacity-100 focus:opacity-100 active:opacity-100 cursor-pointer ml-2 transition-color duration-200 ease-in-out text-blue-400 hover:text-blue-500 absolute right-1 top-1" aria-pressed="false" aria-label="Copy code to clipboard"><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" aria-hidden="true" data-slot="icon" width="24" height="24"><path stroke-linecap="round" stroke-linejoin="round" d="M15.75 17.25v3.375c0 .621-.504 1.125-1.125 1.125h-9.75a1.125 1.125 0 0 1-1.125-1.125V7.875c0-.621.504-1.125 1.125-1.125H6.75a9.06 9.06 0 0 1 1.5.124m7.5 10.376h3.375c.621 0 1.125-.504 1.125-1.125V11.25c0-4.46-3.243-8.161-7.5-8.876a9.06 9.06 0 0 0-1.5-.124H9.375c-.621 0-1.125.504-1.125 1.125v3.5m7.5 10.375H9.375a1.125 1.125 0 0 1-1.125-1.125v-9.25m12 6.625v-1.875a3.375 3.375 0 0 0-3.375-3.375h-1.5a1.125 1.125 0 0 1-1.125-1.125v-1.5a3.375 3.375 0 0 0-3.375-3.375H9.75"></path></svg></button></div><div data-mdast-node-id="b7OYWKrZb73axHzrLqiMF" class="max-w-full overflow-y-visible overflow-x-auto m-0 group not-prose relative text-left"></div></div><div id="uGDrX0SpGc" class="relative group/block"><div class="flex sticky top-[80px] z-10 opacity-70 group-hover/block:opacity-100 group-hover/block:hidden"><div class="absolute top-0 -right-[28px] flex md:flex-col"></div></div><div class="hidden sticky top-[80px] z-10 opacity-70 group-hover/block:opacity-100 group-hover/block:flex"><div class="absolute top-0 -right-[28px] flex md:flex-col"></div></div><div class="relative group not-prose overflow-auto shadow hover:shadow-md dark:shadow-2xl dark:shadow-neutral-900 my-5 text-sm border border-l-4 border-l-blue-400 border-gray-200 dark:border-l-blue-400 dark:border-gray-800"><pre class="block p-3 hljs" style="background-color:unset"><code class="language-python" style="white-space:pre">fig = plt.figure(figsize=(10, 10))
image = np.clip(eopatch.data[&#x27;FEATURES&#x27;][8][..., [2, 1, 0]] * 3.5, 0, 1)
plt.imshow(image)
</code></pre><button title="Copy to Clipboard" class="inline-flex items-center opacity-0 group-hover:opacity-100 hover:opacity-100 focus:opacity-100 active:opacity-100 cursor-pointer ml-2 transition-color duration-200 ease-in-out text-blue-400 hover:text-blue-500 absolute right-1 top-1" aria-pressed="false" aria-label="Copy code to clipboard"><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" aria-hidden="true" data-slot="icon" width="24" height="24"><path stroke-linecap="round" stroke-linejoin="round" d="M15.75 17.25v3.375c0 .621-.504 1.125-1.125 1.125h-9.75a1.125 1.125 0 0 1-1.125-1.125V7.875c0-.621.504-1.125 1.125-1.125H6.75a9.06 9.06 0 0 1 1.5.124m7.5 10.376h3.375c.621 0 1.125-.504 1.125-1.125V11.25c0-4.46-3.243-8.161-7.5-8.876a9.06 9.06 0 0 0-1.5-.124H9.375c-.621 0-1.125.504-1.125 1.125v3.5m7.5 10.375H9.375a1.125 1.125 0 0 1-1.125-1.125v-9.25m12 6.625v-1.875a3.375 3.375 0 0 0-3.375-3.375h-1.5a1.125 1.125 0 0 1-1.125-1.125v-1.5a3.375 3.375 0 0 0-3.375-3.375H9.75"></path></svg></button></div><div data-mdast-node-id="ExgqwDkrmbS_FX9qcsmqC" class="max-w-full overflow-y-visible overflow-x-auto m-0 group not-prose relative text-left mb-5"><img src="/notebooks_test/build/e75f8ea4744cb7ce67fca036335cca1e.png" alt="&lt;Figure size 720x720 with 1 Axes&gt;"/></div></div><div id="FcWKg4FwvK" class="relative group/block"><h3 id="declaration" class="relative group"><span class="heading-text">Declaration</span><a class="no-underline text-inherit hover:text-inherit inline-block w-0 px-0 translate-x-[10px] font-normal select-none transition-opacity opacity-0 focus:opacity-100 group-hover:opacity-70" href="#declaration" title="Link to this Section" aria-label="Link to this Section">¶</a></h3></div><div id="LjnTtfGXmF" class="relative group/block"><div class="flex sticky top-[80px] z-10 opacity-70 group-hover/block:opacity-100 group-hover/block:hidden"><div class="absolute top-0 -right-[28px] flex md:flex-col"></div></div><div class="hidden sticky top-[80px] z-10 opacity-70 group-hover/block:opacity-100 group-hover/block:flex"><div class="absolute top-0 -right-[28px] flex md:flex-col"></div></div><div class="relative group not-prose overflow-auto shadow hover:shadow-md dark:shadow-2xl dark:shadow-neutral-900 my-5 text-sm border border-l-4 border-l-blue-400 border-gray-200 dark:border-l-blue-400 dark:border-gray-800"><pre class="block p-3 hljs" style="background-color:unset"><code class="language-python" style="white-space:pre">fig = plt.figure(figsize=(10, 10))
plt.imshow(eopatch.mask_timeless[&#x27;CROP_TYPE_ERODED&#x27;].squeeze(), cmap=ct_cmap, norm=ct_norm)</code></pre><button title="Copy to Clipboard" class="inline-flex items-center opacity-0 group-hover:opacity-100 hover:opacity-100 focus:opacity-100 active:opacity-100 cursor-pointer ml-2 transition-color duration-200 ease-in-out text-blue-400 hover:text-blue-500 absolute right-1 top-1" aria-pressed="false" aria-label="Copy code to clipboard"><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" aria-hidden="true" data-slot="icon" width="24" height="24"><path stroke-linecap="round" stroke-linejoin="round" d="M15.75 17.25v3.375c0 .621-.504 1.125-1.125 1.125h-9.75a1.125 1.125 0 0 1-1.125-1.125V7.875c0-.621.504-1.125 1.125-1.125H6.75a9.06 9.06 0 0 1 1.5.124m7.5 10.376h3.375c.621 0 1.125-.504 1.125-1.125V11.25c0-4.46-3.243-8.161-7.5-8.876a9.06 9.06 0 0 0-1.5-.124H9.375c-.621 0-1.125.504-1.125 1.125v3.5m7.5 10.375H9.375a1.125 1.125 0 0 1-1.125-1.125v-9.25m12 6.625v-1.875a3.375 3.375 0 0 0-3.375-3.375h-1.5a1.125 1.125 0 0 1-1.125-1.125v-1.5a3.375 3.375 0 0 0-3.375-3.375H9.75"></path></svg></button></div><div data-mdast-node-id="kpnrNqMTcJJqXZdTzI4MB" class="max-w-full overflow-y-visible overflow-x-auto m-0 group not-prose relative text-left mb-5"><img src="/notebooks_test/build/7747949466dfd7ae7c6e5b87e5911ca7.png" alt="&lt;Figure size 720x720 with 1 Axes&gt;"/></div></div><div id="kfZg8KiVbd" class="relative group/block"><h3 id="prediction" class="relative group"><span class="heading-text">Prediction</span><a class="no-underline text-inherit hover:text-inherit inline-block w-0 px-0 translate-x-[10px] font-normal select-none transition-opacity opacity-0 focus:opacity-100 group-hover:opacity-70" href="#prediction" title="Link to this Section" aria-label="Link to this Section">¶</a></h3></div><div id="iIHZRq3m5G" class="relative group/block"><div class="flex sticky top-[80px] z-10 opacity-70 group-hover/block:opacity-100 group-hover/block:hidden"><div class="absolute top-0 -right-[28px] flex md:flex-col"></div></div><div class="hidden sticky top-[80px] z-10 opacity-70 group-hover/block:opacity-100 group-hover/block:flex"><div class="absolute top-0 -right-[28px] flex md:flex-col"></div></div><div class="relative group not-prose overflow-auto shadow hover:shadow-md dark:shadow-2xl dark:shadow-neutral-900 my-5 text-sm border border-l-4 border-l-blue-400 border-gray-200 dark:border-l-blue-400 dark:border-gray-800"><pre class="block p-3 hljs" style="background-color:unset"><code class="language-python" style="white-space:pre">fig = plt.figure(figsize=(10, 10))
axes = plt.gca()


im = plt.imshow(eopatch.mask_timeless[&#x27;LBL_GBM&#x27;].squeeze(), cmap=ct_cmap, norm=ct_norm)
plt.xticks([])
plt.yticks([])


cb = fig.colorbar(im, ax=axes, orientation=&#x27;horizontal&#x27;, pad=0.01, aspect=100)
cb.ax.tick_params(labelsize=20) 
cb.set_ticks([entry.id for entry in CTGROUPS])
cb.ax.set_xticklabels([entry.class_name for entry in CTGROUPS], rotation=90, fontsize=15)
plt.show()</code></pre><button title="Copy to Clipboard" class="inline-flex items-center opacity-0 group-hover:opacity-100 hover:opacity-100 focus:opacity-100 active:opacity-100 cursor-pointer ml-2 transition-color duration-200 ease-in-out text-blue-400 hover:text-blue-500 absolute right-1 top-1" aria-pressed="false" aria-label="Copy code to clipboard"><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" aria-hidden="true" data-slot="icon" width="24" height="24"><path stroke-linecap="round" stroke-linejoin="round" d="M15.75 17.25v3.375c0 .621-.504 1.125-1.125 1.125h-9.75a1.125 1.125 0 0 1-1.125-1.125V7.875c0-.621.504-1.125 1.125-1.125H6.75a9.06 9.06 0 0 1 1.5.124m7.5 10.376h3.375c.621 0 1.125-.504 1.125-1.125V11.25c0-4.46-3.243-8.161-7.5-8.876a9.06 9.06 0 0 0-1.5-.124H9.375c-.621 0-1.125.504-1.125 1.125v3.5m7.5 10.375H9.375a1.125 1.125 0 0 1-1.125-1.125v-9.25m12 6.625v-1.875a3.375 3.375 0 0 0-3.375-3.375h-1.5a1.125 1.125 0 0 1-1.125-1.125v-1.5a3.375 3.375 0 0 0-3.375-3.375H9.75"></path></svg></button></div><div data-mdast-node-id="1gb70c_eydN70ar3_MTvB" class="max-w-full overflow-y-visible overflow-x-auto m-0 group not-prose relative text-left mb-5"><img src="/notebooks_test/build/d573ae757dc93f685751c859a0ba633f.png" alt="&lt;Figure size 720x720 with 2 Axes&gt;"/></div></div><div id="GM8wW7zpFt" class="relative group/block"><h3 id="accuracy-of-classification" class="relative group"><span class="heading-text">Accuracy of classification</span><a class="no-underline text-inherit hover:text-inherit inline-block w-0 px-0 translate-x-[10px] font-normal select-none transition-opacity opacity-0 focus:opacity-100 group-hover:opacity-70" href="#accuracy-of-classification" title="Link to this Section" aria-label="Link to this Section">¶</a></h3></div><div id="keUfrXXVZf" class="relative group/block"><div class="flex sticky top-[80px] z-10 opacity-70 group-hover/block:opacity-100 group-hover/block:hidden"><div class="absolute top-0 -right-[28px] flex md:flex-col"></div></div><div class="hidden sticky top-[80px] z-10 opacity-70 group-hover/block:opacity-100 group-hover/block:flex"><div class="absolute top-0 -right-[28px] flex md:flex-col"></div></div><div class="relative group not-prose overflow-auto shadow hover:shadow-md dark:shadow-2xl dark:shadow-neutral-900 my-5 text-sm border border-l-4 border-l-blue-400 border-gray-200 dark:border-l-blue-400 dark:border-gray-800"><pre class="block p-3 hljs" style="background-color:unset"><code class="language-python" style="white-space:pre">mask = (eopatch.mask_timeless[&#x27;CROP_TYPE_ERODED&#x27;] != 0).squeeze()

REF = eopatch.mask_timeless[&#x27;CROP_TYPE&#x27;].squeeze()[mask]
LBL_GBM = eopatch.mask_timeless[&#x27;LBL_GBM&#x27;].squeeze()[mask]

# classification is class with most pixels
unique = np.unique(LBL_GBM, return_counts=True)
classification_id = unique[0][unique[1].argmax()]

# remap to original id
classification_id_mapped = ctToctnuml4aMapping[classification_id][0]

# precentage of pixels in prediction classified same as lpis
accuracy = sum(REF == LBL_GBM) / len(LBL_GBM)

print(&quot;Parcel with ID {} classified as class {} with an accuracy of {:.2%}&quot;.format(lpis_id, classification_id_mapped, accuracy))
</code></pre><button title="Copy to Clipboard" class="inline-flex items-center opacity-0 group-hover:opacity-100 hover:opacity-100 focus:opacity-100 active:opacity-100 cursor-pointer ml-2 transition-color duration-200 ease-in-out text-blue-400 hover:text-blue-500 absolute right-1 top-1" aria-pressed="false" aria-label="Copy code to clipboard"><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" aria-hidden="true" data-slot="icon" width="24" height="24"><path stroke-linecap="round" stroke-linejoin="round" d="M15.75 17.25v3.375c0 .621-.504 1.125-1.125 1.125h-9.75a1.125 1.125 0 0 1-1.125-1.125V7.875c0-.621.504-1.125 1.125-1.125H6.75a9.06 9.06 0 0 1 1.5.124m7.5 10.376h3.375c.621 0 1.125-.504 1.125-1.125V11.25c0-4.46-3.243-8.161-7.5-8.876a9.06 9.06 0 0 0-1.5-.124H9.375c-.621 0-1.125.504-1.125 1.125v3.5m7.5 10.375H9.375a1.125 1.125 0 0 1-1.125-1.125v-9.25m12 6.625v-1.875a3.375 3.375 0 0 0-3.375-3.375h-1.5a1.125 1.125 0 0 1-1.125-1.125v-1.5a3.375 3.375 0 0 0-3.375-3.375H9.75"></path></svg></button></div><div data-mdast-node-id="89Yn0nzDsN2NUE78EAarJ" class="max-w-full overflow-y-visible overflow-x-auto m-0 group not-prose relative text-left mb-5"><div><pre class="text-sm font-thin font-system"><code><span>Parcel with ID 126939 classified as class 1020 with an accuracy of 90.91%
</span></code></pre></div></div></div><div id="qiX2jt9JdE" class="relative group/block"><h1 id="part-5-persist-classification-results-in-database" class="relative group"><span class="heading-text">Part 5: Persist classification results in database</span><a class="no-underline text-inherit hover:text-inherit inline-block w-0 px-0 translate-x-[10px] font-normal select-none transition-opacity opacity-0 focus:opacity-100 group-hover:opacity-70" href="#part-5-persist-classification-results-in-database" title="Link to this Section" aria-label="Link to this Section">¶</a></h1></div><div id="uu6XMLdzct" class="relative group/block"><h2 id="add-the-model-configuration-to-the-db" class="relative group"><span class="heading-text">Add the model configuration to the db</span><a class="no-underline text-inherit hover:text-inherit inline-block w-0 px-0 translate-x-[10px] font-normal select-none transition-opacity opacity-0 focus:opacity-100 group-hover:opacity-70" href="#add-the-model-configuration-to-the-db" title="Link to this Section" aria-label="Link to this Section">¶</a></h2></div><div id="kC4f9yTiZo" class="relative group/block"><div class="flex sticky top-[80px] z-10 opacity-70 group-hover/block:opacity-100 group-hover/block:hidden"><div class="absolute top-0 -right-[28px] flex md:flex-col"></div></div><div class="hidden sticky top-[80px] z-10 opacity-70 group-hover/block:opacity-100 group-hover/block:flex"><div class="absolute top-0 -right-[28px] flex md:flex-col"></div></div><div class="relative group not-prose overflow-auto shadow hover:shadow-md dark:shadow-2xl dark:shadow-neutral-900 my-5 text-sm border border-l-4 border-l-blue-400 border-gray-200 dark:border-l-blue-400 dark:border-gray-800"><pre class="block p-3 hljs" style="background-color:unset"><code class="language-python" style="white-space:pre">model_name = &quot;default_3x3_noe&quot;

model_config = {

  &quot;reference&quot;: {
      &quot;table&quot;: &quot;lpis_at&quot;,
      &quot;column&quot;: &quot;ctnuml4a&quot;,
      
  },
    
  &quot;classifiier&quot;: &quot;lgbm&quot;,
    
  &quot;model_parameters&quot;:
    {
      &quot;boosting_type&quot;: &quot;gbdt&quot;,
      &quot;num_leaves&quot;: 31, 
      &quot;max_depth&quot;: -1, 
      &quot;learning_rate&quot;: 0.1
    },
    
  &quot;valid_data_threshold&quot;: 0.8,
    
  &quot;interpolation_range&quot;: {
    &quot;start&quot;: &quot;2018-01-01&quot;,
    &quot;end&quot;: &quot;2018-09-30&quot;,
    &quot;interval&quot;: 16
  },
    
  &quot;erosion_radius&quot;: 1,
    
  &quot;features&quot;: 
  [
    &quot;B02&quot;,
    &quot;B03&quot;,
    &quot;B04&quot;,
    &quot;B08&quot;,
    &quot;B11&quot;,
    &quot;B12&quot;,
    &quot;NDVI&quot;,
    &quot;NDWI&quot;,
    &quot;NORM&quot;
  ],
    
  &quot;training_bounds&quot;: bounds
}</code></pre><button title="Copy to Clipboard" class="inline-flex items-center opacity-0 group-hover:opacity-100 hover:opacity-100 focus:opacity-100 active:opacity-100 cursor-pointer ml-2 transition-color duration-200 ease-in-out text-blue-400 hover:text-blue-500 absolute right-1 top-1" aria-pressed="false" aria-label="Copy code to clipboard"><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" aria-hidden="true" data-slot="icon" width="24" height="24"><path stroke-linecap="round" stroke-linejoin="round" d="M15.75 17.25v3.375c0 .621-.504 1.125-1.125 1.125h-9.75a1.125 1.125 0 0 1-1.125-1.125V7.875c0-.621.504-1.125 1.125-1.125H6.75a9.06 9.06 0 0 1 1.5.124m7.5 10.376h3.375c.621 0 1.125-.504 1.125-1.125V11.25c0-4.46-3.243-8.161-7.5-8.876a9.06 9.06 0 0 0-1.5-.124H9.375c-.621 0-1.125.504-1.125 1.125v3.5m7.5 10.375H9.375a1.125 1.125 0 0 1-1.125-1.125v-9.25m12 6.625v-1.875a3.375 3.375 0 0 0-3.375-3.375h-1.5a1.125 1.125 0 0 1-1.125-1.125v-1.5a3.375 3.375 0 0 0-3.375-3.375H9.75"></path></svg></button></div><div data-mdast-node-id="TnDtg7Gd1T2h2xJSoT2cA" class="max-w-full overflow-y-visible overflow-x-auto m-0 group not-prose relative text-left"></div></div><div id="lO1OV1bco8" class="relative group/block"><div class="flex sticky top-[80px] z-10 opacity-70 group-hover/block:opacity-100 group-hover/block:hidden"><div class="absolute top-0 -right-[28px] flex md:flex-col"></div></div><div class="hidden sticky top-[80px] z-10 opacity-70 group-hover/block:opacity-100 group-hover/block:flex"><div class="absolute top-0 -right-[28px] flex md:flex-col"></div></div><div class="relative group not-prose overflow-auto shadow hover:shadow-md dark:shadow-2xl dark:shadow-neutral-900 my-5 text-sm border border-l-4 border-l-blue-400 border-gray-200 dark:border-l-blue-400 dark:border-gray-800"><pre class="block p-3 hljs" style="background-color:unset"><code class="language-python" style="white-space:pre">insert_model = &quot;&quot;&quot;
INSERT INTO model_at (name, ref_date, training_time, configuration)
VALUES (
    &#x27;{model_name}&#x27;, 
    &#x27;2018-06-30&#x27;, 
        (
            SELECT CURRENT_TIMESTAMP
        ),
    &#x27;{config}&#x27;
        
    ); 
&quot;&quot;&quot;.format(
    config = str(model_config).replace(&quot;&#x27;&quot;, &quot;\&quot;&quot;),
    model_name = model_name
)

with psycopg2.connect(**db_conn_params) as db_conn:
    with db_conn.cursor() as cur:
        cur.execute(insert_model)
        db_conn.commit()</code></pre><button title="Copy to Clipboard" class="inline-flex items-center opacity-0 group-hover:opacity-100 hover:opacity-100 focus:opacity-100 active:opacity-100 cursor-pointer ml-2 transition-color duration-200 ease-in-out text-blue-400 hover:text-blue-500 absolute right-1 top-1" aria-pressed="false" aria-label="Copy code to clipboard"><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" aria-hidden="true" data-slot="icon" width="24" height="24"><path stroke-linecap="round" stroke-linejoin="round" d="M15.75 17.25v3.375c0 .621-.504 1.125-1.125 1.125h-9.75a1.125 1.125 0 0 1-1.125-1.125V7.875c0-.621.504-1.125 1.125-1.125H6.75a9.06 9.06 0 0 1 1.5.124m7.5 10.376h3.375c.621 0 1.125-.504 1.125-1.125V11.25c0-4.46-3.243-8.161-7.5-8.876a9.06 9.06 0 0 0-1.5-.124H9.375c-.621 0-1.125.504-1.125 1.125v3.5m7.5 10.375H9.375a1.125 1.125 0 0 1-1.125-1.125v-9.25m12 6.625v-1.875a3.375 3.375 0 0 0-3.375-3.375h-1.5a1.125 1.125 0 0 1-1.125-1.125v-1.5a3.375 3.375 0 0 0-3.375-3.375H9.75"></path></svg></button></div><div data-mdast-node-id="NXtMuIBPuCQluy-LRtIlr" class="max-w-full overflow-y-visible overflow-x-auto m-0 group not-prose relative text-left"></div></div><div id="OyEAdx5Gtw" class="relative group/block"><h2 id="add-all-classification-results-for-parcels-within-definded-bounds" class="relative group"><span class="heading-text">Add all classification results for parcels within definded bounds</span><a class="no-underline text-inherit hover:text-inherit inline-block w-0 px-0 translate-x-[10px] font-normal select-none transition-opacity opacity-0 focus:opacity-100 group-hover:opacity-70" href="#add-all-classification-results-for-parcels-within-definded-bounds" title="Link to this Section" aria-label="Link to this Section">¶</a></h2></div><div id="jz71TuA2aQ" class="relative group/block"><div class="flex sticky top-[80px] z-10 opacity-70 group-hover/block:opacity-100 group-hover/block:hidden"><div class="absolute top-0 -right-[28px] flex md:flex-col"></div></div><div class="hidden sticky top-[80px] z-10 opacity-70 group-hover/block:opacity-100 group-hover/block:flex"><div class="absolute top-0 -right-[28px] flex md:flex-col"></div></div><div class="relative group not-prose overflow-auto shadow hover:shadow-md dark:shadow-2xl dark:shadow-neutral-900 my-5 text-sm border border-l-4 border-l-blue-400 border-gray-200 dark:border-l-blue-400 dark:border-gray-800"><pre class="block p-3 hljs" style="background-color:unset"><code class="language-python" style="white-space:pre"># change this bounding box depending on where the classification should be carried out
bounds_for_classification = bounds
model_name = &quot;default_3x3_noe&quot;</code></pre><button title="Copy to Clipboard" class="inline-flex items-center opacity-0 group-hover:opacity-100 hover:opacity-100 focus:opacity-100 active:opacity-100 cursor-pointer ml-2 transition-color duration-200 ease-in-out text-blue-400 hover:text-blue-500 absolute right-1 top-1" aria-pressed="false" aria-label="Copy code to clipboard"><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" aria-hidden="true" data-slot="icon" width="24" height="24"><path stroke-linecap="round" stroke-linejoin="round" d="M15.75 17.25v3.375c0 .621-.504 1.125-1.125 1.125h-9.75a1.125 1.125 0 0 1-1.125-1.125V7.875c0-.621.504-1.125 1.125-1.125H6.75a9.06 9.06 0 0 1 1.5.124m7.5 10.376h3.375c.621 0 1.125-.504 1.125-1.125V11.25c0-4.46-3.243-8.161-7.5-8.876a9.06 9.06 0 0 0-1.5-.124H9.375c-.621 0-1.125.504-1.125 1.125v3.5m7.5 10.375H9.375a1.125 1.125 0 0 1-1.125-1.125v-9.25m12 6.625v-1.875a3.375 3.375 0 0 0-3.375-3.375h-1.5a1.125 1.125 0 0 1-1.125-1.125v-1.5a3.375 3.375 0 0 0-3.375-3.375H9.75"></path></svg></button></div><div data-mdast-node-id="wEUfoQ9IwloHYAuhHaMqq" class="max-w-full overflow-y-visible overflow-x-auto m-0 group not-prose relative text-left"></div></div><div id="A0mg7bKUHK" class="relative group/block"><h3 id="eotasks" class="relative group"><span class="heading-text">EOTasks</span><a class="no-underline text-inherit hover:text-inherit inline-block w-0 px-0 translate-x-[10px] font-normal select-none transition-opacity opacity-0 focus:opacity-100 group-hover:opacity-70" href="#eotasks" title="Link to this Section" aria-label="Link to this Section">¶</a></h3></div><div id="WEtbG68aCZ" class="relative group/block"><div class="flex sticky top-[80px] z-10 opacity-70 group-hover/block:opacity-100 group-hover/block:hidden"><div class="absolute top-0 -right-[28px] flex md:flex-col"></div></div><div class="hidden sticky top-[80px] z-10 opacity-70 group-hover/block:opacity-100 group-hover/block:flex"><div class="absolute top-0 -right-[28px] flex md:flex-col"></div></div><div class="relative group not-prose overflow-auto shadow hover:shadow-md dark:shadow-2xl dark:shadow-neutral-900 my-5 text-sm border border-l-4 border-l-blue-400 border-gray-200 dark:border-l-blue-400 dark:border-gray-800"><pre class="block p-3 hljs" style="background-color:unset"><code class="language-python" style="white-space:pre">class AddPredictionToDatabase(EOTask):
    def __init__(self, ref_date, model_id, target_table, db_conn_params):
        self.ref_date = ref_date
        self.model_id = model_id
        self.target_table = target_table
        self.db_conn_params = db_conn_params

        
    def execute(self, eopatch, parcel_id):
        
        mask = (eopatch.mask_timeless[&#x27;CROP_TYPE_ERODED&#x27;] != 0).squeeze()

        # scores per pixel
        scores_pixel = eopatch.data_timeless[&quot;SCR_GBM&quot;][mask]

        # averaged scores for each class form pixels to parcel
        scores_parcel = np.nanmean(scores_pixel, axis=0)

        # ranking
        ranking = np.argsort(scores_parcel)

        # probabilities ordered descending by ranking
        scores_parcel = scores_parcel[ranking][::-1]

        # ranked classes ordered descending by ranking
        classes_parcel = model.classes_[ranking[::-1]]

        # mapped back to original
        classes_parcel_original = np.vectorize(lambda x: ctToctnuml4aMapping[x][0])(classes_parcel)
        
        prediction = [
            dict(
                crop_id=crop_id, 
                probability=round(probability, 2) if not np.isnan(probability) else 0
            )

            for crop_id, probability in zip(classes_parcel_original, scores_parcel)
        ]
        
        
        sql = &quot;&quot;&quot;
        INSERT INTO {target_table} (parcel_id, ref_date, model_id, prediction)
        VALUES (
             {parcel_id}, 
            &#x27;{ref_date}&#x27;, 
             {model_id},
            &#x27;{prediction}&#x27;
            )
            
        -- skip existing entries
        ON CONFLICT DO NOTHING 
        ; 
        &quot;&quot;&quot;

        sql = sql.format(
            target_table = self.target_table,
            parcel_id = parcel_id,
            ref_date = self.ref_date,
            model_id = self.model_id,
            prediction = str(prediction).replace(&quot;&#x27;&quot;, &quot;\&quot;&quot;)
        )
        with psycopg2.connect(**self.db_conn_params) as db_conn:
            with db_conn.cursor() as cur:
                cur.execute(sql)
                db_conn.commit()
                
        return eopatch</code></pre><button title="Copy to Clipboard" class="inline-flex items-center opacity-0 group-hover:opacity-100 hover:opacity-100 focus:opacity-100 active:opacity-100 cursor-pointer ml-2 transition-color duration-200 ease-in-out text-blue-400 hover:text-blue-500 absolute right-1 top-1" aria-pressed="false" aria-label="Copy code to clipboard"><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" aria-hidden="true" data-slot="icon" width="24" height="24"><path stroke-linecap="round" stroke-linejoin="round" d="M15.75 17.25v3.375c0 .621-.504 1.125-1.125 1.125h-9.75a1.125 1.125 0 0 1-1.125-1.125V7.875c0-.621.504-1.125 1.125-1.125H6.75a9.06 9.06 0 0 1 1.5.124m7.5 10.376h3.375c.621 0 1.125-.504 1.125-1.125V11.25c0-4.46-3.243-8.161-7.5-8.876a9.06 9.06 0 0 0-1.5-.124H9.375c-.621 0-1.125.504-1.125 1.125v3.5m7.5 10.375H9.375a1.125 1.125 0 0 1-1.125-1.125v-9.25m12 6.625v-1.875a3.375 3.375 0 0 0-3.375-3.375h-1.5a1.125 1.125 0 0 1-1.125-1.125v-1.5a3.375 3.375 0 0 0-3.375-3.375H9.75"></path></svg></button></div><div data-mdast-node-id="FB8seLo7qJi36Ixu8r7kt" class="max-w-full overflow-y-visible overflow-x-auto m-0 group not-prose relative text-left"></div></div><div id="gRu66akiKr" class="relative group/block"><h3 id="get-model-id" class="relative group"><span class="heading-text">Get Model ID</span><a class="no-underline text-inherit hover:text-inherit inline-block w-0 px-0 translate-x-[10px] font-normal select-none transition-opacity opacity-0 focus:opacity-100 group-hover:opacity-70" href="#get-model-id" title="Link to this Section" aria-label="Link to this Section">¶</a></h3></div><div id="V48qoYWegx" class="relative group/block"><div class="flex sticky top-[80px] z-10 opacity-70 group-hover/block:opacity-100 group-hover/block:hidden"><div class="absolute top-0 -right-[28px] flex md:flex-col"></div></div><div class="hidden sticky top-[80px] z-10 opacity-70 group-hover/block:opacity-100 group-hover/block:flex"><div class="absolute top-0 -right-[28px] flex md:flex-col"></div></div><div class="relative group not-prose overflow-auto shadow hover:shadow-md dark:shadow-2xl dark:shadow-neutral-900 my-5 text-sm border border-l-4 border-l-blue-400 border-gray-200 dark:border-l-blue-400 dark:border-gray-800"><pre class="block p-3 hljs" style="background-color:unset"><code class="language-python" style="white-space:pre">sql = &quot;SELECT id from model_at where name = &#x27;{}&#x27;;&quot;.format(model_name)

with psycopg2.connect(**db_conn_params) as db_conn:
    with db_conn.cursor() as cur:
        cur.execute(sql)
        model_id = cur.fetchall()[0][0]
        
print(&quot;model_id: &quot;, model_id)</code></pre><button title="Copy to Clipboard" class="inline-flex items-center opacity-0 group-hover:opacity-100 hover:opacity-100 focus:opacity-100 active:opacity-100 cursor-pointer ml-2 transition-color duration-200 ease-in-out text-blue-400 hover:text-blue-500 absolute right-1 top-1" aria-pressed="false" aria-label="Copy code to clipboard"><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" aria-hidden="true" data-slot="icon" width="24" height="24"><path stroke-linecap="round" stroke-linejoin="round" d="M15.75 17.25v3.375c0 .621-.504 1.125-1.125 1.125h-9.75a1.125 1.125 0 0 1-1.125-1.125V7.875c0-.621.504-1.125 1.125-1.125H6.75a9.06 9.06 0 0 1 1.5.124m7.5 10.376h3.375c.621 0 1.125-.504 1.125-1.125V11.25c0-4.46-3.243-8.161-7.5-8.876a9.06 9.06 0 0 0-1.5-.124H9.375c-.621 0-1.125.504-1.125 1.125v3.5m7.5 10.375H9.375a1.125 1.125 0 0 1-1.125-1.125v-9.25m12 6.625v-1.875a3.375 3.375 0 0 0-3.375-3.375h-1.5a1.125 1.125 0 0 1-1.125-1.125v-1.5a3.375 3.375 0 0 0-3.375-3.375H9.75"></path></svg></button></div><div data-mdast-node-id="gmcogW_OODLd212qYqQY9" class="max-w-full overflow-y-visible overflow-x-auto m-0 group not-prose relative text-left mb-5"><div><pre class="text-sm font-thin font-system"><code><span>model_id:  12
</span></code></pre></div></div></div><div id="jWWEjQuJZF" class="relative group/block"><h3 id="define-workflow-1" class="relative group"><span class="heading-text">Define workflow</span><a class="no-underline text-inherit hover:text-inherit inline-block w-0 px-0 translate-x-[10px] font-normal select-none transition-opacity opacity-0 focus:opacity-100 group-hover:opacity-70" href="#define-workflow-1" title="Link to this Section" aria-label="Link to this Section">¶</a></h3></div><div id="K6Dstuzsfv" class="relative group/block"><div class="flex sticky top-[80px] z-10 opacity-70 group-hover/block:opacity-100 group-hover/block:hidden"><div class="absolute top-0 -right-[28px] flex md:flex-col"></div></div><div class="hidden sticky top-[80px] z-10 opacity-70 group-hover/block:opacity-100 group-hover/block:flex"><div class="absolute top-0 -right-[28px] flex md:flex-col"></div></div><div class="relative group not-prose overflow-auto shadow hover:shadow-md dark:shadow-2xl dark:shadow-neutral-900 my-5 text-sm border border-l-4 border-l-blue-400 border-gray-200 dark:border-l-blue-400 dark:border-gray-800"><pre class="block p-3 hljs" style="background-color:unset"><code class="language-python" style="white-space:pre">classification_to_db = AddPredictionToDatabase(&#x27;2018-06-30&#x27;, model_id, &#x27;classification_at&#x27;, db_conn_params)
add_parcel = AddFeature((FeatureType.VECTOR_TIMELESS, &quot;CROP_TYPE_GDF&quot;))
mask_no_data = MaskNoDataInPrediction(&quot;CROP_TYPE_ERODED&quot;, 0, &quot;LBL_GBM&quot;)
predict = PredictPatch(model, (FeatureType.DATA, &#x27;FEATURES&#x27;), &#x27;LBL_GBM&#x27;, &#x27;SCR_GBM&#x27;)</code></pre><button title="Copy to Clipboard" class="inline-flex items-center opacity-0 group-hover:opacity-100 hover:opacity-100 focus:opacity-100 active:opacity-100 cursor-pointer ml-2 transition-color duration-200 ease-in-out text-blue-400 hover:text-blue-500 absolute right-1 top-1" aria-pressed="false" aria-label="Copy code to clipboard"><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" aria-hidden="true" data-slot="icon" width="24" height="24"><path stroke-linecap="round" stroke-linejoin="round" d="M15.75 17.25v3.375c0 .621-.504 1.125-1.125 1.125h-9.75a1.125 1.125 0 0 1-1.125-1.125V7.875c0-.621.504-1.125 1.125-1.125H6.75a9.06 9.06 0 0 1 1.5.124m7.5 10.376h3.375c.621 0 1.125-.504 1.125-1.125V11.25c0-4.46-3.243-8.161-7.5-8.876a9.06 9.06 0 0 0-1.5-.124H9.375c-.621 0-1.125.504-1.125 1.125v3.5m7.5 10.375H9.375a1.125 1.125 0 0 1-1.125-1.125v-9.25m12 6.625v-1.875a3.375 3.375 0 0 0-3.375-3.375h-1.5a1.125 1.125 0 0 1-1.125-1.125v-1.5a3.375 3.375 0 0 0-3.375-3.375H9.75"></path></svg></button></div><div data-mdast-node-id="fSHCsr7lkdXltlwfKs-d1" class="max-w-full overflow-y-visible overflow-x-auto m-0 group not-prose relative text-left"></div></div><div id="MAyqCAVpef" class="relative group/block"><div class="flex sticky top-[80px] z-10 opacity-70 group-hover/block:opacity-100 group-hover/block:hidden"><div class="absolute top-0 -right-[28px] flex md:flex-col"></div></div><div class="hidden sticky top-[80px] z-10 opacity-70 group-hover/block:opacity-100 group-hover/block:flex"><div class="absolute top-0 -right-[28px] flex md:flex-col"></div></div><div class="relative group not-prose overflow-auto shadow hover:shadow-md dark:shadow-2xl dark:shadow-neutral-900 my-5 text-sm border border-l-4 border-l-blue-400 border-gray-200 dark:border-l-blue-400 dark:border-gray-800"><pre class="block p-3 hljs" style="background-color:unset"><code class="language-python" style="white-space:pre">workflow = LinearWorkflow(
    add_data,
    add_clm,
    ndvi,
    ndwi,
    norm,
    add_sh_valmask,
    add_parcel,
    ct_rasterization_task,
    concatenate,
    filter_task,
    linear_interp,
    erosion,
    predict,
    mask_no_data,
    classification_to_db
)</code></pre><button title="Copy to Clipboard" class="inline-flex items-center opacity-0 group-hover:opacity-100 hover:opacity-100 focus:opacity-100 active:opacity-100 cursor-pointer ml-2 transition-color duration-200 ease-in-out text-blue-400 hover:text-blue-500 absolute right-1 top-1" aria-pressed="false" aria-label="Copy code to clipboard"><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" aria-hidden="true" data-slot="icon" width="24" height="24"><path stroke-linecap="round" stroke-linejoin="round" d="M15.75 17.25v3.375c0 .621-.504 1.125-1.125 1.125h-9.75a1.125 1.125 0 0 1-1.125-1.125V7.875c0-.621.504-1.125 1.125-1.125H6.75a9.06 9.06 0 0 1 1.5.124m7.5 10.376h3.375c.621 0 1.125-.504 1.125-1.125V11.25c0-4.46-3.243-8.161-7.5-8.876a9.06 9.06 0 0 0-1.5-.124H9.375c-.621 0-1.125.504-1.125 1.125v3.5m7.5 10.375H9.375a1.125 1.125 0 0 1-1.125-1.125v-9.25m12 6.625v-1.875a3.375 3.375 0 0 0-3.375-3.375h-1.5a1.125 1.125 0 0 1-1.125-1.125v-1.5a3.375 3.375 0 0 0-3.375-3.375H9.75"></path></svg></button></div><div data-mdast-node-id="yLrjzDxaa7uPvRgl283M_" class="max-w-full overflow-y-visible overflow-x-auto m-0 group not-prose relative text-left"></div></div><div id="L4rplDGuZy" class="relative group/block"><h3 id="list-of-parcels-to-process" class="relative group"><span class="heading-text">List of parcels to process</span><a class="no-underline text-inherit hover:text-inherit inline-block w-0 px-0 translate-x-[10px] font-normal select-none transition-opacity opacity-0 focus:opacity-100 group-hover:opacity-70" href="#list-of-parcels-to-process" title="Link to this Section" aria-label="Link to this Section">¶</a></h3></div><div id="xDpNLxc3o6" class="relative group/block"><div class="flex sticky top-[80px] z-10 opacity-70 group-hover/block:opacity-100 group-hover/block:hidden"><div class="absolute top-0 -right-[28px] flex md:flex-col"></div></div><div class="hidden sticky top-[80px] z-10 opacity-70 group-hover/block:opacity-100 group-hover/block:flex"><div class="absolute top-0 -right-[28px] flex md:flex-col"></div></div><div class="relative group not-prose overflow-auto shadow hover:shadow-md dark:shadow-2xl dark:shadow-neutral-900 my-5 text-sm border border-l-4 border-l-blue-400 border-gray-200 dark:border-l-blue-400 dark:border-gray-800"><pre class="block p-3 hljs" style="background-color:unset"><code class="language-python" style="white-space:pre">with psycopg2.connect(**db_conn_params) as db_conn:

    sql = &#x27;&#x27;&#x27;
    SELECT
        ogd_id,
        {column},
        ST_Transform(geometry, {targetCrs}) as geometry

    FROM
        {tableName}
    WHERE
        ref_date &gt;= &#x27;{dateFilterMin}&#x27;
    AND 
        ref_date &lt;= &#x27;{dateFilterMax}&#x27;
    AND
        ST_INTERSECTS(
            ST_Transform(geometry, 4326),
            ST_SetSRID(
                ST_MakeBox2D(
                        ST_Point({min_x}, {min_y}),
                        ST_Point({max_x}, {max_y})
                ),
                4326
            )
        );
    &#x27;&#x27;&#x27;

    sql = sql.format(tableName = model_config[&quot;reference&quot;][&quot;table&quot;],
                     column = model_config[&quot;reference&quot;][&quot;column&quot;],
                     targetCrs = target_crs,
                     dateFilterMin = dateFilterMin, 
                     dateFilterMax = dateFilterMax,
                     min_x = bounds_for_classification[0],
                     min_y = bounds_for_classification[1],
                     max_x = bounds_for_classification[2],
                     max_y = bounds_for_classification[3],
                    )
    
    parcels_to_process = gpd.GeoDataFrame.from_postgis(sql, db_conn, geom_col=&#x27;geometry&#x27;, )


# remap id
parcels_to_process[&quot;ct&quot;] = parcels_to_process[&quot;ctnuml4a&quot;].apply(lambda x: ctnuml4aToctMapping[x])</code></pre><button title="Copy to Clipboard" class="inline-flex items-center opacity-0 group-hover:opacity-100 hover:opacity-100 focus:opacity-100 active:opacity-100 cursor-pointer ml-2 transition-color duration-200 ease-in-out text-blue-400 hover:text-blue-500 absolute right-1 top-1" aria-pressed="false" aria-label="Copy code to clipboard"><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" aria-hidden="true" data-slot="icon" width="24" height="24"><path stroke-linecap="round" stroke-linejoin="round" d="M15.75 17.25v3.375c0 .621-.504 1.125-1.125 1.125h-9.75a1.125 1.125 0 0 1-1.125-1.125V7.875c0-.621.504-1.125 1.125-1.125H6.75a9.06 9.06 0 0 1 1.5.124m7.5 10.376h3.375c.621 0 1.125-.504 1.125-1.125V11.25c0-4.46-3.243-8.161-7.5-8.876a9.06 9.06 0 0 0-1.5-.124H9.375c-.621 0-1.125.504-1.125 1.125v3.5m7.5 10.375H9.375a1.125 1.125 0 0 1-1.125-1.125v-9.25m12 6.625v-1.875a3.375 3.375 0 0 0-3.375-3.375h-1.5a1.125 1.125 0 0 1-1.125-1.125v-1.5a3.375 3.375 0 0 0-3.375-3.375H9.75"></path></svg></button></div><div data-mdast-node-id="ztzZdAolxta8cCGX17Bd7" class="max-w-full overflow-y-visible overflow-x-auto m-0 group not-prose relative text-left"></div></div><div id="AGcmxavqQA" class="relative group/block"><div class="flex sticky top-[80px] z-10 opacity-70 group-hover/block:opacity-100 group-hover/block:hidden"><div class="absolute top-0 -right-[28px] flex md:flex-col"></div></div><div class="hidden sticky top-[80px] z-10 opacity-70 group-hover/block:opacity-100 group-hover/block:flex"><div class="absolute top-0 -right-[28px] flex md:flex-col"></div></div><div class="relative group not-prose overflow-auto shadow hover:shadow-md dark:shadow-2xl dark:shadow-neutral-900 my-5 text-sm border border-l-4 border-l-blue-400 border-gray-200 dark:border-l-blue-400 dark:border-gray-800"><pre class="block p-3 hljs" style="background-color:unset"><code class="language-python" style="white-space:pre">parcels_to_process</code></pre><button title="Copy to Clipboard" class="inline-flex items-center opacity-0 group-hover:opacity-100 hover:opacity-100 focus:opacity-100 active:opacity-100 cursor-pointer ml-2 transition-color duration-200 ease-in-out text-blue-400 hover:text-blue-500 absolute right-1 top-1" aria-pressed="false" aria-label="Copy code to clipboard"><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" aria-hidden="true" data-slot="icon" width="24" height="24"><path stroke-linecap="round" stroke-linejoin="round" d="M15.75 17.25v3.375c0 .621-.504 1.125-1.125 1.125h-9.75a1.125 1.125 0 0 1-1.125-1.125V7.875c0-.621.504-1.125 1.125-1.125H6.75a9.06 9.06 0 0 1 1.5.124m7.5 10.376h3.375c.621 0 1.125-.504 1.125-1.125V11.25c0-4.46-3.243-8.161-7.5-8.876a9.06 9.06 0 0 0-1.5-.124H9.375c-.621 0-1.125.504-1.125 1.125v3.5m7.5 10.375H9.375a1.125 1.125 0 0 1-1.125-1.125v-9.25m12 6.625v-1.875a3.375 3.375 0 0 0-3.375-3.375h-1.5a1.125 1.125 0 0 1-1.125-1.125v-1.5a3.375 3.375 0 0 0-3.375-3.375H9.75"></path></svg></button></div><div data-mdast-node-id="IeW04KWUDF-yTE4PdT5Lk" class="max-w-full overflow-y-visible overflow-x-auto m-0 group not-prose relative text-left mb-5"><div><div class="p-2.5">Loading...</div></div></div></div><div id="y9HfdibFxj" class="relative group/block"><h3 id="execute-workflow-1" class="relative group"><span class="heading-text">Execute workflow</span><a class="no-underline text-inherit hover:text-inherit inline-block w-0 px-0 translate-x-[10px] font-normal select-none transition-opacity opacity-0 focus:opacity-100 group-hover:opacity-70" href="#execute-workflow-1" title="Link to this Section" aria-label="Link to this Section">¶</a></h3><p>classification data is added to the database</p></div><div id="hDZGU5YWoZ" class="relative group/block"><div class="flex sticky top-[80px] z-10 opacity-70 group-hover/block:opacity-100 group-hover/block:hidden"><div class="absolute top-0 -right-[28px] flex md:flex-col"></div></div><div class="hidden sticky top-[80px] z-10 opacity-70 group-hover/block:opacity-100 group-hover/block:flex"><div class="absolute top-0 -right-[28px] flex md:flex-col"></div></div><div class="relative group not-prose overflow-auto shadow hover:shadow-md dark:shadow-2xl dark:shadow-neutral-900 my-5 text-sm border border-l-4 border-l-blue-400 border-gray-200 dark:border-l-blue-400 dark:border-gray-800"><pre class="block p-3 hljs" style="background-color:unset"><code class="language-python" style="white-space:pre">execution_args = []

for i in range(len(parcels_to_process)):
    
    # Data Frame for current parcel
    parcel_df = parcels_to_process[parcels_to_process.index == i]
    parcel = parcel_df.iloc[0]
    
    bbox = BBox(parcel.geometry.bounds, crs=target_crs)    

    execution_args.append({
        add_data: {&#x27;bbox&#x27;: bbox, &#x27;time_interval&#x27;: selected_date_interval_for_satellite_imagery},
        add_parcel: {&#x27;data&#x27;: parcel_df},
        classification_to_db: {&#x27;parcel_id&#x27;: int(parcel.ogd_id)}
    })


executor = EOExecutor(workflow, execution_args, save_logs=True)
executor.run(workers=1, multiprocess=False)

executor.make_report()</code></pre><button title="Copy to Clipboard" class="inline-flex items-center opacity-0 group-hover:opacity-100 hover:opacity-100 focus:opacity-100 active:opacity-100 cursor-pointer ml-2 transition-color duration-200 ease-in-out text-blue-400 hover:text-blue-500 absolute right-1 top-1" aria-pressed="false" aria-label="Copy code to clipboard"><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" aria-hidden="true" data-slot="icon" width="24" height="24"><path stroke-linecap="round" stroke-linejoin="round" d="M15.75 17.25v3.375c0 .621-.504 1.125-1.125 1.125h-9.75a1.125 1.125 0 0 1-1.125-1.125V7.875c0-.621.504-1.125 1.125-1.125H6.75a9.06 9.06 0 0 1 1.5.124m7.5 10.376h3.375c.621 0 1.125-.504 1.125-1.125V11.25c0-4.46-3.243-8.161-7.5-8.876a9.06 9.06 0 0 0-1.5-.124H9.375c-.621 0-1.125.504-1.125 1.125v3.5m7.5 10.375H9.375a1.125 1.125 0 0 1-1.125-1.125v-9.25m12 6.625v-1.875a3.375 3.375 0 0 0-3.375-3.375h-1.5a1.125 1.125 0 0 1-1.125-1.125v-1.5a3.375 3.375 0 0 0-3.375-3.375H9.75"></path></svg></button></div><div data-mdast-node-id="oN3J-l1cNHJdwgxZfixwr" class="max-w-full overflow-y-visible overflow-x-auto m-0 group not-prose relative text-left mb-5"><div><div class="p-2.5">Loading...</div></div></div></div><div id="lrhej3yKti" class="relative group/block"><h2 id="show-classification-results" class="relative group"><span class="heading-text">Show classification results</span><a class="no-underline text-inherit hover:text-inherit inline-block w-0 px-0 translate-x-[10px] font-normal select-none transition-opacity opacity-0 focus:opacity-100 group-hover:opacity-70" href="#show-classification-results" title="Link to this Section" aria-label="Link to this Section">¶</a></h2><p>First 20 classified parcels within the defined bounding box</p></div><div id="yRr7EpgQTk" class="relative group/block"><div class="flex sticky top-[80px] z-10 opacity-70 group-hover/block:opacity-100 group-hover/block:hidden"><div class="absolute top-0 -right-[28px] flex md:flex-col"></div></div><div class="hidden sticky top-[80px] z-10 opacity-70 group-hover/block:opacity-100 group-hover/block:flex"><div class="absolute top-0 -right-[28px] flex md:flex-col"></div></div><div class="relative group not-prose overflow-auto shadow hover:shadow-md dark:shadow-2xl dark:shadow-neutral-900 my-5 text-sm border border-l-4 border-l-blue-400 border-gray-200 dark:border-l-blue-400 dark:border-gray-800"><pre class="block p-3 hljs" style="background-color:unset"><code class="language-python" style="white-space:pre">
with psycopg2.connect(**db_conn_params) as db_conn:
    with db_conn.cursor() as cur:

        sql = &#x27;&#x27;&#x27;
            SELECT 
                parcel_id,
                ref_date,
                model_id,
                prediction -&gt; 0,
                prediction -&gt; 1,
                prediction -&gt; 2
            FROM classification_at
            WHERE
                model_id = {model_id} AND
                ref_date = &#x27;2018-06-30&#x27;
            LIMIT 20
        &#x27;&#x27;&#x27;.format(model_id=model_id)

        cur.execute(sql)
        result = cur.fetchall()</code></pre><button title="Copy to Clipboard" class="inline-flex items-center opacity-0 group-hover:opacity-100 hover:opacity-100 focus:opacity-100 active:opacity-100 cursor-pointer ml-2 transition-color duration-200 ease-in-out text-blue-400 hover:text-blue-500 absolute right-1 top-1" aria-pressed="false" aria-label="Copy code to clipboard"><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" aria-hidden="true" data-slot="icon" width="24" height="24"><path stroke-linecap="round" stroke-linejoin="round" d="M15.75 17.25v3.375c0 .621-.504 1.125-1.125 1.125h-9.75a1.125 1.125 0 0 1-1.125-1.125V7.875c0-.621.504-1.125 1.125-1.125H6.75a9.06 9.06 0 0 1 1.5.124m7.5 10.376h3.375c.621 0 1.125-.504 1.125-1.125V11.25c0-4.46-3.243-8.161-7.5-8.876a9.06 9.06 0 0 0-1.5-.124H9.375c-.621 0-1.125.504-1.125 1.125v3.5m7.5 10.375H9.375a1.125 1.125 0 0 1-1.125-1.125v-9.25m12 6.625v-1.875a3.375 3.375 0 0 0-3.375-3.375h-1.5a1.125 1.125 0 0 1-1.125-1.125v-1.5a3.375 3.375 0 0 0-3.375-3.375H9.75"></path></svg></button></div><div data-mdast-node-id="m9siwrq4KRLTll8tM2aw5" class="max-w-full overflow-y-visible overflow-x-auto m-0 group not-prose relative text-left"></div></div><div id="bfPIYMlEIK" class="relative group/block"><div class="flex sticky top-[80px] z-10 opacity-70 group-hover/block:opacity-100 group-hover/block:hidden"><div class="absolute top-0 -right-[28px] flex md:flex-col"></div></div><div class="hidden sticky top-[80px] z-10 opacity-70 group-hover/block:opacity-100 group-hover/block:flex"><div class="absolute top-0 -right-[28px] flex md:flex-col"></div></div><div class="relative group not-prose overflow-auto shadow hover:shadow-md dark:shadow-2xl dark:shadow-neutral-900 my-5 text-sm border border-l-4 border-l-blue-400 border-gray-200 dark:border-l-blue-400 dark:border-gray-800"><pre class="block p-3 hljs" style="background-color:unset"><code class="language-python" style="white-space:pre">pd.DataFrame(result, columns=[&quot;ogd_id&quot;, &quot;ref_date&quot;, &quot;model_id&quot;, &quot;1st_classification&quot;, &quot;2nd_classification&quot;, &quot;3rd_classification&quot;])</code></pre><button title="Copy to Clipboard" class="inline-flex items-center opacity-0 group-hover:opacity-100 hover:opacity-100 focus:opacity-100 active:opacity-100 cursor-pointer ml-2 transition-color duration-200 ease-in-out text-blue-400 hover:text-blue-500 absolute right-1 top-1" aria-pressed="false" aria-label="Copy code to clipboard"><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" aria-hidden="true" data-slot="icon" width="24" height="24"><path stroke-linecap="round" stroke-linejoin="round" d="M15.75 17.25v3.375c0 .621-.504 1.125-1.125 1.125h-9.75a1.125 1.125 0 0 1-1.125-1.125V7.875c0-.621.504-1.125 1.125-1.125H6.75a9.06 9.06 0 0 1 1.5.124m7.5 10.376h3.375c.621 0 1.125-.504 1.125-1.125V11.25c0-4.46-3.243-8.161-7.5-8.876a9.06 9.06 0 0 0-1.5-.124H9.375c-.621 0-1.125.504-1.125 1.125v3.5m7.5 10.375H9.375a1.125 1.125 0 0 1-1.125-1.125v-9.25m12 6.625v-1.875a3.375 3.375 0 0 0-3.375-3.375h-1.5a1.125 1.125 0 0 1-1.125-1.125v-1.5a3.375 3.375 0 0 0-3.375-3.375H9.75"></path></svg></button></div><div data-mdast-node-id="fdg2_j6Webb6ji8YVsgIw" class="max-w-full overflow-y-visible overflow-x-auto m-0 group not-prose relative text-left mb-5"><div><div class="p-2.5">Loading...</div></div></div></div><div></div></main></article><script>((a,d)=>{if(!window.history.state||!window.history.state.key){let h=Math.random().toString(32).slice(2);window.history.replaceState({key:h},"")}try{let f=JSON.parse(sessionStorage.getItem(a)||"{}")[d||window.history.state.key];typeof f=="number"&&window.scrollTo(0,f)}catch(h){console.error(h),sessionStorage.removeItem(a)}})("positions", null)</script><link rel="modulepreload" href="/notebooks_test/build/entry.client-UNPC4GT3.js"/><link rel="modulepreload" href="/notebooks_test/build/_shared/chunk-OCTKKCIL.js"/><link rel="modulepreload" href="/notebooks_test/build/_shared/chunk-UAI5KRM7.js"/><link rel="modulepreload" href="/notebooks_test/build/_shared/chunk-2NH4LW52.js"/><link rel="modulepreload" href="/notebooks_test/build/_shared/chunk-IZFMW3M4.js"/><link rel="modulepreload" href="/notebooks_test/build/_shared/chunk-HBJK6BW3.js"/><link rel="modulepreload" href="/notebooks_test/build/_shared/chunk-HYMQ7M2K.js"/><link rel="modulepreload" href="/notebooks_test/build/_shared/chunk-OHOXABTA.js"/><link rel="modulepreload" href="/notebooks_test/build/_shared/chunk-OCWQY3HK.js"/><link rel="modulepreload" href="/notebooks_test/build/_shared/chunk-CPTH56EW.js"/><link rel="modulepreload" href="/notebooks_test/build/_shared/chunk-3CVK3PYF.js"/><link rel="modulepreload" href="/notebooks_test/build/_shared/chunk-J6FHCSRC.js"/><link rel="modulepreload" href="/notebooks_test/build/_shared/chunk-S4SWV34C.js"/><link rel="modulepreload" href="/notebooks_test/build/_shared/chunk-GUCIBHGO.js"/><link rel="modulepreload" href="/notebooks_test/build/root-QGLRP2PL.js"/><link rel="modulepreload" href="/notebooks_test/build/_shared/chunk-CB3BH7WY.js"/><link rel="modulepreload" href="/notebooks_test/build/routes/$-7JYT5576.js"/><script>window.__remixContext = {"url":"/external-notebooks/eurodatacube/notebooks/notebooks/contributions/edc-usecase-lpis-crop-type-classification","state":{"loaderData":{"root":{"config":{"version":1,"myst":"1.3.25","options":{"hide_toc":true,"hide_footer_links":true,"folders":true},"nav":[],"actions":[],"projects":[{"github":"https://github.com/eoxhub-workspaces/documentation/","id":"5aa0318b-5bc1-41e2-b1d4-053e8b61961b","exports":[],"bibliography":[],"title":"Location for eodashboard notebooks","index":"readme","pages":[{"title":"External Notebooks","level":1},{"title":"Eurodatacube","level":2},{"title":"Notebooks","level":3},{"slug":"external-notebooks.eurodatacube.notebooks.readme","title":"Jupyter notebooks","description":"","date":"","thumbnail":"","thumbnailOptimized":"","banner":"","bannerOptimized":"","tags":[],"level":4},{"title":"Notebooks","level":4},{"slug":"external-notebooks.eurodatacube.notebooks.notebooks.readme","title":"Euro Data Cube Notebooks","description":"","date":"","thumbnail":"","thumbnailOptimized":"","banner":"","bannerOptimized":"","tags":[],"level":5},{"title":"Contributions","level":5},{"slug":"external-notebooks.eurodatacube.notebooks.notebooks.contributions.aireo-pilot-dataset-ai4arctic-sea-ice","title":"Introduction","description":"","date":"","thumbnail":"","thumbnailOptimized":"","banner":"","bannerOptimized":"","tags":[],"level":6},{"slug":"external-notebooks.eurodatacube.notebooks.notebooks.contributions.aireo-pilot-dataset-biomass-forest-observation-sys","title":"AIREO pilot dataset - Biomass (Forest Observation System)","description":"","date":"","thumbnail":"","thumbnailOptimized":"","banner":"","bannerOptimized":"","tags":[],"level":6},{"slug":"external-notebooks.eurodatacube.notebooks.notebooks.contributions.aireo-pilot-dataset-cap","title":"Introduction","description":"","date":"","thumbnail":"","thumbnailOptimized":"","banner":"","bannerOptimized":"","tags":[],"level":6},{"slug":"external-notebooks.eurodatacube.notebooks.notebooks.contributions.aireo-pilot-dataset-spacenet7","title":"Introduction","description":"","date":"","thumbnail":"","thumbnailOptimized":"","banner":"","bannerOptimized":"","tags":[],"level":6},{"slug":"external-notebooks.eurodatacube.notebooks.notebooks.contributions.aot-covid19","title":"Aerosol Optical Thickness (AOT) Anomaly Detection Using Sentinel-2","description":"","date":"","thumbnail":"","thumbnailOptimized":"","banner":"","bannerOptimized":"","tags":[],"level":6},{"slug":"external-notebooks.eurodatacube.notebooks.notebooks.contributions.batch-zarr-output","title":"Generating Zarr data cubes with Sentinel Hub Batch API","description":"","date":"","thumbnail":"/notebooks_test/build/68dffbf744fa42f4bf3d35e55684984e.png","thumbnailOptimized":"","banner":"","bannerOptimized":"","tags":[],"level":6},{"slug":"external-notebooks.eurodatacube.notebooks.notebooks.contributions.client-side-processing-using-mass-sh","title":"Important notes","description":"","date":"","thumbnail":"","thumbnailOptimized":"","banner":"","bannerOptimized":"","tags":[],"level":6},{"slug":"external-notebooks.eurodatacube.notebooks.notebooks.contributions.cmems-data-download","title":"Cmems Data Download","description":"","date":"","thumbnail":"","thumbnailOptimized":"","banner":"","bannerOptimized":"","tags":[],"level":6},{"slug":"external-notebooks.eurodatacube.notebooks.notebooks.contributions.detect-trucks-sentinel2","title":"Detect Trucks using Sentinel-2 data","description":"","date":"","thumbnail":"","thumbnailOptimized":"","banner":"","bannerOptimized":"","tags":[],"level":6},{"slug":"external-notebooks.eurodatacube.notebooks.notebooks.contributions.drought-monitoring","title":"Drought impact monitoring platform","description":"","date":"","thumbnail":"/notebooks_test/build/ad5c19782b006f72352ae57794305840.png","thumbnailOptimized":"","banner":"","bannerOptimized":"","tags":[],"level":6},{"slug":"external-notebooks.eurodatacube.notebooks.notebooks.contributions.edc-africa-cube-africa-custom-contest","title":"Custom Script Contest – Urban Growth in Africa","description":"","date":"","thumbnail":"/notebooks_test/build/e9275f3fe80a704e2f5aa1ec1220e48a.jpeg","thumbnailOptimized":"","banner":"","bannerOptimized":"","tags":[],"level":6},{"slug":"external-notebooks.eurodatacube.notebooks.notebooks.contributions.edc-byoc-tutorial","title":"How to bring your own data to EDC: Using Sentinel Hub Python package","description":"","date":"","thumbnail":"","thumbnailOptimized":"","banner":"","bannerOptimized":"","tags":[],"level":6},{"slug":"external-notebooks.eurodatacube.notebooks.notebooks.contributions.edc-demo-phi-week-v2","title":"xcube-gen and xcube-geodb Hands-On Workshop Φ-Week 2020","description":"","date":"","thumbnail":"","thumbnailOptimized":"","banner":"","bannerOptimized":"","tags":[],"level":6},{"slug":"external-notebooks.eurodatacube.notebooks.notebooks.contributions.edc-geodb-4-eurocrops-demo","title":"Demonstration of Eurocrops data use in geoDB","description":"","date":"","thumbnail":"","thumbnailOptimized":"","banner":"","bannerOptimized":"","tags":[],"level":6},{"slug":"external-notebooks.eurodatacube.notebooks.notebooks.contributions.edc-notebook-lstm","title":"South Africa Crop Type Classification on Euro Data Cube (EDC)","description":"","date":"","thumbnail":"","thumbnailOptimized":"","banner":"","bannerOptimized":"","tags":[],"level":6},{"slug":"external-notebooks.eurodatacube.notebooks.notebooks.contributions.edc-usecase-lpis-crop-type-classification","title":"Important notes","description":"","date":"","thumbnail":"","thumbnailOptimized":"","banner":"","bannerOptimized":"","tags":[],"level":6},{"slug":"external-notebooks.eurodatacube.notebooks.notebooks.contributions.eurocrops-crop-classification-example","title":"Crop-classification using Sentinel-2 time-series","description":"","date":"","thumbnail":"","thumbnailOptimized":"","banner":"","bannerOptimized":"","tags":[],"level":6},{"slug":"external-notebooks.eurodatacube.notebooks.notebooks.contributions.ghsl-urban-delineation","title":"\u003cb\u003eUrban delineation\u003cb\u003e","description":"","date":"","thumbnail":"/notebooks_test/build/7bbf545a5eae1d9ebdb91ae42b261063.png","thumbnailOptimized":"","banner":"","bannerOptimized":"","tags":[],"level":6},{"slug":"external-notebooks.eurodatacube.notebooks.notebooks.contributions.globalearthmonitor-example","title":"Pre-requisites","description":"","date":"","thumbnail":"/notebooks_test/build/205c1ded6bd59771975a9fbd3753fd3b.png","thumbnailOptimized":"","banner":"","bannerOptimized":"","tags":[],"level":6},{"slug":"external-notebooks.eurodatacube.notebooks.notebooks.contributions.gpu-support-eoxhub","title":"GPU-Support on EOxHub","description":"","date":"","thumbnail":"","thumbnailOptimized":"","banner":"","bannerOptimized":"","tags":[],"level":6},{"slug":"external-notebooks.eurodatacube.notebooks.notebooks.contributions.gran-chaco-phiweek","title":"ESA EO \\phi- week 2020","description":"","date":"","thumbnail":"/notebooks_test/build/80cee7db6cdc7002ceedda5689f889fa.jpeg","thumbnailOptimized":"","banner":"","bannerOptimized":"","tags":[],"level":6},{"slug":"external-notebooks.eurodatacube.notebooks.notebooks.contributions.howtolulc-batch-updated-210621","title":"How To: Land-Use-Land-Cover Prediction for Slovenia - using the Batch Processing API","description":"","date":"","thumbnail":"","thumbnailOptimized":"","banner":"","bannerOptimized":"","tags":[],"level":6},{"slug":"external-notebooks.eurodatacube.notebooks.notebooks.contributions.lpis-lulc-slo","title":"LPIS Use Case for Land Use / Land Cover Classification","description":"","date":"","thumbnail":"","thumbnailOptimized":"","banner":"","bannerOptimized":"","tags":[],"level":6},{"slug":"external-notebooks.eurodatacube.notebooks.notebooks.contributions.lps2022-leverage-euro-data-cube-services","title":"Living Planet Symposium 2022 Training Session","description":"","date":"","thumbnail":"","thumbnailOptimized":"","banner":"","bannerOptimized":"","tags":[],"level":6},{"slug":"external-notebooks.eurodatacube.notebooks.notebooks.contributions.no2-analysis-covid19-lockdowns","title":"Impact of Covid19 induced lockdown on NO2 levels","description":"","date":"","thumbnail":"","thumbnailOptimized":"","banner":"","bannerOptimized":"","tags":[],"level":6},{"slug":"external-notebooks.eurodatacube.notebooks.notebooks.contributions.no2-so2-trend-veda-api-igarss-2023","title":"Using the NASA VEDA EOAPI","description":"","date":"","thumbnail":"","thumbnailOptimized":"","banner":"","bannerOptimized":"","tags":[],"level":6},{"slug":"external-notebooks.eurodatacube.notebooks.notebooks.contributions.ogc-edc","title":"Important notes","description":"","date":"","thumbnail":"","thumbnailOptimized":"","banner":"","bannerOptimized":"","tags":[],"level":6},{"slug":"external-notebooks.eurodatacube.notebooks.notebooks.contributions.openeo-client-demo","title":"openEO Client Demo","description":"","date":"","thumbnail":"","thumbnailOptimized":"","banner":"","bannerOptimized":"","tags":[],"level":6},{"slug":"external-notebooks.eurodatacube.notebooks.notebooks.contributions.race-finishedgoodsinventory-inidcator","title":"Finished Goods Inventory indicator for RACE","description":"","date":"","thumbnail":"","thumbnailOptimized":"","banner":"","bannerOptimized":"","tags":[],"level":6},{"slug":"external-notebooks.eurodatacube.notebooks.notebooks.contributions.third-party-planetscope","title":"Third Party Data Import - PlanetScope","description":"","date":"","thumbnail":"","thumbnailOptimized":"","banner":"","bannerOptimized":"","tags":[],"level":6},{"slug":"external-notebooks.eurodatacube.notebooks.notebooks.contributions.xcube-access-datasets","title":"Using xcube to access non-commercial and commercial data sets","description":"","date":"","thumbnail":"","thumbnailOptimized":"","banner":"","bannerOptimized":"","tags":[],"level":6},{"slug":"external-notebooks.eurodatacube.notebooks.notebooks.contributions.xcube-viewer-as-a-service-in-edc1","title":"Visualizing data with xcube viewer in EuroDataCube","description":"","date":"","thumbnail":"","thumbnailOptimized":"","banner":"","bannerOptimized":"","tags":[],"level":6},{"slug":"external-notebooks.eurodatacube.notebooks.notebooks.contributions.dapa.dapa-evaluation-workshop","title":"DAPA Evaluation Workshop: Introduction \u0026 Documentation","description":"","date":"","thumbnail":"","thumbnailOptimized":"","banner":"","bannerOptimized":"","tags":[],"level":6},{"slug":"external-notebooks.eurodatacube.notebooks.notebooks.contributions.dapa.dapa-tutorial-1-cube-sentinel-2","title":"DAPA Tutorial #1: Cube - Sentinel-2","description":"","date":"","thumbnail":"","thumbnailOptimized":"","banner":"","bannerOptimized":"","tags":[],"level":6},{"slug":"external-notebooks.eurodatacube.notebooks.notebooks.contributions.dapa.dapa-tutorial-2-area-sentinel-2","title":"DAPA Tutorial #2: Area - Sentinel-2","description":"","date":"","thumbnail":"","thumbnailOptimized":"","banner":"","bannerOptimized":"","tags":[],"level":6},{"slug":"external-notebooks.eurodatacube.notebooks.notebooks.contributions.dapa.dapa-tutorial-3-timeseries-sentinel-2","title":"DAPA Tutorial #3: Timeseries - Sentinel-2","description":"","date":"","thumbnail":"","thumbnailOptimized":"","banner":"","bannerOptimized":"","tags":[],"level":6},{"slug":"external-notebooks.eurodatacube.notebooks.notebooks.contributions.dapa.dapa-tutorial-4-value-sentinel-2","title":"DAPA Tutorial #4: Value - Sentinel-2","description":"","date":"","thumbnail":"","thumbnailOptimized":"","banner":"","bannerOptimized":"","tags":[],"level":6},{"slug":"external-notebooks.eurodatacube.notebooks.notebooks.contributions.dapa.dapa-tutorial-5-dem","title":"DAPA Tutorial #5: DEM","description":"","date":"","thumbnail":"","thumbnailOptimized":"","banner":"","bannerOptimized":"","tags":[],"level":6},{"slug":"external-notebooks.eurodatacube.notebooks.notebooks.contributions.fairicube.fairicube-data-access-demonstration","title":"EDC Sentinel Hub - data access using xcube","description":"","date":"","thumbnail":"","thumbnailOptimized":"","banner":"","bannerOptimized":"","tags":[],"level":6},{"slug":"external-notebooks.eurodatacube.notebooks.notebooks.contributions.igarss2022.igarss-22-australian-bushfires","title":"Australian Bushfires","description":"","date":"","thumbnail":"/notebooks_test/build/ab194b4f8c40a2b9d64d8a85e37ce1fd.png","thumbnailOptimized":"","banner":"","bannerOptimized":"","tags":["IGARSS-22","EO Dashboard"],"level":6},{"slug":"external-notebooks.eurodatacube.notebooks.notebooks.contributions.igarss2022.igarss-22-data-access","title":"Data Access","description":"","date":"","thumbnail":"","thumbnailOptimized":"","banner":"","bannerOptimized":"","tags":[],"level":6},{"slug":"external-notebooks.eurodatacube.notebooks.notebooks.contributions.igarss2022.igarss-22-detect-trucks-sentinel2","title":"Truck Detection Exercise","description":"","date":"","thumbnail":"","thumbnailOptimized":"","banner":"","bannerOptimized":"","tags":[],"level":6},{"slug":"external-notebooks.eurodatacube.notebooks.notebooks.contributions.igarss2022.igarss-22-lockdown-in-venice","title":"Environmental Impacts of Lockdown in Venice, Italy during 2020","description":"","date":"","thumbnail":"","thumbnailOptimized":"","banner":"","bannerOptimized":"","tags":[],"level":6},{"slug":"external-notebooks.eurodatacube.notebooks.notebooks.contributions.igarss2022.igarss-22-nasa-api-lockdown-in-venice","title":"Lockdown in Venice","description":"","date":"","thumbnail":"","thumbnailOptimized":"","banner":"","bannerOptimized":"","tags":[],"level":6},{"slug":"external-notebooks.eurodatacube.notebooks.notebooks.contributions.igarss2022.igarss-22-no2-timeseries-analysis","title":"NO2 timeseries analysis","description":"","date":"","thumbnail":"","thumbnailOptimized":"","banner":"","bannerOptimized":"","tags":[],"level":6},{"slug":"external-notebooks.eurodatacube.notebooks.notebooks.contributions.igarss2022.igarss-22-timeseries-stac-api-single-vs-multi","title":"Time series using STAC API statistics endpoints","description":"","date":"","thumbnail":"","thumbnailOptimized":"","banner":"","bannerOptimized":"","tags":[],"level":6},{"title":"Curated","level":5},{"slug":"external-notebooks.eurodatacube.notebooks.notebooks.curated.access-iacs-data","title":"How to access IACS Spatial Data","description":"","date":"","thumbnail":"","thumbnailOptimized":"","banner":"","bannerOptimized":"","tags":[],"level":6},{"slug":"external-notebooks.eurodatacube.notebooks.notebooks.curated.edc-access-cci-data","title":"Access CCI data with xcube","description":"","date":"","thumbnail":"","thumbnailOptimized":"","banner":"","bannerOptimized":"","tags":[],"level":6},{"slug":"external-notebooks.eurodatacube.notebooks.notebooks.curated.edc-first-steps","title":"First steps on the Euro Data Cube platform","description":"","date":"","thumbnail":"","thumbnailOptimized":"","banner":"","bannerOptimized":"","tags":[],"level":6},{"slug":"external-notebooks.eurodatacube.notebooks.notebooks.curated.edc-geodb-1-manage-datasets-v11","title":"Manage Collections in your GeoDB","description":"","date":"","thumbnail":"","thumbnailOptimized":"","banner":"","bannerOptimized":"","tags":[],"level":6},{"slug":"external-notebooks.eurodatacube.notebooks.notebooks.curated.edc-geodb-2-explore-datasets-2","title":"Exploring Data","description":"","date":"","thumbnail":"","thumbnailOptimized":"","banner":"","bannerOptimized":"","tags":[],"level":6},{"slug":"external-notebooks.eurodatacube.notebooks.notebooks.curated.edc-geodb-3-share-datasets1","title":"Sharing Data","description":"","date":"","thumbnail":"","thumbnailOptimized":"","banner":"","bannerOptimized":"","tags":[],"level":6},{"slug":"external-notebooks.eurodatacube.notebooks.notebooks.curated.edc-geodb-access-urban-atlas-data-v1","title":"[xcube-geodb] How to accesss EEA Urban Atlas Data","description":"","date":"","thumbnail":"","thumbnailOptimized":"","banner":"","bannerOptimized":"","tags":[],"level":6},{"slug":"external-notebooks.eurodatacube.notebooks.notebooks.curated.edc-sentinel-hub-data-access","title":"EDC Sentinel Hub - data access using xcube","description":"","date":"","thumbnail":"","thumbnailOptimized":"","banner":"","bannerOptimized":"","tags":[],"level":6},{"slug":"external-notebooks.eurodatacube.notebooks.notebooks.curated.edc-sentinelhub-datafusion-basic","title":"EDC Sentinel Hub: Data Fusion","description":"","date":"","thumbnail":"","thumbnailOptimized":"","banner":"","bannerOptimized":"","tags":[],"level":6},{"slug":"external-notebooks.eurodatacube.notebooks.notebooks.curated.edc-sentinelhub-datafusion-ndvi","title":"EDC Sentinel Hub: Data Fusion","description":"","date":"","thumbnail":"","thumbnailOptimized":"","banner":"","bannerOptimized":"","tags":[],"level":6},{"slug":"external-notebooks.eurodatacube.notebooks.notebooks.curated.edc-sentinel-hub-datasets","title":"EDC Sentinel Hub - using xcube to access different data sets in Sentinel Hub","description":"","date":"","thumbnail":"","thumbnailOptimized":"","banner":"","bannerOptimized":"","tags":[],"level":6},{"slug":"external-notebooks.eurodatacube.notebooks.notebooks.curated.edc-sentinel-hub-setup","title":"Setup for EDC core API access using xcube client library","description":"","date":"","thumbnail":"","thumbnailOptimized":"","banner":"","bannerOptimized":"","tags":[],"level":6},{"slug":"external-notebooks.eurodatacube.notebooks.notebooks.curated.edc-sentinel-hub-xcube-integration","title":"EDC Sentinel Hub - XCUBE integration","description":"","date":"","thumbnail":"","thumbnailOptimized":"","banner":"","bannerOptimized":"","tags":[],"level":6},{"slug":"external-notebooks.eurodatacube.notebooks.notebooks.curated.edc-usecase-ndvi-timeline","title":"NDVI timeline","description":"","date":"","thumbnail":"","thumbnailOptimized":"","banner":"","bannerOptimized":"","tags":[],"level":6},{"slug":"external-notebooks.eurodatacube.notebooks.notebooks.curated.eo-learn","title":"Using eo-learn in EDC: a starter’s guide.","description":"","date":"","thumbnail":"/notebooks_test/build/5a1f8475f0c3652f4630d03d72891b98.png","thumbnailOptimized":"","banner":"","bannerOptimized":"","tags":[],"level":6},{"slug":"external-notebooks.eurodatacube.notebooks.notebooks.curated.esdl-edc-v0-2","title":"Earth System Data Lab Tutorial @ Euro Data Cube","description":"","date":"","thumbnail":"","thumbnailOptimized":"","banner":"","bannerOptimized":"","tags":[],"level":6},{"slug":"external-notebooks.eurodatacube.notebooks.notebooks.curated.exploring-time-and-space-with-edc","title":"Exploring Time and Space: A guide to accessing, analysing and visualising data in the Euro Data Cube","description":"","date":"","thumbnail":"","thumbnailOptimized":"","banner":"","bannerOptimized":"","tags":[],"level":6},{"slug":"external-notebooks.eurodatacube.notebooks.notebooks.curated.how-to-access-dem-data-through-sentinel-hub-api","title":"How to access DEM data through Sentinel Hub API","description":"","date":"","thumbnail":"","thumbnailOptimized":"","banner":"","bannerOptimized":"","tags":[],"level":6},{"slug":"external-notebooks.eurodatacube.notebooks.notebooks.curated.sentinelhub-py","title":"Using Sentinel Hub Process API in EDC: a starter’s guide.","description":"","date":"","thumbnail":"/notebooks_test/build/01e22903839391bc356ac886ec2b2fa7.png","thumbnailOptimized":"","banner":"","bannerOptimized":"","tags":[],"level":6},{"title":"Notebooks","level":1},{"slug":"notebooks.example1","title":"📘 Example Notebook 1","description":"","date":"","thumbnail":"","thumbnailOptimized":"","banner":"","bannerOptimized":"","tags":[],"level":2},{"slug":"notebooks.example2","title":"📘 Example Notebook 2","description":"","date":"","thumbnail":"","thumbnailOptimized":"","banner":"","bannerOptimized":"","tags":[],"level":2}]}]},"CONTENT_CDN_PORT":"3100","MODE":"static","BASE_URL":"/notebooks_test"},"routes/$":{"config":{"version":1,"myst":"1.3.25","options":{"hide_toc":true,"hide_footer_links":true,"folders":true},"nav":[],"actions":[],"projects":[{"github":"https://github.com/eoxhub-workspaces/documentation/","id":"5aa0318b-5bc1-41e2-b1d4-053e8b61961b","exports":[],"bibliography":[],"title":"Location for eodashboard notebooks","index":"readme","pages":[{"title":"External Notebooks","level":1},{"title":"Eurodatacube","level":2},{"title":"Notebooks","level":3},{"slug":"external-notebooks.eurodatacube.notebooks.readme","title":"Jupyter notebooks","description":"","date":"","thumbnail":"","thumbnailOptimized":"","banner":"","bannerOptimized":"","tags":[],"level":4},{"title":"Notebooks","level":4},{"slug":"external-notebooks.eurodatacube.notebooks.notebooks.readme","title":"Euro Data Cube Notebooks","description":"","date":"","thumbnail":"","thumbnailOptimized":"","banner":"","bannerOptimized":"","tags":[],"level":5},{"title":"Contributions","level":5},{"slug":"external-notebooks.eurodatacube.notebooks.notebooks.contributions.aireo-pilot-dataset-ai4arctic-sea-ice","title":"Introduction","description":"","date":"","thumbnail":"","thumbnailOptimized":"","banner":"","bannerOptimized":"","tags":[],"level":6},{"slug":"external-notebooks.eurodatacube.notebooks.notebooks.contributions.aireo-pilot-dataset-biomass-forest-observation-sys","title":"AIREO pilot dataset - Biomass (Forest Observation System)","description":"","date":"","thumbnail":"","thumbnailOptimized":"","banner":"","bannerOptimized":"","tags":[],"level":6},{"slug":"external-notebooks.eurodatacube.notebooks.notebooks.contributions.aireo-pilot-dataset-cap","title":"Introduction","description":"","date":"","thumbnail":"","thumbnailOptimized":"","banner":"","bannerOptimized":"","tags":[],"level":6},{"slug":"external-notebooks.eurodatacube.notebooks.notebooks.contributions.aireo-pilot-dataset-spacenet7","title":"Introduction","description":"","date":"","thumbnail":"","thumbnailOptimized":"","banner":"","bannerOptimized":"","tags":[],"level":6},{"slug":"external-notebooks.eurodatacube.notebooks.notebooks.contributions.aot-covid19","title":"Aerosol Optical Thickness (AOT) Anomaly Detection Using Sentinel-2","description":"","date":"","thumbnail":"","thumbnailOptimized":"","banner":"","bannerOptimized":"","tags":[],"level":6},{"slug":"external-notebooks.eurodatacube.notebooks.notebooks.contributions.batch-zarr-output","title":"Generating Zarr data cubes with Sentinel Hub Batch API","description":"","date":"","thumbnail":"/notebooks_test/build/68dffbf744fa42f4bf3d35e55684984e.png","thumbnailOptimized":"","banner":"","bannerOptimized":"","tags":[],"level":6},{"slug":"external-notebooks.eurodatacube.notebooks.notebooks.contributions.client-side-processing-using-mass-sh","title":"Important notes","description":"","date":"","thumbnail":"","thumbnailOptimized":"","banner":"","bannerOptimized":"","tags":[],"level":6},{"slug":"external-notebooks.eurodatacube.notebooks.notebooks.contributions.cmems-data-download","title":"Cmems Data Download","description":"","date":"","thumbnail":"","thumbnailOptimized":"","banner":"","bannerOptimized":"","tags":[],"level":6},{"slug":"external-notebooks.eurodatacube.notebooks.notebooks.contributions.detect-trucks-sentinel2","title":"Detect Trucks using Sentinel-2 data","description":"","date":"","thumbnail":"","thumbnailOptimized":"","banner":"","bannerOptimized":"","tags":[],"level":6},{"slug":"external-notebooks.eurodatacube.notebooks.notebooks.contributions.drought-monitoring","title":"Drought impact monitoring platform","description":"","date":"","thumbnail":"/notebooks_test/build/ad5c19782b006f72352ae57794305840.png","thumbnailOptimized":"","banner":"","bannerOptimized":"","tags":[],"level":6},{"slug":"external-notebooks.eurodatacube.notebooks.notebooks.contributions.edc-africa-cube-africa-custom-contest","title":"Custom Script Contest – Urban Growth in Africa","description":"","date":"","thumbnail":"/notebooks_test/build/e9275f3fe80a704e2f5aa1ec1220e48a.jpeg","thumbnailOptimized":"","banner":"","bannerOptimized":"","tags":[],"level":6},{"slug":"external-notebooks.eurodatacube.notebooks.notebooks.contributions.edc-byoc-tutorial","title":"How to bring your own data to EDC: Using Sentinel Hub Python package","description":"","date":"","thumbnail":"","thumbnailOptimized":"","banner":"","bannerOptimized":"","tags":[],"level":6},{"slug":"external-notebooks.eurodatacube.notebooks.notebooks.contributions.edc-demo-phi-week-v2","title":"xcube-gen and xcube-geodb Hands-On Workshop Φ-Week 2020","description":"","date":"","thumbnail":"","thumbnailOptimized":"","banner":"","bannerOptimized":"","tags":[],"level":6},{"slug":"external-notebooks.eurodatacube.notebooks.notebooks.contributions.edc-geodb-4-eurocrops-demo","title":"Demonstration of Eurocrops data use in geoDB","description":"","date":"","thumbnail":"","thumbnailOptimized":"","banner":"","bannerOptimized":"","tags":[],"level":6},{"slug":"external-notebooks.eurodatacube.notebooks.notebooks.contributions.edc-notebook-lstm","title":"South Africa Crop Type Classification on Euro Data Cube (EDC)","description":"","date":"","thumbnail":"","thumbnailOptimized":"","banner":"","bannerOptimized":"","tags":[],"level":6},{"slug":"external-notebooks.eurodatacube.notebooks.notebooks.contributions.edc-usecase-lpis-crop-type-classification","title":"Important notes","description":"","date":"","thumbnail":"","thumbnailOptimized":"","banner":"","bannerOptimized":"","tags":[],"level":6},{"slug":"external-notebooks.eurodatacube.notebooks.notebooks.contributions.eurocrops-crop-classification-example","title":"Crop-classification using Sentinel-2 time-series","description":"","date":"","thumbnail":"","thumbnailOptimized":"","banner":"","bannerOptimized":"","tags":[],"level":6},{"slug":"external-notebooks.eurodatacube.notebooks.notebooks.contributions.ghsl-urban-delineation","title":"\u003cb\u003eUrban delineation\u003cb\u003e","description":"","date":"","thumbnail":"/notebooks_test/build/7bbf545a5eae1d9ebdb91ae42b261063.png","thumbnailOptimized":"","banner":"","bannerOptimized":"","tags":[],"level":6},{"slug":"external-notebooks.eurodatacube.notebooks.notebooks.contributions.globalearthmonitor-example","title":"Pre-requisites","description":"","date":"","thumbnail":"/notebooks_test/build/205c1ded6bd59771975a9fbd3753fd3b.png","thumbnailOptimized":"","banner":"","bannerOptimized":"","tags":[],"level":6},{"slug":"external-notebooks.eurodatacube.notebooks.notebooks.contributions.gpu-support-eoxhub","title":"GPU-Support on EOxHub","description":"","date":"","thumbnail":"","thumbnailOptimized":"","banner":"","bannerOptimized":"","tags":[],"level":6},{"slug":"external-notebooks.eurodatacube.notebooks.notebooks.contributions.gran-chaco-phiweek","title":"ESA EO \\phi- week 2020","description":"","date":"","thumbnail":"/notebooks_test/build/80cee7db6cdc7002ceedda5689f889fa.jpeg","thumbnailOptimized":"","banner":"","bannerOptimized":"","tags":[],"level":6},{"slug":"external-notebooks.eurodatacube.notebooks.notebooks.contributions.howtolulc-batch-updated-210621","title":"How To: Land-Use-Land-Cover Prediction for Slovenia - using the Batch Processing API","description":"","date":"","thumbnail":"","thumbnailOptimized":"","banner":"","bannerOptimized":"","tags":[],"level":6},{"slug":"external-notebooks.eurodatacube.notebooks.notebooks.contributions.lpis-lulc-slo","title":"LPIS Use Case for Land Use / Land Cover Classification","description":"","date":"","thumbnail":"","thumbnailOptimized":"","banner":"","bannerOptimized":"","tags":[],"level":6},{"slug":"external-notebooks.eurodatacube.notebooks.notebooks.contributions.lps2022-leverage-euro-data-cube-services","title":"Living Planet Symposium 2022 Training Session","description":"","date":"","thumbnail":"","thumbnailOptimized":"","banner":"","bannerOptimized":"","tags":[],"level":6},{"slug":"external-notebooks.eurodatacube.notebooks.notebooks.contributions.no2-analysis-covid19-lockdowns","title":"Impact of Covid19 induced lockdown on NO2 levels","description":"","date":"","thumbnail":"","thumbnailOptimized":"","banner":"","bannerOptimized":"","tags":[],"level":6},{"slug":"external-notebooks.eurodatacube.notebooks.notebooks.contributions.no2-so2-trend-veda-api-igarss-2023","title":"Using the NASA VEDA EOAPI","description":"","date":"","thumbnail":"","thumbnailOptimized":"","banner":"","bannerOptimized":"","tags":[],"level":6},{"slug":"external-notebooks.eurodatacube.notebooks.notebooks.contributions.ogc-edc","title":"Important notes","description":"","date":"","thumbnail":"","thumbnailOptimized":"","banner":"","bannerOptimized":"","tags":[],"level":6},{"slug":"external-notebooks.eurodatacube.notebooks.notebooks.contributions.openeo-client-demo","title":"openEO Client Demo","description":"","date":"","thumbnail":"","thumbnailOptimized":"","banner":"","bannerOptimized":"","tags":[],"level":6},{"slug":"external-notebooks.eurodatacube.notebooks.notebooks.contributions.race-finishedgoodsinventory-inidcator","title":"Finished Goods Inventory indicator for RACE","description":"","date":"","thumbnail":"","thumbnailOptimized":"","banner":"","bannerOptimized":"","tags":[],"level":6},{"slug":"external-notebooks.eurodatacube.notebooks.notebooks.contributions.third-party-planetscope","title":"Third Party Data Import - PlanetScope","description":"","date":"","thumbnail":"","thumbnailOptimized":"","banner":"","bannerOptimized":"","tags":[],"level":6},{"slug":"external-notebooks.eurodatacube.notebooks.notebooks.contributions.xcube-access-datasets","title":"Using xcube to access non-commercial and commercial data sets","description":"","date":"","thumbnail":"","thumbnailOptimized":"","banner":"","bannerOptimized":"","tags":[],"level":6},{"slug":"external-notebooks.eurodatacube.notebooks.notebooks.contributions.xcube-viewer-as-a-service-in-edc1","title":"Visualizing data with xcube viewer in EuroDataCube","description":"","date":"","thumbnail":"","thumbnailOptimized":"","banner":"","bannerOptimized":"","tags":[],"level":6},{"slug":"external-notebooks.eurodatacube.notebooks.notebooks.contributions.dapa.dapa-evaluation-workshop","title":"DAPA Evaluation Workshop: Introduction \u0026 Documentation","description":"","date":"","thumbnail":"","thumbnailOptimized":"","banner":"","bannerOptimized":"","tags":[],"level":6},{"slug":"external-notebooks.eurodatacube.notebooks.notebooks.contributions.dapa.dapa-tutorial-1-cube-sentinel-2","title":"DAPA Tutorial #1: Cube - Sentinel-2","description":"","date":"","thumbnail":"","thumbnailOptimized":"","banner":"","bannerOptimized":"","tags":[],"level":6},{"slug":"external-notebooks.eurodatacube.notebooks.notebooks.contributions.dapa.dapa-tutorial-2-area-sentinel-2","title":"DAPA Tutorial #2: Area - Sentinel-2","description":"","date":"","thumbnail":"","thumbnailOptimized":"","banner":"","bannerOptimized":"","tags":[],"level":6},{"slug":"external-notebooks.eurodatacube.notebooks.notebooks.contributions.dapa.dapa-tutorial-3-timeseries-sentinel-2","title":"DAPA Tutorial #3: Timeseries - Sentinel-2","description":"","date":"","thumbnail":"","thumbnailOptimized":"","banner":"","bannerOptimized":"","tags":[],"level":6},{"slug":"external-notebooks.eurodatacube.notebooks.notebooks.contributions.dapa.dapa-tutorial-4-value-sentinel-2","title":"DAPA Tutorial #4: Value - Sentinel-2","description":"","date":"","thumbnail":"","thumbnailOptimized":"","banner":"","bannerOptimized":"","tags":[],"level":6},{"slug":"external-notebooks.eurodatacube.notebooks.notebooks.contributions.dapa.dapa-tutorial-5-dem","title":"DAPA Tutorial #5: DEM","description":"","date":"","thumbnail":"","thumbnailOptimized":"","banner":"","bannerOptimized":"","tags":[],"level":6},{"slug":"external-notebooks.eurodatacube.notebooks.notebooks.contributions.fairicube.fairicube-data-access-demonstration","title":"EDC Sentinel Hub - data access using xcube","description":"","date":"","thumbnail":"","thumbnailOptimized":"","banner":"","bannerOptimized":"","tags":[],"level":6},{"slug":"external-notebooks.eurodatacube.notebooks.notebooks.contributions.igarss2022.igarss-22-australian-bushfires","title":"Australian Bushfires","description":"","date":"","thumbnail":"/notebooks_test/build/ab194b4f8c40a2b9d64d8a85e37ce1fd.png","thumbnailOptimized":"","banner":"","bannerOptimized":"","tags":["IGARSS-22","EO Dashboard"],"level":6},{"slug":"external-notebooks.eurodatacube.notebooks.notebooks.contributions.igarss2022.igarss-22-data-access","title":"Data Access","description":"","date":"","thumbnail":"","thumbnailOptimized":"","banner":"","bannerOptimized":"","tags":[],"level":6},{"slug":"external-notebooks.eurodatacube.notebooks.notebooks.contributions.igarss2022.igarss-22-detect-trucks-sentinel2","title":"Truck Detection Exercise","description":"","date":"","thumbnail":"","thumbnailOptimized":"","banner":"","bannerOptimized":"","tags":[],"level":6},{"slug":"external-notebooks.eurodatacube.notebooks.notebooks.contributions.igarss2022.igarss-22-lockdown-in-venice","title":"Environmental Impacts of Lockdown in Venice, Italy during 2020","description":"","date":"","thumbnail":"","thumbnailOptimized":"","banner":"","bannerOptimized":"","tags":[],"level":6},{"slug":"external-notebooks.eurodatacube.notebooks.notebooks.contributions.igarss2022.igarss-22-nasa-api-lockdown-in-venice","title":"Lockdown in Venice","description":"","date":"","thumbnail":"","thumbnailOptimized":"","banner":"","bannerOptimized":"","tags":[],"level":6},{"slug":"external-notebooks.eurodatacube.notebooks.notebooks.contributions.igarss2022.igarss-22-no2-timeseries-analysis","title":"NO2 timeseries analysis","description":"","date":"","thumbnail":"","thumbnailOptimized":"","banner":"","bannerOptimized":"","tags":[],"level":6},{"slug":"external-notebooks.eurodatacube.notebooks.notebooks.contributions.igarss2022.igarss-22-timeseries-stac-api-single-vs-multi","title":"Time series using STAC API statistics endpoints","description":"","date":"","thumbnail":"","thumbnailOptimized":"","banner":"","bannerOptimized":"","tags":[],"level":6},{"title":"Curated","level":5},{"slug":"external-notebooks.eurodatacube.notebooks.notebooks.curated.access-iacs-data","title":"How to access IACS Spatial Data","description":"","date":"","thumbnail":"","thumbnailOptimized":"","banner":"","bannerOptimized":"","tags":[],"level":6},{"slug":"external-notebooks.eurodatacube.notebooks.notebooks.curated.edc-access-cci-data","title":"Access CCI data with xcube","description":"","date":"","thumbnail":"","thumbnailOptimized":"","banner":"","bannerOptimized":"","tags":[],"level":6},{"slug":"external-notebooks.eurodatacube.notebooks.notebooks.curated.edc-first-steps","title":"First steps on the Euro Data Cube platform","description":"","date":"","thumbnail":"","thumbnailOptimized":"","banner":"","bannerOptimized":"","tags":[],"level":6},{"slug":"external-notebooks.eurodatacube.notebooks.notebooks.curated.edc-geodb-1-manage-datasets-v11","title":"Manage Collections in your GeoDB","description":"","date":"","thumbnail":"","thumbnailOptimized":"","banner":"","bannerOptimized":"","tags":[],"level":6},{"slug":"external-notebooks.eurodatacube.notebooks.notebooks.curated.edc-geodb-2-explore-datasets-2","title":"Exploring Data","description":"","date":"","thumbnail":"","thumbnailOptimized":"","banner":"","bannerOptimized":"","tags":[],"level":6},{"slug":"external-notebooks.eurodatacube.notebooks.notebooks.curated.edc-geodb-3-share-datasets1","title":"Sharing Data","description":"","date":"","thumbnail":"","thumbnailOptimized":"","banner":"","bannerOptimized":"","tags":[],"level":6},{"slug":"external-notebooks.eurodatacube.notebooks.notebooks.curated.edc-geodb-access-urban-atlas-data-v1","title":"[xcube-geodb] How to accesss EEA Urban Atlas Data","description":"","date":"","thumbnail":"","thumbnailOptimized":"","banner":"","bannerOptimized":"","tags":[],"level":6},{"slug":"external-notebooks.eurodatacube.notebooks.notebooks.curated.edc-sentinel-hub-data-access","title":"EDC Sentinel Hub - data access using xcube","description":"","date":"","thumbnail":"","thumbnailOptimized":"","banner":"","bannerOptimized":"","tags":[],"level":6},{"slug":"external-notebooks.eurodatacube.notebooks.notebooks.curated.edc-sentinelhub-datafusion-basic","title":"EDC Sentinel Hub: Data Fusion","description":"","date":"","thumbnail":"","thumbnailOptimized":"","banner":"","bannerOptimized":"","tags":[],"level":6},{"slug":"external-notebooks.eurodatacube.notebooks.notebooks.curated.edc-sentinelhub-datafusion-ndvi","title":"EDC Sentinel Hub: Data Fusion","description":"","date":"","thumbnail":"","thumbnailOptimized":"","banner":"","bannerOptimized":"","tags":[],"level":6},{"slug":"external-notebooks.eurodatacube.notebooks.notebooks.curated.edc-sentinel-hub-datasets","title":"EDC Sentinel Hub - using xcube to access different data sets in Sentinel Hub","description":"","date":"","thumbnail":"","thumbnailOptimized":"","banner":"","bannerOptimized":"","tags":[],"level":6},{"slug":"external-notebooks.eurodatacube.notebooks.notebooks.curated.edc-sentinel-hub-setup","title":"Setup for EDC core API access using xcube client library","description":"","date":"","thumbnail":"","thumbnailOptimized":"","banner":"","bannerOptimized":"","tags":[],"level":6},{"slug":"external-notebooks.eurodatacube.notebooks.notebooks.curated.edc-sentinel-hub-xcube-integration","title":"EDC Sentinel Hub - XCUBE integration","description":"","date":"","thumbnail":"","thumbnailOptimized":"","banner":"","bannerOptimized":"","tags":[],"level":6},{"slug":"external-notebooks.eurodatacube.notebooks.notebooks.curated.edc-usecase-ndvi-timeline","title":"NDVI timeline","description":"","date":"","thumbnail":"","thumbnailOptimized":"","banner":"","bannerOptimized":"","tags":[],"level":6},{"slug":"external-notebooks.eurodatacube.notebooks.notebooks.curated.eo-learn","title":"Using eo-learn in EDC: a starter’s guide.","description":"","date":"","thumbnail":"/notebooks_test/build/5a1f8475f0c3652f4630d03d72891b98.png","thumbnailOptimized":"","banner":"","bannerOptimized":"","tags":[],"level":6},{"slug":"external-notebooks.eurodatacube.notebooks.notebooks.curated.esdl-edc-v0-2","title":"Earth System Data Lab Tutorial @ Euro Data Cube","description":"","date":"","thumbnail":"","thumbnailOptimized":"","banner":"","bannerOptimized":"","tags":[],"level":6},{"slug":"external-notebooks.eurodatacube.notebooks.notebooks.curated.exploring-time-and-space-with-edc","title":"Exploring Time and Space: A guide to accessing, analysing and visualising data in the Euro Data Cube","description":"","date":"","thumbnail":"","thumbnailOptimized":"","banner":"","bannerOptimized":"","tags":[],"level":6},{"slug":"external-notebooks.eurodatacube.notebooks.notebooks.curated.how-to-access-dem-data-through-sentinel-hub-api","title":"How to access DEM data through Sentinel Hub API","description":"","date":"","thumbnail":"","thumbnailOptimized":"","banner":"","bannerOptimized":"","tags":[],"level":6},{"slug":"external-notebooks.eurodatacube.notebooks.notebooks.curated.sentinelhub-py","title":"Using Sentinel Hub Process API in EDC: a starter’s guide.","description":"","date":"","thumbnail":"/notebooks_test/build/01e22903839391bc356ac886ec2b2fa7.png","thumbnailOptimized":"","banner":"","bannerOptimized":"","tags":[],"level":6},{"title":"Notebooks","level":1},{"slug":"notebooks.example1","title":"📘 Example Notebook 1","description":"","date":"","thumbnail":"","thumbnailOptimized":"","banner":"","bannerOptimized":"","tags":[],"level":2},{"slug":"notebooks.example2","title":"📘 Example Notebook 2","description":"","date":"","thumbnail":"","thumbnailOptimized":"","banner":"","bannerOptimized":"","tags":[],"level":2}]}]},"page":{"version":1,"kind":"Notebook","sha256":"7a5f7b46e8127befb37ff22ff5812be44199094178b8593cfb1c95bb62d9a2de","slug":"external-notebooks.eurodatacube.notebooks.notebooks.contributions.edc-usecase-lpis-crop-type-classification","location":"/external_notebooks/eurodatacube/notebooks/notebooks/contributions/EDC_Usecase-LPIS_Crop-Type-Classification.ipynb","dependencies":[],"frontmatter":{"title":"Important notes","content_includes_title":true,"kernelspec":{"name":"python3","display_name":"Python 3","language":"python"},"github":"https://github.com/eoxhub-workspaces/documentation/","numbering":{"title":{"offset":5}},"edit_url":"https://github.com/eoxhub-workspaces/documentation//blob/main/external_notebooks/eurodatacube/notebooks/notebooks/contributions/EDC_Usecase-LPIS_Crop-Type-Classification.ipynb","exports":[{"format":"ipynb","filename":"EDC_Usecase-LPIS_Crop-Type-Classification.ipynb","url":"/notebooks_test/build/EDC_Usecase-LPIS_Cro-79e5dfb470d4144ffd5baf72000733e5.ipynb"}]},"widgets":{},"mdast":{"type":"root","children":[{"type":"block","kind":"notebook-code","data":{},"children":[{"type":"code","lang":"python","executable":true,"value":"from edc import setup_environment_variables\nsetup_environment_variables()","key":"hBmVwqRQ0l"},{"type":"output","id":"yExUpHMLN3szwMxqDyPHN","data":[{"output_type":"display_data","metadata":{},"data":{"text/markdown":{"content":"API credentials have automatically been injected for your active subscriptions.  \nThe following environment variables are now available:\n* `SH_CLIENT_NAME`\n* `SH_CLIENT_SECRET`\n* `SH_INSTANCE_ID`\n* `SH_CLIENT_ID`\n\nThe following additional environment variables have been loaded from `~/custom.env`:\n* `REFERENCE_DATA`\n* `AWS_BUCKET`\n* `OGC_EDC_URL`\n* `DB_HOST`\n* `DB_NAME`\n* `DB_USER`\n* `DB_PASSWORD`\n------\n","content_type":"text/markdown"},"text/plain":{"content":"\u003cIPython.core.display.Markdown object\u003e","content_type":"text/plain"}}}],"key":"joS1jKzMsO"}],"key":"fFw5iX7MOM"},{"type":"block","kind":"notebook-content","data":{},"children":[{"type":"heading","depth":1,"position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"children":[{"type":"text","value":"Important notes","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"aZCPbM2Qlz"}],"identifier":"important-notes","label":"Important notes","html_id":"important-notes","implicit":true,"key":"qq1VacPIO6"},{"type":"paragraph","position":{"start":{"line":2,"column":1},"end":{"line":2,"column":1}},"children":[{"type":"text","value":"This notebook requires:","position":{"start":{"line":2,"column":1},"end":{"line":2,"column":1}},"key":"QlAK2sWqfj"}],"key":"FxMYuYLmYB"},{"type":"list","ordered":false,"spread":false,"position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"children":[{"type":"listItem","spread":true,"position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"children":[{"type":"text","value":"POSTGIS database (with access information exposed as environment variables) having sample LPIS data ingested -\u003e please find further information ","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"key":"PS3stdxai7"},{"type":"link","url":"https://github.com/eurodatacube/notebooks/tree/master/artifacts","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"children":[{"type":"text","value":"here","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"key":"FSJh5S4S1I"}],"urlSource":"https://github.com/eurodatacube/notebooks/tree/master/artifacts","error":true,"key":"IBgwFTBfFA"}],"key":"fCnnqN3Azw"}],"key":"nnOlwvYE6M"}],"key":"GazEmzmWW1"},{"type":"block","kind":"notebook-content","data":{},"children":[{"type":"heading","depth":1,"position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"children":[{"type":"text","value":"LPIS Use case: Crop-type classification (AUT)","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"TeXJz2KA6B"}],"identifier":"lpis-use-case-crop-type-classification-aut","label":"LPIS Use case: Crop-type classification (AUT)","html_id":"lpis-use-case-crop-type-classification-aut","implicit":true,"key":"YmHWowNr6W"},{"type":"paragraph","position":{"start":{"line":3,"column":1},"end":{"line":4,"column":1}},"children":[{"type":"text","value":"This notebook demonstrates how Euro Data Cube (EDC) tools can be utilized for exploratory analysis and manipulation of data in Land Parcel Identification System (LPIS). The most important part is the example of using satellite imagery and machine learning algorithms for crop type classification, which should be a valuable support for decisions related with LPIS controls.\nThe described workflow consists of several parts:","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"key":"euXnyWGKFM"}],"key":"napctFErUZ"},{"type":"list","ordered":true,"start":1,"spread":false,"position":{"start":{"line":6,"column":1},"end":{"line":10,"column":1}},"children":[{"type":"listItem","spread":true,"position":{"start":{"line":6,"column":1},"end":{"line":6,"column":1}},"children":[{"type":"text","value":"Prepare and explore LPIS data and satellite imagery","position":{"start":{"line":6,"column":1},"end":{"line":6,"column":1}},"key":"JnbNebpmpM"}],"key":"s2846S1Esy"},{"type":"listItem","spread":true,"position":{"start":{"line":7,"column":1},"end":{"line":7,"column":1}},"children":[{"type":"text","value":"Run Machine Learning and create a model for crop type classification","position":{"start":{"line":7,"column":1},"end":{"line":7,"column":1}},"key":"Me8IMl9OgL"}],"key":"bcImEkIgbV"},{"type":"listItem","spread":true,"position":{"start":{"line":8,"column":1},"end":{"line":8,"column":1}},"children":[{"type":"text","value":"Visualize results and extract information to support LPIS controls","position":{"start":{"line":8,"column":1},"end":{"line":8,"column":1}},"key":"L1Cn71xOuf"}],"key":"CwLaRjgcPx"},{"type":"listItem","spread":true,"position":{"start":{"line":9,"column":1},"end":{"line":9,"column":1}},"children":[{"type":"text","value":"Classify on parcel level per LPIS ID","position":{"start":{"line":9,"column":1},"end":{"line":9,"column":1}},"key":"dwfi2jlGvo"}],"key":"FH1MfQb9aF"},{"type":"listItem","spread":true,"position":{"start":{"line":10,"column":1},"end":{"line":10,"column":1}},"children":[{"type":"text","value":"Persist results in database","position":{"start":{"line":10,"column":1},"end":{"line":10,"column":1}},"key":"UOoWUQ2nkE"}],"key":"SHekIjtwp9"}],"key":"bppVpIlOuA"}],"key":"T9OdxmRv5f"},{"type":"block","kind":"notebook-code","data":{},"children":[{"type":"code","lang":"python","executable":true,"value":"# This notebook uses the EO-Learn ML library which requires configuration passed via the 'sentinel.config' tool\n!sentinelhub.config --sh_base_url 'https://services.sentinel-hub.com'\n!sentinelhub.config --sh_client_id $SH_CLIENT_ID\n!sentinelhub.config --sh_client_secret $SH_CLIENT_SECRET\n!sentinelhub.config --instance_id $SH_INSTANCE_ID","key":"UkeSN3RUWn"},{"type":"output","id":"oODOuJYU8Mx8bP4ijLhhx","data":[],"key":"GoqXd6NR1z"}],"key":"wwSJ5EbPBu"},{"type":"block","kind":"notebook-code","data":{},"children":[{"type":"code","lang":"python","executable":true,"value":"# see section Important Notes above\nimport os\ndb_conn_params = {\n    'host': os.getenv('DB_HOST'),\n    'database': os.getenv('DB_NAME'),\n    'user': os.getenv('DB_USER'),\n    'password': os.getenv('DB_PASSWORD')\n}","key":"o7X7FHjONL"},{"type":"output","id":"zBv3ckQLD30BepVpz26Uw","data":[],"key":"g4KqlCAuTm"}],"key":"MnmWaN6PMw"},{"type":"block","kind":"notebook-content","data":{},"children":[{"type":"heading","depth":2,"position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"children":[{"type":"text","value":"Import packages","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"nngydOoVkI"}],"identifier":"import-packages","label":"Import packages","html_id":"import-packages","implicit":true,"key":"xQ05GMBXM8"}],"key":"ZStr9wdOaS"},{"type":"block","kind":"notebook-code","data":{"scrolled":true},"children":[{"type":"code","lang":"python","executable":true,"value":"import warnings\nwarnings.filterwarnings('ignore')\n\n# Jupyter notebook related\n%reload_ext autoreload\n%autoreload 2\n%matplotlib inline\n\n# Built-in modules\nimport pickle\nimport sys\nimport datetime\nimport time\nimport itertools\nimport math\nimport subprocess\nimport fiona\nimport fiona.crs\nfrom enum import Enum\n\n# Basics of Python data handling and visualization\nimport numpy as np\nimport pandas as pd\nimport geopandas as gpd\nimport matplotlib as mpl\nimport matplotlib.pyplot as plt\nimport matplotlib.gridspec as gridspec\nfrom mpl_toolkits.axes_grid1 import make_axes_locatable\nfrom shapely.geometry import Polygon\nfrom tqdm import tqdm_notebook as tqdm\n\n# Machine learning \nimport lightgbm as lgb\nfrom sklearn.externals import joblib\nfrom sklearn import metrics\nfrom sklearn import preprocessing\n\n# Imports from eo-learn and sentinelhub-py\nfrom eolearn.core import EOTask, EOPatch, LinearWorkflow, FeatureType, OverwritePermission, \\\n    LoadTask, SaveTask, EOExecutor\nfrom eolearn.core.core_tasks import AddFeature\nfrom eolearn.io import S2L1CWCSInput, ExportToTiff\nfrom eolearn.mask import AddCloudMaskTask, get_s2_pixel_cloud_detector, AddValidDataMaskTask\nfrom eolearn.geometry import VectorToRaster, PointSamplingTask, ErosionTask\nfrom eolearn.features import LinearInterpolation, SimpleFilterTask\nfrom sentinelhub import BBoxSplitter, BBox, CRS, CustomUrlParam, UtmGridSplitter\n\n# OAuth2\nfrom oauthlib.oauth2 import BackendApplicationClient\nfrom requests_oauthlib import OAuth2Session\n\n# DB and raw geometry\nimport psycopg2\nfrom psycopg2._psycopg import AsIs\nfrom psycopg2.extensions import register_adapter\nimport shapely.wkt\nfrom shapely.geometry import Polygon, MultiPolygon\nfrom geopandas import GeoDataFrame\n\n\n# imports for xcube\nimport xarray as xr\nfrom shapely.ops import cascaded_union\n\nfrom xcube_sh.cube import open_cube\nfrom xcube_sh.observers import Observers\nfrom xcube_sh.config import CubeConfig\n\nfrom xcube.core.geom import mask_dataset_by_geometry\n\n# Amazon S3\nimport boto3","key":"b4TnVQGYjn"},{"type":"output","id":"oZQWLfshA1W8yD8jD19jb","data":[{"name":"stderr","output_type":"stream","text":"/opt/conda/lib/python3.7/site-packages/xcube_sh/cube.py:22: DeprecationWarning: Using or importing the ABCs from 'collections' instead of from 'collections.abc' is deprecated since Python 3.3,and in 3.9 it will stop working\n  from collections import Callable\n/opt/conda/lib/python3.7/site-packages/xcube_sh/store.py:26: DeprecationWarning: Using or importing the ABCs from 'collections' instead of from 'collections.abc' is deprecated since Python 3.3,and in 3.9 it will stop working\n  from collections import MutableMapping\n"}],"key":"DECSAOfaWy"}],"key":"xvbcMuR09h"},{"type":"block","kind":"notebook-content","data":{},"children":[{"type":"heading","depth":1,"position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"children":[{"type":"text","value":"Database loading and mapping functionality","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"HW2Y5z6f7z"}],"identifier":"database-loading-and-mapping-functionality","label":"Database loading and mapping functionality","html_id":"database-loading-and-mapping-functionality","implicit":true,"key":"dEtHmRiY3D"}],"key":"pzKtkX9s2S"},{"type":"block","kind":"notebook-code","data":{},"children":[{"type":"code","lang":"python","executable":true,"value":"## mapping of crop type groups into 24 classes that are to be predicted\n\n# AT: vector to raster needs uint8 values \nctToctnuml4aMapping = {\n    1: [1010], #SOMMERGETREIDE\n    2: [1020], #WINTERGETREIDE\n    3: [1030], #MENGGETREIDE_AEHNLICHES\n    4: [1040], #MAIS_AEHNLICHES\n    5: [1050], #SOMMERRAPS_AEHNLICHES\n    6: [1060], #WINTERRAPS_AEHNLICHES\n    7: [1070], #SONNENBLUME\n    8: [1080], #HANF\n    9: [1090], #LEGUMINOSEN_AEHNLICHES\n    10: [1100], #WINTERLEGUMINOSE\n    11: [1110], #KARTOFFELN_AEHNLICHES\n    12: [1120], #RUEBEN\n    13: [1130], #GEMUESE_AEHNLICHES\n    14: [1140], #GEWUERZE_AEHNLICHES\n    15: [1150], #WINTERGEWUERZE_AEHNLICHES   \n    16: [1160], #KUERBIS\n    17: [1170], #BRACHE\n    18: [1180], #DAUERKULTUR\n    19: [1190], #GEWAECHSHAUS\n    20: [1200], #WEIN\n    21: [1210], #GRUENLAND\n    22: [1220], #PRO_RATA\n    23: [1230], #LAGERFLAECHEN\n    24: [1240] #SONSTIGES\n}\nctnuml4aToctMapping = {ctnuml4a: ctid for ctid, ctnuml4aList in ctToctnuml4aMapping.items() for ctnuml4a in ctnuml4aList}\n\n# needed for DB mapping\nregister_adapter(np.int64, AsIs)\nregister_adapter(Polygon, AsIs)\nregister_adapter(MultiPolygon, AsIs)\n\ndef loadFromDatabase(db_conn, taskName, tableName, bbox, dateFilterMin, dateFilterMax, mappedColumnName = None, mappingLambdaFunc = None):\n    columns = [\"ogd_id\", \"ctnuml4a\", \"geometry\"]\n    geometries = []\n\n    if (mappedColumnName and mappingLambdaFunc):\n        columns.append(mappedColumnName)\n    \n    with db_conn.cursor() as cur:\n        sql = '''\n            SELECT ogd_id, ctnuml4a, ST_AsText(ST_Transform(geometry, {targetCrs})) \n            FROM {tableName}\n            WHERE ST_Intersects(geometry, ST_Transform(ST_GeomFromText('{bbox}', {targetCrs}), 31287))\n                AND ref_date \u003e= '{dateFilterMin}' AND ref_date \u003c= '{dateFilterMax}'\n            '''\n        \n        sql = sql.format(tableName = tableName, targetCrs = bbox.crs.value, \n            dateFilterMin = dateFilterMin, dateFilterMax = dateFilterMax,\n            bbox = bbox.geometry.wkt)\n        #print(sql)\n\n        cur.execute(sql)\n        for row in cur:\n            properties = {\"ogd_id\": row[0], \"ctnuml4a_id\": row[1]}\n            if (mappedColumnName and mappingLambdaFunc):\n                properties[mappedColumnName] = mappingLambdaFunc(row[1])\n\n            geometry = shapely.wkt.loads(row[2]);\n            geometries.append({\"geometry\": geometry, \"properties\": properties})\n        print(taskName + \": \" + str(len(geometries)) + ' DB records for bbox = ' + str(bbox) + ' ' + str(bbox.crs.value))        \n        crs = {\"init\": \"epsg:{}\".format(bbox.crs.value)}\n        gdf = GeoDataFrame.from_features(geometries, crs = crs, columns = columns)\n        return gdf","key":"I0y669hzMw"},{"type":"output","id":"Vv76reHlAaCblNLCt2Gww","data":[],"key":"jQlGn3fnBl"}],"key":"f3zaoamrjo"},{"type":"block","kind":"notebook-content","data":{},"children":[{"type":"heading","depth":1,"position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"children":[{"type":"text","value":"Part 1: Exploratory Analysis","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"Gvqe1HLW4G"}],"identifier":"part-1-exploratory-analysis","label":"Part 1: Exploratory Analysis","html_id":"part-1-exploratory-analysis","implicit":true,"key":"UHSvq8B7m7"},{"type":"heading","depth":2,"position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"children":[{"type":"text","value":"Define the Area-of-Interest (AOI):","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"key":"Dei0bWQDTj"}],"identifier":"define-the-area-of-interest-aoi","label":"Define the Area-of-Interest (AOI):","html_id":"define-the-area-of-interest-aoi","implicit":true,"key":"UjgVUUph89"},{"type":"paragraph","position":{"start":{"line":5,"column":1},"end":{"line":5,"column":1}},"children":[{"type":"text","value":"The whole territory of a country is splited into patches which makes the processing more efficient. The process is run on are of 3x3 patches for demonstration purposes.  AOI can be selected as the id of the patch in the middle.","position":{"start":{"line":5,"column":1},"end":{"line":5,"column":1}},"key":"Q641zt3NtF"}],"key":"hSZBTOxzqz"},{"type":"paragraph","position":{"start":{"line":7,"column":1},"end":{"line":7,"column":1}},"children":[{"type":"text","value":"Main steps in this part of the notebook:","position":{"start":{"line":7,"column":1},"end":{"line":7,"column":1}},"key":"V8FpdRuQeV"}],"key":"CnqEDVShVE"},{"type":"list","ordered":false,"spread":false,"position":{"start":{"line":8,"column":1},"end":{"line":12,"column":1}},"children":[{"type":"listItem","spread":true,"position":{"start":{"line":8,"column":1},"end":{"line":8,"column":1}},"children":[{"type":"text","value":"Load a geographical shape of Austria","position":{"start":{"line":8,"column":1},"end":{"line":8,"column":1}},"key":"QxDcWnadjs"}],"key":"Lk3xEVXzGh"},{"type":"listItem","spread":true,"position":{"start":{"line":9,"column":1},"end":{"line":9,"column":1}},"children":[{"type":"text","value":"Convert it to selected CRS: taken to be the CRS of central UTM tile (UTM_33N)","position":{"start":{"line":9,"column":1},"end":{"line":9,"column":1}},"key":"IqzurHMONw"}],"key":"W9ilUALfsI"},{"type":"listItem","spread":true,"position":{"start":{"line":10,"column":1},"end":{"line":10,"column":1}},"children":[{"type":"text","value":"Split it into smaller, manageable, non-overlapping rectangular tiles (patches)","position":{"start":{"line":10,"column":1},"end":{"line":10,"column":1}},"key":"gIhzOKJyTn"}],"key":"Hj9htocbz0"},{"type":"listItem","spread":true,"position":{"start":{"line":11,"column":1},"end":{"line":12,"column":1}},"children":[{"type":"text","value":"Select a small 3x3 area for classification","position":{"start":{"line":11,"column":1},"end":{"line":11,"column":1}},"key":"GGLjF7IJ0b"}],"key":"OxakGVLf4Z"}],"key":"jSMpNL5yuM"},{"type":"paragraph","position":{"start":{"line":13,"column":1},"end":{"line":13,"column":1}},"children":[{"type":"text","value":"Be sure that your choice of CRS is the same as the CRS of your reference data.","position":{"start":{"line":13,"column":1},"end":{"line":13,"column":1}},"key":"TQ9ltryV8Z"}],"key":"Phum4uSdnv"},{"type":"paragraph","position":{"start":{"line":15,"column":1},"end":{"line":15,"column":1}},"children":[{"type":"text","value":"In the case that you are having problems with empty data being downloaded, try changing the CRS to something that suits the location of the AOI better.","position":{"start":{"line":15,"column":1},"end":{"line":15,"column":1}},"key":"DFIJurJnoa"}],"key":"QXr7b1Q0JL"}],"key":"cf8J3082kl"},{"type":"block","kind":"notebook-code","data":{},"children":[{"type":"code","lang":"python","executable":true,"value":"# Folder where data for running the notebook is stored\nDATA_FOLDER = os.path.join('example_data')\n\n# Load geojson file containing the outline of the country\ncountry = gpd.read_file(os.path.join(DATA_FOLDER, 'at_not_buffered.geojson'))\n\n# Convert CRS to UTM_33N\ncountry_crs = CRS.UTM_33N\ncountry = country.to_crs(crs={'init': CRS.ogc_string(country_crs)})\n\n# Get the country's shape in polygon format\ncountry_shape = country.geometry.values[-1]\n\n# Define bounds and select middle patch ID\nuse_smaller_patches = True\n\nID = 13311 if use_smaller_patches else 1606\n\nbounds = [15.5242, 48.7574, 15.5391, 48.7698]  if use_smaller_patches else [15.4191, 48.653, 15.7335, 48.8102]\n\nbbox_splitter_large = BBoxSplitter([country_shape], country_crs, (25 * 3, 17 * 3))\nbbox_splitter_small = BBoxSplitter([country_shape], country_crs, (25 * 9, 17 * 9))\n\nbbox_splitter = bbox_splitter_small if use_smaller_patches else bbox_splitter_large\nbbox_list_aligned = [BBox((10 * math.floor(bbox.min_x / 10), 10 * math.floor(bbox.min_y / 10), \n                           10 * math.floor(bbox.max_x / 10), 10 * math.floor(bbox.max_y / 10)), country_crs) \n                     for bbox in bbox_splitter.get_bbox_list()]\n\nbbox_list = np.array(bbox_list_aligned)\ninfo_list = np.array(bbox_splitter.get_info_list())\n\nall_patches_gdf = gpd.GeoDataFrame(\n    {\n        \"index_x\": [info['index_x'] for info in info_list],\n        \"index_y\": [info['index_y'] for info in info_list],\n    },\n    crs={'init': CRS.ogc_string(country_crs)},\n    geometry=[Polygon(bbox.get_polygon()) for bbox in bbox_list]\n)","key":"Afta7IlyLh"},{"type":"output","id":"WTvoTP1Z4mJeSbsnIyoEA","data":[],"key":"I2G3n3rB4N"}],"key":"JHIspQGRtP"},{"type":"block","kind":"notebook-code","data":{},"children":[{"type":"code","lang":"python","executable":true,"value":"# Obtain surrounding patches\npatchIDs = []\nfor idx, [bbox, info] in enumerate(zip(bbox_list, info_list)):\n    if (abs(info['index_x'] - info_list[ID]['index_x']) \u003c= 1 and\n        abs(info['index_y'] - info_list[ID]['index_y']) \u003c= 1):\n        patchIDs.append(idx)\n\n# Check if final size is 3x3\nif len(patchIDs) != 9:\n    print('Warning! Use a different central patch ID, this one is on the border.')\n    \n# Change the order of the patches (used for plotting later)\npatchIDs = np.transpose(np.fliplr(np.array(patchIDs).reshape(3, 3))).ravel()\n    \n# Prepare info of selected EOPatches\ngeometry = [Polygon(bbox.get_polygon()) for bbox in bbox_list[patchIDs]]\nidxs_x = [info['index_x'] for info in info_list[patchIDs]]\nidxs_y = [info['index_y'] for info in info_list[patchIDs]]\n\ngdf = gpd.GeoDataFrame({'index_x': idxs_x, 'index_y': idxs_y}, \n                       crs={'init': CRS.ogc_string(country_crs)}, \n                       geometry=geometry)\n\n# save to shapefile\nshapefile_name = './selected_3x3_bboxes_at_small.shp' if use_smaller_patches \\\n    else './selected_3x3_bboxes_at_large.shp'\ngdf.to_file(shapefile_name)\n\n# Visualize the selection\npoly = gdf['geometry'][0]\nx1, y1, x2, y2 = poly.bounds\naspect_ratio = (y1 - y2) / (x1 - x2)\n\nfontdict = {'family': 'monospace', 'weight': 'normal', 'size': 11}\n\n# if bboxes have all same size, estimate offset\nxl, yl, xu, yu = gdf.geometry[0].bounds\nxoff, yoff = (xu - xl) / 3, (yu - yl) / 5\n\n# figure\nfig, ax = plt.subplots(figsize=(20, 20));\ngdf.plot(ax=ax,facecolor='w',edgecolor='r',alpha=0.5);\ncountry.plot(ax=ax, facecolor='w',edgecolor='b',alpha=0.5);\nax.set_title('Selected 3x3 patches within the border of Austria');\nplt.axis('off');","key":"nmuWfQnIxu"},{"type":"output","id":"_nbxDlur1X0sOBdNITTBo","data":[{"output_type":"display_data","metadata":{"needs_background":"light"},"data":{"image/png":{"content_type":"image/png","hash":"69ed8651d431e96cb283a99227826b73","path":"/notebooks_test/build/69ed8651d431e96cb283a99227826b73.png"},"text/plain":{"content":"\u003cFigure size 1440x1440 with 1 Axes\u003e","content_type":"text/plain"}}}],"key":"Achk5jG4zE"}],"key":"ywGps0fKcs"},{"type":"block","kind":"notebook-code","data":{},"children":[{"type":"code","lang":"python","executable":true,"value":"# Rearange selected EOPatches into bbox, which can be used for xcube definition\npatches_geometries = [Polygon(bbox.transform(CRS.WGS84).get_polygon()) for bbox in bbox_list[patchIDs]]\nbbox_of_patches = gpd.GeoSeries(cascaded_union(patches_geometries))\n\nx1 = bbox_of_patches.bounds['minx'][0].item()\ny1 = bbox_of_patches.bounds['miny'][0].item()\nx2 = bbox_of_patches.bounds['maxx'][0].item()\ny2 = bbox_of_patches.bounds['maxy'][0].item()\nbbox_wgs84 = x1, y1, x2, y2","key":"TehJRr2qMx"},{"type":"output","id":"BKB3lC9QY3SgFgzWQJpZD","data":[],"key":"bKrWadtcYx"}],"key":"qv9R3MpaGi"},{"type":"block","kind":"notebook-code","data":{},"children":[{"type":"code","lang":"python","executable":true,"value":"## Plot time series of satellite images for bbox\nx1, y1, x2, y2 = bbox\nspatial_res_meters = 10\npixx = (x2-x1)/spatial_res_meters; pixy = (y2-y1)/spatial_res_meters;\nx1, y1, x2, y2 = bbox_wgs84\nspatial_res = float(np.mean([(x2-x1)/pixx, (y2-y1)/pixy]))\n\ncube_config = CubeConfig(dataset_name='S2L1C',\n                         band_names=[\"B02\", \"B03\", \"B04\", \"B08\", \"B11\", \"B12\"],\n                         chunk_size=[512, 512],\n                         geometry=bbox_wgs84,\n                         spatial_res=spatial_res,\n                         time_range=['2018-01-01', '2018-09-30'],\n                         time_period='4D')  \n\n# So we can print some SentinelHub usage stats\nrequest_collector = Observers.request_collector()\ncube = open_cube(cube_config, request_collector)\n\n# Add Indecies\n## NDVI\nb_red = cube.B04\nb_nir = cube.B08\nndvi = (b_nir - b_red) / (b_nir + b_red)\nndvi.attrs['long_name'] = 'Normalized Difference Vegetation Index'\nndvi.attrs['units'] = 'unitless'\ncube[\"ndvi\"] = ndvi\n\n## NDWI\nb_green = cube.B03\nb_nir = cube.B08\nndwi = (b_green - b_nir) / (b_green + b_nir)\nndwi.attrs['long_name'] = 'Normalized Difference Water Index'\nndwi.attrs['units'] = 'unitless'\ncube[\"ndwi\"] = ndwi\n\ncube.time","key":"B8FaIBVm1Z"},{"type":"output","id":"CXFxVixmq8jVtIusCwlc6","data":[{"name":"stderr","output_type":"stream","text":"/opt/conda/lib/python3.7/site-packages/xcube_sh/store.py:73: DeprecationWarning: parsing timezone aware datetimes is deprecated; this will raise an error in the future\n  t_array = np.array([s + 0.5 * (e - s) for s, e in self._time_ranges]).astype('datetime64[s]').astype(np.int64)\n/opt/conda/lib/python3.7/site-packages/xcube_sh/store.py:74: DeprecationWarning: parsing timezone aware datetimes is deprecated; this will raise an error in the future\n  t_bnds_array = np.array(self._time_ranges).astype('datetime64[s]').astype(np.int64)\n"},{"output_type":"execute_result","execution_count":10,"metadata":{},"data":{"text/html":{"content":"\u003cpre\u003e\u0026lt;xarray.DataArray \u0026#x27;time\u0026#x27; (time: 69)\u0026gt;\narray([\u0026#x27;2018-01-03T00:00:00.000000000\u0026#x27;, \u0026#x27;2018-01-07T00:00:00.000000000\u0026#x27;,\n       \u0026#x27;2018-01-11T00:00:00.000000000\u0026#x27;, \u0026#x27;2018-01-15T00:00:00.000000000\u0026#x27;,\n       \u0026#x27;2018-01-19T00:00:00.000000000\u0026#x27;, \u0026#x27;2018-01-23T00:00:00.000000000\u0026#x27;,\n       \u0026#x27;2018-01-27T00:00:00.000000000\u0026#x27;, \u0026#x27;2018-01-31T00:00:00.000000000\u0026#x27;,\n       \u0026#x27;2018-02-04T00:00:00.000000000\u0026#x27;, \u0026#x27;2018-02-08T00:00:00.000000000\u0026#x27;,\n       \u0026#x27;2018-02-12T00:00:00.000000000\u0026#x27;, \u0026#x27;2018-02-16T00:00:00.000000000\u0026#x27;,\n       \u0026#x27;2018-02-20T00:00:00.000000000\u0026#x27;, \u0026#x27;2018-02-24T00:00:00.000000000\u0026#x27;,\n       \u0026#x27;2018-02-28T00:00:00.000000000\u0026#x27;, \u0026#x27;2018-03-04T00:00:00.000000000\u0026#x27;,\n       \u0026#x27;2018-03-08T00:00:00.000000000\u0026#x27;, \u0026#x27;2018-03-12T00:00:00.000000000\u0026#x27;,\n       \u0026#x27;2018-03-16T00:00:00.000000000\u0026#x27;, \u0026#x27;2018-03-20T00:00:00.000000000\u0026#x27;,\n       \u0026#x27;2018-03-24T00:00:00.000000000\u0026#x27;, \u0026#x27;2018-03-28T00:00:00.000000000\u0026#x27;,\n       \u0026#x27;2018-04-01T00:00:00.000000000\u0026#x27;, \u0026#x27;2018-04-05T00:00:00.000000000\u0026#x27;,\n       \u0026#x27;2018-04-09T00:00:00.000000000\u0026#x27;, \u0026#x27;2018-04-13T00:00:00.000000000\u0026#x27;,\n       \u0026#x27;2018-04-17T00:00:00.000000000\u0026#x27;, \u0026#x27;2018-04-21T00:00:00.000000000\u0026#x27;,\n       \u0026#x27;2018-04-25T00:00:00.000000000\u0026#x27;, \u0026#x27;2018-04-29T00:00:00.000000000\u0026#x27;,\n       \u0026#x27;2018-05-03T00:00:00.000000000\u0026#x27;, \u0026#x27;2018-05-07T00:00:00.000000000\u0026#x27;,\n       \u0026#x27;2018-05-11T00:00:00.000000000\u0026#x27;, \u0026#x27;2018-05-15T00:00:00.000000000\u0026#x27;,\n       \u0026#x27;2018-05-19T00:00:00.000000000\u0026#x27;, \u0026#x27;2018-05-23T00:00:00.000000000\u0026#x27;,\n       \u0026#x27;2018-05-27T00:00:00.000000000\u0026#x27;, \u0026#x27;2018-05-31T00:00:00.000000000\u0026#x27;,\n       \u0026#x27;2018-06-04T00:00:00.000000000\u0026#x27;, \u0026#x27;2018-06-08T00:00:00.000000000\u0026#x27;,\n       \u0026#x27;2018-06-12T00:00:00.000000000\u0026#x27;, \u0026#x27;2018-06-16T00:00:00.000000000\u0026#x27;,\n       \u0026#x27;2018-06-20T00:00:00.000000000\u0026#x27;, \u0026#x27;2018-06-24T00:00:00.000000000\u0026#x27;,\n       \u0026#x27;2018-06-28T00:00:00.000000000\u0026#x27;, \u0026#x27;2018-07-02T00:00:00.000000000\u0026#x27;,\n       \u0026#x27;2018-07-06T00:00:00.000000000\u0026#x27;, \u0026#x27;2018-07-10T00:00:00.000000000\u0026#x27;,\n       \u0026#x27;2018-07-14T00:00:00.000000000\u0026#x27;, \u0026#x27;2018-07-18T00:00:00.000000000\u0026#x27;,\n       \u0026#x27;2018-07-22T00:00:00.000000000\u0026#x27;, \u0026#x27;2018-07-26T00:00:00.000000000\u0026#x27;,\n       \u0026#x27;2018-07-30T00:00:00.000000000\u0026#x27;, \u0026#x27;2018-08-03T00:00:00.000000000\u0026#x27;,\n       \u0026#x27;2018-08-07T00:00:00.000000000\u0026#x27;, \u0026#x27;2018-08-11T00:00:00.000000000\u0026#x27;,\n       \u0026#x27;2018-08-15T00:00:00.000000000\u0026#x27;, \u0026#x27;2018-08-19T00:00:00.000000000\u0026#x27;,\n       \u0026#x27;2018-08-23T00:00:00.000000000\u0026#x27;, \u0026#x27;2018-08-27T00:00:00.000000000\u0026#x27;,\n       \u0026#x27;2018-08-31T00:00:00.000000000\u0026#x27;, \u0026#x27;2018-09-04T00:00:00.000000000\u0026#x27;,\n       \u0026#x27;2018-09-08T00:00:00.000000000\u0026#x27;, \u0026#x27;2018-09-12T00:00:00.000000000\u0026#x27;,\n       \u0026#x27;2018-09-16T00:00:00.000000000\u0026#x27;, \u0026#x27;2018-09-20T00:00:00.000000000\u0026#x27;,\n       \u0026#x27;2018-09-24T00:00:00.000000000\u0026#x27;, \u0026#x27;2018-09-28T00:00:00.000000000\u0026#x27;,\n       \u0026#x27;2018-10-02T00:00:00.000000000\u0026#x27;], dtype=\u0026#x27;datetime64[ns]\u0026#x27;)\nCoordinates:\n  * time     (time) datetime64[ns] 2018-01-03 2018-01-07 ... 2018-10-02\nAttributes:\n    standard_name:  time\n    bounds:         time_bnds\u003c/pre\u003e","content_type":"text/html"},"text/plain":{"content":"\u003cxarray.DataArray 'time' (time: 69)\u003e\narray(['2018-01-03T00:00:00.000000000', '2018-01-07T00:00:00.000000000',\n       '2018-01-11T00:00:00.000000000', '2018-01-15T00:00:00.000000000',\n       '2018-01-19T00:00:00.000000000', '2018-01-23T00:00:00.000000000',\n       '2018-01-27T00:00:00.000000000', '2018-01-31T00:00:00.000000000',\n       '2018-02-04T00:00:00.000000000', '2018-02-08T00:00:00.000000000',\n       '2018-02-12T00:00:00.000000000', '2018-02-16T00:00:00.000000000',\n       '2018-02-20T00:00:00.000000000', '2018-02-24T00:00:00.000000000',\n       '2018-02-28T00:00:00.000000000', '2018-03-04T00:00:00.000000000',\n       '2018-03-08T00:00:00.000000000', '2018-03-12T00:00:00.000000000',\n       '2018-03-16T00:00:00.000000000', '2018-03-20T00:00:00.000000000',\n       '2018-03-24T00:00:00.000000000', '2018-03-28T00:00:00.000000000',\n       '2018-04-01T00:00:00.000000000', '2018-04-05T00:00:00.000000000',\n       '2018-04-09T00:00:00.000000000', '2018-04-13T00:00:00.000000000',\n       '2018-04-17T00:00:00.000000000', '2018-04-21T00:00:00.000000000',\n       '2018-04-25T00:00:00.000000000', '2018-04-29T00:00:00.000000000',\n       '2018-05-03T00:00:00.000000000', '2018-05-07T00:00:00.000000000',\n       '2018-05-11T00:00:00.000000000', '2018-05-15T00:00:00.000000000',\n       '2018-05-19T00:00:00.000000000', '2018-05-23T00:00:00.000000000',\n       '2018-05-27T00:00:00.000000000', '2018-05-31T00:00:00.000000000',\n       '2018-06-04T00:00:00.000000000', '2018-06-08T00:00:00.000000000',\n       '2018-06-12T00:00:00.000000000', '2018-06-16T00:00:00.000000000',\n       '2018-06-20T00:00:00.000000000', '2018-06-24T00:00:00.000000000',\n       '2018-06-28T00:00:00.000000000', '2018-07-02T00:00:00.000000000',\n       '2018-07-06T00:00:00.000000000', '2018-07-10T00:00:00.000000000',\n       '2018-07-14T00:00:00.000000000', '2018-07-18T00:00:00.000000000',\n       '2018-07-22T00:00:00.000000000', '2018-07-26T00:00:00.000000000',\n       '2018-07-30T00:00:00.000000000', '2018-08-03T00:00:00.000000000',\n       '2018-08-07T00:00:00.000000000', '2018-08-11T00:00:00.000000000',\n       '2018-08-15T00:00:00.000000000', '2018-08-19T00:00:00.000000000',\n       '2018-08-23T00:00:00.000000000', '2018-08-27T00:00:00.000000000',\n       '2018-08-31T00:00:00.000000000', '2018-09-04T00:00:00.000000000',\n       '2018-09-08T00:00:00.000000000', '2018-09-12T00:00:00.000000000',\n       '2018-09-16T00:00:00.000000000', '2018-09-20T00:00:00.000000000',\n       '2018-09-24T00:00:00.000000000', '2018-09-28T00:00:00.000000000',\n       '2018-10-02T00:00:00.000000000'], dtype='datetime64[ns]')\nCoordinates:\n  * time     (time) datetime64[ns] 2018-01-03 2018-01-07 ... 2018-10-02\nAttributes:\n    standard_name:  time\n    bounds:         time_bnds","content_type":"text/plain"}}}],"key":"kko4yc9LUr"}],"key":"VRnKhki0vm"},{"type":"block","kind":"notebook-code","data":{},"children":[{"type":"code","lang":"python","executable":true,"value":"selected_time = '2018-08-03' #User's input. Must be a value in cube.time\n\n# True color image\n\nfactor = 2.5\nR = cube.B04.sel(time=selected_time)*factor\nG = cube.B03.sel(time=selected_time)*factor\nB = cube.B02.sel(time=selected_time)*factor\nRGB = np.dstack([R, G, B])\nrgb_array = xr.DataArray(RGB, dims=('lat', 'lon', 'b'), coords=dict(lat=cube.B04.lat, lon=cube.B04.lon))\nrgb_array.plot.imshow(rgb='b', figsize=(16, 16))","key":"TVRRQsMn1T"},{"type":"output","id":"Hil6C3Ld-KkDSlXtqYjkR","data":[{"name":"stderr","output_type":"stream","text":"Clipping input data to the valid range for imshow with RGB data ([0..1] for floats or [0..255] for integers).\n"},{"output_type":"display_data","metadata":{"needs_background":"light"},"data":{"image/png":{"content_type":"image/png","hash":"2f36ca2e36531dc736bea3d7cfd06609","path":"/notebooks_test/build/2f36ca2e36531dc736bea3d7cfd06609.png"},"text/plain":{"content":"\u003cFigure size 1152x1152 with 1 Axes\u003e","content_type":"text/plain"}}}],"key":"FgBCCTc9Qw"}],"key":"wdLGpfa50r"},{"type":"block","kind":"notebook-content","data":{},"children":[{"type":"heading","depth":1,"position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"children":[{"type":"text","value":"Part 2: Crop Type prediction with Machine Learning","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"y2MeLidXgY"}],"identifier":"part-2-crop-type-prediction-with-machine-learning","label":"Part 2: Crop Type prediction with Machine Learning","html_id":"part-2-crop-type-prediction-with-machine-learning","implicit":true,"key":"oHQkv7w8bx"}],"key":"AnPe0nHQsa"},{"type":"block","kind":"notebook-content","data":{},"children":[{"type":"heading","depth":2,"position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"children":[{"type":"text","value":"Set some of the inputs for prediction with ML","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"rdXDKBeanQ"}],"identifier":"set-some-of-the-inputs-for-prediction-with-ml","label":"Set some of the inputs for prediction with ML","html_id":"set-some-of-the-inputs-for-prediction-with-ml","implicit":true,"key":"C52u9EGSU7"}],"key":"CAGXqVew2m"},{"type":"block","kind":"notebook-code","data":{},"children":[{"type":"code","lang":"python","executable":true,"value":"selected_date_for_reference_data = '2018-06-30'\nselected_date_interval_for_satellite_imagery = ['2018-01-01', '2018-09-30']\nselected_max_cc = 0.8","key":"poK2oSo6Vv"},{"type":"output","id":"n8nceH1xzjo7T1jFHwxSJ","data":[],"key":"Q3CVbjUC50"}],"key":"wxDNEA0dOT"},{"type":"block","kind":"notebook-content","data":{},"children":[{"type":"heading","depth":2,"position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"children":[{"type":"text","value":"Fill EOPatches with data:","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"Upz9jccdBn"}],"identifier":"fill-eopatches-with-data","label":"Fill EOPatches with data:","html_id":"fill-eopatches-with-data","implicit":true,"key":"RSryJUVlFj"},{"type":"paragraph","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"children":[{"type":"text","value":"Now it’s time to create EOPatches and fill them with Sentinel-2 data using Sentinel Hub services. We will add the following data to each EOPatch:","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"key":"eg7I9WlfZE"}],"key":"lizNhpuZv0"},{"type":"list","ordered":false,"spread":false,"position":{"start":{"line":5,"column":1},"end":{"line":8,"column":1}},"children":[{"type":"listItem","spread":true,"position":{"start":{"line":5,"column":1},"end":{"line":6,"column":1}},"children":[{"type":"paragraph","position":{"start":{"line":5,"column":1},"end":{"line":5,"column":1}},"children":[{"type":"text","value":"L1C custom list of bands [B02, B03, B04, B08, B11, B12], which corresponds to [B, G, R, NIR, SWIR1, SWIR2] wavelengths.","position":{"start":{"line":5,"column":1},"end":{"line":5,"column":1}},"key":"poJLOmfXFv"}],"key":"Uz3haHkImm"}],"key":"EQbkDnBzhL"},{"type":"listItem","spread":true,"position":{"start":{"line":7,"column":1},"end":{"line":8,"column":1}},"children":[{"type":"paragraph","position":{"start":{"line":7,"column":1},"end":{"line":7,"column":1}},"children":[{"type":"text","value":"SentinelHub’s cloud probability map and cloud mask","position":{"start":{"line":7,"column":1},"end":{"line":7,"column":1}},"key":"CnhezKFIy5"}],"key":"M71qFLtuYG"}],"key":"HLLBsPLZot"}],"key":"QOeRsMq8Hl"},{"type":"paragraph","position":{"start":{"line":9,"column":1},"end":{"line":9,"column":1}},"children":[{"type":"text","value":"Additionally, we will add:","position":{"start":{"line":9,"column":1},"end":{"line":9,"column":1}},"key":"N0owYrJekN"}],"key":"YocnKFmT4g"},{"type":"list","ordered":false,"spread":false,"position":{"start":{"line":11,"column":1},"end":{"line":17,"column":1}},"children":[{"type":"listItem","spread":true,"position":{"start":{"line":11,"column":1},"end":{"line":12,"column":1}},"children":[{"type":"paragraph","position":{"start":{"line":11,"column":1},"end":{"line":11,"column":1}},"children":[{"type":"text","value":"Calculated NDVI, NDWI, euclidean NORM information","position":{"start":{"line":11,"column":1},"end":{"line":11,"column":1}},"key":"irRXNcHUb5"}],"key":"aE6hFpTrW2"}],"key":"beyy2YFvEQ"},{"type":"listItem","spread":true,"position":{"start":{"line":13,"column":1},"end":{"line":17,"column":1}},"children":[{"type":"paragraph","position":{"start":{"line":13,"column":1},"end":{"line":13,"column":1}},"children":[{"type":"text","value":"A mask of validity, based on acquired data from Sentinel and cloud coverage. Valid pixel is if:","position":{"start":{"line":13,"column":1},"end":{"line":13,"column":1}},"key":"dSbBQ9lubf"}],"key":"TfKxI3GHS8"},{"type":"list","ordered":true,"start":1,"spread":false,"position":{"start":{"line":15,"column":1},"end":{"line":17,"column":1}},"children":[{"type":"listItem","spread":true,"position":{"start":{"line":15,"column":1},"end":{"line":15,"column":1}},"children":[{"type":"text","value":"IS_DATA == True","position":{"start":{"line":15,"column":1},"end":{"line":15,"column":1}},"key":"UCC9Nhzmev"}],"key":"c9fS9J6GKe"},{"type":"listItem","spread":true,"position":{"start":{"line":16,"column":1},"end":{"line":17,"column":1}},"children":[{"type":"text","value":"CLOUD_MASK == 0 (1 indicates that pixel was identified to be covered with cloud)","position":{"start":{"line":16,"column":1},"end":{"line":16,"column":1}},"key":"hEqiaV5jUj"}],"key":"mFwGyFZMcg"}],"key":"V1g91OAc0C"}],"key":"CR0RyVebg3"}],"key":"VStAsmrEXN"},{"type":"paragraph","position":{"start":{"line":18,"column":1},"end":{"line":18,"column":1}},"children":[{"type":"text","value":"An EOPatch is created and manipulated using EOTasks, which are chained in an EOWorkflow. In this example the final workflow is executed on all patches, which are saved to the specified directory.","position":{"start":{"line":18,"column":1},"end":{"line":18,"column":1}},"key":"K8Muk6XS5O"}],"key":"unq2aNYIMN"}],"key":"XBt747Gi0F"},{"type":"block","kind":"notebook-content","data":{},"children":[{"type":"heading","depth":3,"position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"children":[{"type":"text","value":"Define some needed custom EOTasks","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"kWK8tukuJ9"}],"identifier":"define-some-needed-custom-eotasks","label":"Define some needed custom EOTasks","html_id":"define-some-needed-custom-eotasks","implicit":true,"key":"N1ABcQySLE"}],"key":"zSuFJeW6gC"},{"type":"block","kind":"notebook-code","data":{},"children":[{"type":"code","lang":"python","executable":true,"value":"class SentinelHubValidData:\n    \"\"\"\n    Combine Sen2Cor's classification map with `IS_DATA` to define a `VALID_DATA_SH` mask\n    The SentinelHub's cloud mask is asumed to be found in eopatch.mask['CLM']\n    \"\"\"\n    def __call__(self, eopatch):        \n        return np.logical_and(eopatch.mask['IS_DATA'].astype(np.bool), \n                              np.logical_not(eopatch.mask['CLM'].astype(np.bool)))\n    \nclass CountValid(EOTask):   \n    \"\"\"\n    The task counts number of valid observations in time-series and stores the results in the timeless mask.\n    \"\"\"\n    def __init__(self, count_what, feature_name):\n        self.what = count_what\n        self.name = feature_name\n        \n    def execute(self, eopatch):\n        eopatch.add_feature(FeatureType.MASK_TIMELESS, self.name, np.count_nonzero(eopatch.mask[self.what],axis=0))\n        \n        return eopatch\n\n\nclass NormalizedDifferenceIndex(EOTask):   \n    \"\"\"\n    The tasks calculates user defined Normalised Difference Index (NDI) between two bands A and B as:\n    NDI = (A-B)/(A+B).\n    \"\"\"\n    def __init__(self, feature_name, band_a, band_b):\n        self.feature_name = feature_name\n        self.band_a_fetaure_name = band_a.split('/')[0]\n        self.band_b_fetaure_name = band_b.split('/')[0]\n        self.band_a_fetaure_idx = int(band_a.split('/')[-1])\n        self.band_b_fetaure_idx = int(band_b.split('/')[-1])\n        \n    def execute(self, eopatch):\n        band_a = eopatch.data[self.band_a_fetaure_name][..., self.band_a_fetaure_idx]\n        band_b = eopatch.data[self.band_b_fetaure_name][..., self.band_b_fetaure_idx]\n        \n        ndi = (band_a - band_b) / (band_a  + band_b)\n        \n        eopatch.add_feature(FeatureType.DATA, self.feature_name, ndi[..., np.newaxis])\n        \n        return eopatch\n\n    \nclass EuclideanNorm(EOTask):   \n    \"\"\"\n    The tasks calculates Euclidian Norm of all bands within an array:\n    norm = sqrt(sum_i Bi**2),\n    where Bi are the individual bands within user-specified feature array.\n    \"\"\"\n    def __init__(self, feature_name, in_feature_name):\n        self.feature_name = feature_name\n        self.in_feature_name = in_feature_name\n    \n    def execute(self, eopatch):\n        arr = eopatch.data[self.in_feature_name]\n        norm = np.sqrt(np.sum(arr**2, axis=-1))\n        \n        eopatch.add_feature(FeatureType.DATA, self.feature_name, norm[..., np.newaxis])\n        return eopatch","key":"D7OZPkzIyI"},{"type":"output","id":"Jk35cVVdLQW_aQbW5glc6","data":[],"key":"LQuwVeZWDm"}],"key":"M5R0fTMmhH"},{"type":"block","kind":"notebook-content","data":{},"children":[{"type":"heading","depth":3,"position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"children":[{"type":"text","value":"Define the workflow tasks","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"rl247xcK5C"}],"identifier":"define-the-workflow-tasks","label":"Define the workflow tasks","html_id":"define-the-workflow-tasks","implicit":true,"key":"N9VGjXyxYg"}],"key":"da3ByiFF2n"},{"type":"block","kind":"notebook-code","data":{},"children":[{"type":"code","lang":"python","executable":true,"value":"# TASK FOR BAND DATA\n# add a request for B(B02), G(B03), R(B04), NIR (B08), SWIR1(B11), SWIR2(B12) \n# from default layer 'ALL_BANDS' at 10m resolution\n# Here we also do a simple filter of cloudy scenes. A detailed cloud cover \n# detection is performed in the next step\ncustom_script = 'return [B02, B03, B04, B08, B11, B12];'\nadd_data = S2L1CWCSInput(\n    layer='BANDS-S2-L1C', \n    feature=(FeatureType.DATA, 'BANDS'), # save under name 'BANDS'\n    custom_url_params={CustomUrlParam.EVALSCRIPT: custom_script}, # custom url for 6 specific bands\n    resx='10m', # resolution x\n    resy='10m', # resolution y\n    maxcc=selected_max_cc # maximum allowed cloud cover of original ESA tiles\n)\n\n# TASK FOR CLOUD INFO\n# cloud detection is performed at 80m resolution \n# and the resulting cloud probability map and mask \n# are scaled to EOPatch's resolution\ncloud_classifier = get_s2_pixel_cloud_detector(average_over=2, dilation_size=1, all_bands=False)\nadd_clm = AddCloudMaskTask(cloud_classifier, 'BANDS-S2CLOUDLESS', cm_size_y='80m', cm_size_x='80m', \n                           cmask_feature='CLM', # cloud mask name\n                           cprobs_feature='CLP' # cloud prob. map name\n                          )\n\n# TASKS FOR CALCULATING NEW FEATURES\n# NDVI: (B08 - B04)/(B08 + B04)\n# NDWI: (B03 - B08)/(B03 + B08)\n# NORM: sqrt(B02^2 + B03^2 + B04^2 + B08^2 + B11^2 + B12^2)\nndvi = NormalizedDifferenceIndex('NDVI', 'BANDS/3', 'BANDS/2')\nndwi = NormalizedDifferenceIndex('NDWI', 'BANDS/1', 'BANDS/3')\nnorm = EuclideanNorm('NORM','BANDS')\n\n# TASK FOR VALID MASK\n# validate pixels using SentinelHub's cloud detection mask and region of acquisition \nadd_sh_valmask = AddValidDataMaskTask(SentinelHubValidData(), \n                                      'IS_VALID' # name of output mask\n                                     )\n\n# TASK FOR COUNTING VALID PIXELS\n# count number of valid observations per pixel using valid data mask \ncount_val_sh = CountValid('IS_VALID', # name of existing mask\n                          'VALID_COUNT' # name of output scalar\n                         )\n\n# TASK FOR SAVING TO OUTPUT (if needed)\npath_out = './eopatches_small' if use_smaller_patches else './eopatches_large'\nif not os.path.isdir(path_out):\n    os.makedirs(path_out)\nsave = SaveTask(path_out, overwrite_permission=OverwritePermission.OVERWRITE_PATCH)","key":"qRq50alfbx"},{"type":"output","id":"0h3zP5HRhe8prXmRWbhFB","data":[],"key":"je3sp46sGj"}],"key":"OK6BPMlncF"},{"type":"block","kind":"notebook-content","data":{},"children":[{"type":"heading","depth":3,"position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"children":[{"type":"text","value":"Reference map task","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"rFjQ8MtgAj"}],"identifier":"reference-map-task","label":"Reference map task","html_id":"reference-map-task","implicit":true,"key":"eqCeqKg5Fa"},{"type":"paragraph","position":{"start":{"line":3,"column":1},"end":{"line":4,"column":1}},"children":[{"type":"text","value":"For this example the LPIS Data from the austrian Open Government Data portal ","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"key":"cTFuDI8kyM"},{"type":"link","url":"http://data.gv.at","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"children":[{"type":"text","value":"data.gv.at","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"key":"Q7YAIki8V9"}],"urlSource":"http://data.gv.at","key":"Dsi0lY9HTE"},{"type":"text","value":" is used: ","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"key":"ehty18Zvzx"},{"type":"link","url":"https://www.data.gv.at/katalog/dataset/e21a731f-9e08-4dd3-b9e5-cd460438a5d9","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"children":[{"type":"text","value":"INVEKOS Schläge Österreich","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"key":"wxEKlmthvs"}],"urlSource":"https://www.data.gv.at/katalog/dataset/e21a731f-9e08-4dd3-b9e5-cd460438a5d9","key":"bjxJ7DE6gk"},{"type":"text","value":"\nThe crop types are grouped into 23 groups for classification:","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"key":"T9s5I1cvGm"}],"key":"ZLpUGC1Ech"}],"key":"R8IIDQ5uU2"},{"type":"block","kind":"notebook-code","data":{},"children":[{"type":"code","lang":"python","executable":true,"value":"class CTGROUPS(Enum):\n    NO_DATA                   = (0, \"NO_DATA\", \"#ffffff\")\n    SOMMERGETREIDE            = (1, \"SOMMERGETREIDE\", \"#7bf500\")\n    WINTERGETREIDE            = (2, \"WINTERGETREIDE\", \"#a8ff2b\")\n    MENGGETREIDE_AEHNLICHES   = (3, \"MENGGETREIDE_AEHNLICHES\", \"#daff1f\")\n    MAIS_AEHNLICHES           = (4, \"MAIS_AEHNLICHES\", \"#fff200\")\n    SOMMERRAPS_AEHNLICHES     = (5, \"SOMMERRAPS_AEHNLICHES\", \"#ffd701\")\n    WINTERRAPS_AEHNLICHES     = (6, \"WINTERRAPS_AEHNLICHES\", \"#ffbc0c\")\n    SONNENBLUME               = (7, \"SONNENBLUME\", \"#ff7005\")\n    HANF                      = (8, \"HANF\", \"#ff2a00\")\n    LEGUMINOSEN_AEHNLICHES    = (9, \"LEGUMINOSEN_AEHNLICHES\", \"#ff0046\")\n    WINTERLEGUMINOSE          = (10, \"WINTERLEGUMINOSE\", \"#ff00f8\")\n    KARTOFFELN_AEHNLICHES     = (11, \"KARTOFFELN_AEHNLICHES\", \"#b325ff\")\n    RUEBEN                    = (12, \"RUEBEN\", \"#cd61f4\")\n    GEMUESE_AEHNLICHES        = (13, \"GEMUESE_AEHNLICHES\", \"#ef96f1\")\n    GEWUERZE_AEHNLICHES       = (14, \"GEWUERZE_AEHNLICHES\", \"#f6c9f7\")\n    WINTERGEWUERZE_AEHNLICHES = (15, \"WINTERGEWUERZE_AEHNLICHES\", \"#000080\")\n    KUERBIS                   = (16, \"KUERBIS\", \"#004821\")\n    BRACHE                    = (17, \"BRACHE\", \"#00288a\")\n    DAUERKULTUR               = (18, \"DAUERKULTUR\", \"#0046ff\")\n    GEWAECHSHAUS              = (19, \"GEWAECHSHAUS\", \"#00c5ff\")\n    WEIN                      = (20, \"WEIN\", \"#00f6f8\")\n    GRUENLAND                 = (21, \"GRUENLAND\", \"#26ef00\")\n    PRO_RATA                  = (22, \"PRO_RATA\", \"#67d400\")\n    LAGERFLAECHEN             = (23, \"LAGERFLAECHEN\", \"#aaaaaa\")\n    SONSTIGES                 = (24, \"SONSTIGES\", \"#555555\")\n\n    \n    def __init__(self, val1, val2, val3):\n        self.id = val1\n        self.class_name = val2\n        self.color = val3\n\n\n#Reference colormap things\nct_cmap = mpl.colors.ListedColormap([entry.color for entry in CTGROUPS])\nct_norm = mpl.colors.BoundaryNorm(np.arange(-0.5, 24, 1), ct_cmap.N)","key":"IXeiyVC0zp"},{"type":"output","id":"slhzwBhckwhprValha3hd","data":[],"key":"lrRSx2zBPd"}],"key":"im0eXt4FZC"},{"type":"block","kind":"notebook-content","data":{},"children":[{"type":"paragraph","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"children":[{"type":"text","value":"The main point of this task is to create a raster mask from the vector polygons and add it to the eopatch. With this procedure, any kind of a labeled shapefile can be transformed into a raster reference map. This result is achieved with the existing task ","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"MadgHuSWRU"},{"type":"inlineCode","value":"VectorToRaster","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"cXWhxd0ohv"},{"type":"text","value":" from the ","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"PDiwbXJnpU"},{"type":"inlineCode","value":"eolearn.geometry","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"fzbTUm56zx"},{"type":"text","value":" package. All polygons belonging to the each of the classes are separately burned to the raster mask.","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"H3KjtPsLu9"}],"key":"UjJndCY9pj"}],"key":"p9r2G6VjDl"},{"type":"block","kind":"notebook-code","data":{},"children":[{"type":"code","lang":"python","executable":true,"value":"# user param\nLPISRecordsDateMin = selected_date_for_reference_data \nLPISRecordsDateMax = selected_date_for_reference_data\n\nclass LoadFromDatabaseTask(EOTask):\n    def __init__(self, feature, taskName, crs, tableName, dateFilterMin, dateFilterMax, mappedColumnName = None, mappingLambdaFunc = None):\n        self.feature_type, self.feature_name = next(self._parse_features(feature)())\n        self.taskName = taskName\n        self.crs = crs\n        self.tableName = tableName\n        self.dateFilterMin = dateFilterMin\n        self.dateFilterMax = dateFilterMax\n        self.mappedColumnName = mappedColumnName\n        self.mappingLambdaFunc = mappingLambdaFunc\n\n    def execute(self, eopatch, db_conn):\n        eopatch[self.feature_type][self.feature_name] = loadFromDatabase(db_conn, \n            self.taskName, self.tableName, eopatch.bbox, \n            self.dateFilterMin, self.dateFilterMax, \n            self.mappedColumnName, self.mappingLambdaFunc)\n        return eopatch\n    \n\n# LPIS\nct_use_db_task = LoadFromDatabaseTask((FeatureType.VECTOR_TIMELESS, 'CROP_TYPE_GDF'), \n    \"crop type\", CRS.UTM_33N, \"lpis_at\", LPISRecordsDateMin, LPISRecordsDateMax, \n    \"ct\", lambda ct_id: ctnuml4aToctMapping[ct_id] if ct_id in ctnuml4aToctMapping else 0)\n\n\nct_rasterization_task = VectorToRaster((FeatureType.VECTOR_TIMELESS, 'CROP_TYPE_GDF'), (FeatureType.MASK_TIMELESS, 'CROP_TYPE'),\n    values_column='ct', raster_shape=(FeatureType.MASK, 'IS_VALID'),\n    raster_dtype=np.uint8)\n\nct_export_tiff = ExportToTiff((FeatureType.MASK_TIMELESS, 'CROP_TYPE'))","key":"XNlEMfIa0h"},{"type":"output","id":"hZaffuifWrRfG-zGhgdCi","data":[],"key":"tcp67c4tSa"}],"key":"jzvY8hnwNV"},{"type":"block","kind":"notebook-content","data":{},"children":[{"type":"heading","depth":3,"position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"children":[{"type":"text","value":"Define the workflow","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"W3LaKwfRzQ"}],"identifier":"define-the-workflow","label":"Define the workflow","html_id":"define-the-workflow","implicit":true,"key":"EwW9POexqB"},{"type":"paragraph","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"children":[{"type":"text","value":"All the tasks that were defined so far create and fill the EOPatches. The tasks need to be put in some order and executed one by one. This can be achieved by manually executing the tasks, or more conveniently, defining an ","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"key":"m6l4WFaBLV"},{"type":"inlineCode","value":"EOWorkflow","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"key":"iYJHEtpwcd"},{"type":"text","value":" which does this for you.","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"key":"btWIEw54O2"}],"key":"uS3ToxSDrz"},{"type":"paragraph","position":{"start":{"line":5,"column":1},"end":{"line":5,"column":1}},"children":[{"type":"text","value":"The following workflow is created and executed:","position":{"start":{"line":5,"column":1},"end":{"line":5,"column":1}},"key":"GKoV61wkUO"}],"key":"X33an0C27X"},{"type":"list","ordered":true,"start":1,"spread":false,"position":{"start":{"line":7,"column":1},"end":{"line":13,"column":1}},"children":[{"type":"listItem","spread":true,"position":{"start":{"line":7,"column":1},"end":{"line":7,"column":1}},"children":[{"type":"text","value":"Create EOPatches with band data","position":{"start":{"line":7,"column":1},"end":{"line":7,"column":1}},"key":"XSZYCw1zH0"}],"key":"dvCgOBP9wQ"},{"type":"listItem","spread":true,"position":{"start":{"line":8,"column":1},"end":{"line":8,"column":1}},"children":[{"type":"text","value":"Add cloud info","position":{"start":{"line":8,"column":1},"end":{"line":8,"column":1}},"key":"s0VqE8imgK"}],"key":"q75JSuNCiR"},{"type":"listItem","spread":true,"position":{"start":{"line":9,"column":1},"end":{"line":9,"column":1}},"children":[{"type":"text","value":"Calculate and add NDVI, NDWI, NORM","position":{"start":{"line":9,"column":1},"end":{"line":9,"column":1}},"key":"Pf6wCEjaUT"}],"key":"Gne7mkITkQ"},{"type":"listItem","spread":true,"position":{"start":{"line":10,"column":1},"end":{"line":10,"column":1}},"children":[{"type":"text","value":"Add mask of valid pixels","position":{"start":{"line":10,"column":1},"end":{"line":10,"column":1}},"key":"Hif5uwiW7v"}],"key":"h0Zio05eQD"},{"type":"listItem","spread":true,"position":{"start":{"line":11,"column":1},"end":{"line":11,"column":1}},"children":[{"type":"text","value":"Add scalar feature representing the cound of valid pixels","position":{"start":{"line":11,"column":1},"end":{"line":11,"column":1}},"key":"GJHORWoMYT"}],"key":"AquT1FUmg1"},{"type":"listItem","spread":true,"position":{"start":{"line":12,"column":1},"end":{"line":13,"column":1}},"children":[{"type":"text","value":"Save eopatches","position":{"start":{"line":12,"column":1},"end":{"line":12,"column":1}},"key":"mlTFPympcI"}],"key":"LLw8KM3uRG"}],"key":"CdeVB5ZTDy"},{"type":"paragraph","position":{"start":{"line":14,"column":1},"end":{"line":14,"column":1}},"children":[{"type":"text","value":"An EOWorkflow can be linear or more complex, but it should be acyclic. Here we will use the linear case of the EOWorkflow, available as ","position":{"start":{"line":14,"column":1},"end":{"line":14,"column":1}},"key":"IJYWp5B7M4"},{"type":"inlineCode","value":"LinearWorkflow","position":{"start":{"line":14,"column":1},"end":{"line":14,"column":1}},"key":"uZMrkvnHky"}],"key":"JwYu5h2AiF"}],"key":"oUYYZola6w"},{"type":"block","kind":"notebook-content","data":{},"children":[{"type":"paragraph","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"children":[{"type":"text","value":"Define the workflow","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"TcngyybapL"}],"key":"RbmyHmz7UC"}],"key":"Ugnr3N3fHq"},{"type":"block","kind":"notebook-code","data":{},"children":[{"type":"code","lang":"python","executable":true,"value":"# Define the workflow\nworkflow = LinearWorkflow(\n    add_data,\n    add_clm,\n    ndvi,\n    ndwi,\n    norm,\n    add_sh_valmask,\n    count_val_sh,\n    ct_use_db_task,\n    ct_rasterization_task,\n    ct_export_tiff,\n    save\n)\n\n# Let's visualize it\nworkflow.dependency_graph()","key":"xqiCqPGfmW"},{"type":"output","id":"dThoFHbOCBVIcYn1OuHSb","data":[{"output_type":"execute_result","execution_count":17,"metadata":{},"data":{"image/svg+xml":{"content":"\u003c?xml version=\"1.0\" encoding=\"UTF-8\" standalone=\"no\"?\u003e\n\u003c!DOCTYPE svg PUBLIC \"-//W3C//DTD SVG 1.1//EN\"\n \"http://www.w3.org/Graphics/SVG/1.1/DTD/svg11.dtd\"\u003e\n\u003c!-- Generated by graphviz version 2.42.3 (20191010.1750)\n --\u003e\n\u003c!-- Title: %3 Pages: 1 --\u003e\n\u003csvg width=\"2183pt\" height=\"44pt\"\n viewBox=\"0.00 0.00 2182.64 44.00\" xmlns=\"http://www.w3.org/2000/svg\" xmlns:xlink=\"http://www.w3.org/1999/xlink\"\u003e\n\u003cg id=\"graph0\" class=\"graph\" transform=\"scale(1 1) rotate(0) translate(4 40)\"\u003e\n\u003ctitle\u003e%3\u003c/title\u003e\n\u003cpolygon fill=\"white\" stroke=\"transparent\" points=\"-4,4 -4,-40 2178.64,-40 2178.64,4 -4,4\"/\u003e\n\u003c!-- S2L1CWCSInput --\u003e\n\u003cg id=\"node1\" class=\"node\"\u003e\n\u003ctitle\u003eS2L1CWCSInput\u003c/title\u003e\n\u003cellipse fill=\"none\" stroke=\"black\" cx=\"78.64\" cy=\"-18\" rx=\"78.79\" ry=\"18\"/\u003e\n\u003ctext text-anchor=\"middle\" x=\"78.64\" y=\"-14.3\" font-family=\"Times,serif\" font-size=\"14.00\"\u003eS2L1CWCSInput\u003c/text\u003e\n\u003c/g\u003e\n\u003c!-- AddCloudMaskTask --\u003e\n\u003cg id=\"node2\" class=\"node\"\u003e\n\u003ctitle\u003eAddCloudMaskTask\u003c/title\u003e\n\u003cellipse fill=\"none\" stroke=\"black\" cx=\"282.33\" cy=\"-18\" rx=\"89.08\" ry=\"18\"/\u003e\n\u003ctext text-anchor=\"middle\" x=\"282.33\" y=\"-14.3\" font-family=\"Times,serif\" font-size=\"14.00\"\u003eAddCloudMaskTask\u003c/text\u003e\n\u003c/g\u003e\n\u003c!-- S2L1CWCSInput\u0026#45;\u0026gt;AddCloudMaskTask --\u003e\n\u003cg id=\"edge1\" class=\"edge\"\u003e\n\u003ctitle\u003eS2L1CWCSInput\u0026#45;\u0026gt;AddCloudMaskTask\u003c/title\u003e\n\u003cpath fill=\"none\" stroke=\"black\" d=\"M157.33,-18C165.79,-18 174.47,-18 183.13,-18\"/\u003e\n\u003cpolygon fill=\"black\" stroke=\"black\" points=\"183.26,-21.5 193.26,-18 183.26,-14.5 183.26,-21.5\"/\u003e\n\u003c/g\u003e\n\u003c!-- NormalizedDifferenceIndex --\u003e\n\u003cg id=\"node3\" class=\"node\"\u003e\n\u003ctitle\u003eNormalizedDifferenceIndex\u003c/title\u003e\n\u003cellipse fill=\"none\" stroke=\"black\" cx=\"521.76\" cy=\"-18\" rx=\"114.28\" ry=\"18\"/\u003e\n\u003ctext text-anchor=\"middle\" x=\"521.76\" y=\"-14.3\" font-family=\"Times,serif\" font-size=\"14.00\"\u003eNormalizedDifferenceIndex\u003c/text\u003e\n\u003c/g\u003e\n\u003c!-- AddCloudMaskTask\u0026#45;\u0026gt;NormalizedDifferenceIndex --\u003e\n\u003cg id=\"edge2\" class=\"edge\"\u003e\n\u003ctitle\u003eAddCloudMaskTask\u0026#45;\u0026gt;NormalizedDifferenceIndex\u003c/title\u003e\n\u003cpath fill=\"none\" stroke=\"black\" d=\"M371.4,-18C379.75,-18 388.31,-18 396.91,-18\"/\u003e\n\u003cpolygon fill=\"black\" stroke=\"black\" points=\"397.02,-21.5 407.02,-18 397.02,-14.5 397.02,-21.5\"/\u003e\n\u003c/g\u003e\n\u003c!-- NormalizedDifferenceIndex_1 --\u003e\n\u003cg id=\"node4\" class=\"node\"\u003e\n\u003ctitle\u003eNormalizedDifferenceIndex_1\u003c/title\u003e\n\u003cellipse fill=\"none\" stroke=\"black\" cx=\"796.29\" cy=\"-18\" rx=\"124.28\" ry=\"18\"/\u003e\n\u003ctext text-anchor=\"middle\" x=\"796.29\" y=\"-14.3\" font-family=\"Times,serif\" font-size=\"14.00\"\u003eNormalizedDifferenceIndex_1\u003c/text\u003e\n\u003c/g\u003e\n\u003c!-- NormalizedDifferenceIndex\u0026#45;\u0026gt;NormalizedDifferenceIndex_1 --\u003e\n\u003cg id=\"edge3\" class=\"edge\"\u003e\n\u003ctitle\u003eNormalizedDifferenceIndex\u0026#45;\u0026gt;NormalizedDifferenceIndex_1\u003c/title\u003e\n\u003cpath fill=\"none\" stroke=\"black\" d=\"M636.36,-18C644.67,-18 653.09,-18 661.5,-18\"/\u003e\n\u003cpolygon fill=\"black\" stroke=\"black\" points=\"661.75,-21.5 671.75,-18 661.75,-14.5 661.75,-21.5\"/\u003e\n\u003c/g\u003e\n\u003c!-- EuclideanNorm --\u003e\n\u003cg id=\"node5\" class=\"node\"\u003e\n\u003ctitle\u003eEuclideanNorm\u003c/title\u003e\n\u003cellipse fill=\"none\" stroke=\"black\" cx=\"1025.97\" cy=\"-18\" rx=\"69.59\" ry=\"18\"/\u003e\n\u003ctext text-anchor=\"middle\" x=\"1025.97\" y=\"-14.3\" font-family=\"Times,serif\" font-size=\"14.00\"\u003eEuclideanNorm\u003c/text\u003e\n\u003c/g\u003e\n\u003c!-- NormalizedDifferenceIndex_1\u0026#45;\u0026gt;EuclideanNorm --\u003e\n\u003cg id=\"edge4\" class=\"edge\"\u003e\n\u003ctitle\u003eNormalizedDifferenceIndex_1\u0026#45;\u0026gt;EuclideanNorm\u003c/title\u003e\n\u003cpath fill=\"none\" stroke=\"black\" d=\"M920.46,-18C929.18,-18 937.82,-18 946.18,-18\"/\u003e\n\u003cpolygon fill=\"black\" stroke=\"black\" points=\"946.23,-21.5 956.23,-18 946.23,-14.5 946.23,-21.5\"/\u003e\n\u003c/g\u003e\n\u003c!-- AddValidDataMaskTask --\u003e\n\u003cg id=\"node6\" class=\"node\"\u003e\n\u003ctitle\u003eAddValidDataMaskTask\u003c/title\u003e\n\u003cellipse fill=\"none\" stroke=\"black\" cx=\"1233.56\" cy=\"-18\" rx=\"102.08\" ry=\"18\"/\u003e\n\u003ctext text-anchor=\"middle\" x=\"1233.56\" y=\"-14.3\" font-family=\"Times,serif\" font-size=\"14.00\"\u003eAddValidDataMaskTask\u003c/text\u003e\n\u003c/g\u003e\n\u003c!-- EuclideanNorm\u0026#45;\u0026gt;AddValidDataMaskTask --\u003e\n\u003cg id=\"edge5\" class=\"edge\"\u003e\n\u003ctitle\u003eEuclideanNorm\u0026#45;\u0026gt;AddValidDataMaskTask\u003c/title\u003e\n\u003cpath fill=\"none\" stroke=\"black\" d=\"M1095.71,-18C1103.94,-18 1112.49,-18 1121.12,-18\"/\u003e\n\u003cpolygon fill=\"black\" stroke=\"black\" points=\"1121.27,-21.5 1131.27,-18 1121.27,-14.5 1121.27,-21.5\"/\u003e\n\u003c/g\u003e\n\u003c!-- CountValid --\u003e\n\u003cg id=\"node7\" class=\"node\"\u003e\n\u003ctitle\u003eCountValid\u003c/title\u003e\n\u003cellipse fill=\"none\" stroke=\"black\" cx=\"1425.54\" cy=\"-18\" rx=\"53.89\" ry=\"18\"/\u003e\n\u003ctext text-anchor=\"middle\" x=\"1425.54\" y=\"-14.3\" font-family=\"Times,serif\" font-size=\"14.00\"\u003eCountValid\u003c/text\u003e\n\u003c/g\u003e\n\u003c!-- AddValidDataMaskTask\u0026#45;\u0026gt;CountValid --\u003e\n\u003cg id=\"edge6\" class=\"edge\"\u003e\n\u003ctitle\u003eAddValidDataMaskTask\u0026#45;\u0026gt;CountValid\u003c/title\u003e\n\u003cpath fill=\"none\" stroke=\"black\" d=\"M1335.67,-18C1344.27,-18 1352.8,-18 1360.98,-18\"/\u003e\n\u003cpolygon fill=\"black\" stroke=\"black\" points=\"1361.13,-21.5 1371.13,-18 1361.13,-14.5 1361.13,-21.5\"/\u003e\n\u003c/g\u003e\n\u003c!-- LoadFromDatabaseTask --\u003e\n\u003cg id=\"node8\" class=\"node\"\u003e\n\u003ctitle\u003eLoadFromDatabaseTask\u003c/title\u003e\n\u003cellipse fill=\"none\" stroke=\"black\" cx=\"1616.88\" cy=\"-18\" rx=\"101.28\" ry=\"18\"/\u003e\n\u003ctext text-anchor=\"middle\" x=\"1616.88\" y=\"-14.3\" font-family=\"Times,serif\" font-size=\"14.00\"\u003eLoadFromDatabaseTask\u003c/text\u003e\n\u003c/g\u003e\n\u003c!-- CountValid\u0026#45;\u0026gt;LoadFromDatabaseTask --\u003e\n\u003cg id=\"edge7\" class=\"edge\"\u003e\n\u003ctitle\u003eCountValid\u0026#45;\u0026gt;LoadFromDatabaseTask\u003c/title\u003e\n\u003cpath fill=\"none\" stroke=\"black\" d=\"M1479.54,-18C1487.72,-18 1496.43,-18 1505.33,-18\"/\u003e\n\u003cpolygon fill=\"black\" stroke=\"black\" points=\"1505.44,-21.5 1515.44,-18 1505.44,-14.5 1505.44,-21.5\"/\u003e\n\u003c/g\u003e\n\u003c!-- VectorToRaster --\u003e\n\u003cg id=\"node9\" class=\"node\"\u003e\n\u003ctitle\u003eVectorToRaster\u003c/title\u003e\n\u003cellipse fill=\"none\" stroke=\"black\" cx=\"1821.86\" cy=\"-18\" rx=\"67.69\" ry=\"18\"/\u003e\n\u003ctext text-anchor=\"middle\" x=\"1821.86\" y=\"-14.3\" font-family=\"Times,serif\" font-size=\"14.00\"\u003eVectorToRaster\u003c/text\u003e\n\u003c/g\u003e\n\u003c!-- LoadFromDatabaseTask\u0026#45;\u0026gt;VectorToRaster --\u003e\n\u003cg id=\"edge8\" class=\"edge\"\u003e\n\u003ctitle\u003eLoadFromDatabaseTask\u0026#45;\u0026gt;VectorToRaster\u003c/title\u003e\n\u003cpath fill=\"none\" stroke=\"black\" d=\"M1718.48,-18C1727.06,-18 1735.64,-18 1743.99,-18\"/\u003e\n\u003cpolygon fill=\"black\" stroke=\"black\" points=\"1744.04,-21.5 1754.04,-18 1744.04,-14.5 1744.04,-21.5\"/\u003e\n\u003c/g\u003e\n\u003c!-- ExportToTiff --\u003e\n\u003cg id=\"node10\" class=\"node\"\u003e\n\u003ctitle\u003eExportToTiff\u003c/title\u003e\n\u003cellipse fill=\"none\" stroke=\"black\" cx=\"1985.9\" cy=\"-18\" rx=\"60.39\" ry=\"18\"/\u003e\n\u003ctext text-anchor=\"middle\" x=\"1985.9\" y=\"-14.3\" font-family=\"Times,serif\" font-size=\"14.00\"\u003eExportToTiff\u003c/text\u003e\n\u003c/g\u003e\n\u003c!-- VectorToRaster\u0026#45;\u0026gt;ExportToTiff --\u003e\n\u003cg id=\"edge9\" class=\"edge\"\u003e\n\u003ctitle\u003eVectorToRaster\u0026#45;\u0026gt;ExportToTiff\u003c/title\u003e\n\u003cpath fill=\"none\" stroke=\"black\" d=\"M1889.71,-18C1898.07,-18 1906.65,-18 1915.06,-18\"/\u003e\n\u003cpolygon fill=\"black\" stroke=\"black\" points=\"1915.21,-21.5 1925.21,-18 1915.21,-14.5 1915.21,-21.5\"/\u003e\n\u003c/g\u003e\n\u003c!-- SaveTask --\u003e\n\u003cg id=\"node11\" class=\"node\"\u003e\n\u003ctitle\u003eSaveTask\u003c/title\u003e\n\u003cellipse fill=\"none\" stroke=\"black\" cx=\"2128.49\" cy=\"-18\" rx=\"46.29\" ry=\"18\"/\u003e\n\u003ctext text-anchor=\"middle\" x=\"2128.49\" y=\"-14.3\" font-family=\"Times,serif\" font-size=\"14.00\"\u003eSaveTask\u003c/text\u003e\n\u003c/g\u003e\n\u003c!-- ExportToTiff\u0026#45;\u0026gt;SaveTask --\u003e\n\u003cg id=\"edge10\" class=\"edge\"\u003e\n\u003ctitle\u003eExportToTiff\u0026#45;\u0026gt;SaveTask\u003c/title\u003e\n\u003cpath fill=\"none\" stroke=\"black\" d=\"M2046.53,-18C2055.04,-18 2063.77,-18 2072.19,-18\"/\u003e\n\u003cpolygon fill=\"black\" stroke=\"black\" points=\"2072.28,-21.5 2082.28,-18 2072.28,-14.5 2072.28,-21.5\"/\u003e\n\u003c/g\u003e\n\u003c/g\u003e\n\u003c/svg\u003e\n","content_type":"image/svg+xml"},"text/plain":{"content":"\u003cgraphviz.dot.Digraph at 0x7f066027e290\u003e","content_type":"text/plain"}}}],"key":"x5ciOzBkZn"}],"key":"ULeZlFkmlu"},{"type":"block","kind":"notebook-content","data":{},"children":[{"type":"paragraph","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"children":[{"type":"emphasis","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"children":[{"type":"text","value":"This may take some time, so go grab a cup of coffee ...","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"UbbNiuirz3"}],"key":"PDhepOUh2k"}],"key":"OLIXZ7O79z"}],"key":"PkuV9OhNu6"},{"type":"block","kind":"notebook-code","data":{},"children":[{"type":"code","lang":"python","executable":true,"value":"%%time\n\n# Execute the workflow\n\nsource_tiff_location = './source_tiff'\nif not os.path.isdir(source_tiff_location):\n    os.makedirs(source_tiff_location)\n\n# define additional parameters of the workflow\nwith psycopg2.connect(**db_conn_params) as db_conn: # must use single DB connection for all the tasks\n    execution_args = []\n    for idx, bbox in enumerate(bbox_list[patchIDs]):       \n        execution_args.append({\n            add_data: {'bbox': bbox, 'time_interval': selected_date_interval_for_satellite_imagery},\n            ct_use_db_task: {'db_conn': db_conn},\n            ct_export_tiff: {'filename': '{}/crop_type_eopatch_{}_original.tiff'.format(source_tiff_location, idx)},\n            save: {'eopatch_folder': 'eopatch_{}'.format(idx)}\n        })\n\nexecutor = EOExecutor(workflow, execution_args, save_logs=True)\nexecutor.run(workers=9, multiprocess=False)\n\nexecutor.make_report()","key":"dV3trKkxmc"},{"type":"output","id":"9RVjiO-rO-2pL_6Xyr5VM","data":[{"output_type":"display_data","metadata":{},"data":{"application/vnd.jupyter.widget-view+json":{"content":"{\"model_id\":\"5936511d02c44528a8b3e6de6b120ab0\",\"version_major\":2,\"version_minor\":0}","content_type":"application/vnd.jupyter.widget-view+json"},"text/plain":{"content":"HBox(children=(FloatProgress(value=0.0, max=9.0), HTML(value='')))","content_type":"text/plain"}}},{"name":"stdout","output_type":"stream","text":"crop type: 224 DB records for bbox = 538530.0,5400680.0,541080.0,5402600.0 32633\ncrop type: 301 DB records for bbox = 538530.0,5398760.0,541080.0,5400680.0 32633\ncrop type: 384 DB records for bbox = 533420.0,5400680.0,535980.0,5402600.0 32633\ncrop type: 259 DB records for bbox = 535980.0,5400680.0,538530.0,5402600.0 32633\ncrop type: 82 DB records for bbox = 533420.0,5396840.0,535980.0,5398760.0 32633\ncrop type: 500 DB records for bbox = 535980.0,5396840.0,538530.0,5398760.0 32633\ncrop type: 436 DB records for bbox = 535980.0,5398760.0,538530.0,5400680.0 32633\ncrop type: 456 DB records for bbox = 533420.0,5398760.0,535980.0,5400680.0 32633\ncrop type: 137 DB records for bbox = 538530.0,5396840.0,541080.0,5398760.0 32633\n\nCPU times: user 41 s, sys: 9.51 s, total: 50.5 s\nWall time: 46.9 s\n"}],"key":"gDd1q0M8Hv"}],"key":"TE9XQDd3yA"},{"type":"block","kind":"notebook-content","data":{},"children":[{"type":"paragraph","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"children":[{"type":"text","value":"In this case, all patches come from a small region, so all of them have the same dates of acquisition for at least a few dates, so we can inspect the area without interpolation at this point.","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"wiQP199STd"}],"key":"VWQsR9CZJd"}],"key":"U4PGT3Vo9n"},{"type":"block","kind":"notebook-content","data":{},"children":[{"type":"heading","depth":2,"position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"children":[{"type":"text","value":"Visualize the true color image","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"AnIvUcQOM2"}],"identifier":"visualize-the-true-color-image","label":"Visualize the true color image","html_id":"visualize-the-true-color-image","implicit":true,"key":"MXXs1YYt7r"}],"key":"ZOIaWeZD7F"},{"type":"block","kind":"notebook-code","data":{},"children":[{"type":"code","lang":"python","executable":true,"value":"# Draw the RGB image\npath_out = './eopatches_small' if use_smaller_patches else './eopatches_large/'\nfig = plt.figure(figsize=(20, 20 * aspect_ratio))\n\npbar = tqdm(total=9)\nfor i in range(9):\n    eopatch = EOPatch.load('{}/eopatch_{}'.format(path_out, i), lazy_loading=True)\n    ax = plt.subplot(3, 3, i + 1)\n    plt.imshow(np.clip(eopatch.data['BANDS'][0][..., [2, 1, 0]] * 3.5, 0, 1))\n    plt.xticks([])\n    plt.yticks([])\n    ax.set_aspect(\"auto\")\n    pbar.update(1)\n    del eopatch\n\nfig.subplots_adjust(wspace=0, hspace=0)","key":"im0sd9pJ4Z"},{"type":"output","id":"hBmkD5roNuwl6DqYlN5PS","data":[{"name":"stderr","output_type":"stream","text":"/opt/conda/lib/python3.7/site-packages/ipykernel_launcher.py:5: TqdmDeprecationWarning: This function will be removed in tqdm==5.0.0\nPlease use `tqdm.notebook.tqdm` instead of `tqdm.tqdm_notebook`\n  \"\"\"\n"},{"output_type":"display_data","metadata":{},"data":{"application/vnd.jupyter.widget-view+json":{"content":"{\"model_id\":\"8ffafeaef5894e769dc8fbe2520caf31\",\"version_major\":2,\"version_minor\":0}","content_type":"application/vnd.jupyter.widget-view+json"},"text/plain":{"content":"HBox(children=(FloatProgress(value=0.0, max=9.0), HTML(value='')))","content_type":"text/plain"}}},{"output_type":"display_data","metadata":{},"data":{"image/png":{"content_type":"image/png","hash":"a3fb404b0e5ea7b09d7d94008dc3aa76","path":"/notebooks_test/build/a3fb404b0e5ea7b09d7d94008dc3aa76.png"},"text/plain":{"content":"\u003cFigure size 1440x1080 with 9 Axes\u003e","content_type":"text/plain"}}}],"key":"dG5TEs17av"}],"key":"bUTHrsDTbY"},{"type":"block","kind":"notebook-content","data":{},"children":[{"type":"heading","depth":2,"position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"children":[{"type":"text","value":"Visualize the reference map","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"N44HxTzFCc"}],"identifier":"visualize-the-reference-map","label":"Visualize the reference map","html_id":"visualize-the-reference-map","implicit":true,"key":"L313ZpiQK0"}],"key":"qLtQl6TDg6"},{"type":"block","kind":"notebook-code","data":{},"children":[{"type":"code","lang":"python","executable":true,"value":"path_out = './eopatches_small/' if use_smaller_patches else './eopatches_large/'\n\nfig, axes = plt.subplots(figsize=(20, 20 * aspect_ratio), nrows=3, ncols=3)\n\npbar = tqdm(total=9)\nfor i, ax in enumerate(axes.flat):\n    eopatch = EOPatch.load('{}/eopatch_{}'.format(path_out, i), lazy_loading=True)\n    im = ax.imshow(eopatch.mask_timeless['CROP_TYPE'].squeeze(), cmap=ct_cmap, norm=ct_norm)\n    ax.set_xticks([])\n    ax.set_yticks([])\n    ax.set_aspect(\"auto\")\n    pbar.update(1)\n    del eopatch\n\nfig.subplots_adjust(wspace=0, hspace=0)\n\ncb = fig.colorbar(im, ax=axes.ravel().tolist(), orientation='horizontal', pad=0.01, aspect=100)\ncb.ax.tick_params(labelsize=20) \ncb.set_ticks([entry.id for entry in CTGROUPS])\ncb.ax.set_xticklabels([entry.class_name for entry in CTGROUPS], rotation=90, fontsize=15)\nplt.show()","key":"vUuKYQhsFg"},{"type":"output","id":"g3gi8N7xd072-8xlHNe2d","data":[{"name":"stderr","output_type":"stream","text":"/opt/conda/lib/python3.7/site-packages/ipykernel_launcher.py:5: TqdmDeprecationWarning: This function will be removed in tqdm==5.0.0\nPlease use `tqdm.notebook.tqdm` instead of `tqdm.tqdm_notebook`\n  \"\"\"\n"},{"output_type":"display_data","metadata":{},"data":{"application/vnd.jupyter.widget-view+json":{"content":"{\"model_id\":\"76ac0ef0a5ec4bb28a1bdb6e2e4e75a0\",\"version_major\":2,\"version_minor\":0}","content_type":"application/vnd.jupyter.widget-view+json"},"text/plain":{"content":"HBox(children=(FloatProgress(value=0.0, max=9.0), HTML(value='')))","content_type":"text/plain"}}},{"output_type":"display_data","metadata":{"needs_background":"light"},"data":{"image/png":{"content_type":"image/png","hash":"97e41be4c58473da8345ac351956f209","path":"/notebooks_test/build/97e41be4c58473da8345ac351956f209.png"},"text/plain":{"content":"\u003cFigure size 1440x1080 with 10 Axes\u003e","content_type":"text/plain"}}}],"key":"Jcjm0z9aYx"}],"key":"iaeqJYyO9v"},{"type":"block","kind":"notebook-content","data":{},"children":[{"type":"heading","depth":2,"position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"children":[{"type":"text","value":"Prepare the training data","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"k6X8QUOEW5"}],"identifier":"prepare-the-training-data","label":"Prepare the training data","html_id":"prepare-the-training-data","implicit":true,"key":"QqP7eSP8TM"},{"type":"paragraph","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"children":[{"type":"text","value":"We will create a new workflow that processes the data:","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"key":"HyHHkaz54D"}],"key":"Xo1SJWUJVK"},{"type":"list","ordered":true,"start":1,"spread":false,"position":{"start":{"line":5,"column":1},"end":{"line":17,"column":1}},"children":[{"type":"listItem","spread":true,"position":{"start":{"line":5,"column":1},"end":{"line":7,"column":1}},"children":[{"type":"text","value":"Remove too cloudy scenes","position":{"start":{"line":5,"column":1},"end":{"line":5,"column":1}},"key":"OaFefqGgCA"},{"type":"list","ordered":false,"spread":false,"position":{"start":{"line":6,"column":1},"end":{"line":7,"column":1}},"children":[{"type":"listItem","spread":true,"position":{"start":{"line":6,"column":1},"end":{"line":6,"column":1}},"children":[{"type":"text","value":"Check the ratio of the valid data for each patch and for each time frame","position":{"start":{"line":6,"column":1},"end":{"line":6,"column":1}},"key":"n2d9fs7D3h"}],"key":"punEmBHkUk"},{"type":"listItem","spread":true,"position":{"start":{"line":7,"column":1},"end":{"line":7,"column":1}},"children":[{"type":"text","value":"Keep only time frames with \u003e 80 % valid coverage (no clouds)","position":{"start":{"line":7,"column":1},"end":{"line":7,"column":1}},"key":"cS08EcqeI2"}],"key":"Rcx4sCfjiC"}],"key":"O7LP4izT8C"}],"key":"C3t0uE7A5w"},{"type":"listItem","spread":true,"position":{"start":{"line":8,"column":1},"end":{"line":8,"column":1}},"children":[{"type":"text","value":"Concatenate BAND, NDVI, NDWI, NORM info into a single feature called FEATURES","position":{"start":{"line":8,"column":1},"end":{"line":8,"column":1}},"key":"U4kn8SB79V"}],"key":"rOCSrKIJq6"},{"type":"listItem","spread":true,"position":{"start":{"line":9,"column":1},"end":{"line":11,"column":1}},"children":[{"type":"text","value":"Perform temporal interpolation (filling gaps and resampling to the same dates)","position":{"start":{"line":9,"column":1},"end":{"line":9,"column":1}},"key":"qun4YJVt4N"},{"type":"list","ordered":false,"spread":false,"position":{"start":{"line":10,"column":1},"end":{"line":11,"column":1}},"children":[{"type":"listItem","spread":true,"position":{"start":{"line":10,"column":1},"end":{"line":10,"column":1}},"children":[{"type":"text","value":"Create a task for linear interpolation in the temporal dimension","position":{"start":{"line":10,"column":1},"end":{"line":10,"column":1}},"key":"EUDZqhY9Bu"}],"key":"yeN7btP0M6"},{"type":"listItem","spread":true,"position":{"start":{"line":11,"column":1},"end":{"line":11,"column":1}},"children":[{"type":"text","value":"Provide the cloud mask to tell the interpolating function which values to update","position":{"start":{"line":11,"column":1},"end":{"line":11,"column":1}},"key":"UO0tJ194Ai"}],"key":"qSsFgixQCJ"}],"key":"DKdeaM8Wgj"}],"key":"ej69kURku1"},{"type":"listItem","spread":true,"position":{"start":{"line":12,"column":1},"end":{"line":13,"column":1}},"children":[{"type":"text","value":"Perform erosion","position":{"start":{"line":12,"column":1},"end":{"line":12,"column":1}},"key":"NEsWcQrqak"},{"type":"list","ordered":false,"spread":false,"position":{"start":{"line":13,"column":1},"end":{"line":13,"column":1}},"children":[{"type":"listItem","spread":true,"position":{"start":{"line":13,"column":1},"end":{"line":13,"column":1}},"children":[{"type":"text","value":"This removes artefacts with a width of 1 px, and also removes the edges between polygons of different classes","position":{"start":{"line":13,"column":1},"end":{"line":13,"column":1}},"key":"SMnvTtyW1U"}],"key":"ssC3kUNr0n"}],"key":"pfa0wLKkRO"}],"key":"mC7OD8VZmE"},{"type":"listItem","spread":true,"position":{"start":{"line":14,"column":1},"end":{"line":15,"column":1}},"children":[{"type":"text","value":"Random spatial sampling of the EOPatches","position":{"start":{"line":14,"column":1},"end":{"line":14,"column":1}},"key":"U0bwi3ND14"},{"type":"list","ordered":false,"spread":false,"position":{"start":{"line":15,"column":1},"end":{"line":15,"column":1}},"children":[{"type":"listItem","spread":true,"position":{"start":{"line":15,"column":1},"end":{"line":15,"column":1}},"children":[{"type":"text","value":"Randomly take a subset of pixels from a patch to use in the machine learning training","position":{"start":{"line":15,"column":1},"end":{"line":15,"column":1}},"key":"mw5U1mtuSf"}],"key":"hwJAlDJgDf"}],"key":"qnXUTV4oKj"}],"key":"LeY1iajGg5"},{"type":"listItem","spread":true,"position":{"start":{"line":16,"column":1},"end":{"line":17,"column":1}},"children":[{"type":"text","value":"Split patches for training/validation","position":{"start":{"line":16,"column":1},"end":{"line":16,"column":1}},"key":"hnZGdsGywj"},{"type":"list","ordered":false,"spread":false,"position":{"start":{"line":17,"column":1},"end":{"line":17,"column":1}},"children":[{"type":"listItem","spread":true,"position":{"start":{"line":17,"column":1},"end":{"line":17,"column":1}},"children":[{"type":"text","value":"Split the patches into a training and validation set","position":{"start":{"line":17,"column":1},"end":{"line":17,"column":1}},"key":"yFrDSzgRT8"}],"key":"JgfYXG1jHI"}],"key":"UyNjU6JXP2"}],"key":"gHaDjOtRis"}],"key":"dIKk7jW8Ko"}],"key":"RHuIl3QdeT"},{"type":"block","kind":"notebook-content","data":{},"children":[{"type":"heading","depth":3,"position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"children":[{"type":"text","value":"Define EOTasks","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"iII8xiO00I"}],"identifier":"define-eotasks","label":"Define EOTasks","html_id":"define-eotasks","implicit":true,"key":"MxVQ8EG66e"}],"key":"brQiVZV51B"},{"type":"block","kind":"notebook-code","data":{},"children":[{"type":"code","lang":"python","executable":true,"value":"class ConcatenateData(EOTask):\n    \"\"\" Task to concatenate data arrays along the last dimension\n    \"\"\"\n    def __init__(self, feature_name, feature_names_to_concatenate):\n        self.feature_name = feature_name\n        self.feature_names_to_concatenate = feature_names_to_concatenate\n\n    def execute(self, eopatch):\n        arrays = [eopatch.data[name] for name in self.feature_names_to_concatenate]\n\n        eopatch.add_feature(FeatureType.DATA, self.feature_name, np.concatenate(arrays, axis=-1))\n\n        return eopatch\n    \n    \nclass ValidDataFractionPredicate:\n    \"\"\" Predicate that defines if a frame from EOPatch's time-series is valid or not. Frame is valid, if the \n    valid data fraction is above the specified threshold.\n    \"\"\"\n    def __init__(self, threshold):\n        self.threshold = threshold\n        \n    def __call__(self, array):\n        coverage = np.sum(array.astype(np.uint8)) / np.prod(array.shape)\n        return coverage \u003e self.threshold\n    \n# TASK TO LOAD EXISTING EOPATCHES\nload = LoadTask(path_out)\n\n# TASK FOR CONCATENATION\nconcatenate = ConcatenateData('FEATURES', ['BANDS', 'NDVI', 'NDWI', 'NORM'])\n\n# TASK FOR FILTERING OUT TOO CLOUDY SCENES\n# keep frames with \u003e 80 % valid coverage\nvalid_data_predicate = ValidDataFractionPredicate(0.8)\nfilter_task = SimpleFilterTask((FeatureType.MASK, 'IS_VALID'), valid_data_predicate)\n\n# TASK FOR LINEAR INTERPOLATION\n# linear interpolation of full time-series and date resampling\nselected_date_interval_for_interpolation = selected_date_interval_for_satellite_imagery + [16] \n# TODO: replace fixed number of times with fixed time difference\n#resampled_range = tuple(selected_date_interval_for_satellite_imagery)\nresampled_range = (\n    selected_date_interval_for_interpolation[0].replace(\"-\", \"\"),\n    selected_date_interval_for_interpolation[1].replace(\"-\", \"\"),\n    selected_date_interval_for_interpolation[2]\n)\nlinear_interp = LinearInterpolation(\n    'FEATURES', # name of field to interpolate\n    mask_feature=(FeatureType.MASK, 'IS_VALID'), # mask to be used in interpolation\n    copy_features=[(FeatureType.MASK_TIMELESS, 'CROP_TYPE')], # features to keep\n    resample_range=resampled_range, # set the resampling range\n    bounds_error=False # extrapolate with NaN's\n)\n\n# TASK FOR EROSION\n# erode each class of the reference map\nerosion = ErosionTask(mask_feature=(FeatureType.MASK_TIMELESS,'CROP_TYPE','CROP_TYPE_ERODED'), disk_radius=1)\n\n# TASK FOR SPATIAL SAMPLING\n# Uniformly sample about pixels from patches\nn_samples = int(4e4) if use_smaller_patches else int(1e5) # no. of pixels to sample\nref_labels = list(range(11)) # reference labels to take into account when sampling\nspatial_sampling = PointSamplingTask(\n    n_samples=n_samples, \n    ref_mask_feature='CROP_TYPE_ERODED', \n    ref_labels=ref_labels, \n    sample_features=[  # tag fields to sample\n        (FeatureType.DATA, 'FEATURES'),\n        (FeatureType.MASK_TIMELESS, 'CROP_TYPE_ERODED')\n    ])\n\npath_out_sampled = './eopatches_sampled_small/' if use_smaller_patches else './eopatches_sampled_large/'\nif not os.path.isdir(path_out_sampled):\n    os.makedirs(path_out_sampled)\nsave = SaveTask(path_out_sampled, overwrite_permission=OverwritePermission.OVERWRITE_PATCH)\n\n# Define the workflow\nworkflow = LinearWorkflow(\n    load,\n    concatenate,\n    filter_task,\n    linear_interp,\n    erosion,\n    spatial_sampling,\n    save\n)","key":"aZH8YnzGaZ"},{"type":"output","id":"LbJ_S4GamwwJxkDQ2L1-v","data":[],"key":"v5AgFoMGx4"}],"key":"yiN2UwZ2HW"},{"type":"block","kind":"notebook-content","data":{},"children":[{"type":"heading","depth":3,"position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"children":[{"type":"text","value":"Run the EOWorkflow over all EOPatches","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"yXkkxtO72s"}],"identifier":"run-the-eoworkflow-over-all-eopatches","label":"Run the EOWorkflow over all EOPatches","html_id":"run-the-eoworkflow-over-all-eopatches","implicit":true,"key":"RdIgan2YQn"}],"key":"pLlY4iO2Ii"},{"type":"block","kind":"notebook-code","data":{},"children":[{"type":"code","lang":"python","executable":true,"value":"%%time\n   \nexecution_args = []\nfor idx in range(len(patchIDs)):\n    execution_args.append({\n        load: {'eopatch_folder': 'eopatch_{}'.format(idx)},\n        save: {'eopatch_folder': 'eopatch_{}'.format(idx)}\n    })\n    \nexecutor = EOExecutor(workflow, execution_args, save_logs=True)\nexecutor.run(workers=1, multiprocess=True)\n\nexecutor.make_report()","key":"xmvGCkOxOz"},{"type":"output","id":"12ZB3hsI323NCQ3H8Y8rN","data":[{"output_type":"display_data","metadata":{},"data":{"application/vnd.jupyter.widget-view+json":{"content":"{\"model_id\":\"74388d82f3a6406cb942473abaab77b1\",\"version_major\":2,\"version_minor\":0}","content_type":"application/vnd.jupyter.widget-view+json"},"text/plain":{"content":"HBox(children=(FloatProgress(value=0.0, max=9.0), HTML(value='')))","content_type":"text/plain"}}},{"name":"stdout","output_type":"stream","text":"\n\nCPU times: user 16.9 s, sys: 3.38 s, total: 20.3 s\nWall time: 56.7 s\n"}],"key":"QdLrkTDipO"}],"key":"M7ZUNlFZVp"},{"type":"block","kind":"notebook-content","data":{},"children":[{"type":"heading","depth":2,"position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"children":[{"type":"text","value":"Model construction and training","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"MGhdBrG3qI"}],"identifier":"model-construction-and-training","label":"Model construction and training","html_id":"model-construction-and-training","implicit":true,"key":"RZdI9SvAOm"},{"type":"paragraph","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"children":[{"type":"text","value":"The patches are split into a train and test subset, where we take the patch with ID = 1 for testing, since it seems a good representative of the area.","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"key":"TzprjMmopa"}],"key":"Q3IDe4yrg5"},{"type":"paragraph","position":{"start":{"line":5,"column":1},"end":{"line":5,"column":1}},"children":[{"type":"text","value":"The test sample is hand picked because of the small set of patches, otherwise with a larged overall set, the training and testing patches should be randomly chosen.","position":{"start":{"line":5,"column":1},"end":{"line":5,"column":1}},"key":"CuUoE57D0f"}],"key":"XApaqrYHMV"},{"type":"paragraph","position":{"start":{"line":7,"column":1},"end":{"line":7,"column":1}},"children":[{"type":"text","value":"The sampled features and labels are loaded and reshaped into ","position":{"start":{"line":7,"column":1},"end":{"line":7,"column":1}},"key":"Qo8PTsUR8s"},{"type":"inlineMath","value":"n \\times m","position":{"start":{"line":7,"column":1},"end":{"line":7,"column":1}},"html":"\u003cspan class=\"katex\"\u003e\u003cspan class=\"katex-mathml\"\u003e\u003cmath xmlns=\"http://www.w3.org/1998/Math/MathML\"\u003e\u003csemantics\u003e\u003cmrow\u003e\u003cmi\u003en\u003c/mi\u003e\u003cmo\u003e×\u003c/mo\u003e\u003cmi\u003em\u003c/mi\u003e\u003c/mrow\u003e\u003cannotation encoding=\"application/x-tex\"\u003en \\times m\u003c/annotation\u003e\u003c/semantics\u003e\u003c/math\u003e\u003c/span\u003e\u003cspan class=\"katex-html\" aria-hidden=\"true\"\u003e\u003cspan class=\"base\"\u003e\u003cspan class=\"strut\" style=\"height:0.6667em;vertical-align:-0.0833em;\"\u003e\u003c/span\u003e\u003cspan class=\"mord mathnormal\"\u003en\u003c/span\u003e\u003cspan class=\"mspace\" style=\"margin-right:0.2222em;\"\u003e\u003c/span\u003e\u003cspan class=\"mbin\"\u003e×\u003c/span\u003e\u003cspan class=\"mspace\" style=\"margin-right:0.2222em;\"\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"base\"\u003e\u003cspan class=\"strut\" style=\"height:0.4306em;\"\u003e\u003c/span\u003e\u003cspan class=\"mord mathnormal\"\u003em\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e","key":"EOePn6OqQ9"},{"type":"text","value":", where ","position":{"start":{"line":7,"column":1},"end":{"line":7,"column":1}},"key":"XXvt1nq5v1"},{"type":"inlineMath","value":"n","position":{"start":{"line":7,"column":1},"end":{"line":7,"column":1}},"html":"\u003cspan class=\"katex\"\u003e\u003cspan class=\"katex-mathml\"\u003e\u003cmath xmlns=\"http://www.w3.org/1998/Math/MathML\"\u003e\u003csemantics\u003e\u003cmrow\u003e\u003cmi\u003en\u003c/mi\u003e\u003c/mrow\u003e\u003cannotation encoding=\"application/x-tex\"\u003en\u003c/annotation\u003e\u003c/semantics\u003e\u003c/math\u003e\u003c/span\u003e\u003cspan class=\"katex-html\" aria-hidden=\"true\"\u003e\u003cspan class=\"base\"\u003e\u003cspan class=\"strut\" style=\"height:0.4306em;\"\u003e\u003c/span\u003e\u003cspan class=\"mord mathnormal\"\u003en\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e","key":"XuLvQeYTol"},{"type":"text","value":" represents the number of training pixels, and ","position":{"start":{"line":7,"column":1},"end":{"line":7,"column":1}},"key":"K8za3aw2WO"},{"type":"inlineMath","value":"m = f \\times t","position":{"start":{"line":7,"column":1},"end":{"line":7,"column":1}},"html":"\u003cspan class=\"katex\"\u003e\u003cspan class=\"katex-mathml\"\u003e\u003cmath xmlns=\"http://www.w3.org/1998/Math/MathML\"\u003e\u003csemantics\u003e\u003cmrow\u003e\u003cmi\u003em\u003c/mi\u003e\u003cmo\u003e=\u003c/mo\u003e\u003cmi\u003ef\u003c/mi\u003e\u003cmo\u003e×\u003c/mo\u003e\u003cmi\u003et\u003c/mi\u003e\u003c/mrow\u003e\u003cannotation encoding=\"application/x-tex\"\u003em = f \\times t\u003c/annotation\u003e\u003c/semantics\u003e\u003c/math\u003e\u003c/span\u003e\u003cspan class=\"katex-html\" aria-hidden=\"true\"\u003e\u003cspan class=\"base\"\u003e\u003cspan class=\"strut\" style=\"height:0.4306em;\"\u003e\u003c/span\u003e\u003cspan class=\"mord mathnormal\"\u003em\u003c/span\u003e\u003cspan class=\"mspace\" style=\"margin-right:0.2778em;\"\u003e\u003c/span\u003e\u003cspan class=\"mrel\"\u003e=\u003c/span\u003e\u003cspan class=\"mspace\" style=\"margin-right:0.2778em;\"\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"base\"\u003e\u003cspan class=\"strut\" style=\"height:0.8889em;vertical-align:-0.1944em;\"\u003e\u003c/span\u003e\u003cspan class=\"mord mathnormal\" style=\"margin-right:0.10764em;\"\u003ef\u003c/span\u003e\u003cspan class=\"mspace\" style=\"margin-right:0.2222em;\"\u003e\u003c/span\u003e\u003cspan class=\"mbin\"\u003e×\u003c/span\u003e\u003cspan class=\"mspace\" style=\"margin-right:0.2222em;\"\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"base\"\u003e\u003cspan class=\"strut\" style=\"height:0.6151em;\"\u003e\u003c/span\u003e\u003cspan class=\"mord mathnormal\"\u003et\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e","key":"EwqDPvlmOC"},{"type":"text","value":" the number of all features, with ","position":{"start":{"line":7,"column":1},"end":{"line":7,"column":1}},"key":"GV8rgFm4gJ"},{"type":"inlineMath","value":"f","position":{"start":{"line":7,"column":1},"end":{"line":7,"column":1}},"html":"\u003cspan class=\"katex\"\u003e\u003cspan class=\"katex-mathml\"\u003e\u003cmath xmlns=\"http://www.w3.org/1998/Math/MathML\"\u003e\u003csemantics\u003e\u003cmrow\u003e\u003cmi\u003ef\u003c/mi\u003e\u003c/mrow\u003e\u003cannotation encoding=\"application/x-tex\"\u003ef\u003c/annotation\u003e\u003c/semantics\u003e\u003c/math\u003e\u003c/span\u003e\u003cspan class=\"katex-html\" aria-hidden=\"true\"\u003e\u003cspan class=\"base\"\u003e\u003cspan class=\"strut\" style=\"height:0.8889em;vertical-align:-0.1944em;\"\u003e\u003c/span\u003e\u003cspan class=\"mord mathnormal\" style=\"margin-right:0.10764em;\"\u003ef\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e","key":"QxiFbeiafF"},{"type":"text","value":" the size of bands and band combinations (in this example 9) and ","position":{"start":{"line":7,"column":1},"end":{"line":7,"column":1}},"key":"QUL1OcXv1n"},{"type":"inlineMath","value":"t","position":{"start":{"line":7,"column":1},"end":{"line":7,"column":1}},"html":"\u003cspan class=\"katex\"\u003e\u003cspan class=\"katex-mathml\"\u003e\u003cmath xmlns=\"http://www.w3.org/1998/Math/MathML\"\u003e\u003csemantics\u003e\u003cmrow\u003e\u003cmi\u003et\u003c/mi\u003e\u003c/mrow\u003e\u003cannotation encoding=\"application/x-tex\"\u003et\u003c/annotation\u003e\u003c/semantics\u003e\u003c/math\u003e\u003c/span\u003e\u003cspan class=\"katex-html\" aria-hidden=\"true\"\u003e\u003cspan class=\"base\"\u003e\u003cspan class=\"strut\" style=\"height:0.6151em;\"\u003e\u003c/span\u003e\u003cspan class=\"mord mathnormal\"\u003et\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e","key":"KZ0xnju5r2"},{"type":"text","value":" the length of the resampled time-series","position":{"start":{"line":7,"column":1},"end":{"line":7,"column":1}},"key":"YUsa5ahG6u"}],"key":"YDUWwgJ5sh"},{"type":"paragraph","position":{"start":{"line":9,"column":1},"end":{"line":9,"column":1}},"children":[{"type":"link","url":"https://github.com/Microsoft/LightGBM","position":{"start":{"line":9,"column":1},"end":{"line":9,"column":1}},"children":[{"type":"text","value":"LightGBM","position":{"start":{"line":9,"column":1},"end":{"line":9,"column":1}},"key":"JOPHfJZVOG"}],"urlSource":"https://github.com/Microsoft/LightGBM","error":true,"key":"cMhslVyQ6R"},{"type":"text","value":" is used as a ML model. It is a fast, distributed, high performance gradient boosting framework based on decision tree algorithms, used for many machine learning tasks.","position":{"start":{"line":9,"column":1},"end":{"line":9,"column":1}},"key":"ZfSin2aG9x"}],"key":"CPDY2paUbb"},{"type":"paragraph","position":{"start":{"line":11,"column":1},"end":{"line":11,"column":1}},"children":[{"type":"text","value":"The default hyper-parameters are used in this example. For more info on parameter tuning, check the ","position":{"start":{"line":11,"column":1},"end":{"line":11,"column":1}},"key":"d4UHpoDV17"},{"type":"link","url":"https://lightgbm.readthedocs.io/en/latest/Parameters-Tuning.html","position":{"start":{"line":11,"column":1},"end":{"line":11,"column":1}},"children":[{"type":"text","value":"ReadTheDocs","position":{"start":{"line":11,"column":1},"end":{"line":11,"column":1}},"key":"hfbTwpdv1j"}],"urlSource":"https://lightgbm.readthedocs.io/en/latest/Parameters-Tuning.html","key":"QfTmUHXHde"},{"type":"text","value":" of the package.","position":{"start":{"line":11,"column":1},"end":{"line":11,"column":1}},"key":"wCps3qvB94"}],"key":"wkJj7aE3tj"}],"key":"Hw3OinS0Ie"},{"type":"block","kind":"notebook-code","data":{},"children":[{"type":"code","lang":"python","executable":true,"value":"# load sampled eopatches\neopatches = []\npath_out_sampled = './eopatches_sampled_small/' if use_smaller_patches else './eopatches_sampled_large/'\n\nfor i in range(9):\n    eopatches.append(EOPatch.load('{}/eopatch_{}'.format(path_out_sampled, i), lazy_loading=True))    \n\neopatches = np.array(eopatches)","key":"zEdPKIMP2o"},{"type":"output","id":"2OiBq5-zk7RnE7Qz_y96T","data":[],"key":"YpsySdxhY4"}],"key":"osqey4MTtl"},{"type":"block","kind":"notebook-code","data":{},"children":[{"type":"code","lang":"python","executable":true,"value":"# Definition of the train and test patch IDs\ntrain_ID = [0,2,3,4,5,6,7,8] if use_smaller_patches else [0,1,3,4,5,6,7,8]\ntest_ID = [1] if use_smaller_patches else [2]\n\n# Set the features and the labels for train and test sets\nfeatures_train = np.array([eopatch.data['FEATURES_SAMPLED'] for eopatch in eopatches[train_ID]])\nlabels_train = np.array([eopatch.mask_timeless['CROP_TYPE_ERODED_SAMPLED'] for eopatch in eopatches[train_ID]])\nfeatures_test = np.array([eopatch.data['FEATURES_SAMPLED'] for eopatch in eopatches[test_ID]])\nlabels_test = np.array([eopatch.mask_timeless['CROP_TYPE_ERODED_SAMPLED'] for eopatch in eopatches[test_ID]])\n\n# get shape\np1, t, w, h, f = features_train.shape\np2, t, w, h, f = features_test.shape\np = p1 + p2\n\n# reshape to n x m\nfeatures_train = np.moveaxis(features_train, 1, 3).reshape(p1 * w * h, t * f)\nlabels_train = np.moveaxis(labels_train, 1, 2).reshape(p1 * w * h, 1).squeeze()\nfeatures_test = np.moveaxis(features_test, 1, 3).reshape(p2 * w * h, t * f)\nlabels_test = np.moveaxis(labels_test, 1, 2).reshape(p2 * w * h, 1).squeeze()\n\n# remove points with no reference from training (so we dont train to recognize \"no data\")\nmask_train = labels_train == 0\nfeatures_train = features_train[~mask_train]\nlabels_train = labels_train[~mask_train]\n\n# remove points with no reference from test (so we dont validate on \"no data\", which doesn't make sense)\nmask_test = labels_test == 0\nfeatures_test = features_test[~mask_test]\nlabels_test = labels_test[~mask_test]","key":"OVhpiot9cD"},{"type":"output","id":"ZbRYl1gNHVDJLNI3fIXOP","data":[],"key":"HFJs8VNUfU"}],"key":"RRk4cA4oyt"},{"type":"block","kind":"notebook-code","data":{},"children":[{"type":"code","lang":"python","executable":true,"value":"# Set up training classes\nlabels_unique = np.unique(labels_train)","key":"OgSXkQt7lt"},{"type":"output","id":"JNcKdV1YqYGzEaJ79kzHK","data":[],"key":"MniAPELtTO"}],"key":"LnvVDsIpK4"},{"type":"block","kind":"notebook-code","data":{},"children":[{"type":"code","lang":"python","executable":true,"value":"%%time\n\n# Set up training classes\nlabels_unique = np.unique(labels_train)\n\n# Set up the model\nmodel = lgb.LGBMClassifier(\n    objective='multiclass', \n    num_class=len(labels_unique), \n    metric='multi_logloss'\n)\n\n# train the model\nmodel.fit(features_train, labels_train)\n\n# uncomment to save the model\nmodel_base_name = 'model_AT_CT_smaller' if use_smaller_patches else 'model_AT_CT_larger'\njoblib.dump(model, './{}.pkl'.format(model_base_name))","key":"lAMsgXJbbd"},{"type":"output","id":"MPHX5xXU2_UQuNrWqzY4J","data":[{"name":"stdout","output_type":"stream","text":"CPU times: user 2min 44s, sys: 0 ns, total: 2min 44s\nWall time: 1min 6s\n"},{"output_type":"execute_result","execution_count":26,"metadata":{},"data":{"text/plain":{"content":"['./model_AT_CT_smaller.pkl']","content_type":"text/plain"}}}],"key":"LRNQd6iTlf"}],"key":"JLcWsfkCUU"},{"type":"block","kind":"notebook-content","data":{},"children":[{"type":"heading","depth":2,"position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"children":[{"type":"text","value":"Validation","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"fGpCjoBbwF"}],"identifier":"validation","label":"Validation","html_id":"validation","implicit":true,"key":"QTwynOIOEM"}],"key":"vqoDRBpm3j"},{"type":"block","kind":"notebook-content","data":{},"children":[{"type":"paragraph","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"children":[{"type":"text","value":"Validation of the model is a crucial step in data science. All models are wrong, but some are less wrong than others, so model evaluation is important.","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"y0fb3zF97C"}],"key":"f2YzSmPv67"},{"type":"paragraph","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"children":[{"type":"text","value":"In order to validate the model, we use the training set to predict the classes, and then compare the predicted set of labels to the “ground truth”.","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"key":"FgvTYJ7chx"}],"key":"zFUrmTMVWd"},{"type":"paragraph","position":{"start":{"line":5,"column":1},"end":{"line":5,"column":1}},"children":[{"type":"text","value":"Unfortunately, ground truth in the scope of EO is a term that should be taken lightly. Usually, it is not 100 % reliable due to several reasons:","position":{"start":{"line":5,"column":1},"end":{"line":5,"column":1}},"key":"beK9IaTNzo"}],"key":"Ipgel9Ot0r"},{"type":"list","ordered":false,"spread":false,"position":{"start":{"line":7,"column":1},"end":{"line":10,"column":1}},"children":[{"type":"listItem","spread":true,"position":{"start":{"line":7,"column":1},"end":{"line":7,"column":1}},"children":[{"type":"text","value":"Labels are determined at specific time, but crop types change.","position":{"start":{"line":7,"column":1},"end":{"line":7,"column":1}},"key":"B7m9weNWJ2"}],"key":"FxHgYRkXil"},{"type":"listItem","spread":true,"position":{"start":{"line":8,"column":1},"end":{"line":8,"column":1}},"children":[{"type":"text","value":"Some classes can have an overlap or similar definitions (","position":{"start":{"line":8,"column":1},"end":{"line":8,"column":1}},"key":"gI87ekVup5"},{"type":"emphasis","position":{"start":{"line":8,"column":1},"end":{"line":8,"column":1}},"children":[{"type":"text","value":"part of a continuum, and not discrete distributions","position":{"start":{"line":8,"column":1},"end":{"line":8,"column":1}},"key":"UNNTsOrlea"}],"key":"PX1Cei5eA8"},{"type":"text","value":")","position":{"start":{"line":8,"column":1},"end":{"line":8,"column":1}},"key":"Rta66ZEJPh"}],"key":"WIGkQhk6vo"},{"type":"listItem","spread":true,"position":{"start":{"line":9,"column":1},"end":{"line":10,"column":1}},"children":[{"type":"text","value":"Human error (_mistakes made within the decleration)","position":{"start":{"line":9,"column":1},"end":{"line":9,"column":1}},"key":"KmJcZXJCB7"}],"key":"MAx0Yi2cRn"}],"key":"uWPpuGb94v"},{"type":"paragraph","position":{"start":{"line":11,"column":1},"end":{"line":11,"column":1}},"children":[{"type":"text","value":"The validation is performed by evaluating various metrics, such as accuracy, precision, recall, ","position":{"start":{"line":11,"column":1},"end":{"line":11,"column":1}},"key":"hGid8HB1ag"},{"type":"inlineMath","value":"F_1","position":{"start":{"line":11,"column":1},"end":{"line":11,"column":1}},"html":"\u003cspan class=\"katex\"\u003e\u003cspan class=\"katex-mathml\"\u003e\u003cmath xmlns=\"http://www.w3.org/1998/Math/MathML\"\u003e\u003csemantics\u003e\u003cmrow\u003e\u003cmsub\u003e\u003cmi\u003eF\u003c/mi\u003e\u003cmn\u003e1\u003c/mn\u003e\u003c/msub\u003e\u003c/mrow\u003e\u003cannotation encoding=\"application/x-tex\"\u003eF_1\u003c/annotation\u003e\u003c/semantics\u003e\u003c/math\u003e\u003c/span\u003e\u003cspan class=\"katex-html\" aria-hidden=\"true\"\u003e\u003cspan class=\"base\"\u003e\u003cspan class=\"strut\" style=\"height:0.8333em;vertical-align:-0.15em;\"\u003e\u003c/span\u003e\u003cspan class=\"mord\"\u003e\u003cspan class=\"mord mathnormal\" style=\"margin-right:0.13889em;\"\u003eF\u003c/span\u003e\u003cspan class=\"msupsub\"\u003e\u003cspan class=\"vlist-t vlist-t2\"\u003e\u003cspan class=\"vlist-r\"\u003e\u003cspan class=\"vlist\" style=\"height:0.3011em;\"\u003e\u003cspan style=\"top:-2.55em;margin-left:-0.1389em;margin-right:0.05em;\"\u003e\u003cspan class=\"pstrut\" style=\"height:2.7em;\"\u003e\u003c/span\u003e\u003cspan class=\"sizing reset-size6 size3 mtight\"\u003e\u003cspan class=\"mord mtight\"\u003e1\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"vlist-s\"\u003e​\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"vlist-r\"\u003e\u003cspan class=\"vlist\" style=\"height:0.15em;\"\u003e\u003cspan\u003e\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e","key":"ARvh5lU7SE"},{"type":"text","value":" score, some of which are nicely described ","position":{"start":{"line":11,"column":1},"end":{"line":11,"column":1}},"key":"QLECKZHFeF"},{"type":"link","url":"https://medium.com/greyatom/performance-metrics-for-classification-problems-in-machine-learning-part-i-b085d432082b","position":{"start":{"line":11,"column":1},"end":{"line":11,"column":1}},"children":[{"type":"text","value":"in this blog post","position":{"start":{"line":11,"column":1},"end":{"line":11,"column":1}},"key":"LGZnkCSk3T"}],"urlSource":"https://medium.com/greyatom/performance-metrics-for-classification-problems-in-machine-learning-part-i-b085d432082b","key":"cADJVlXgmk"}],"key":"xm92GsR0Bx"}],"key":"uCQtzcGWKO"},{"type":"block","kind":"notebook-code","data":{},"children":[{"type":"code","lang":"python","executable":true,"value":"# uncomment to load the model and replace with your file, usually just correct the date\nmodel_path = './model_AT_CT_smaller.pkl' if use_smaller_patches else './model_AT_CT_larger.pkl'\nmodel = joblib.load(model_path)","key":"gb6cdR3vbD"},{"type":"output","id":"d2TWbP0GgfDsQigBGncGf","data":[],"key":"QtU8HngVTr"}],"key":"mfqQY6ubrM"},{"type":"block","kind":"notebook-code","data":{},"children":[{"type":"code","lang":"python","executable":true,"value":"# predict the test labels\nplabels_test = model.predict(features_test)","key":"pOV6uowQYK"},{"type":"output","id":"V82_W62CYWM8piYp2qaGP","data":[],"key":"OhT5eyP7Ya"}],"key":"FvTx4vAPdr"},{"type":"block","kind":"notebook-content","data":{},"children":[{"type":"paragraph","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"children":[{"type":"text","value":"Get the overall accuracy (OA) and the weighted ","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"crTTEo0IQw"},{"type":"inlineMath","value":"F_1","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"html":"\u003cspan class=\"katex\"\u003e\u003cspan class=\"katex-mathml\"\u003e\u003cmath xmlns=\"http://www.w3.org/1998/Math/MathML\"\u003e\u003csemantics\u003e\u003cmrow\u003e\u003cmsub\u003e\u003cmi\u003eF\u003c/mi\u003e\u003cmn\u003e1\u003c/mn\u003e\u003c/msub\u003e\u003c/mrow\u003e\u003cannotation encoding=\"application/x-tex\"\u003eF_1\u003c/annotation\u003e\u003c/semantics\u003e\u003c/math\u003e\u003c/span\u003e\u003cspan class=\"katex-html\" aria-hidden=\"true\"\u003e\u003cspan class=\"base\"\u003e\u003cspan class=\"strut\" style=\"height:0.8333em;vertical-align:-0.15em;\"\u003e\u003c/span\u003e\u003cspan class=\"mord\"\u003e\u003cspan class=\"mord mathnormal\" style=\"margin-right:0.13889em;\"\u003eF\u003c/span\u003e\u003cspan class=\"msupsub\"\u003e\u003cspan class=\"vlist-t vlist-t2\"\u003e\u003cspan class=\"vlist-r\"\u003e\u003cspan class=\"vlist\" style=\"height:0.3011em;\"\u003e\u003cspan style=\"top:-2.55em;margin-left:-0.1389em;margin-right:0.05em;\"\u003e\u003cspan class=\"pstrut\" style=\"height:2.7em;\"\u003e\u003c/span\u003e\u003cspan class=\"sizing reset-size6 size3 mtight\"\u003e\u003cspan class=\"mord mtight\"\u003e1\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"vlist-s\"\u003e​\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"vlist-r\"\u003e\u003cspan class=\"vlist\" style=\"height:0.15em;\"\u003e\u003cspan\u003e\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e","key":"lUQ6NOpMnt"},{"type":"text","value":" score","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"iOzltoyPit"}],"key":"Snm34prHoB"}],"key":"dzLFrapg13"},{"type":"block","kind":"notebook-code","data":{},"children":[{"type":"code","lang":"python","executable":true,"value":"print('Classification accuracy {:.1f}%'.format(100 * metrics.accuracy_score(labels_test, plabels_test)))\nprint('Classification F1-score {:.1f}%'.format(100 * metrics.f1_score(labels_test, plabels_test, average='weighted')))","key":"PD44SYea0A"},{"type":"output","id":"tCBeLdZnyXlBJ1hFIdPOp","data":[{"name":"stdout","output_type":"stream","text":"Classification accuracy 87.8%\nClassification F1-score 89.0%\n"}],"key":"Ob9kau6G0M"}],"key":"eQTtPDEHdZ"},{"type":"block","kind":"notebook-content","data":{},"children":[{"type":"paragraph","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"children":[{"type":"inlineMath","value":"F_1","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"html":"\u003cspan class=\"katex\"\u003e\u003cspan class=\"katex-mathml\"\u003e\u003cmath xmlns=\"http://www.w3.org/1998/Math/MathML\"\u003e\u003csemantics\u003e\u003cmrow\u003e\u003cmsub\u003e\u003cmi\u003eF\u003c/mi\u003e\u003cmn\u003e1\u003c/mn\u003e\u003c/msub\u003e\u003c/mrow\u003e\u003cannotation encoding=\"application/x-tex\"\u003eF_1\u003c/annotation\u003e\u003c/semantics\u003e\u003c/math\u003e\u003c/span\u003e\u003cspan class=\"katex-html\" aria-hidden=\"true\"\u003e\u003cspan class=\"base\"\u003e\u003cspan class=\"strut\" style=\"height:0.8333em;vertical-align:-0.15em;\"\u003e\u003c/span\u003e\u003cspan class=\"mord\"\u003e\u003cspan class=\"mord mathnormal\" style=\"margin-right:0.13889em;\"\u003eF\u003c/span\u003e\u003cspan class=\"msupsub\"\u003e\u003cspan class=\"vlist-t vlist-t2\"\u003e\u003cspan class=\"vlist-r\"\u003e\u003cspan class=\"vlist\" style=\"height:0.3011em;\"\u003e\u003cspan style=\"top:-2.55em;margin-left:-0.1389em;margin-right:0.05em;\"\u003e\u003cspan class=\"pstrut\" style=\"height:2.7em;\"\u003e\u003c/span\u003e\u003cspan class=\"sizing reset-size6 size3 mtight\"\u003e\u003cspan class=\"mord mtight\"\u003e1\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"vlist-s\"\u003e​\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"vlist-r\"\u003e\u003cspan class=\"vlist\" style=\"height:0.15em;\"\u003e\u003cspan\u003e\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e","key":"IWz2dW94xM"},{"type":"text","value":" score, precision, and recall for each class separately","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"r7IgTRjBNX"}],"key":"uM9EJaMDy6"}],"key":"DlLEVDBw05"},{"type":"block","kind":"notebook-code","data":{"scrolled":true},"children":[{"type":"code","lang":"python","executable":true,"value":"class_labels_test = set(np.unique(labels_test))\nclass_labels_train = set(np.unique(labels_train))\nclass_labels = list(class_labels_test.union(class_labels_train))\nclass_names = [entry.class_name for entry in CTGROUPS]\n\nf1_scores = metrics.f1_score(labels_test, plabels_test, labels=class_labels, average=None)\nrecall = metrics.recall_score(labels_test, plabels_test, labels=class_labels, average=None)\nprecision = metrics.precision_score(labels_test, plabels_test, labels=class_labels, average=None) \n\nprint('             Class              =  F1  | Recall | Precision')\nprint('         --------------------------------------------------')\nfor idx, ct in enumerate([class_names[idx] for idx in class_labels]):\n    print('         * {0:30s} = {1:2.1f} |  {2:2.1f}  | {3:2.1f}'.format(ct, \n                                                                         f1_scores[idx] * 100, \n                                                                         recall[idx] * 100, \n                                                                         precision[idx] * 100))","key":"dTiHAMAkZh"},{"type":"output","id":"rg6O2qoaHmSuKDLJszEhj","data":[{"name":"stdout","output_type":"stream","text":"             Class              =  F1  | Recall | Precision\n         --------------------------------------------------\n         * SOMMERGETREIDE                 = 68.1 |  56.1  | 86.6\n         * WINTERGETREIDE                 = 95.2 |  93.8  | 96.6\n         * MENGGETREIDE_AEHNLICHES        = 11.8 |  18.7  | 8.7\n         * MAIS_AEHNLICHES                = 93.2 |  96.7  | 90.0\n         * SOMMERRAPS_AEHNLICHES          = 0.0 |  0.0  | 0.0\n         * WINTERRAPS_AEHNLICHES          = 90.1 |  92.6  | 87.7\n         * SONNENBLUME                    = 0.0 |  0.0  | 0.0\n         * LEGUMINOSEN_AEHNLICHES         = 21.1 |  51.2  | 13.3\n         * WINTERLEGUMINOSE               = 0.0 |  0.0  | 0.0\n"}],"key":"brNxY8SAVp"}],"key":"GLUKH5PJW4"},{"type":"block","kind":"notebook-content","data":{},"children":[{"type":"heading","depth":2,"position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"children":[{"type":"text","value":"Plot the standard and transposed Confusion Matrix","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"qSaWcpqOw1"}],"identifier":"plot-the-standard-and-transposed-confusion-matrix","label":"Plot the standard and transposed Confusion Matrix","html_id":"plot-the-standard-and-transposed-confusion-matrix","implicit":true,"key":"SckCr93lOH"}],"key":"hUTsVKl2L8"},{"type":"block","kind":"notebook-code","data":{},"children":[{"type":"code","lang":"python","executable":true,"value":"# Define the plotting function\ndef plot_confusion_matrix(cm, classes,\n                          normalize=False,\n                          title='Confusion matrix',\n                          cmap=plt.cm.Blues, ylabel='True label', xlabel='Predicted label', filename=None):\n    \"\"\"\n    This function prints and plots the confusion matrix.\n    Normalization can be applied by setting `normalize=True`.\n    \"\"\"\n    np.set_printoptions(precision=2, suppress=True)\n    \n    if normalize:\n        cm = cm.astype('float') / (cm.sum(axis=1)[:, np.newaxis] + np.finfo(np.float).eps)\n\n        plt.imshow(cm, interpolation='nearest', cmap=cmap, vmin=0, vmax=1)\n    plt.title(title, fontsize=20)\n    # plt.colorbar()\n    tick_marks = np.arange(len(classes)+1)-0.5\n    plt.xticks(tick_marks, classes, rotation=90, fontsize=15)\n    plt.yticks(tick_marks, classes, fontsize=15)\n    \n    \n    fmt = '.2f' if normalize else 'd'\n    thresh = cm.max() / 2.\n    for i, j in itertools.product(range(cm.shape[0]), range(cm.shape[1])):\n        plt.text(j, i, format(cm[i, j], fmt),\n                 horizontalalignment=\"center\",\n                 color=\"white\" if cm[i, j] \u003e thresh else \"black\",\n                 fontsize=12)\n\n    plt.tight_layout()\n    plt.ylabel(ylabel, fontsize=15)\n    plt.xlabel(xlabel, fontsize=15)","key":"xAKP2YlTLG"},{"type":"output","id":"lPZDkeFuDmJ-x1uwIpYN7","data":[],"key":"ffh3nQY3du"}],"key":"fCzMPdPyek"},{"type":"block","kind":"notebook-code","data":{},"children":[{"type":"code","lang":"python","executable":true,"value":"fig = plt.figure(figsize=(20, 20))\n\nplt.subplot(1, 2, 1)\nconf_matrix_gbm = metrics.confusion_matrix(labels_test, plabels_test)\nplot_confusion_matrix(conf_matrix_gbm, \n                      classes=[name for idx, name in enumerate(class_names) if idx in class_labels], \n                      normalize=True, \n                      ylabel='Truth (crop type group)', \n                      xlabel='Predicted (GBM)',\n                      title='Confusion matrix');\n\nplt.subplot(1, 2, 2)\nconf_matrix_gbm = metrics.confusion_matrix(plabels_test, labels_test)\nplot_confusion_matrix(conf_matrix_gbm, \n                      classes=[name for idx, name in enumerate(class_names) if idx in class_labels], \n                      normalize=True, \n                      xlabel='Truth (crop type group)', \n                      ylabel='Predicted (GBM)',\n                      title='Transposed Confusion matrix');\n\nplt.tight_layout()","key":"BQeDmqAm4h"},{"type":"output","id":"cZQcYdbrnhFMRztHgZqpT","data":[{"output_type":"display_data","metadata":{"needs_background":"light"},"data":{"image/png":{"content_type":"image/png","hash":"b2bad3a800543658005df7424666819a","path":"/notebooks_test/build/b2bad3a800543658005df7424666819a.png"},"text/plain":{"content":"\u003cFigure size 1440x1440 with 2 Axes\u003e","content_type":"text/plain"}}}],"key":"XFXQHVtt0O"}],"key":"c0AM50LeJN"},{"type":"block","kind":"notebook-code","data":{},"children":[{"type":"code","lang":"python","executable":true,"value":"fig = plt.figure(figsize=(20, 5))\nlabel_ids, label_counts = np.unique(labels_train, return_counts=True)\n\nplt.bar(range(len(label_ids)), label_counts/100)\nplt.xticks(range(len(label_ids)), [class_names[i] for i in label_ids], rotation=90, fontsize=20);\nplt.yticks(fontsize=20);\nplt.ylabel(\"Area [ha] \", size=18)","key":"WB5MNeC1Tb"},{"type":"output","id":"-nyuUGXPGB_3Ief5utRtX","data":[{"output_type":"display_data","metadata":{"needs_background":"light"},"data":{"image/png":{"content_type":"image/png","hash":"c44eb822c2efa650f78f247809eec57d","path":"/notebooks_test/build/c44eb822c2efa650f78f247809eec57d.png"},"text/plain":{"content":"\u003cFigure size 1440x360 with 1 Axes\u003e","content_type":"text/plain"}}}],"key":"RQVJUMvUeN"}],"key":"mRJMonMA5d"},{"type":"block","kind":"notebook-content","data":{},"children":[{"type":"heading","depth":2,"position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"children":[{"type":"text","value":"Predict Crop Type","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"oQXckWwwRP"}],"identifier":"predict-crop-type","label":"Predict Crop Type","html_id":"predict-crop-type","implicit":true,"key":"VAO3UpgA21"}],"key":"yFpO02tkYO"},{"type":"block","kind":"notebook-code","data":{},"children":[{"type":"code","lang":"python","executable":true,"value":"# Define Tasks\n\nclass PredictPatch(EOTask):\n    \"\"\"\n    Task to make model predictions on a patch. Provide the model and the feature, \n    and the output names of labels and scores (optional)\n    \"\"\"\n    def __init__(self, model, features_feature, predicted_labels_name, predicted_scores_name=None):\n        self.model = model\n        self.features_feature = features_feature\n        self.predicted_labels_name = predicted_labels_name\n        self.predicted_scores_name = predicted_scores_name\n        \n    def execute(self, eopatch):\n        ftrs = eopatch[self.features_feature[0]][self.features_feature[1]]\n        \n        t, w, h, f = ftrs.shape\n        ftrs = np.moveaxis(ftrs, 0, 2).reshape(w * h, t * f)\n        \n        plabels = self.model.predict(ftrs)\n        plabels = plabels.reshape(w, h)\n        plabels = plabels[..., np.newaxis]\n\n        eopatch.add_feature(FeatureType.MASK_TIMELESS, self.predicted_labels_name, plabels)\n        \n        if self.predicted_scores_name:\n            pscores = self.model.predict_proba(ftrs)\n            _, d = pscores.shape\n            pscores = pscores.reshape(w, h, d)\n            eopatch.add_feature(FeatureType.DATA_TIMELESS, self.predicted_scores_name, pscores)\n        \n        return eopatch\n\nclass MaskNoDataInPrediction(EOTask):\n    \"\"\"\n    Mask No Data in prediction\n    \"\"\"\n    \n    def __init__(self, src_layer, no_data_value, predicted_labels_name):\n        self.src_layer = src_layer\n        self.no_data_value = no_data_value\n        self.predicted_labels_name = predicted_labels_name\n    \n    def execute(self, eopatch):\n        NO_DATA = eopatch.mask_timeless[self.src_layer] == self.no_data_value\n        eopatch.mask_timeless[self.predicted_labels_name][NO_DATA] = self.no_data_value\n        \n        return eopatch","key":"qrv5qspRlx"},{"type":"output","id":"RhBrSt09tsczWccSAZxXC","data":[],"key":"wU6A4Y3kkf"}],"key":"afQcCT8EmR"},{"type":"block","kind":"notebook-code","data":{},"children":[{"type":"code","lang":"python","executable":true,"value":"# TASK TO LOAD EXISTING EOPATCHES\nload = LoadTask(path_out_sampled)\n\n# TASK FOR PREDICTION\npredict = PredictPatch(model, (FeatureType.DATA, 'FEATURES'), 'LBL_GBM', 'SCR_GBM')\n\n# Mask No Data in Prediction\nmask_no_data = MaskNoDataInPrediction(\"CROP_TYPE\", 0, \"LBL_GBM\")\n\n# TASK FOR SAVING\nsave = SaveTask(str(path_out_sampled), overwrite_permission=OverwritePermission.OVERWRITE_PATCH)\n\n# TASK TO EXPORT TIFF\nexport_tiff = ExportToTiff((FeatureType.MASK_TIMELESS, 'LBL_GBM'))\ntiff_location = './predicted_tiff'\nif not os.path.isdir(tiff_location):\n    os.makedirs(tiff_location)\n\nworkflow = LinearWorkflow(\n    load,\n    predict,\n    mask_no_data,\n    export_tiff,\n    save\n)","key":"RPH9gErT51"},{"type":"output","id":"fJwgc_RNSb92Vfu0oLoDt","data":[],"key":"cc3nweGaGM"}],"key":"IvvCXqE7tB"},{"type":"block","kind":"notebook-code","data":{},"children":[{"type":"code","lang":"python","executable":true,"value":"# create a list of execution arguments for each patch\nexecution_args = []\nfor i in range(len(patchIDs)):\n    execution_args.append(\n        {\n            load: {'eopatch_folder': 'eopatch_{}'.format(i)},\n            export_tiff: {'filename': '{}/prediction_eopatch_{}_original.tiff'.format(tiff_location, i)},\n            save: {'eopatch_folder': 'eopatch_{}'.format(i)}\n        }\n    )\n\n# run the executor on 2 cores\nexecutor = EOExecutor(workflow, execution_args)\n\n# uncomment below save the logs in the current directory and produce a report!\n#executor = EOExecutor(workflow, execution_args, save_logs=True)\n\nexecutor.run(workers=1, multiprocess=False)\nexecutor.make_report()","key":"MzoJ8lSQMh"},{"type":"output","id":"7rtWT7wWnQR6oZZBCnr2X","data":[{"output_type":"display_data","metadata":{},"data":{"application/vnd.jupyter.widget-view+json":{"content":"{\"model_id\":\"79419ae820f3457c91a34d5b4c322465\",\"version_major\":2,\"version_minor\":0}","content_type":"application/vnd.jupyter.widget-view+json"},"text/plain":{"content":"HBox(children=(FloatProgress(value=0.0, max=9.0), HTML(value='')))","content_type":"text/plain"}}},{"name":"stdout","output_type":"stream","text":"\n"}],"key":"w37quOJvLg"}],"key":"mAfmUwDMuI"},{"type":"block","kind":"notebook-content","data":{},"children":[{"type":"heading","depth":1,"position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"children":[{"type":"text","value":"Part 3: Visualize the prediction","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"uaqwuLD9sc"}],"identifier":"part-3-visualize-the-prediction","label":"Part 3: Visualize the prediction","html_id":"part-3-visualize-the-prediction","implicit":true,"key":"knWPgJkabj"}],"key":"qmz8XSmrrK"},{"type":"block","kind":"notebook-code","data":{},"children":[{"type":"code","lang":"python","executable":true,"value":"path_out_sampled = './eopatches_sampled_small/' if use_smaller_patches else './eopatches_sampled_large/'\n\nfig, axes = plt.subplots(figsize=(20, 20 * aspect_ratio), nrows=3, ncols=3)\n\npbar = tqdm(total=9)\nfor i, ax in enumerate(axes.flat):\n    eopatch = EOPatch.load('{}/eopatch_{}'.format(path_out_sampled, i), lazy_loading=True)\n    im = ax.imshow(eopatch.mask_timeless['LBL_GBM'].squeeze(), cmap=ct_cmap, norm=ct_norm)\n    ax.set_xticks([])\n    ax.set_yticks([])\n    ax.set_aspect(\"auto\")\n    pbar.update(1)\n\nfig.subplots_adjust(wspace=0, hspace=0)\n\ncb = fig.colorbar(im, ax=axes.ravel().tolist(), orientation='horizontal', pad=0.01, aspect=100)\ncb.ax.tick_params(labelsize=20) \ncb.set_ticks([entry.id for entry in CTGROUPS])\ncb.ax.set_xticklabels([entry.class_name for entry in CTGROUPS], rotation=90, fontsize=15)\nplt.show()","key":"IuqkiEP8Ce"},{"type":"output","id":"up7vHzZ70TClp6gTy2WgC","data":[{"name":"stderr","output_type":"stream","text":"/opt/conda/lib/python3.7/site-packages/ipykernel_launcher.py:5: TqdmDeprecationWarning: This function will be removed in tqdm==5.0.0\nPlease use `tqdm.notebook.tqdm` instead of `tqdm.tqdm_notebook`\n  \"\"\"\n"},{"output_type":"display_data","metadata":{},"data":{"application/vnd.jupyter.widget-view+json":{"content":"{\"model_id\":\"7960d3f09bbd4b2f934a85bed44377dc\",\"version_major\":2,\"version_minor\":0}","content_type":"application/vnd.jupyter.widget-view+json"},"text/plain":{"content":"HBox(children=(FloatProgress(value=0.0, max=9.0), HTML(value='')))","content_type":"text/plain"}}},{"output_type":"display_data","metadata":{"needs_background":"light"},"data":{"image/png":{"content_type":"image/png","hash":"db341a631ca4e65c17da917aee78454c","path":"/notebooks_test/build/db341a631ca4e65c17da917aee78454c.png"},"text/plain":{"content":"\u003cFigure size 1440x1080 with 10 Axes\u003e","content_type":"text/plain"}}}],"key":"o0RR6w4aL4"}],"key":"De9actgC25"},{"type":"block","kind":"notebook-content","data":{},"children":[{"type":"heading","depth":2,"position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"children":[{"type":"text","value":"Visual inspection of patches","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"x6Z7KXaU2u"}],"identifier":"visual-inspection-of-patches","label":"Visual inspection of patches","html_id":"visual-inspection-of-patches","implicit":true,"key":"GTsJpc7oDV"},{"type":"paragraph","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"children":[{"type":"text","value":"Here is just a simple piece of code that allows a closer inspection of the predicted labels.","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"key":"DPWgCKwRIY"}],"key":"H6CHm9klba"},{"type":"paragraph","position":{"start":{"line":5,"column":1},"end":{"line":5,"column":1}},"children":[{"type":"text","value":"Random subsets of patches are chosen, where prediction and ground truth are compared. For visual aid the mask of differences and the true color image are also provided.","position":{"start":{"line":5,"column":1},"end":{"line":5,"column":1}},"key":"QOskrVRPa0"}],"key":"lLoM7dT8dd"},{"type":"paragraph","position":{"start":{"line":7,"column":1},"end":{"line":7,"column":1}},"children":[{"type":"text","value":"In majority of the cases, differences seem to lie on the border of different structures.","position":{"start":{"line":7,"column":1},"end":{"line":7,"column":1}},"key":"jo6hQWvApW"}],"key":"d3xVquHUCj"}],"key":"wXHkIMn4Hq"},{"type":"block","kind":"notebook-code","data":{},"children":[{"type":"code","lang":"python","executable":true,"value":"# Draw the Reference map\n\nfig = plt.figure(figsize=(20, 20))\nidx = np.random.choice(range(9))\ninspect_size = 100\n\neopatch = EOPatch.load('{}/eopatch_{}'.format(path_out_sampled, idx), lazy_loading=True)\n\nw, h = eopatch.mask_timeless['CROP_TYPE'].squeeze().shape\n\nw_min = np.random.choice(range(w - inspect_size))\nh_min = np.random.choice(range(h - inspect_size))\n\nax = plt.subplot(2, 2, 1)\nplt.imshow(eopatch.mask_timeless['CROP_TYPE'].squeeze()[w_min: w_min + inspect_size, h_min : h_min + inspect_size],\n           cmap=ct_cmap, norm=ct_norm)\nplt.xticks([])\nplt.yticks([])\nax.set_aspect(\"auto\")\nplt.title('Ground Truth', fontsize=20)\n\nax = plt.subplot(2, 2, 2)\nplt.imshow(eopatch.mask_timeless['LBL_GBM'].squeeze()[w_min: w_min + inspect_size, h_min: h_min + inspect_size],\n           cmap=ct_cmap, norm=ct_norm)\nplt.xticks([])\nplt.yticks([])\nax.set_aspect(\"auto\")\nplt.title('Prediction', fontsize=20)\n\nax = plt.subplot(2, 2, 3)\nmask = eopatch.mask_timeless['LBL_GBM'].squeeze() != eopatch.mask_timeless['CROP_TYPE'].squeeze()\nplt.imshow(mask[w_min: w_min + inspect_size, h_min: h_min + inspect_size], cmap='gray')\nplt.xticks([])\nplt.yticks([]);\nax.set_aspect(\"auto\")\nplt.title('Difference', fontsize=20)\n\nax = plt.subplot(2, 2, 4)\nimage = np.clip(eopatch.data['FEATURES'][8][..., [2, 1, 0]] * 3.5, 0, 1)\nplt.imshow(image[w_min: w_min + inspect_size, h_min: h_min + inspect_size])\nplt.xticks([])\nplt.yticks([]);\nax.set_aspect(\"auto\")\nplt.title('True Color', fontsize=20)\n\nfig.subplots_adjust(wspace=0.1, hspace=0.1)","key":"ZFqYIq0Wy5"},{"type":"output","id":"qfjzWDotsAdkjOyqOcwmf","data":[{"output_type":"display_data","metadata":{},"data":{"image/png":{"content_type":"image/png","hash":"199b99469b001b21225f039359d06aa5","path":"/notebooks_test/build/199b99469b001b21225f039359d06aa5.png"},"text/plain":{"content":"\u003cFigure size 1440x1440 with 4 Axes\u003e","content_type":"text/plain"}}}],"key":"EeCYbJjOxD"}],"key":"MEdvNgdMxf"},{"type":"block","kind":"notebook-content","data":{},"children":[{"type":"heading","depth":1,"position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"children":[{"type":"text","value":"Part 4: Classification per LPIS ID","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"fO0GxWDEtl"}],"identifier":"part-4-classification-per-lpis-id","label":"Part 4: Classification per LPIS ID","html_id":"part-4-classification-per-lpis-id","implicit":true,"key":"lxqJiXeiaf"},{"type":"paragraph","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"children":[{"type":"text","value":"Here classification for a specific parcel identified with the unique ID from the OGD Dataset can be carried out.","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"key":"KXq40cDB8F"}],"key":"J8C6hKrXlp"},{"type":"paragraph","position":{"start":{"line":5,"column":1},"end":{"line":5,"column":1}},"children":[{"type":"text","value":"LPIS reference dates and time intervall for satellite imagery have to correspond to the timestamps used for classification.","position":{"start":{"line":5,"column":1},"end":{"line":5,"column":1}},"key":"GcObNvVf8h"}],"key":"xEmHLRpnuf"}],"key":"e67O8ggal1"},{"type":"block","kind":"notebook-code","data":{},"children":[{"type":"code","lang":"python","executable":true,"value":"# Specify OGD ID\n\nlpis_id = 126939\n\nmodel_path = './model_AT_CT_smaller.pkl'\nmodel = joblib.load(model_path)\n\n\n# LPIS reference date\ndateFilterMin = '2018-06-30'\ndateFilterMax = '2018-06-30'\n\n# Satellite imagery time series\nselected_date_interval_for_satellite_imagery = ['2018-01-01', '2018-09-30']\n\ntarget_crs = CRS.UTM_33N.epsg\ntableName = \"lpis_at\"","key":"kLwsSSeanl"},{"type":"output","id":"4a_PX_HiJIfxOpEtHkL81","data":[],"key":"QqrajerhaB"}],"key":"fJZVrDFxYW"},{"type":"block","kind":"notebook-content","data":{},"children":[{"type":"heading","depth":2,"position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"children":[{"type":"text","value":"Load Parcel","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"ZrJS81LFJb"}],"identifier":"load-parcel","label":"Load Parcel","html_id":"load-parcel","implicit":true,"key":"Qhnch91raH"}],"key":"nH72JRlWIW"},{"type":"block","kind":"notebook-code","data":{"scrolled":true},"children":[{"type":"code","lang":"python","executable":true,"value":"def lpis_geom_by_id(tableName, lpis_id, target_crs, dateFilterMin, dateFilterMax):\n\n    with psycopg2.connect(**db_conn_params) as db_conn:\n        sql = '''\n            SELECT \n                ctnuml4a, \n                ST_Transform(geometry, {targetCrs}) as geometry\n            FROM {tableName}\n            WHERE \n                ogd_id = {lpis_id}\n            AND \n                ref_date \u003e= '{dateFilterMin}' \n            AND ref_date \u003c= '{dateFilterMax}'\n            '''\n\n        sql = sql.format(tableName = tableName, \n                         targetCrs = target_crs,\n                         lpis_id = lpis_id,\n                         dateFilterMin = dateFilterMin, \n                         dateFilterMax = dateFilterMax)\n        return gpd.GeoDataFrame.from_postgis(sql, db_conn, geom_col='geometry')","key":"txe01tDe4q"},{"type":"output","id":"MpgjxAAO74kMhpnBY2IKz","data":[],"key":"EgAcHBBLrk"}],"key":"UJVNPGsszl"},{"type":"block","kind":"notebook-code","data":{},"children":[{"type":"code","lang":"python","executable":true,"value":"# load parcel\nlpis_df = lpis_geom_by_id(tableName, lpis_id, target_crs, dateFilterMin, dateFilterMax)\n\n# remap ids\nlpis_df[\"ct\"] = lpis_df[\"ctnuml4a\"].apply(lambda x: ctnuml4aToctMapping[x])\n\n# Visualize the parcel shape\nlpis_df.plot()","key":"DviEiNPgLO"},{"type":"output","id":"M9Jd9rxL7XrKApvjNQ7Xx","data":[{"output_type":"display_data","metadata":{"needs_background":"light"},"data":{"image/png":{"content_type":"image/png","hash":"a5b703584129929d1927e539bf0e0240","path":"/notebooks_test/build/a5b703584129929d1927e539bf0e0240.png"},"text/plain":{"content":"\u003cFigure size 432x288 with 1 Axes\u003e","content_type":"text/plain"}}}],"key":"nqVHZjvfQ6"}],"key":"TrudKTpiaD"},{"type":"block","kind":"notebook-content","data":{},"children":[{"type":"heading","depth":2,"position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"children":[{"type":"text","value":"Define workflow","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"KIrpxexbxT"}],"identifier":"define-workflow","label":"Define workflow","html_id":"define-workflow","implicit":true,"key":"YhoNt6de0N"},{"type":"paragraph","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"children":[{"type":"text","value":"Workflow for classifiaction of the single parcel:","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"key":"HaKwxZcZF6"}],"key":"Ama4GJwv5g"}],"key":"zGvGnWDej8"},{"type":"block","kind":"notebook-code","data":{},"children":[{"type":"code","lang":"python","executable":true,"value":"path_out = './eopatches_lpis'\n\nif not os.path.isdir(path_out):\n    os.makedirs(path_out)\n\nbbox = BBox(lpis_df.iloc[0].geometry.bounds, crs=target_crs)    \nadd_parcel = AddFeature((FeatureType.VECTOR_TIMELESS, \"CROP_TYPE_GDF\"))\nmask_no_data = MaskNoDataInPrediction(\"CROP_TYPE_ERODED\", 0, \"LBL_GBM\")\nerosion = ErosionTask(mask_feature=(FeatureType.MASK_TIMELESS,'CROP_TYPE','CROP_TYPE_ERODED'), disk_radius=1)\npredict = PredictPatch(model, (FeatureType.DATA, 'FEATURES'), 'LBL_GBM', 'SCR_GBM')\nsave = SaveTask(path_out, overwrite_permission=OverwritePermission.OVERWRITE_PATCH)\n\nworkflow = LinearWorkflow(\n    add_data,\n    add_clm,\n    ndvi,\n    ndwi,\n    norm,\n    add_sh_valmask,\n    add_parcel,\n    ct_rasterization_task,\n    concatenate,\n    filter_task,\n    linear_interp,\n    erosion,\n    predict,\n    mask_no_data,\n    save\n)","key":"qbws5u0C4y"},{"type":"output","id":"enye3u0OwIzVMIiqIx12r","data":[],"key":"WaCX9Al8Dt"}],"key":"S6Yqotz6MS"},{"type":"block","kind":"notebook-content","data":{},"children":[{"type":"heading","depth":2,"position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"children":[{"type":"text","value":"Execute workflow","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"wzFpPoef0z"}],"identifier":"execute-workflow","label":"Execute workflow","html_id":"execute-workflow","implicit":true,"key":"NX054PNGOW"}],"key":"vgGEZn74ay"},{"type":"block","kind":"notebook-code","data":{},"children":[{"type":"code","lang":"python","executable":true,"value":"%%time\n\nexecution_args = []\n\nexecution_args.append({\n    add_data: {'bbox': bbox, 'time_interval': selected_date_interval_for_satellite_imagery},\n    add_parcel: {'data': lpis_df},\n    save: {'eopatch_folder': 'eopatch_{}'.format(lpis_id)}\n})\n    \nexecutor = EOExecutor(workflow, execution_args, save_logs=True)\nexecutor.run(workers=1, multiprocess=True)\n\nexecutor.make_report()","key":"UO2E7lejKN"},{"type":"output","id":"2HxSroT9BpBQ7SivphHyG","data":[{"output_type":"display_data","metadata":{},"data":{"application/vnd.jupyter.widget-view+json":{"content":"{\"model_id\":\"d1412f3f24c549a095b8c559f2954d0c\",\"version_major\":2,\"version_minor\":0}","content_type":"application/vnd.jupyter.widget-view+json"},"text/plain":{"content":"HBox(children=(FloatProgress(value=0.0, max=1.0), HTML(value='')))","content_type":"text/plain"}}},{"name":"stdout","output_type":"stream","text":"\nCPU times: user 1.58 s, sys: 160 ms, total: 1.74 s\nWall time: 5.15 s\n"}],"key":"NftdnpnR34"}],"key":"DR9UPhl3mO"},{"type":"block","kind":"notebook-content","data":{},"children":[{"type":"heading","depth":2,"position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"children":[{"type":"text","value":"Classification Result","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"KRud5ygn2P"}],"identifier":"classification-result","label":"Classification Result","html_id":"classification-result","implicit":true,"key":"yy2D4ONNss"}],"key":"OB4ZB9eBzO"},{"type":"block","kind":"notebook-code","data":{},"children":[{"type":"code","lang":"python","executable":true,"value":"eopatch = EOPatch.load('./eopatches_lpis/eopatch_{}'.format(lpis_id))","key":"HwyZAwgB9B"},{"type":"output","id":"b7OYWKrZb73axHzrLqiMF","data":[],"key":"bxNHzqvtIS"}],"key":"LV7wvKKqXV"},{"type":"block","kind":"notebook-code","data":{},"children":[{"type":"code","lang":"python","executable":true,"value":"fig = plt.figure(figsize=(10, 10))\nimage = np.clip(eopatch.data['FEATURES'][8][..., [2, 1, 0]] * 3.5, 0, 1)\nplt.imshow(image)\n","key":"mSQB6j9ww9"},{"type":"output","id":"ExgqwDkrmbS_FX9qcsmqC","data":[{"output_type":"display_data","metadata":{"needs_background":"light"},"data":{"image/png":{"content_type":"image/png","hash":"e75f8ea4744cb7ce67fca036335cca1e","path":"/notebooks_test/build/e75f8ea4744cb7ce67fca036335cca1e.png"},"text/plain":{"content":"\u003cFigure size 720x720 with 1 Axes\u003e","content_type":"text/plain"}}}],"key":"txSPSUgXRB"}],"key":"uGDrX0SpGc"},{"type":"block","kind":"notebook-content","data":{},"children":[{"type":"heading","depth":3,"position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"children":[{"type":"text","value":"Declaration","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"WLgYbsoMV3"}],"identifier":"declaration","label":"Declaration","html_id":"declaration","implicit":true,"key":"f1wm7qXdr6"}],"key":"FcWKg4FwvK"},{"type":"block","kind":"notebook-code","data":{},"children":[{"type":"code","lang":"python","executable":true,"value":"fig = plt.figure(figsize=(10, 10))\nplt.imshow(eopatch.mask_timeless['CROP_TYPE_ERODED'].squeeze(), cmap=ct_cmap, norm=ct_norm)","key":"WHfkw6bIiX"},{"type":"output","id":"kpnrNqMTcJJqXZdTzI4MB","data":[{"output_type":"display_data","metadata":{"needs_background":"light"},"data":{"image/png":{"content_type":"image/png","hash":"7747949466dfd7ae7c6e5b87e5911ca7","path":"/notebooks_test/build/7747949466dfd7ae7c6e5b87e5911ca7.png"},"text/plain":{"content":"\u003cFigure size 720x720 with 1 Axes\u003e","content_type":"text/plain"}}}],"key":"TvXvyhFJ3N"}],"key":"LjnTtfGXmF"},{"type":"block","kind":"notebook-content","data":{},"children":[{"type":"heading","depth":3,"position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"children":[{"type":"text","value":"Prediction","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"E9yhtuOmdV"}],"identifier":"prediction","label":"Prediction","html_id":"prediction","implicit":true,"key":"IzWVM3HoeC"}],"key":"kfZg8KiVbd"},{"type":"block","kind":"notebook-code","data":{},"children":[{"type":"code","lang":"python","executable":true,"value":"fig = plt.figure(figsize=(10, 10))\naxes = plt.gca()\n\n\nim = plt.imshow(eopatch.mask_timeless['LBL_GBM'].squeeze(), cmap=ct_cmap, norm=ct_norm)\nplt.xticks([])\nplt.yticks([])\n\n\ncb = fig.colorbar(im, ax=axes, orientation='horizontal', pad=0.01, aspect=100)\ncb.ax.tick_params(labelsize=20) \ncb.set_ticks([entry.id for entry in CTGROUPS])\ncb.ax.set_xticklabels([entry.class_name for entry in CTGROUPS], rotation=90, fontsize=15)\nplt.show()","key":"BgtPG5IT6B"},{"type":"output","id":"1gb70c_eydN70ar3_MTvB","data":[{"output_type":"display_data","metadata":{"needs_background":"light"},"data":{"image/png":{"content_type":"image/png","hash":"d573ae757dc93f685751c859a0ba633f","path":"/notebooks_test/build/d573ae757dc93f685751c859a0ba633f.png"},"text/plain":{"content":"\u003cFigure size 720x720 with 2 Axes\u003e","content_type":"text/plain"}}}],"key":"e1uyQvBdbT"}],"key":"iIHZRq3m5G"},{"type":"block","kind":"notebook-content","data":{},"children":[{"type":"heading","depth":3,"position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"children":[{"type":"text","value":"Accuracy of classification","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"W4kCWZFASL"}],"identifier":"accuracy-of-classification","label":"Accuracy of classification","html_id":"accuracy-of-classification","implicit":true,"key":"HPVDvc4Jhp"}],"key":"GM8wW7zpFt"},{"type":"block","kind":"notebook-code","data":{},"children":[{"type":"code","lang":"python","executable":true,"value":"mask = (eopatch.mask_timeless['CROP_TYPE_ERODED'] != 0).squeeze()\n\nREF = eopatch.mask_timeless['CROP_TYPE'].squeeze()[mask]\nLBL_GBM = eopatch.mask_timeless['LBL_GBM'].squeeze()[mask]\n\n# classification is class with most pixels\nunique = np.unique(LBL_GBM, return_counts=True)\nclassification_id = unique[0][unique[1].argmax()]\n\n# remap to original id\nclassification_id_mapped = ctToctnuml4aMapping[classification_id][0]\n\n# precentage of pixels in prediction classified same as lpis\naccuracy = sum(REF == LBL_GBM) / len(LBL_GBM)\n\nprint(\"Parcel with ID {} classified as class {} with an accuracy of {:.2%}\".format(lpis_id, classification_id_mapped, accuracy))\n","key":"wgcT5A0kKU"},{"type":"output","id":"89Yn0nzDsN2NUE78EAarJ","data":[{"name":"stdout","output_type":"stream","text":"Parcel with ID 126939 classified as class 1020 with an accuracy of 90.91%\n"}],"key":"Kae94zn8rX"}],"key":"keUfrXXVZf"},{"type":"block","kind":"notebook-content","data":{},"children":[{"type":"heading","depth":1,"position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"children":[{"type":"text","value":"Part 5: Persist classification results in database","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"Duj9oQy5VT"}],"identifier":"part-5-persist-classification-results-in-database","label":"Part 5: Persist classification results in database","html_id":"part-5-persist-classification-results-in-database","implicit":true,"key":"gYiV60VQds"}],"key":"qiX2jt9JdE"},{"type":"block","kind":"notebook-content","data":{},"children":[{"type":"heading","depth":2,"position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"children":[{"type":"text","value":"Add the model configuration to the db","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"r4cZEF2Jas"}],"identifier":"add-the-model-configuration-to-the-db","label":"Add the model configuration to the db","html_id":"add-the-model-configuration-to-the-db","implicit":true,"key":"RIlgOcYIM3"}],"key":"uu6XMLdzct"},{"type":"block","kind":"notebook-code","data":{},"children":[{"type":"code","lang":"python","executable":true,"value":"model_name = \"default_3x3_noe\"\n\nmodel_config = {\n\n  \"reference\": {\n      \"table\": \"lpis_at\",\n      \"column\": \"ctnuml4a\",\n      \n  },\n    \n  \"classifiier\": \"lgbm\",\n    \n  \"model_parameters\":\n    {\n      \"boosting_type\": \"gbdt\",\n      \"num_leaves\": 31, \n      \"max_depth\": -1, \n      \"learning_rate\": 0.1\n    },\n    \n  \"valid_data_threshold\": 0.8,\n    \n  \"interpolation_range\": {\n    \"start\": \"2018-01-01\",\n    \"end\": \"2018-09-30\",\n    \"interval\": 16\n  },\n    \n  \"erosion_radius\": 1,\n    \n  \"features\": \n  [\n    \"B02\",\n    \"B03\",\n    \"B04\",\n    \"B08\",\n    \"B11\",\n    \"B12\",\n    \"NDVI\",\n    \"NDWI\",\n    \"NORM\"\n  ],\n    \n  \"training_bounds\": bounds\n}","key":"HbkSZzqaeE"},{"type":"output","id":"TnDtg7Gd1T2h2xJSoT2cA","data":[],"key":"uvsA3EKdW5"}],"key":"kC4f9yTiZo"},{"type":"block","kind":"notebook-code","data":{},"children":[{"type":"code","lang":"python","executable":true,"value":"insert_model = \"\"\"\nINSERT INTO model_at (name, ref_date, training_time, configuration)\nVALUES (\n    '{model_name}', \n    '2018-06-30', \n        (\n            SELECT CURRENT_TIMESTAMP\n        ),\n    '{config}'\n        \n    ); \n\"\"\".format(\n    config = str(model_config).replace(\"'\", \"\\\"\"),\n    model_name = model_name\n)\n\nwith psycopg2.connect(**db_conn_params) as db_conn:\n    with db_conn.cursor() as cur:\n        cur.execute(insert_model)\n        db_conn.commit()","key":"YqHLhX94x1"},{"type":"output","id":"NXtMuIBPuCQluy-LRtIlr","data":[],"key":"ZecJ46JNqk"}],"key":"lO1OV1bco8"},{"type":"block","kind":"notebook-content","data":{},"children":[{"type":"heading","depth":2,"position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"children":[{"type":"text","value":"Add all classification results for parcels within definded bounds","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"v936txZhlZ"}],"identifier":"add-all-classification-results-for-parcels-within-definded-bounds","label":"Add all classification results for parcels within definded bounds","html_id":"add-all-classification-results-for-parcels-within-definded-bounds","implicit":true,"key":"QnqWciUa1J"}],"key":"OyEAdx5Gtw"},{"type":"block","kind":"notebook-code","data":{},"children":[{"type":"code","lang":"python","executable":true,"value":"# change this bounding box depending on where the classification should be carried out\nbounds_for_classification = bounds\nmodel_name = \"default_3x3_noe\"","key":"upR9JLyCwr"},{"type":"output","id":"wEUfoQ9IwloHYAuhHaMqq","data":[],"key":"HUed1xsDei"}],"key":"jz71TuA2aQ"},{"type":"block","kind":"notebook-content","data":{},"children":[{"type":"heading","depth":3,"position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"children":[{"type":"text","value":"EOTasks","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"NHCoS3skGi"}],"identifier":"eotasks","label":"EOTasks","html_id":"eotasks","implicit":true,"key":"jVUtZPPYQI"}],"key":"A0mg7bKUHK"},{"type":"block","kind":"notebook-code","data":{},"children":[{"type":"code","lang":"python","executable":true,"value":"class AddPredictionToDatabase(EOTask):\n    def __init__(self, ref_date, model_id, target_table, db_conn_params):\n        self.ref_date = ref_date\n        self.model_id = model_id\n        self.target_table = target_table\n        self.db_conn_params = db_conn_params\n\n        \n    def execute(self, eopatch, parcel_id):\n        \n        mask = (eopatch.mask_timeless['CROP_TYPE_ERODED'] != 0).squeeze()\n\n        # scores per pixel\n        scores_pixel = eopatch.data_timeless[\"SCR_GBM\"][mask]\n\n        # averaged scores for each class form pixels to parcel\n        scores_parcel = np.nanmean(scores_pixel, axis=0)\n\n        # ranking\n        ranking = np.argsort(scores_parcel)\n\n        # probabilities ordered descending by ranking\n        scores_parcel = scores_parcel[ranking][::-1]\n\n        # ranked classes ordered descending by ranking\n        classes_parcel = model.classes_[ranking[::-1]]\n\n        # mapped back to original\n        classes_parcel_original = np.vectorize(lambda x: ctToctnuml4aMapping[x][0])(classes_parcel)\n        \n        prediction = [\n            dict(\n                crop_id=crop_id, \n                probability=round(probability, 2) if not np.isnan(probability) else 0\n            )\n\n            for crop_id, probability in zip(classes_parcel_original, scores_parcel)\n        ]\n        \n        \n        sql = \"\"\"\n        INSERT INTO {target_table} (parcel_id, ref_date, model_id, prediction)\n        VALUES (\n             {parcel_id}, \n            '{ref_date}', \n             {model_id},\n            '{prediction}'\n            )\n            \n        -- skip existing entries\n        ON CONFLICT DO NOTHING \n        ; \n        \"\"\"\n\n        sql = sql.format(\n            target_table = self.target_table,\n            parcel_id = parcel_id,\n            ref_date = self.ref_date,\n            model_id = self.model_id,\n            prediction = str(prediction).replace(\"'\", \"\\\"\")\n        )\n        with psycopg2.connect(**self.db_conn_params) as db_conn:\n            with db_conn.cursor() as cur:\n                cur.execute(sql)\n                db_conn.commit()\n                \n        return eopatch","key":"IMrQ860i4S"},{"type":"output","id":"FB8seLo7qJi36Ixu8r7kt","data":[],"key":"p1tbhZ9YR7"}],"key":"WEtbG68aCZ"},{"type":"block","kind":"notebook-content","data":{},"children":[{"type":"heading","depth":3,"position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"children":[{"type":"text","value":"Get Model ID","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"d3XLHEjBFF"}],"identifier":"get-model-id","label":"Get Model ID","html_id":"get-model-id","implicit":true,"key":"ZKCTC5N8Y3"}],"key":"gRu66akiKr"},{"type":"block","kind":"notebook-code","data":{},"children":[{"type":"code","lang":"python","executable":true,"value":"sql = \"SELECT id from model_at where name = '{}';\".format(model_name)\n\nwith psycopg2.connect(**db_conn_params) as db_conn:\n    with db_conn.cursor() as cur:\n        cur.execute(sql)\n        model_id = cur.fetchall()[0][0]\n        \nprint(\"model_id: \", model_id)","key":"hRsrOZbdKR"},{"type":"output","id":"gmcogW_OODLd212qYqQY9","data":[{"name":"stdout","output_type":"stream","text":"model_id:  12\n"}],"key":"oqjoLJWGiH"}],"key":"V48qoYWegx"},{"type":"block","kind":"notebook-content","data":{},"children":[{"type":"heading","depth":3,"position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"children":[{"type":"text","value":"Define workflow","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"z6VnTKm2Lw"}],"identifier":"define-workflow","label":"Define workflow","html_id":"define-workflow-1","implicit":true,"key":"zxLmVbcEmu"}],"key":"jWWEjQuJZF"},{"type":"block","kind":"notebook-code","data":{},"children":[{"type":"code","lang":"python","executable":true,"value":"classification_to_db = AddPredictionToDatabase('2018-06-30', model_id, 'classification_at', db_conn_params)\nadd_parcel = AddFeature((FeatureType.VECTOR_TIMELESS, \"CROP_TYPE_GDF\"))\nmask_no_data = MaskNoDataInPrediction(\"CROP_TYPE_ERODED\", 0, \"LBL_GBM\")\npredict = PredictPatch(model, (FeatureType.DATA, 'FEATURES'), 'LBL_GBM', 'SCR_GBM')","key":"K6Nt2gbAmh"},{"type":"output","id":"fSHCsr7lkdXltlwfKs-d1","data":[],"key":"timTAjLI4H"}],"key":"K6Dstuzsfv"},{"type":"block","kind":"notebook-code","data":{},"children":[{"type":"code","lang":"python","executable":true,"value":"workflow = LinearWorkflow(\n    add_data,\n    add_clm,\n    ndvi,\n    ndwi,\n    norm,\n    add_sh_valmask,\n    add_parcel,\n    ct_rasterization_task,\n    concatenate,\n    filter_task,\n    linear_interp,\n    erosion,\n    predict,\n    mask_no_data,\n    classification_to_db\n)","key":"qJJta7MOOB"},{"type":"output","id":"yLrjzDxaa7uPvRgl283M_","data":[],"key":"U5cLkUXT9w"}],"key":"MAyqCAVpef"},{"type":"block","kind":"notebook-content","data":{},"children":[{"type":"heading","depth":3,"position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"children":[{"type":"text","value":"List of parcels to process","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"jcusSrkxcW"}],"identifier":"list-of-parcels-to-process","label":"List of parcels to process","html_id":"list-of-parcels-to-process","implicit":true,"key":"Rbj1TuEwrT"}],"key":"L4rplDGuZy"},{"type":"block","kind":"notebook-code","data":{},"children":[{"type":"code","lang":"python","executable":true,"value":"with psycopg2.connect(**db_conn_params) as db_conn:\n\n    sql = '''\n    SELECT\n        ogd_id,\n        {column},\n        ST_Transform(geometry, {targetCrs}) as geometry\n\n    FROM\n        {tableName}\n    WHERE\n        ref_date \u003e= '{dateFilterMin}'\n    AND \n        ref_date \u003c= '{dateFilterMax}'\n    AND\n        ST_INTERSECTS(\n            ST_Transform(geometry, 4326),\n            ST_SetSRID(\n                ST_MakeBox2D(\n                        ST_Point({min_x}, {min_y}),\n                        ST_Point({max_x}, {max_y})\n                ),\n                4326\n            )\n        );\n    '''\n\n    sql = sql.format(tableName = model_config[\"reference\"][\"table\"],\n                     column = model_config[\"reference\"][\"column\"],\n                     targetCrs = target_crs,\n                     dateFilterMin = dateFilterMin, \n                     dateFilterMax = dateFilterMax,\n                     min_x = bounds_for_classification[0],\n                     min_y = bounds_for_classification[1],\n                     max_x = bounds_for_classification[2],\n                     max_y = bounds_for_classification[3],\n                    )\n    \n    parcels_to_process = gpd.GeoDataFrame.from_postgis(sql, db_conn, geom_col='geometry', )\n\n\n# remap id\nparcels_to_process[\"ct\"] = parcels_to_process[\"ctnuml4a\"].apply(lambda x: ctnuml4aToctMapping[x])","key":"bHOiGUOfyc"},{"type":"output","id":"ztzZdAolxta8cCGX17Bd7","data":[],"key":"W1LQRo5WuK"}],"key":"xDpNLxc3o6"},{"type":"block","kind":"notebook-code","data":{},"children":[{"type":"code","lang":"python","executable":true,"value":"parcels_to_process","key":"EqkP4nUPjm"},{"type":"output","id":"IeW04KWUDF-yTE4PdT5Lk","data":[{"output_type":"execute_result","execution_count":57,"metadata":{},"data":{"text/html":{"content":"\u003cdiv\u003e\n\u003cstyle scoped\u003e\n    .dataframe tbody tr th:only-of-type {\n        vertical-align: middle;\n    }\n\n    .dataframe tbody tr th {\n        vertical-align: top;\n    }\n\n    .dataframe thead th {\n        text-align: right;\n    }\n\u003c/style\u003e\n\u003ctable border=\"1\" class=\"dataframe\"\u003e\n  \u003cthead\u003e\n    \u003ctr style=\"text-align: right;\"\u003e\n      \u003cth\u003e\u003c/th\u003e\n      \u003cth\u003eogd_id\u003c/th\u003e\n      \u003cth\u003ectnuml4a\u003c/th\u003e\n      \u003cth\u003egeometry\u003c/th\u003e\n      \u003cth\u003ect\u003c/th\u003e\n    \u003c/tr\u003e\n  \u003c/thead\u003e\n  \u003ctbody\u003e\n    \u003ctr\u003e\n      \u003cth\u003e0\u003c/th\u003e\n      \u003ctd\u003e333386.0\u003c/td\u003e\n      \u003ctd\u003e1020\u003c/td\u003e\n      \u003ctd\u003ePOLYGON ((538844.452 5401988.173, 538791.190 5...\u003c/td\u003e\n      \u003ctd\u003e2\u003c/td\u003e\n    \u003c/tr\u003e\n    \u003ctr\u003e\n      \u003cth\u003e1\u003c/th\u003e\n      \u003ctd\u003e333388.0\u003c/td\u003e\n      \u003ctd\u003e1210\u003c/td\u003e\n      \u003ctd\u003ePOLYGON ((538940.617 5401357.192, 538900.718 5...\u003c/td\u003e\n      \u003ctd\u003e21\u003c/td\u003e\n    \u003c/tr\u003e\n    \u003ctr\u003e\n      \u003cth\u003e2\u003c/th\u003e\n      \u003ctd\u003e334104.0\u003c/td\u003e\n      \u003ctd\u003e1010\u003c/td\u003e\n      \u003ctd\u003ePOLYGON ((538657.001 5401587.709, 538599.773 5...\u003c/td\u003e\n      \u003ctd\u003e1\u003c/td\u003e\n    \u003c/tr\u003e\n    \u003ctr\u003e\n      \u003cth\u003e3\u003c/th\u003e\n      \u003ctd\u003e334105.0\u003c/td\u003e\n      \u003ctd\u003e1210\u003c/td\u003e\n      \u003ctd\u003ePOLYGON ((539119.085 5401857.078, 539173.783 5...\u003c/td\u003e\n      \u003ctd\u003e21\u003c/td\u003e\n    \u003c/tr\u003e\n    \u003ctr\u003e\n      \u003cth\u003e4\u003c/th\u003e\n      \u003ctd\u003e334106.0\u003c/td\u003e\n      \u003ctd\u003e1210\u003c/td\u003e\n      \u003ctd\u003ePOLYGON ((538963.364 5401353.648, 538952.689 5...\u003c/td\u003e\n      \u003ctd\u003e21\u003c/td\u003e\n    \u003c/tr\u003e\n    \u003ctr\u003e\n      \u003cth\u003e5\u003c/th\u003e\n      \u003ctd\u003e513054.0\u003c/td\u003e\n      \u003ctd\u003e1020\u003c/td\u003e\n      \u003ctd\u003ePOLYGON ((538776.253 5402396.809, 538811.508 5...\u003c/td\u003e\n      \u003ctd\u003e2\u003c/td\u003e\n    \u003c/tr\u003e\n    \u003ctr\u003e\n      \u003cth\u003e6\u003c/th\u003e\n      \u003ctd\u003e511905.0\u003c/td\u003e\n      \u003ctd\u003e1010\u003c/td\u003e\n      \u003ctd\u003ePOLYGON ((538766.889 5401359.859, 539114.235 5...\u003c/td\u003e\n      \u003ctd\u003e1\u003c/td\u003e\n    \u003c/tr\u003e\n    \u003ctr\u003e\n      \u003cth\u003e7\u003c/th\u003e\n      \u003ctd\u003e512660.0\u003c/td\u003e\n      \u003ctd\u003e1010\u003c/td\u003e\n      \u003ctd\u003ePOLYGON ((539122.924 5402090.288, 539134.580 5...\u003c/td\u003e\n      \u003ctd\u003e1\u003c/td\u003e\n    \u003c/tr\u003e\n    \u003ctr\u003e\n      \u003cth\u003e8\u003c/th\u003e\n      \u003ctd\u003e1030069.0\u003c/td\u003e\n      \u003ctd\u003e1050\u003c/td\u003e\n      \u003ctd\u003ePOLYGON ((538375.922 5401676.473, 538365.054 5...\u003c/td\u003e\n      \u003ctd\u003e5\u003c/td\u003e\n    \u003c/tr\u003e\n    \u003ctr\u003e\n      \u003cth\u003e9\u003c/th\u003e\n      \u003ctd\u003e1031087.0\u003c/td\u003e\n      \u003ctd\u003e1210\u003c/td\u003e\n      \u003ctd\u003ePOLYGON ((538814.320 5401357.902, 539142.634 5...\u003c/td\u003e\n      \u003ctd\u003e21\u003c/td\u003e\n    \u003c/tr\u003e\n    \u003ctr\u003e\n      \u003cth\u003e10\u003c/th\u003e\n      \u003ctd\u003e1093378.0\u003c/td\u003e\n      \u003ctd\u003e1090\u003c/td\u003e\n      \u003ctd\u003ePOLYGON ((538491.661 5400177.570, 538511.199 5...\u003c/td\u003e\n      \u003ctd\u003e9\u003c/td\u003e\n    \u003c/tr\u003e\n    \u003ctr\u003e\n      \u003cth\u003e11\u003c/th\u003e\n      \u003ctd\u003e1093379.0\u003c/td\u003e\n      \u003ctd\u003e1010\u003c/td\u003e\n      \u003ctd\u003ePOLYGON ((538746.810 5400483.771, 538734.941 5...\u003c/td\u003e\n      \u003ctd\u003e1\u003c/td\u003e\n    \u003c/tr\u003e\n    \u003ctr\u003e\n      \u003cth\u003e12\u003c/th\u003e\n      \u003ctd\u003e1093380.0\u003c/td\u003e\n      \u003ctd\u003e1050\u003c/td\u003e\n      \u003ctd\u003ePOLYGON ((538490.284 5400662.682, 538496.677 5...\u003c/td\u003e\n      \u003ctd\u003e5\u003c/td\u003e\n    \u003c/tr\u003e\n    \u003ctr\u003e\n      \u003cth\u003e13\u003c/th\u003e\n      \u003ctd\u003e1093381.0\u003c/td\u003e\n      \u003ctd\u003e1020\u003c/td\u003e\n      \u003ctd\u003ePOLYGON ((538768.957 5400884.197, 538735.711 5...\u003c/td\u003e\n      \u003ctd\u003e2\u003c/td\u003e\n    \u003c/tr\u003e\n    \u003ctr\u003e\n      \u003cth\u003e14\u003c/th\u003e\n      \u003ctd\u003e1114582.0\u003c/td\u003e\n      \u003ctd\u003e1060\u003c/td\u003e\n      \u003ctd\u003ePOLYGON ((538888.397 5400872.477, 538898.062 5...\u003c/td\u003e\n      \u003ctd\u003e6\u003c/td\u003e\n    \u003c/tr\u003e\n    \u003ctr\u003e\n      \u003cth\u003e15\u003c/th\u003e\n      \u003ctd\u003e1115008.0\u003c/td\u003e\n      \u003ctd\u003e1040\u003c/td\u003e\n      \u003ctd\u003ePOLYGON ((538769.006 5400609.582, 538723.259 5...\u003c/td\u003e\n      \u003ctd\u003e4\u003c/td\u003e\n    \u003c/tr\u003e\n    \u003ctr\u003e\n      \u003cth\u003e16\u003c/th\u003e\n      \u003ctd\u003e1115106.0\u003c/td\u003e\n      \u003ctd\u003e1020\u003c/td\u003e\n      \u003ctd\u003ePOLYGON ((539021.618 5400672.690, 539030.647 5...\u003c/td\u003e\n      \u003ctd\u003e2\u003c/td\u003e\n    \u003c/tr\u003e\n    \u003ctr\u003e\n      \u003cth\u003e17\u003c/th\u003e\n      \u003ctd\u003e1115108.0\u003c/td\u003e\n      \u003ctd\u003e1020\u003c/td\u003e\n      \u003ctd\u003ePOLYGON ((538610.623 5400673.428, 538590.545 5...\u003c/td\u003e\n      \u003ctd\u003e2\u003c/td\u003e\n    \u003c/tr\u003e\n    \u003ctr\u003e\n      \u003cth\u003e18\u003c/th\u003e\n      \u003ctd\u003e1115109.0\u003c/td\u003e\n      \u003ctd\u003e1020\u003c/td\u003e\n      \u003ctd\u003ePOLYGON ((538768.236 5400882.835, 538820.171 5...\u003c/td\u003e\n      \u003ctd\u003e2\u003c/td\u003e\n    \u003c/tr\u003e\n    \u003ctr\u003e\n      \u003cth\u003e19\u003c/th\u003e\n      \u003ctd\u003e1116843.0\u003c/td\u003e\n      \u003ctd\u003e1240\u003c/td\u003e\n      \u003ctd\u003ePOLYGON ((538446.658 5400959.995, 538445.552 5...\u003c/td\u003e\n      \u003ctd\u003e24\u003c/td\u003e\n    \u003c/tr\u003e\n    \u003ctr\u003e\n      \u003cth\u003e20\u003c/th\u003e\n      \u003ctd\u003e1116846.0\u003c/td\u003e\n      \u003ctd\u003e1010\u003c/td\u003e\n      \u003ctd\u003ePOLYGON ((538774.157 5400605.353, 538722.915 5...\u003c/td\u003e\n      \u003ctd\u003e1\u003c/td\u003e\n    \u003c/tr\u003e\n    \u003ctr\u003e\n      \u003cth\u003e21\u003c/th\u003e\n      \u003ctd\u003e1119100.0\u003c/td\u003e\n      \u003ctd\u003e1020\u003c/td\u003e\n      \u003ctd\u003ePOLYGON ((538523.806 5400877.293, 538485.333 5...\u003c/td\u003e\n      \u003ctd\u003e2\u003c/td\u003e\n    \u003c/tr\u003e\n    \u003ctr\u003e\n      \u003cth\u003e22\u003c/th\u003e\n      \u003ctd\u003e1119101.0\u003c/td\u003e\n      \u003ctd\u003e1060\u003c/td\u003e\n      \u003ctd\u003ePOLYGON ((538885.102 5400871.225, 538821.949 5...\u003c/td\u003e\n      \u003ctd\u003e6\u003c/td\u003e\n    \u003c/tr\u003e\n    \u003ctr\u003e\n      \u003cth\u003e23\u003c/th\u003e\n      \u003ctd\u003e1119102.0\u003c/td\u003e\n      \u003ctd\u003e1060\u003c/td\u003e\n      \u003ctd\u003ePOLYGON ((538921.392 5400884.111, 538903.323 5...\u003c/td\u003e\n      \u003ctd\u003e6\u003c/td\u003e\n    \u003c/tr\u003e\n    \u003ctr\u003e\n      \u003cth\u003e24\u003c/th\u003e\n      \u003ctd\u003e1492894.0\u003c/td\u003e\n      \u003ctd\u003e1040\u003c/td\u003e\n      \u003ctd\u003ePOLYGON ((538356.118 5400089.171, 538412.305 5...\u003c/td\u003e\n      \u003ctd\u003e4\u003c/td\u003e\n    \u003c/tr\u003e\n    \u003ctr\u003e\n      \u003cth\u003e25\u003c/th\u003e\n      \u003ctd\u003e1498138.0\u003c/td\u003e\n      \u003ctd\u003e1040\u003c/td\u003e\n      \u003ctd\u003ePOLYGON ((538606.436 5400593.986, 538606.446 5...\u003c/td\u003e\n      \u003ctd\u003e4\u003c/td\u003e\n    \u003c/tr\u003e\n    \u003ctr\u003e\n      \u003cth\u003e26\u003c/th\u003e\n      \u003ctd\u003e1498139.0\u003c/td\u003e\n      \u003ctd\u003e1040\u003c/td\u003e\n      \u003ctd\u003ePOLYGON ((538877.284 5400856.416, 538855.877 5...\u003c/td\u003e\n      \u003ctd\u003e4\u003c/td\u003e\n    \u003c/tr\u003e\n    \u003ctr\u003e\n      \u003cth\u003e27\u003c/th\u003e\n      \u003ctd\u003e1562116.0\u003c/td\u003e\n      \u003ctd\u003e1020\u003c/td\u003e\n      \u003ctd\u003ePOLYGON ((538422.344 5401641.427, 538378.657 5...\u003c/td\u003e\n      \u003ctd\u003e2\u003c/td\u003e\n    \u003c/tr\u003e\n    \u003ctr\u003e\n      \u003cth\u003e28\u003c/th\u003e\n      \u003ctd\u003e2201537.0\u003c/td\u003e\n      \u003ctd\u003e1210\u003c/td\u003e\n      \u003ctd\u003ePOLYGON ((538663.014 5400913.721, 538673.844 5...\u003c/td\u003e\n      \u003ctd\u003e21\u003c/td\u003e\n    \u003c/tr\u003e\n    \u003ctr\u003e\n      \u003cth\u003e29\u003c/th\u003e\n      \u003ctd\u003e2201968.0\u003c/td\u003e\n      \u003ctd\u003e1020\u003c/td\u003e\n      \u003ctd\u003ePOLYGON ((538586.934 5400757.539, 538591.586 5...\u003c/td\u003e\n      \u003ctd\u003e2\u003c/td\u003e\n    \u003c/tr\u003e\n    \u003ctr\u003e\n      \u003cth\u003e30\u003c/th\u003e\n      \u003ctd\u003e2201979.0\u003c/td\u003e\n      \u003ctd\u003e1020\u003c/td\u003e\n      \u003ctd\u003ePOLYGON ((538706.683 5400891.357, 538769.879 5...\u003c/td\u003e\n      \u003ctd\u003e2\u003c/td\u003e\n    \u003c/tr\u003e\n    \u003ctr\u003e\n      \u003cth\u003e31\u003c/th\u003e\n      \u003ctd\u003e2202753.0\u003c/td\u003e\n      \u003ctd\u003e1010\u003c/td\u003e\n      \u003ctd\u003ePOLYGON ((538610.953 5400829.021, 538622.156 5...\u003c/td\u003e\n      \u003ctd\u003e1\u003c/td\u003e\n    \u003c/tr\u003e\n    \u003ctr\u003e\n      \u003cth\u003e32\u003c/th\u003e\n      \u003ctd\u003e2213647.0\u003c/td\u003e\n      \u003ctd\u003e1020\u003c/td\u003e\n      \u003ctd\u003ePOLYGON ((538604.009 5400812.883, 538610.953 5...\u003c/td\u003e\n      \u003ctd\u003e2\u003c/td\u003e\n    \u003c/tr\u003e\n    \u003ctr\u003e\n      \u003cth\u003e33\u003c/th\u003e\n      \u003ctd\u003e2220478.0\u003c/td\u003e\n      \u003ctd\u003e1010\u003c/td\u003e\n      \u003ctd\u003ePOLYGON ((538538.068 5400600.747, 538544.498 5...\u003c/td\u003e\n      \u003ctd\u003e1\u003c/td\u003e\n    \u003c/tr\u003e\n    \u003ctr\u003e\n      \u003cth\u003e34\u003c/th\u003e\n      \u003ctd\u003e2220819.0\u003c/td\u003e\n      \u003ctd\u003e1060\u003c/td\u003e\n      \u003ctd\u003ePOLYGON ((538559.113 5400654.667, 538522.089 5...\u003c/td\u003e\n      \u003ctd\u003e6\u003c/td\u003e\n    \u003c/tr\u003e\n    \u003ctr\u003e\n      \u003cth\u003e35\u003c/th\u003e\n      \u003ctd\u003e2220821.0\u003c/td\u003e\n      \u003ctd\u003e1060\u003c/td\u003e\n      \u003ctd\u003ePOLYGON ((538943.844 5400826.118, 538856.445 5...\u003c/td\u003e\n      \u003ctd\u003e6\u003c/td\u003e\n    \u003c/tr\u003e\n    \u003ctr\u003e\n      \u003cth\u003e36\u003c/th\u003e\n      \u003ctd\u003e2220824.0\u003c/td\u003e\n      \u003ctd\u003e1060\u003c/td\u003e\n      \u003ctd\u003ePOLYGON ((538719.997 5400888.823, 538782.538 5...\u003c/td\u003e\n      \u003ctd\u003e6\u003c/td\u003e\n    \u003c/tr\u003e\n    \u003ctr\u003e\n      \u003cth\u003e37\u003c/th\u003e\n      \u003ctd\u003e2230029.0\u003c/td\u003e\n      \u003ctd\u003e1010\u003c/td\u003e\n      \u003ctd\u003ePOLYGON ((538729.568 5401366.168, 538724.188 5...\u003c/td\u003e\n      \u003ctd\u003e1\u003c/td\u003e\n    \u003c/tr\u003e\n    \u003ctr\u003e\n      \u003cth\u003e38\u003c/th\u003e\n      \u003ctd\u003e2235477.0\u003c/td\u003e\n      \u003ctd\u003e1020\u003c/td\u003e\n      \u003ctd\u003ePOLYGON ((539313.375 5402185.990, 539209.344 5...\u003c/td\u003e\n      \u003ctd\u003e2\u003c/td\u003e\n    \u003c/tr\u003e\n    \u003ctr\u003e\n      \u003cth\u003e39\u003c/th\u003e\n      \u003ctd\u003e2235485.0\u003c/td\u003e\n      \u003ctd\u003e1020\u003c/td\u003e\n      \u003ctd\u003ePOLYGON ((538748.435 5401361.481, 539103.145 5...\u003c/td\u003e\n      \u003ctd\u003e2\u003c/td\u003e\n    \u003c/tr\u003e\n    \u003ctr\u003e\n      \u003cth\u003e40\u003c/th\u003e\n      \u003ctd\u003e2700060.0\u003c/td\u003e\n      \u003ctd\u003e1210\u003c/td\u003e\n      \u003ctd\u003ePOLYGON ((539297.463 5401989.705, 539288.521 5...\u003c/td\u003e\n      \u003ctd\u003e21\u003c/td\u003e\n    \u003c/tr\u003e\n    \u003ctr\u003e\n      \u003cth\u003e41\u003c/th\u003e\n      \u003ctd\u003e2710354.0\u003c/td\u003e\n      \u003ctd\u003e1020\u003c/td\u003e\n      \u003ctd\u003ePOLYGON ((539209.344 5401934.545, 539313.375 5...\u003c/td\u003e\n      \u003ctd\u003e2\u003c/td\u003e\n    \u003c/tr\u003e\n    \u003ctr\u003e\n      \u003cth\u003e42\u003c/th\u003e\n      \u003ctd\u003e3282870.0\u003c/td\u003e\n      \u003ctd\u003e1170\u003c/td\u003e\n      \u003ctd\u003ePOLYGON ((538470.878 5400665.536, 538462.178 5...\u003c/td\u003e\n      \u003ctd\u003e17\u003c/td\u003e\n    \u003c/tr\u003e\n    \u003ctr\u003e\n      \u003cth\u003e43\u003c/th\u003e\n      \u003ctd\u003e3292453.0\u003c/td\u003e\n      \u003ctd\u003e1210\u003c/td\u003e\n      \u003ctd\u003ePOLYGON ((539073.696 5400954.560, 539038.852 5...\u003c/td\u003e\n      \u003ctd\u003e21\u003c/td\u003e\n    \u003c/tr\u003e\n    \u003ctr\u003e\n      \u003cth\u003e44\u003c/th\u003e\n      \u003ctd\u003e3292460.0\u003c/td\u003e\n      \u003ctd\u003e1020\u003c/td\u003e\n      \u003ctd\u003ePOLYGON ((538622.156 5400850.341, 538633.416 5...\u003c/td\u003e\n      \u003ctd\u003e2\u003c/td\u003e\n    \u003c/tr\u003e\n    \u003ctr\u003e\n      \u003cth\u003e45\u003c/th\u003e\n      \u003ctd\u003e3625398.0\u003c/td\u003e\n      \u003ctd\u003e1020\u003c/td\u003e\n      \u003ctd\u003ePOLYGON ((538948.750 5400715.235, 538972.781 5...\u003c/td\u003e\n      \u003ctd\u003e2\u003c/td\u003e\n    \u003c/tr\u003e\n    \u003ctr\u003e\n      \u003cth\u003e46\u003c/th\u003e\n      \u003ctd\u003e3625399.0\u003c/td\u003e\n      \u003ctd\u003e1020\u003c/td\u003e\n      \u003ctd\u003ePOLYGON ((538769.879 5401010.879, 538706.185 5...\u003c/td\u003e\n      \u003ctd\u003e2\u003c/td\u003e\n    \u003c/tr\u003e\n    \u003ctr\u003e\n      \u003cth\u003e47\u003c/th\u003e\n      \u003ctd\u003e3798537.0\u003c/td\u003e\n      \u003ctd\u003e1210\u003c/td\u003e\n      \u003ctd\u003ePOLYGON ((539247.012 5402248.699, 539270.409 5...\u003c/td\u003e\n      \u003ctd\u003e21\u003c/td\u003e\n    \u003c/tr\u003e\n    \u003ctr\u003e\n      \u003cth\u003e48\u003c/th\u003e\n      \u003ctd\u003e3798539.0\u003c/td\u003e\n      \u003ctd\u003e1020\u003c/td\u003e\n      \u003ctd\u003ePOLYGON ((538458.427 5401632.103, 538811.508 5...\u003c/td\u003e\n      \u003ctd\u003e2\u003c/td\u003e\n    \u003c/tr\u003e\n    \u003ctr\u003e\n      \u003cth\u003e49\u003c/th\u003e\n      \u003ctd\u003e3834900.0\u003c/td\u003e\n      \u003ctd\u003e1170\u003c/td\u003e\n      \u003ctd\u003ePOLYGON ((538964.008 5400816.413, 538956.734 5...\u003c/td\u003e\n      \u003ctd\u003e17\u003c/td\u003e\n    \u003c/tr\u003e\n    \u003ctr\u003e\n      \u003cth\u003e50\u003c/th\u003e\n      \u003ctd\u003e3834910.0\u003c/td\u003e\n      \u003ctd\u003e1170\u003c/td\u003e\n      \u003ctd\u003ePOLYGON ((538856.943 5400632.525, 538944.615 5...\u003c/td\u003e\n      \u003ctd\u003e17\u003c/td\u003e\n    \u003c/tr\u003e\n    \u003ctr\u003e\n      \u003cth\u003e51\u003c/th\u003e\n      \u003ctd\u003e4375165.0\u003c/td\u003e\n      \u003ctd\u003e1210\u003c/td\u003e\n      \u003ctd\u003ePOLYGON ((539013.274 5400867.592, 539045.687 5...\u003c/td\u003e\n      \u003ctd\u003e21\u003c/td\u003e\n    \u003c/tr\u003e\n    \u003ctr\u003e\n      \u003cth\u003e52\u003c/th\u003e\n      \u003ctd\u003e4397511.0\u003c/td\u003e\n      \u003ctd\u003e1210\u003c/td\u003e\n      \u003ctd\u003ePOLYGON ((538536.065 5400962.920, 538517.783 5...\u003c/td\u003e\n      \u003ctd\u003e21\u003c/td\u003e\n    \u003c/tr\u003e\n    \u003ctr\u003e\n      \u003cth\u003e53\u003c/th\u003e\n      \u003ctd\u003e4397516.0\u003c/td\u003e\n      \u003ctd\u003e1060\u003c/td\u003e\n      \u003ctd\u003ePOLYGON ((538440.897 5401107.970, 538552.751 5...\u003c/td\u003e\n      \u003ctd\u003e6\u003c/td\u003e\n    \u003c/tr\u003e\n    \u003ctr\u003e\n      \u003cth\u003e54\u003c/th\u003e\n      \u003ctd\u003e4397519.0\u003c/td\u003e\n      \u003ctd\u003e1020\u003c/td\u003e\n      \u003ctd\u003ePOLYGON ((538657.001 5401587.709, 538943.764 5...\u003c/td\u003e\n      \u003ctd\u003e2\u003c/td\u003e\n    \u003c/tr\u003e\n    \u003ctr\u003e\n      \u003cth\u003e55\u003c/th\u003e\n      \u003ctd\u003e4399112.0\u003c/td\u003e\n      \u003ctd\u003e1040\u003c/td\u003e\n      \u003ctd\u003ePOLYGON ((538204.012 5401652.954, 538230.812 5...\u003c/td\u003e\n      \u003ctd\u003e4\u003c/td\u003e\n    \u003c/tr\u003e\n    \u003ctr\u003e\n      \u003cth\u003e56\u003c/th\u003e\n      \u003ctd\u003e4399114.0\u003c/td\u003e\n      \u003ctd\u003e1240\u003c/td\u003e\n      \u003ctd\u003ePOLYGON ((538446.377 5400962.515, 538494.538 5...\u003c/td\u003e\n      \u003ctd\u003e24\u003c/td\u003e\n    \u003c/tr\u003e\n    \u003ctr\u003e\n      \u003cth\u003e57\u003c/th\u003e\n      \u003ctd\u003e4399115.0\u003c/td\u003e\n      \u003ctd\u003e1210\u003c/td\u003e\n      \u003ctd\u003ePOLYGON ((538567.482 5401078.946, 538615.272 5...\u003c/td\u003e\n      \u003ctd\u003e21\u003c/td\u003e\n    \u003c/tr\u003e\n    \u003ctr\u003e\n      \u003cth\u003e58\u003c/th\u003e\n      \u003ctd\u003e4620993.0\u003c/td\u003e\n      \u003ctd\u003e1020\u003c/td\u003e\n      \u003ctd\u003ePOLYGON ((538648.293 5400691.236, 538584.338 5...\u003c/td\u003e\n      \u003ctd\u003e2\u003c/td\u003e\n    \u003c/tr\u003e\n    \u003ctr\u003e\n      \u003cth\u003e59\u003c/th\u003e\n      \u003ctd\u003e4664131.0\u003c/td\u003e\n      \u003ctd\u003e1040\u003c/td\u003e\n      \u003ctd\u003ePOLYGON ((538557.138 5401610.031, 538909.679 5...\u003c/td\u003e\n      \u003ctd\u003e4\u003c/td\u003e\n    \u003c/tr\u003e\n  \u003c/tbody\u003e\n\u003c/table\u003e\n\u003c/div\u003e","content_type":"text/html"},"text/plain":{"content":"       ogd_id  ctnuml4a                                           geometry  ct\n0    333386.0      1020  POLYGON ((538844.452 5401988.173, 538791.190 5...   2\n1    333388.0      1210  POLYGON ((538940.617 5401357.192, 538900.718 5...  21\n2    334104.0      1010  POLYGON ((538657.001 5401587.709, 538599.773 5...   1\n3    334105.0      1210  POLYGON ((539119.085 5401857.078, 539173.783 5...  21\n4    334106.0      1210  POLYGON ((538963.364 5401353.648, 538952.689 5...  21\n5    513054.0      1020  POLYGON ((538776.253 5402396.809, 538811.508 5...   2\n6    511905.0      1010  POLYGON ((538766.889 5401359.859, 539114.235 5...   1\n7    512660.0      1010  POLYGON ((539122.924 5402090.288, 539134.580 5...   1\n8   1030069.0      1050  POLYGON ((538375.922 5401676.473, 538365.054 5...   5\n9   1031087.0      1210  POLYGON ((538814.320 5401357.902, 539142.634 5...  21\n10  1093378.0      1090  POLYGON ((538491.661 5400177.570, 538511.199 5...   9\n11  1093379.0      1010  POLYGON ((538746.810 5400483.771, 538734.941 5...   1\n12  1093380.0      1050  POLYGON ((538490.284 5400662.682, 538496.677 5...   5\n13  1093381.0      1020  POLYGON ((538768.957 5400884.197, 538735.711 5...   2\n14  1114582.0      1060  POLYGON ((538888.397 5400872.477, 538898.062 5...   6\n15  1115008.0      1040  POLYGON ((538769.006 5400609.582, 538723.259 5...   4\n16  1115106.0      1020  POLYGON ((539021.618 5400672.690, 539030.647 5...   2\n17  1115108.0      1020  POLYGON ((538610.623 5400673.428, 538590.545 5...   2\n18  1115109.0      1020  POLYGON ((538768.236 5400882.835, 538820.171 5...   2\n19  1116843.0      1240  POLYGON ((538446.658 5400959.995, 538445.552 5...  24\n20  1116846.0      1010  POLYGON ((538774.157 5400605.353, 538722.915 5...   1\n21  1119100.0      1020  POLYGON ((538523.806 5400877.293, 538485.333 5...   2\n22  1119101.0      1060  POLYGON ((538885.102 5400871.225, 538821.949 5...   6\n23  1119102.0      1060  POLYGON ((538921.392 5400884.111, 538903.323 5...   6\n24  1492894.0      1040  POLYGON ((538356.118 5400089.171, 538412.305 5...   4\n25  1498138.0      1040  POLYGON ((538606.436 5400593.986, 538606.446 5...   4\n26  1498139.0      1040  POLYGON ((538877.284 5400856.416, 538855.877 5...   4\n27  1562116.0      1020  POLYGON ((538422.344 5401641.427, 538378.657 5...   2\n28  2201537.0      1210  POLYGON ((538663.014 5400913.721, 538673.844 5...  21\n29  2201968.0      1020  POLYGON ((538586.934 5400757.539, 538591.586 5...   2\n30  2201979.0      1020  POLYGON ((538706.683 5400891.357, 538769.879 5...   2\n31  2202753.0      1010  POLYGON ((538610.953 5400829.021, 538622.156 5...   1\n32  2213647.0      1020  POLYGON ((538604.009 5400812.883, 538610.953 5...   2\n33  2220478.0      1010  POLYGON ((538538.068 5400600.747, 538544.498 5...   1\n34  2220819.0      1060  POLYGON ((538559.113 5400654.667, 538522.089 5...   6\n35  2220821.0      1060  POLYGON ((538943.844 5400826.118, 538856.445 5...   6\n36  2220824.0      1060  POLYGON ((538719.997 5400888.823, 538782.538 5...   6\n37  2230029.0      1010  POLYGON ((538729.568 5401366.168, 538724.188 5...   1\n38  2235477.0      1020  POLYGON ((539313.375 5402185.990, 539209.344 5...   2\n39  2235485.0      1020  POLYGON ((538748.435 5401361.481, 539103.145 5...   2\n40  2700060.0      1210  POLYGON ((539297.463 5401989.705, 539288.521 5...  21\n41  2710354.0      1020  POLYGON ((539209.344 5401934.545, 539313.375 5...   2\n42  3282870.0      1170  POLYGON ((538470.878 5400665.536, 538462.178 5...  17\n43  3292453.0      1210  POLYGON ((539073.696 5400954.560, 539038.852 5...  21\n44  3292460.0      1020  POLYGON ((538622.156 5400850.341, 538633.416 5...   2\n45  3625398.0      1020  POLYGON ((538948.750 5400715.235, 538972.781 5...   2\n46  3625399.0      1020  POLYGON ((538769.879 5401010.879, 538706.185 5...   2\n47  3798537.0      1210  POLYGON ((539247.012 5402248.699, 539270.409 5...  21\n48  3798539.0      1020  POLYGON ((538458.427 5401632.103, 538811.508 5...   2\n49  3834900.0      1170  POLYGON ((538964.008 5400816.413, 538956.734 5...  17\n50  3834910.0      1170  POLYGON ((538856.943 5400632.525, 538944.615 5...  17\n51  4375165.0      1210  POLYGON ((539013.274 5400867.592, 539045.687 5...  21\n52  4397511.0      1210  POLYGON ((538536.065 5400962.920, 538517.783 5...  21\n53  4397516.0      1060  POLYGON ((538440.897 5401107.970, 538552.751 5...   6\n54  4397519.0      1020  POLYGON ((538657.001 5401587.709, 538943.764 5...   2\n55  4399112.0      1040  POLYGON ((538204.012 5401652.954, 538230.812 5...   4\n56  4399114.0      1240  POLYGON ((538446.377 5400962.515, 538494.538 5...  24\n57  4399115.0      1210  POLYGON ((538567.482 5401078.946, 538615.272 5...  21\n58  4620993.0      1020  POLYGON ((538648.293 5400691.236, 538584.338 5...   2\n59  4664131.0      1040  POLYGON ((538557.138 5401610.031, 538909.679 5...   4","content_type":"text/plain"}}}],"key":"WlBAuxUSWf"}],"key":"AGcmxavqQA"},{"type":"block","kind":"notebook-content","data":{},"children":[{"type":"heading","depth":3,"position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"children":[{"type":"text","value":"Execute workflow","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"Vk4aQ4rpU9"}],"identifier":"execute-workflow","label":"Execute workflow","html_id":"execute-workflow-1","implicit":true,"key":"PCj4GaV8pz"},{"type":"paragraph","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"children":[{"type":"text","value":"classification data is added to the database","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"key":"ojEErc9TUX"}],"key":"RmicdJfCAU"}],"key":"y9HfdibFxj"},{"type":"block","kind":"notebook-code","data":{},"children":[{"type":"code","lang":"python","executable":true,"value":"execution_args = []\n\nfor i in range(len(parcels_to_process)):\n    \n    # Data Frame for current parcel\n    parcel_df = parcels_to_process[parcels_to_process.index == i]\n    parcel = parcel_df.iloc[0]\n    \n    bbox = BBox(parcel.geometry.bounds, crs=target_crs)    \n\n    execution_args.append({\n        add_data: {'bbox': bbox, 'time_interval': selected_date_interval_for_satellite_imagery},\n        add_parcel: {'data': parcel_df},\n        classification_to_db: {'parcel_id': int(parcel.ogd_id)}\n    })\n\n\nexecutor = EOExecutor(workflow, execution_args, save_logs=True)\nexecutor.run(workers=1, multiprocess=False)\n\nexecutor.make_report()","key":"QvtCVVKmUz"},{"type":"output","id":"oN3J-l1cNHJdwgxZfixwr","data":[{"output_type":"display_data","metadata":{},"data":{"application/vnd.jupyter.widget-view+json":{"content":"{\"model_id\":\"5643ccfeb4554cc1a06739dba2276f91\",\"version_major\":2,\"version_minor\":0}","content_type":"application/vnd.jupyter.widget-view+json"},"text/plain":{"content":"HBox(children=(FloatProgress(value=0.0, max=60.0), HTML(value='')))","content_type":"text/plain"}}},{"name":"stdout","output_type":"stream","text":"\n"}],"key":"EaUV0VVlmr"}],"key":"hDZGU5YWoZ"},{"type":"block","kind":"notebook-content","data":{},"children":[{"type":"heading","depth":2,"position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"children":[{"type":"text","value":"Show classification results","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"s7AcRlbV8J"}],"identifier":"show-classification-results","label":"Show classification results","html_id":"show-classification-results","implicit":true,"key":"iD4AvaoOsz"},{"type":"paragraph","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"children":[{"type":"text","value":"First 20 classified parcels within the defined bounding box","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"key":"nUkquuHLhC"}],"key":"PdHMUgR8VO"}],"key":"lrhej3yKti"},{"type":"block","kind":"notebook-code","data":{},"children":[{"type":"code","lang":"python","executable":true,"value":"\nwith psycopg2.connect(**db_conn_params) as db_conn:\n    with db_conn.cursor() as cur:\n\n        sql = '''\n            SELECT \n                parcel_id,\n                ref_date,\n                model_id,\n                prediction -\u003e 0,\n                prediction -\u003e 1,\n                prediction -\u003e 2\n            FROM classification_at\n            WHERE\n                model_id = {model_id} AND\n                ref_date = '2018-06-30'\n            LIMIT 20\n        '''.format(model_id=model_id)\n\n        cur.execute(sql)\n        result = cur.fetchall()","key":"XLo9szTNoi"},{"type":"output","id":"m9siwrq4KRLTll8tM2aw5","data":[],"key":"d7c9wrnolS"}],"key":"yRr7EpgQTk"},{"type":"block","kind":"notebook-code","data":{},"children":[{"type":"code","lang":"python","executable":true,"value":"pd.DataFrame(result, columns=[\"ogd_id\", \"ref_date\", \"model_id\", \"1st_classification\", \"2nd_classification\", \"3rd_classification\"])","key":"Q3dL5mEdEI"},{"type":"output","id":"fdg2_j6Webb6ji8YVsgIw","data":[{"output_type":"execute_result","execution_count":60,"metadata":{},"data":{"text/html":{"content":"\u003cdiv\u003e\n\u003cstyle scoped\u003e\n    .dataframe tbody tr th:only-of-type {\n        vertical-align: middle;\n    }\n\n    .dataframe tbody tr th {\n        vertical-align: top;\n    }\n\n    .dataframe thead th {\n        text-align: right;\n    }\n\u003c/style\u003e\n\u003ctable border=\"1\" class=\"dataframe\"\u003e\n  \u003cthead\u003e\n    \u003ctr style=\"text-align: right;\"\u003e\n      \u003cth\u003e\u003c/th\u003e\n      \u003cth\u003eogd_id\u003c/th\u003e\n      \u003cth\u003eref_date\u003c/th\u003e\n      \u003cth\u003emodel_id\u003c/th\u003e\n      \u003cth\u003e1st_classification\u003c/th\u003e\n      \u003cth\u003e2nd_classification\u003c/th\u003e\n      \u003cth\u003e3rd_classification\u003c/th\u003e\n    \u003c/tr\u003e\n  \u003c/thead\u003e\n  \u003ctbody\u003e\n    \u003ctr\u003e\n      \u003cth\u003e0\u003c/th\u003e\n      \u003ctd\u003e333386\u003c/td\u003e\n      \u003ctd\u003e2018-06-30\u003c/td\u003e\n      \u003ctd\u003e12\u003c/td\u003e\n      \u003ctd\u003e{'crop_id': 1020, 'probability': 0.75}\u003c/td\u003e\n      \u003ctd\u003e{'crop_id': 1090, 'probability': 0.13}\u003c/td\u003e\n      \u003ctd\u003e{'crop_id': 1010, 'probability': 0.09}\u003c/td\u003e\n    \u003c/tr\u003e\n    \u003ctr\u003e\n      \u003cth\u003e1\u003c/th\u003e\n      \u003ctd\u003e333388\u003c/td\u003e\n      \u003ctd\u003e2018-06-30\u003c/td\u003e\n      \u003ctd\u003e12\u003c/td\u003e\n      \u003ctd\u003e{'crop_id': 1020, 'probability': 0.69}\u003c/td\u003e\n      \u003ctd\u003e{'crop_id': 1060, 'probability': 0.15}\u003c/td\u003e\n      \u003ctd\u003e{'crop_id': 1090, 'probability': 0.06}\u003c/td\u003e\n    \u003c/tr\u003e\n    \u003ctr\u003e\n      \u003cth\u003e2\u003c/th\u003e\n      \u003ctd\u003e334104\u003c/td\u003e\n      \u003ctd\u003e2018-06-30\u003c/td\u003e\n      \u003ctd\u003e12\u003c/td\u003e\n      \u003ctd\u003e{'crop_id': 1090, 'probability': 0.87}\u003c/td\u003e\n      \u003ctd\u003e{'crop_id': 1010, 'probability': 0.11}\u003c/td\u003e\n      \u003ctd\u003e{'crop_id': 1040, 'probability': 0.02}\u003c/td\u003e\n    \u003c/tr\u003e\n    \u003ctr\u003e\n      \u003cth\u003e3\u003c/th\u003e\n      \u003ctd\u003e334105\u003c/td\u003e\n      \u003ctd\u003e2018-06-30\u003c/td\u003e\n      \u003ctd\u003e12\u003c/td\u003e\n      \u003ctd\u003e{'crop_id': 1040, 'probability': 0.41}\u003c/td\u003e\n      \u003ctd\u003e{'crop_id': 1020, 'probability': 0.25}\u003c/td\u003e\n      \u003ctd\u003e{'crop_id': 1090, 'probability': 0.2}\u003c/td\u003e\n    \u003c/tr\u003e\n    \u003ctr\u003e\n      \u003cth\u003e4\u003c/th\u003e\n      \u003ctd\u003e334106\u003c/td\u003e\n      \u003ctd\u003e2018-06-30\u003c/td\u003e\n      \u003ctd\u003e12\u003c/td\u003e\n      \u003ctd\u003e{'crop_id': 1060, 'probability': 0.5}\u003c/td\u003e\n      \u003ctd\u003e{'crop_id': 1020, 'probability': 0.39}\u003c/td\u003e\n      \u003ctd\u003e{'crop_id': 1090, 'probability': 0.08}\u003c/td\u003e\n    \u003c/tr\u003e\n    \u003ctr\u003e\n      \u003cth\u003e5\u003c/th\u003e\n      \u003ctd\u003e513054\u003c/td\u003e\n      \u003ctd\u003e2018-06-30\u003c/td\u003e\n      \u003ctd\u003e12\u003c/td\u003e\n      \u003ctd\u003e{'crop_id': 1020, 'probability': 0.98}\u003c/td\u003e\n      \u003ctd\u003e{'crop_id': 1060, 'probability': 0.01}\u003c/td\u003e\n      \u003ctd\u003e{'crop_id': 1040, 'probability': 0.01}\u003c/td\u003e\n    \u003c/tr\u003e\n    \u003ctr\u003e\n      \u003cth\u003e6\u003c/th\u003e\n      \u003ctd\u003e511905\u003c/td\u003e\n      \u003ctd\u003e2018-06-30\u003c/td\u003e\n      \u003ctd\u003e12\u003c/td\u003e\n      \u003ctd\u003e{'crop_id': 1100, 'probability': 0}\u003c/td\u003e\n      \u003ctd\u003e{'crop_id': 1090, 'probability': 0}\u003c/td\u003e\n      \u003ctd\u003e{'crop_id': 1070, 'probability': 0}\u003c/td\u003e\n    \u003c/tr\u003e\n    \u003ctr\u003e\n      \u003cth\u003e7\u003c/th\u003e\n      \u003ctd\u003e512660\u003c/td\u003e\n      \u003ctd\u003e2018-06-30\u003c/td\u003e\n      \u003ctd\u003e12\u003c/td\u003e\n      \u003ctd\u003e{'crop_id': 1090, 'probability': 0.52}\u003c/td\u003e\n      \u003ctd\u003e{'crop_id': 1010, 'probability': 0.43}\u003c/td\u003e\n      \u003ctd\u003e{'crop_id': 1020, 'probability': 0.04}\u003c/td\u003e\n    \u003c/tr\u003e\n    \u003ctr\u003e\n      \u003cth\u003e8\u003c/th\u003e\n      \u003ctd\u003e1030069\u003c/td\u003e\n      \u003ctd\u003e2018-06-30\u003c/td\u003e\n      \u003ctd\u003e12\u003c/td\u003e\n      \u003ctd\u003e{'crop_id': 1100, 'probability': 0}\u003c/td\u003e\n      \u003ctd\u003e{'crop_id': 1090, 'probability': 0}\u003c/td\u003e\n      \u003ctd\u003e{'crop_id': 1070, 'probability': 0}\u003c/td\u003e\n    \u003c/tr\u003e\n    \u003ctr\u003e\n      \u003cth\u003e9\u003c/th\u003e\n      \u003ctd\u003e1031087\u003c/td\u003e\n      \u003ctd\u003e2018-06-30\u003c/td\u003e\n      \u003ctd\u003e12\u003c/td\u003e\n      \u003ctd\u003e{'crop_id': 1090, 'probability': 0.44}\u003c/td\u003e\n      \u003ctd\u003e{'crop_id': 1010, 'probability': 0.36}\u003c/td\u003e\n      \u003ctd\u003e{'crop_id': 1040, 'probability': 0.1}\u003c/td\u003e\n    \u003c/tr\u003e\n    \u003ctr\u003e\n      \u003cth\u003e10\u003c/th\u003e\n      \u003ctd\u003e1093378\u003c/td\u003e\n      \u003ctd\u003e2018-06-30\u003c/td\u003e\n      \u003ctd\u003e12\u003c/td\u003e\n      \u003ctd\u003e{'crop_id': 1090, 'probability': 0.61}\u003c/td\u003e\n      \u003ctd\u003e{'crop_id': 1010, 'probability': 0.32}\u003c/td\u003e\n      \u003ctd\u003e{'crop_id': 1040, 'probability': 0.07}\u003c/td\u003e\n    \u003c/tr\u003e\n    \u003ctr\u003e\n      \u003cth\u003e11\u003c/th\u003e\n      \u003ctd\u003e1093379\u003c/td\u003e\n      \u003ctd\u003e2018-06-30\u003c/td\u003e\n      \u003ctd\u003e12\u003c/td\u003e\n      \u003ctd\u003e{'crop_id': 1010, 'probability': 0.92}\u003c/td\u003e\n      \u003ctd\u003e{'crop_id': 1020, 'probability': 0.06}\u003c/td\u003e\n      \u003ctd\u003e{'crop_id': 1090, 'probability': 0.02}\u003c/td\u003e\n    \u003c/tr\u003e\n    \u003ctr\u003e\n      \u003cth\u003e12\u003c/th\u003e\n      \u003ctd\u003e1093380\u003c/td\u003e\n      \u003ctd\u003e2018-06-30\u003c/td\u003e\n      \u003ctd\u003e12\u003c/td\u003e\n      \u003ctd\u003e{'crop_id': 1060, 'probability': 0.61}\u003c/td\u003e\n      \u003ctd\u003e{'crop_id': 1010, 'probability': 0.2}\u003c/td\u003e\n      \u003ctd\u003e{'crop_id': 1020, 'probability': 0.19}\u003c/td\u003e\n    \u003c/tr\u003e\n    \u003ctr\u003e\n      \u003cth\u003e13\u003c/th\u003e\n      \u003ctd\u003e1093381\u003c/td\u003e\n      \u003ctd\u003e2018-06-30\u003c/td\u003e\n      \u003ctd\u003e12\u003c/td\u003e\n      \u003ctd\u003e{'crop_id': 1020, 'probability': 0.91}\u003c/td\u003e\n      \u003ctd\u003e{'crop_id': 1010, 'probability': 0.09}\u003c/td\u003e\n      \u003ctd\u003e{'crop_id': 1060, 'probability': 0.0}\u003c/td\u003e\n    \u003c/tr\u003e\n    \u003ctr\u003e\n      \u003cth\u003e14\u003c/th\u003e\n      \u003ctd\u003e1114582\u003c/td\u003e\n      \u003ctd\u003e2018-06-30\u003c/td\u003e\n      \u003ctd\u003e12\u003c/td\u003e\n      \u003ctd\u003e{'crop_id': 1060, 'probability': 0.96}\u003c/td\u003e\n      \u003ctd\u003e{'crop_id': 1020, 'probability': 0.01}\u003c/td\u003e\n      \u003ctd\u003e{'crop_id': 1090, 'probability': 0.01}\u003c/td\u003e\n    \u003c/tr\u003e\n    \u003ctr\u003e\n      \u003cth\u003e15\u003c/th\u003e\n      \u003ctd\u003e1115008\u003c/td\u003e\n      \u003ctd\u003e2018-06-30\u003c/td\u003e\n      \u003ctd\u003e12\u003c/td\u003e\n      \u003ctd\u003e{'crop_id': 1040, 'probability': 0.99}\u003c/td\u003e\n      \u003ctd\u003e{'crop_id': 1010, 'probability': 0.0}\u003c/td\u003e\n      \u003ctd\u003e{'crop_id': 1090, 'probability': 0.0}\u003c/td\u003e\n    \u003c/tr\u003e\n    \u003ctr\u003e\n      \u003cth\u003e16\u003c/th\u003e\n      \u003ctd\u003e1115106\u003c/td\u003e\n      \u003ctd\u003e2018-06-30\u003c/td\u003e\n      \u003ctd\u003e12\u003c/td\u003e\n      \u003ctd\u003e{'crop_id': 1020, 'probability': 0.95}\u003c/td\u003e\n      \u003ctd\u003e{'crop_id': 1010, 'probability': 0.04}\u003c/td\u003e\n      \u003ctd\u003e{'crop_id': 1040, 'probability': 0.02}\u003c/td\u003e\n    \u003c/tr\u003e\n    \u003ctr\u003e\n      \u003cth\u003e17\u003c/th\u003e\n      \u003ctd\u003e1115108\u003c/td\u003e\n      \u003ctd\u003e2018-06-30\u003c/td\u003e\n      \u003ctd\u003e12\u003c/td\u003e\n      \u003ctd\u003e{'crop_id': 1020, 'probability': 0.75}\u003c/td\u003e\n      \u003ctd\u003e{'crop_id': 1060, 'probability': 0.25}\u003c/td\u003e\n      \u003ctd\u003e{'crop_id': 1010, 'probability': 0.0}\u003c/td\u003e\n    \u003c/tr\u003e\n    \u003ctr\u003e\n      \u003cth\u003e18\u003c/th\u003e\n      \u003ctd\u003e1115109\u003c/td\u003e\n      \u003ctd\u003e2018-06-30\u003c/td\u003e\n      \u003ctd\u003e12\u003c/td\u003e\n      \u003ctd\u003e{'crop_id': 1020, 'probability': 1.0}\u003c/td\u003e\n      \u003ctd\u003e{'crop_id': 1100, 'probability': 0.0}\u003c/td\u003e\n      \u003ctd\u003e{'crop_id': 1090, 'probability': 0.0}\u003c/td\u003e\n    \u003c/tr\u003e\n    \u003ctr\u003e\n      \u003cth\u003e19\u003c/th\u003e\n      \u003ctd\u003e1116846\u003c/td\u003e\n      \u003ctd\u003e2018-06-30\u003c/td\u003e\n      \u003ctd\u003e12\u003c/td\u003e\n      \u003ctd\u003e{'crop_id': 1100, 'probability': 0}\u003c/td\u003e\n      \u003ctd\u003e{'crop_id': 1090, 'probability': 0}\u003c/td\u003e\n      \u003ctd\u003e{'crop_id': 1070, 'probability': 0}\u003c/td\u003e\n    \u003c/tr\u003e\n  \u003c/tbody\u003e\n\u003c/table\u003e\n\u003c/div\u003e","content_type":"text/html"},"text/plain":{"content":"     ogd_id    ref_date  model_id                      1st_classification  \\\n0    333386  2018-06-30        12  {'crop_id': 1020, 'probability': 0.75}   \n1    333388  2018-06-30        12  {'crop_id': 1020, 'probability': 0.69}   \n2    334104  2018-06-30        12  {'crop_id': 1090, 'probability': 0.87}   \n3    334105  2018-06-30        12  {'crop_id': 1040, 'probability': 0.41}   \n4    334106  2018-06-30        12   {'crop_id': 1060, 'probability': 0.5}   \n5    513054  2018-06-30        12  {'crop_id': 1020, 'probability': 0.98}   \n6    511905  2018-06-30        12     {'crop_id': 1100, 'probability': 0}   \n7    512660  2018-06-30        12  {'crop_id': 1090, 'probability': 0.52}   \n8   1030069  2018-06-30        12     {'crop_id': 1100, 'probability': 0}   \n9   1031087  2018-06-30        12  {'crop_id': 1090, 'probability': 0.44}   \n10  1093378  2018-06-30        12  {'crop_id': 1090, 'probability': 0.61}   \n11  1093379  2018-06-30        12  {'crop_id': 1010, 'probability': 0.92}   \n12  1093380  2018-06-30        12  {'crop_id': 1060, 'probability': 0.61}   \n13  1093381  2018-06-30        12  {'crop_id': 1020, 'probability': 0.91}   \n14  1114582  2018-06-30        12  {'crop_id': 1060, 'probability': 0.96}   \n15  1115008  2018-06-30        12  {'crop_id': 1040, 'probability': 0.99}   \n16  1115106  2018-06-30        12  {'crop_id': 1020, 'probability': 0.95}   \n17  1115108  2018-06-30        12  {'crop_id': 1020, 'probability': 0.75}   \n18  1115109  2018-06-30        12   {'crop_id': 1020, 'probability': 1.0}   \n19  1116846  2018-06-30        12     {'crop_id': 1100, 'probability': 0}   \n\n                        2nd_classification  \\\n0   {'crop_id': 1090, 'probability': 0.13}   \n1   {'crop_id': 1060, 'probability': 0.15}   \n2   {'crop_id': 1010, 'probability': 0.11}   \n3   {'crop_id': 1020, 'probability': 0.25}   \n4   {'crop_id': 1020, 'probability': 0.39}   \n5   {'crop_id': 1060, 'probability': 0.01}   \n6      {'crop_id': 1090, 'probability': 0}   \n7   {'crop_id': 1010, 'probability': 0.43}   \n8      {'crop_id': 1090, 'probability': 0}   \n9   {'crop_id': 1010, 'probability': 0.36}   \n10  {'crop_id': 1010, 'probability': 0.32}   \n11  {'crop_id': 1020, 'probability': 0.06}   \n12   {'crop_id': 1010, 'probability': 0.2}   \n13  {'crop_id': 1010, 'probability': 0.09}   \n14  {'crop_id': 1020, 'probability': 0.01}   \n15   {'crop_id': 1010, 'probability': 0.0}   \n16  {'crop_id': 1010, 'probability': 0.04}   \n17  {'crop_id': 1060, 'probability': 0.25}   \n18   {'crop_id': 1100, 'probability': 0.0}   \n19     {'crop_id': 1090, 'probability': 0}   \n\n                        3rd_classification  \n0   {'crop_id': 1010, 'probability': 0.09}  \n1   {'crop_id': 1090, 'probability': 0.06}  \n2   {'crop_id': 1040, 'probability': 0.02}  \n3    {'crop_id': 1090, 'probability': 0.2}  \n4   {'crop_id': 1090, 'probability': 0.08}  \n5   {'crop_id': 1040, 'probability': 0.01}  \n6      {'crop_id': 1070, 'probability': 0}  \n7   {'crop_id': 1020, 'probability': 0.04}  \n8      {'crop_id': 1070, 'probability': 0}  \n9    {'crop_id': 1040, 'probability': 0.1}  \n10  {'crop_id': 1040, 'probability': 0.07}  \n11  {'crop_id': 1090, 'probability': 0.02}  \n12  {'crop_id': 1020, 'probability': 0.19}  \n13   {'crop_id': 1060, 'probability': 0.0}  \n14  {'crop_id': 1090, 'probability': 0.01}  \n15   {'crop_id': 1090, 'probability': 0.0}  \n16  {'crop_id': 1040, 'probability': 0.02}  \n17   {'crop_id': 1010, 'probability': 0.0}  \n18   {'crop_id': 1090, 'probability': 0.0}  \n19     {'crop_id': 1070, 'probability': 0}  ","content_type":"text/plain"}}}],"key":"DR5iUi2clZ"}],"key":"bfPIYMlEIK"}],"key":"pfmvycyvBB"},"references":{"cite":{"order":[],"data":{}}},"footer":{"navigation":{"prev":{"title":"South Africa Crop Type Classification on Euro Data Cube (EDC)","url":"/external-notebooks/eurodatacube/notebooks/notebooks/contributions/edc-notebook-lstm","group":"Contributions"},"next":{"title":"Crop-classification using Sentinel-2 time-series","url":"/external-notebooks/eurodatacube/notebooks/notebooks/contributions/eurocrops-crop-classification-example","group":"Contributions"}}},"domain":"http://localhost:3000"},"project":{"github":"https://github.com/eoxhub-workspaces/documentation/","id":"5aa0318b-5bc1-41e2-b1d4-053e8b61961b","exports":[],"bibliography":[],"title":"Location for eodashboard notebooks","index":"readme","pages":[{"title":"External Notebooks","level":1},{"title":"Eurodatacube","level":2},{"title":"Notebooks","level":3},{"slug":"external-notebooks.eurodatacube.notebooks.readme","title":"Jupyter notebooks","description":"","date":"","thumbnail":"","thumbnailOptimized":"","banner":"","bannerOptimized":"","tags":[],"level":4},{"title":"Notebooks","level":4},{"slug":"external-notebooks.eurodatacube.notebooks.notebooks.readme","title":"Euro Data Cube Notebooks","description":"","date":"","thumbnail":"","thumbnailOptimized":"","banner":"","bannerOptimized":"","tags":[],"level":5},{"title":"Contributions","level":5},{"slug":"external-notebooks.eurodatacube.notebooks.notebooks.contributions.aireo-pilot-dataset-ai4arctic-sea-ice","title":"Introduction","description":"","date":"","thumbnail":"","thumbnailOptimized":"","banner":"","bannerOptimized":"","tags":[],"level":6},{"slug":"external-notebooks.eurodatacube.notebooks.notebooks.contributions.aireo-pilot-dataset-biomass-forest-observation-sys","title":"AIREO pilot dataset - Biomass (Forest Observation System)","description":"","date":"","thumbnail":"","thumbnailOptimized":"","banner":"","bannerOptimized":"","tags":[],"level":6},{"slug":"external-notebooks.eurodatacube.notebooks.notebooks.contributions.aireo-pilot-dataset-cap","title":"Introduction","description":"","date":"","thumbnail":"","thumbnailOptimized":"","banner":"","bannerOptimized":"","tags":[],"level":6},{"slug":"external-notebooks.eurodatacube.notebooks.notebooks.contributions.aireo-pilot-dataset-spacenet7","title":"Introduction","description":"","date":"","thumbnail":"","thumbnailOptimized":"","banner":"","bannerOptimized":"","tags":[],"level":6},{"slug":"external-notebooks.eurodatacube.notebooks.notebooks.contributions.aot-covid19","title":"Aerosol Optical Thickness (AOT) Anomaly Detection Using Sentinel-2","description":"","date":"","thumbnail":"","thumbnailOptimized":"","banner":"","bannerOptimized":"","tags":[],"level":6},{"slug":"external-notebooks.eurodatacube.notebooks.notebooks.contributions.batch-zarr-output","title":"Generating Zarr data cubes with Sentinel Hub Batch API","description":"","date":"","thumbnail":"/notebooks_test/build/68dffbf744fa42f4bf3d35e55684984e.png","thumbnailOptimized":"","banner":"","bannerOptimized":"","tags":[],"level":6},{"slug":"external-notebooks.eurodatacube.notebooks.notebooks.contributions.client-side-processing-using-mass-sh","title":"Important notes","description":"","date":"","thumbnail":"","thumbnailOptimized":"","banner":"","bannerOptimized":"","tags":[],"level":6},{"slug":"external-notebooks.eurodatacube.notebooks.notebooks.contributions.cmems-data-download","title":"Cmems Data Download","description":"","date":"","thumbnail":"","thumbnailOptimized":"","banner":"","bannerOptimized":"","tags":[],"level":6},{"slug":"external-notebooks.eurodatacube.notebooks.notebooks.contributions.detect-trucks-sentinel2","title":"Detect Trucks using Sentinel-2 data","description":"","date":"","thumbnail":"","thumbnailOptimized":"","banner":"","bannerOptimized":"","tags":[],"level":6},{"slug":"external-notebooks.eurodatacube.notebooks.notebooks.contributions.drought-monitoring","title":"Drought impact monitoring platform","description":"","date":"","thumbnail":"/notebooks_test/build/ad5c19782b006f72352ae57794305840.png","thumbnailOptimized":"","banner":"","bannerOptimized":"","tags":[],"level":6},{"slug":"external-notebooks.eurodatacube.notebooks.notebooks.contributions.edc-africa-cube-africa-custom-contest","title":"Custom Script Contest – Urban Growth in Africa","description":"","date":"","thumbnail":"/notebooks_test/build/e9275f3fe80a704e2f5aa1ec1220e48a.jpeg","thumbnailOptimized":"","banner":"","bannerOptimized":"","tags":[],"level":6},{"slug":"external-notebooks.eurodatacube.notebooks.notebooks.contributions.edc-byoc-tutorial","title":"How to bring your own data to EDC: Using Sentinel Hub Python package","description":"","date":"","thumbnail":"","thumbnailOptimized":"","banner":"","bannerOptimized":"","tags":[],"level":6},{"slug":"external-notebooks.eurodatacube.notebooks.notebooks.contributions.edc-demo-phi-week-v2","title":"xcube-gen and xcube-geodb Hands-On Workshop Φ-Week 2020","description":"","date":"","thumbnail":"","thumbnailOptimized":"","banner":"","bannerOptimized":"","tags":[],"level":6},{"slug":"external-notebooks.eurodatacube.notebooks.notebooks.contributions.edc-geodb-4-eurocrops-demo","title":"Demonstration of Eurocrops data use in geoDB","description":"","date":"","thumbnail":"","thumbnailOptimized":"","banner":"","bannerOptimized":"","tags":[],"level":6},{"slug":"external-notebooks.eurodatacube.notebooks.notebooks.contributions.edc-notebook-lstm","title":"South Africa Crop Type Classification on Euro Data Cube (EDC)","description":"","date":"","thumbnail":"","thumbnailOptimized":"","banner":"","bannerOptimized":"","tags":[],"level":6},{"slug":"external-notebooks.eurodatacube.notebooks.notebooks.contributions.edc-usecase-lpis-crop-type-classification","title":"Important notes","description":"","date":"","thumbnail":"","thumbnailOptimized":"","banner":"","bannerOptimized":"","tags":[],"level":6},{"slug":"external-notebooks.eurodatacube.notebooks.notebooks.contributions.eurocrops-crop-classification-example","title":"Crop-classification using Sentinel-2 time-series","description":"","date":"","thumbnail":"","thumbnailOptimized":"","banner":"","bannerOptimized":"","tags":[],"level":6},{"slug":"external-notebooks.eurodatacube.notebooks.notebooks.contributions.ghsl-urban-delineation","title":"\u003cb\u003eUrban delineation\u003cb\u003e","description":"","date":"","thumbnail":"/notebooks_test/build/7bbf545a5eae1d9ebdb91ae42b261063.png","thumbnailOptimized":"","banner":"","bannerOptimized":"","tags":[],"level":6},{"slug":"external-notebooks.eurodatacube.notebooks.notebooks.contributions.globalearthmonitor-example","title":"Pre-requisites","description":"","date":"","thumbnail":"/notebooks_test/build/205c1ded6bd59771975a9fbd3753fd3b.png","thumbnailOptimized":"","banner":"","bannerOptimized":"","tags":[],"level":6},{"slug":"external-notebooks.eurodatacube.notebooks.notebooks.contributions.gpu-support-eoxhub","title":"GPU-Support on EOxHub","description":"","date":"","thumbnail":"","thumbnailOptimized":"","banner":"","bannerOptimized":"","tags":[],"level":6},{"slug":"external-notebooks.eurodatacube.notebooks.notebooks.contributions.gran-chaco-phiweek","title":"ESA EO \\phi- week 2020","description":"","date":"","thumbnail":"/notebooks_test/build/80cee7db6cdc7002ceedda5689f889fa.jpeg","thumbnailOptimized":"","banner":"","bannerOptimized":"","tags":[],"level":6},{"slug":"external-notebooks.eurodatacube.notebooks.notebooks.contributions.howtolulc-batch-updated-210621","title":"How To: Land-Use-Land-Cover Prediction for Slovenia - using the Batch Processing API","description":"","date":"","thumbnail":"","thumbnailOptimized":"","banner":"","bannerOptimized":"","tags":[],"level":6},{"slug":"external-notebooks.eurodatacube.notebooks.notebooks.contributions.lpis-lulc-slo","title":"LPIS Use Case for Land Use / Land Cover Classification","description":"","date":"","thumbnail":"","thumbnailOptimized":"","banner":"","bannerOptimized":"","tags":[],"level":6},{"slug":"external-notebooks.eurodatacube.notebooks.notebooks.contributions.lps2022-leverage-euro-data-cube-services","title":"Living Planet Symposium 2022 Training Session","description":"","date":"","thumbnail":"","thumbnailOptimized":"","banner":"","bannerOptimized":"","tags":[],"level":6},{"slug":"external-notebooks.eurodatacube.notebooks.notebooks.contributions.no2-analysis-covid19-lockdowns","title":"Impact of Covid19 induced lockdown on NO2 levels","description":"","date":"","thumbnail":"","thumbnailOptimized":"","banner":"","bannerOptimized":"","tags":[],"level":6},{"slug":"external-notebooks.eurodatacube.notebooks.notebooks.contributions.no2-so2-trend-veda-api-igarss-2023","title":"Using the NASA VEDA EOAPI","description":"","date":"","thumbnail":"","thumbnailOptimized":"","banner":"","bannerOptimized":"","tags":[],"level":6},{"slug":"external-notebooks.eurodatacube.notebooks.notebooks.contributions.ogc-edc","title":"Important notes","description":"","date":"","thumbnail":"","thumbnailOptimized":"","banner":"","bannerOptimized":"","tags":[],"level":6},{"slug":"external-notebooks.eurodatacube.notebooks.notebooks.contributions.openeo-client-demo","title":"openEO Client Demo","description":"","date":"","thumbnail":"","thumbnailOptimized":"","banner":"","bannerOptimized":"","tags":[],"level":6},{"slug":"external-notebooks.eurodatacube.notebooks.notebooks.contributions.race-finishedgoodsinventory-inidcator","title":"Finished Goods Inventory indicator for RACE","description":"","date":"","thumbnail":"","thumbnailOptimized":"","banner":"","bannerOptimized":"","tags":[],"level":6},{"slug":"external-notebooks.eurodatacube.notebooks.notebooks.contributions.third-party-planetscope","title":"Third Party Data Import - PlanetScope","description":"","date":"","thumbnail":"","thumbnailOptimized":"","banner":"","bannerOptimized":"","tags":[],"level":6},{"slug":"external-notebooks.eurodatacube.notebooks.notebooks.contributions.xcube-access-datasets","title":"Using xcube to access non-commercial and commercial data sets","description":"","date":"","thumbnail":"","thumbnailOptimized":"","banner":"","bannerOptimized":"","tags":[],"level":6},{"slug":"external-notebooks.eurodatacube.notebooks.notebooks.contributions.xcube-viewer-as-a-service-in-edc1","title":"Visualizing data with xcube viewer in EuroDataCube","description":"","date":"","thumbnail":"","thumbnailOptimized":"","banner":"","bannerOptimized":"","tags":[],"level":6},{"slug":"external-notebooks.eurodatacube.notebooks.notebooks.contributions.dapa.dapa-evaluation-workshop","title":"DAPA Evaluation Workshop: Introduction \u0026 Documentation","description":"","date":"","thumbnail":"","thumbnailOptimized":"","banner":"","bannerOptimized":"","tags":[],"level":6},{"slug":"external-notebooks.eurodatacube.notebooks.notebooks.contributions.dapa.dapa-tutorial-1-cube-sentinel-2","title":"DAPA Tutorial #1: Cube - Sentinel-2","description":"","date":"","thumbnail":"","thumbnailOptimized":"","banner":"","bannerOptimized":"","tags":[],"level":6},{"slug":"external-notebooks.eurodatacube.notebooks.notebooks.contributions.dapa.dapa-tutorial-2-area-sentinel-2","title":"DAPA Tutorial #2: Area - Sentinel-2","description":"","date":"","thumbnail":"","thumbnailOptimized":"","banner":"","bannerOptimized":"","tags":[],"level":6},{"slug":"external-notebooks.eurodatacube.notebooks.notebooks.contributions.dapa.dapa-tutorial-3-timeseries-sentinel-2","title":"DAPA Tutorial #3: Timeseries - Sentinel-2","description":"","date":"","thumbnail":"","thumbnailOptimized":"","banner":"","bannerOptimized":"","tags":[],"level":6},{"slug":"external-notebooks.eurodatacube.notebooks.notebooks.contributions.dapa.dapa-tutorial-4-value-sentinel-2","title":"DAPA Tutorial #4: Value - Sentinel-2","description":"","date":"","thumbnail":"","thumbnailOptimized":"","banner":"","bannerOptimized":"","tags":[],"level":6},{"slug":"external-notebooks.eurodatacube.notebooks.notebooks.contributions.dapa.dapa-tutorial-5-dem","title":"DAPA Tutorial #5: DEM","description":"","date":"","thumbnail":"","thumbnailOptimized":"","banner":"","bannerOptimized":"","tags":[],"level":6},{"slug":"external-notebooks.eurodatacube.notebooks.notebooks.contributions.fairicube.fairicube-data-access-demonstration","title":"EDC Sentinel Hub - data access using xcube","description":"","date":"","thumbnail":"","thumbnailOptimized":"","banner":"","bannerOptimized":"","tags":[],"level":6},{"slug":"external-notebooks.eurodatacube.notebooks.notebooks.contributions.igarss2022.igarss-22-australian-bushfires","title":"Australian Bushfires","description":"","date":"","thumbnail":"/notebooks_test/build/ab194b4f8c40a2b9d64d8a85e37ce1fd.png","thumbnailOptimized":"","banner":"","bannerOptimized":"","tags":["IGARSS-22","EO Dashboard"],"level":6},{"slug":"external-notebooks.eurodatacube.notebooks.notebooks.contributions.igarss2022.igarss-22-data-access","title":"Data Access","description":"","date":"","thumbnail":"","thumbnailOptimized":"","banner":"","bannerOptimized":"","tags":[],"level":6},{"slug":"external-notebooks.eurodatacube.notebooks.notebooks.contributions.igarss2022.igarss-22-detect-trucks-sentinel2","title":"Truck Detection Exercise","description":"","date":"","thumbnail":"","thumbnailOptimized":"","banner":"","bannerOptimized":"","tags":[],"level":6},{"slug":"external-notebooks.eurodatacube.notebooks.notebooks.contributions.igarss2022.igarss-22-lockdown-in-venice","title":"Environmental Impacts of Lockdown in Venice, Italy during 2020","description":"","date":"","thumbnail":"","thumbnailOptimized":"","banner":"","bannerOptimized":"","tags":[],"level":6},{"slug":"external-notebooks.eurodatacube.notebooks.notebooks.contributions.igarss2022.igarss-22-nasa-api-lockdown-in-venice","title":"Lockdown in Venice","description":"","date":"","thumbnail":"","thumbnailOptimized":"","banner":"","bannerOptimized":"","tags":[],"level":6},{"slug":"external-notebooks.eurodatacube.notebooks.notebooks.contributions.igarss2022.igarss-22-no2-timeseries-analysis","title":"NO2 timeseries analysis","description":"","date":"","thumbnail":"","thumbnailOptimized":"","banner":"","bannerOptimized":"","tags":[],"level":6},{"slug":"external-notebooks.eurodatacube.notebooks.notebooks.contributions.igarss2022.igarss-22-timeseries-stac-api-single-vs-multi","title":"Time series using STAC API statistics endpoints","description":"","date":"","thumbnail":"","thumbnailOptimized":"","banner":"","bannerOptimized":"","tags":[],"level":6},{"title":"Curated","level":5},{"slug":"external-notebooks.eurodatacube.notebooks.notebooks.curated.access-iacs-data","title":"How to access IACS Spatial Data","description":"","date":"","thumbnail":"","thumbnailOptimized":"","banner":"","bannerOptimized":"","tags":[],"level":6},{"slug":"external-notebooks.eurodatacube.notebooks.notebooks.curated.edc-access-cci-data","title":"Access CCI data with xcube","description":"","date":"","thumbnail":"","thumbnailOptimized":"","banner":"","bannerOptimized":"","tags":[],"level":6},{"slug":"external-notebooks.eurodatacube.notebooks.notebooks.curated.edc-first-steps","title":"First steps on the Euro Data Cube platform","description":"","date":"","thumbnail":"","thumbnailOptimized":"","banner":"","bannerOptimized":"","tags":[],"level":6},{"slug":"external-notebooks.eurodatacube.notebooks.notebooks.curated.edc-geodb-1-manage-datasets-v11","title":"Manage Collections in your GeoDB","description":"","date":"","thumbnail":"","thumbnailOptimized":"","banner":"","bannerOptimized":"","tags":[],"level":6},{"slug":"external-notebooks.eurodatacube.notebooks.notebooks.curated.edc-geodb-2-explore-datasets-2","title":"Exploring Data","description":"","date":"","thumbnail":"","thumbnailOptimized":"","banner":"","bannerOptimized":"","tags":[],"level":6},{"slug":"external-notebooks.eurodatacube.notebooks.notebooks.curated.edc-geodb-3-share-datasets1","title":"Sharing Data","description":"","date":"","thumbnail":"","thumbnailOptimized":"","banner":"","bannerOptimized":"","tags":[],"level":6},{"slug":"external-notebooks.eurodatacube.notebooks.notebooks.curated.edc-geodb-access-urban-atlas-data-v1","title":"[xcube-geodb] How to accesss EEA Urban Atlas Data","description":"","date":"","thumbnail":"","thumbnailOptimized":"","banner":"","bannerOptimized":"","tags":[],"level":6},{"slug":"external-notebooks.eurodatacube.notebooks.notebooks.curated.edc-sentinel-hub-data-access","title":"EDC Sentinel Hub - data access using xcube","description":"","date":"","thumbnail":"","thumbnailOptimized":"","banner":"","bannerOptimized":"","tags":[],"level":6},{"slug":"external-notebooks.eurodatacube.notebooks.notebooks.curated.edc-sentinelhub-datafusion-basic","title":"EDC Sentinel Hub: Data Fusion","description":"","date":"","thumbnail":"","thumbnailOptimized":"","banner":"","bannerOptimized":"","tags":[],"level":6},{"slug":"external-notebooks.eurodatacube.notebooks.notebooks.curated.edc-sentinelhub-datafusion-ndvi","title":"EDC Sentinel Hub: Data Fusion","description":"","date":"","thumbnail":"","thumbnailOptimized":"","banner":"","bannerOptimized":"","tags":[],"level":6},{"slug":"external-notebooks.eurodatacube.notebooks.notebooks.curated.edc-sentinel-hub-datasets","title":"EDC Sentinel Hub - using xcube to access different data sets in Sentinel Hub","description":"","date":"","thumbnail":"","thumbnailOptimized":"","banner":"","bannerOptimized":"","tags":[],"level":6},{"slug":"external-notebooks.eurodatacube.notebooks.notebooks.curated.edc-sentinel-hub-setup","title":"Setup for EDC core API access using xcube client library","description":"","date":"","thumbnail":"","thumbnailOptimized":"","banner":"","bannerOptimized":"","tags":[],"level":6},{"slug":"external-notebooks.eurodatacube.notebooks.notebooks.curated.edc-sentinel-hub-xcube-integration","title":"EDC Sentinel Hub - XCUBE integration","description":"","date":"","thumbnail":"","thumbnailOptimized":"","banner":"","bannerOptimized":"","tags":[],"level":6},{"slug":"external-notebooks.eurodatacube.notebooks.notebooks.curated.edc-usecase-ndvi-timeline","title":"NDVI timeline","description":"","date":"","thumbnail":"","thumbnailOptimized":"","banner":"","bannerOptimized":"","tags":[],"level":6},{"slug":"external-notebooks.eurodatacube.notebooks.notebooks.curated.eo-learn","title":"Using eo-learn in EDC: a starter’s guide.","description":"","date":"","thumbnail":"/notebooks_test/build/5a1f8475f0c3652f4630d03d72891b98.png","thumbnailOptimized":"","banner":"","bannerOptimized":"","tags":[],"level":6},{"slug":"external-notebooks.eurodatacube.notebooks.notebooks.curated.esdl-edc-v0-2","title":"Earth System Data Lab Tutorial @ Euro Data Cube","description":"","date":"","thumbnail":"","thumbnailOptimized":"","banner":"","bannerOptimized":"","tags":[],"level":6},{"slug":"external-notebooks.eurodatacube.notebooks.notebooks.curated.exploring-time-and-space-with-edc","title":"Exploring Time and Space: A guide to accessing, analysing and visualising data in the Euro Data Cube","description":"","date":"","thumbnail":"","thumbnailOptimized":"","banner":"","bannerOptimized":"","tags":[],"level":6},{"slug":"external-notebooks.eurodatacube.notebooks.notebooks.curated.how-to-access-dem-data-through-sentinel-hub-api","title":"How to access DEM data through Sentinel Hub API","description":"","date":"","thumbnail":"","thumbnailOptimized":"","banner":"","bannerOptimized":"","tags":[],"level":6},{"slug":"external-notebooks.eurodatacube.notebooks.notebooks.curated.sentinelhub-py","title":"Using Sentinel Hub Process API in EDC: a starter’s guide.","description":"","date":"","thumbnail":"/notebooks_test/build/01e22903839391bc356ac886ec2b2fa7.png","thumbnailOptimized":"","banner":"","bannerOptimized":"","tags":[],"level":6},{"title":"Notebooks","level":1},{"slug":"notebooks.example1","title":"📘 Example Notebook 1","description":"","date":"","thumbnail":"","thumbnailOptimized":"","banner":"","bannerOptimized":"","tags":[],"level":2},{"slug":"notebooks.example2","title":"📘 Example Notebook 2","description":"","date":"","thumbnail":"","thumbnailOptimized":"","banner":"","bannerOptimized":"","tags":[],"level":2}]}}},"actionData":null,"errors":null},"future":{"unstable_dev":false,"unstable_postcss":false,"unstable_tailwind":false,"v2_errorBoundary":true,"v2_headers":true,"v2_meta":true,"v2_normalizeFormMethod":true,"v2_routeConvention":true}};</script><script type="module" async="">import "/notebooks_test/build/manifest-B4831781.js";
import * as route0 from "/notebooks_test/build/root-QGLRP2PL.js";
import * as route1 from "/notebooks_test/build/routes/$-7JYT5576.js";
window.__remixRouteModules = {"root":route0,"routes/$":route1};

import("/notebooks_test/build/entry.client-UNPC4GT3.js");</script></body></html>