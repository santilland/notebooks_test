{"version":1,"kind":"Notebook","sha256":"2cba42edff0e56b2087bc0598deb229556f54c3a1a72ff29ed95c778b9108b61","slug":"external-notebooks.eurodatacube.notebooks.notebooks.contributions.igarss2022.igarss-22-nasa-api-lockdown-in-venice","location":"/external_notebooks/eurodatacube/notebooks/notebooks/contributions/IGARSS2022/IGARSS-22_NASA_API_Lockdown_in_Venice.ipynb","dependencies":[],"frontmatter":{"title":"Lockdown in Venice","content_includes_title":true,"kernelspec":{"name":"conda-env-edc-default-2022.07-00-py","display_name":"python3 (edc-default-2022.07-00)","language":"python"},"github":"https://github.com/eoxhub-workspaces/documentation/","numbering":{"title":{"offset":5}},"edit_url":"https://github.com/eoxhub-workspaces/documentation//blob/main/external_notebooks/eurodatacube/notebooks/notebooks/contributions/IGARSS2022/IGARSS-22_NASA_API_Lockdown_in_Venice.ipynb","exports":[{"format":"ipynb","filename":"IGARSS-22_NASA_API_Lockdown_in_Venice.ipynb","url":"/notebooks_test/build/IGARSS-22_NASA_API_L-4c5ed9bc0e5d3a2933edb99cad2b5c65.ipynb"}]},"widgets":{"application/vnd.jupyter.widget-state+json":{"state":{"1de5bee723014296842eea4e0f797b01":{"model_module":"jupyter-leaflet","model_module_version":"^0.17","model_name":"LeafletAttributionControlModel","state":{"_model_module":"jupyter-leaflet","_model_module_version":"^0.17","_model_name":"LeafletAttributionControlModel","_view_count":null,"_view_module":"jupyter-leaflet","_view_module_version":"^0.17","_view_name":"LeafletAttributionControlView","options":["position","prefix"],"position":"bottomright","prefix":"ipyleaflet"}},"3eba80642b254afb8b280f6e93cca318":{"model_module":"jupyter-leaflet","model_module_version":"^0.17","model_name":"LeafletMapStyleModel","state":{"_model_module":"jupyter-leaflet","_model_module_version":"^0.17","_model_name":"LeafletMapStyleModel","_view_count":null,"_view_module":"@jupyter-widgets/base","_view_module_version":"2.0.0","_view_name":"StyleView","cursor":"grab"}},"41d22326bf2f4364bc61ed7f2de5c6dc":{"model_module":"@jupyter-widgets/base","model_module_version":"2.0.0","model_name":"LayoutModel","state":{"_model_module":"@jupyter-widgets/base","_model_module_version":"2.0.0","_model_name":"LayoutModel","_view_count":null,"_view_module":"@jupyter-widgets/base","_view_module_version":"2.0.0","_view_name":"LayoutView","align_content":null,"align_items":null,"align_self":null,"border_bottom":null,"border_left":null,"border_right":null,"border_top":null,"bottom":null,"display":null,"flex":null,"flex_flow":null,"grid_area":null,"grid_auto_columns":null,"grid_auto_flow":null,"grid_auto_rows":null,"grid_column":null,"grid_gap":null,"grid_row":null,"grid_template_areas":null,"grid_template_columns":null,"grid_template_rows":null,"height":null,"justify_content":null,"justify_items":null,"left":null,"margin":null,"max_height":null,"max_width":null,"min_height":null,"min_width":null,"object_fit":null,"object_position":null,"order":null,"overflow":null,"padding":null,"right":null,"top":null,"visibility":null,"width":null}},"4216aa622f59453ab3382f6bc6ba7064":{"model_module":"jupyter-leaflet","model_module_version":"^0.17","model_name":"LeafletAttributionControlModel","state":{"_model_module":"jupyter-leaflet","_model_module_version":"^0.17","_model_name":"LeafletAttributionControlModel","_view_count":null,"_view_module":"jupyter-leaflet","_view_module_version":"^0.17","_view_name":"LeafletAttributionControlView","options":["position","prefix"],"position":"bottomright","prefix":"ipyleaflet"}},"58cacafde63847d085bacffd7a2aeb2b":{"model_module":"jupyter-leaflet","model_module_version":"^0.17","model_name":"LeafletZoomControlModel","state":{"_model_module":"jupyter-leaflet","_model_module_version":"^0.17","_model_name":"LeafletZoomControlModel","_view_count":null,"_view_module":"jupyter-leaflet","_view_module_version":"^0.17","_view_name":"LeafletZoomControlView","options":["position","zoom_in_text","zoom_in_title","zoom_out_text","zoom_out_title"],"position":"topleft","zoom_in_text":"+","zoom_in_title":"Zoom in","zoom_out_text":"-","zoom_out_title":"Zoom out"}},"645d620a3cc8408799f3ecf239c05d63":{"model_module":"jupyter-leaflet","model_module_version":"^0.17","model_name":"LeafletMapModel","state":{"_dom_classes":[],"_model_module":"jupyter-leaflet","_model_module_version":"^0.17","_model_name":"LeafletMapModel","_view_count":null,"_view_module":"jupyter-leaflet","_view_module_version":"^0.17","_view_name":"LeafletMapView","bottom":0,"bounce_at_zoom_limits":true,"box_zoom":true,"center":[45,14],"close_popup_on_click":true,"controls":["IPY_MODEL_9d9a6a650b6f41d7bacc15b4431322b6","IPY_MODEL_1de5bee723014296842eea4e0f797b01"],"crs":{"custom":false,"name":"EPSG3857"},"default_style":"IPY_MODEL_dc5b4af60e4646be87b3dd3452a0eb19","double_click_zoom":true,"dragging":true,"dragging_style":"IPY_MODEL_9ddc625ab2374d838f1e56425943c9cd","east":0,"fullscreen":false,"inertia":true,"inertia_deceleration":3000,"inertia_max_speed":1500,"interpolation":"bilinear","keyboard":true,"keyboard_pan_offset":80,"keyboard_zoom_offset":1,"layers":["IPY_MODEL_b0b54ee8bdb94239adf05f5bee7d643d","IPY_MODEL_b3e8bd505a5549f1937cc4160d9811fb"],"layout":"IPY_MODEL_826983971a3c4d7cbc77a40cd5b534ea","left":9007199254740991,"max_zoom":null,"min_zoom":null,"modisdate":"2023-03-21","north":0,"options":["bounce_at_zoom_limits","box_zoom","center","close_popup_on_click","double_click_zoom","dragging","fullscreen","inertia","inertia_deceleration","inertia_max_speed","interpolation","keyboard","keyboard_pan_offset","keyboard_zoom_offset","max_zoom","min_zoom","prefer_canvas","scroll_wheel_zoom","tap","tap_tolerance","touch_zoom","world_copy_jump","zoom","zoom_animation_threshold","zoom_delta","zoom_snap"],"panes":{},"prefer_canvas":false,"right":0,"scroll_wheel_zoom":true,"south":0,"style":"IPY_MODEL_3eba80642b254afb8b280f6e93cca318","tabbable":null,"tap":true,"tap_tolerance":15,"tooltip":null,"top":9007199254740991,"touch_zoom":true,"west":0,"window_url":"","world_copy_jump":false,"zoom":6,"zoom_animation_threshold":4,"zoom_delta":1,"zoom_snap":1}},"808e557d7b4b465d9cd4063d635ac3b8":{"model_module":"jupyter-leaflet","model_module_version":"^0.17","model_name":"LeafletMapStyleModel","state":{"_model_module":"jupyter-leaflet","_model_module_version":"^0.17","_model_name":"LeafletMapStyleModel","_view_count":null,"_view_module":"@jupyter-widgets/base","_view_module_version":"2.0.0","_view_name":"StyleView","cursor":"grab"}},"826983971a3c4d7cbc77a40cd5b534ea":{"model_module":"@jupyter-widgets/base","model_module_version":"2.0.0","model_name":"LayoutModel","state":{"_model_module":"@jupyter-widgets/base","_model_module_version":"2.0.0","_model_name":"LayoutModel","_view_count":null,"_view_module":"@jupyter-widgets/base","_view_module_version":"2.0.0","_view_name":"LayoutView","align_content":null,"align_items":null,"align_self":null,"border_bottom":null,"border_left":null,"border_right":null,"border_top":null,"bottom":null,"display":null,"flex":null,"flex_flow":null,"grid_area":null,"grid_auto_columns":null,"grid_auto_flow":null,"grid_auto_rows":null,"grid_column":null,"grid_gap":null,"grid_row":null,"grid_template_areas":null,"grid_template_columns":null,"grid_template_rows":null,"height":null,"justify_content":null,"justify_items":null,"left":null,"margin":null,"max_height":null,"max_width":null,"min_height":null,"min_width":null,"object_fit":null,"object_position":null,"order":null,"overflow":null,"padding":null,"right":null,"top":null,"visibility":null,"width":null}},"99b6fab6ce8b4e9da55be265dbf59048":{"model_module":"jupyter-leaflet","model_module_version":"^0.17","model_name":"LeafletGeoJSONModel","state":{"_model_module":"jupyter-leaflet","_model_module_version":"^0.17","_model_name":"LeafletGeoJSONModel","_view_count":null,"_view_module":"jupyter-leaflet","_view_module_version":"^0.17","_view_name":"LeafletGeoJSONView","base":false,"bottom":false,"data":{"geometry":{"coordinates":[[[11.763174,45.060626],[11.763174,45.793101],[12.790396,45.793101],[12.790396,45.060626],[11.763174,45.060626]]],"type":"Polygon"},"properties":{"style":{"color":"red","fillOpacity":0}},"type":"Feature"},"hover_style":{},"layers":[],"name":"","options":[],"pane":"","point_style":{},"popup":null,"popup_max_height":null,"popup_max_width":300,"popup_min_width":50,"style":{"color":"red","fillOpacity":0},"subitems":[],"visible":true}},"9d0c68847ac14f50a782d924824ddc9c":{"model_module":"jupyter-leaflet","model_module_version":"^0.17","model_name":"LeafletMapStyleModel","state":{"_model_module":"jupyter-leaflet","_model_module_version":"^0.17","_model_name":"LeafletMapStyleModel","_view_count":null,"_view_module":"@jupyter-widgets/base","_view_module_version":"2.0.0","_view_name":"StyleView","cursor":"grab"}},"9d9a6a650b6f41d7bacc15b4431322b6":{"model_module":"jupyter-leaflet","model_module_version":"^0.17","model_name":"LeafletZoomControlModel","state":{"_model_module":"jupyter-leaflet","_model_module_version":"^0.17","_model_name":"LeafletZoomControlModel","_view_count":null,"_view_module":"jupyter-leaflet","_view_module_version":"^0.17","_view_name":"LeafletZoomControlView","options":["position","zoom_in_text","zoom_in_title","zoom_out_text","zoom_out_title"],"position":"topleft","zoom_in_text":"+","zoom_in_title":"Zoom in","zoom_out_text":"-","zoom_out_title":"Zoom out"}},"9ddc625ab2374d838f1e56425943c9cd":{"model_module":"jupyter-leaflet","model_module_version":"^0.17","model_name":"LeafletMapStyleModel","state":{"_model_module":"jupyter-leaflet","_model_module_version":"^0.17","_model_name":"LeafletMapStyleModel","_view_count":null,"_view_module":"@jupyter-widgets/base","_view_module_version":"2.0.0","_view_name":"StyleView","cursor":"move"}},"afc69bfa371744dd918a6b78879ef977":{"model_module":"jupyter-leaflet","model_module_version":"^0.17","model_name":"LeafletMapModel","state":{"_dom_classes":[],"_model_module":"jupyter-leaflet","_model_module_version":"^0.17","_model_name":"LeafletMapModel","_view_count":null,"_view_module":"jupyter-leaflet","_view_module_version":"^0.17","_view_name":"LeafletMapView","bottom":0,"bounce_at_zoom_limits":true,"box_zoom":true,"center":[45,14],"close_popup_on_click":true,"controls":["IPY_MODEL_58cacafde63847d085bacffd7a2aeb2b","IPY_MODEL_4216aa622f59453ab3382f6bc6ba7064"],"crs":{"custom":false,"name":"EPSG3857"},"default_style":"IPY_MODEL_808e557d7b4b465d9cd4063d635ac3b8","double_click_zoom":true,"dragging":true,"dragging_style":"IPY_MODEL_f865b0617e0b4bc19f8df4a14396aa50","east":0,"fullscreen":false,"inertia":true,"inertia_deceleration":3000,"inertia_max_speed":1500,"interpolation":"bilinear","keyboard":true,"keyboard_pan_offset":80,"keyboard_zoom_offset":1,"layers":["IPY_MODEL_fb0a9f415233477a841aeee7014e159e","IPY_MODEL_99b6fab6ce8b4e9da55be265dbf59048"],"layout":"IPY_MODEL_41d22326bf2f4364bc61ed7f2de5c6dc","left":9007199254740991,"max_zoom":null,"min_zoom":null,"modisdate":"2023-03-21","north":0,"options":["bounce_at_zoom_limits","box_zoom","center","close_popup_on_click","double_click_zoom","dragging","fullscreen","inertia","inertia_deceleration","inertia_max_speed","interpolation","keyboard","keyboard_pan_offset","keyboard_zoom_offset","max_zoom","min_zoom","prefer_canvas","scroll_wheel_zoom","tap","tap_tolerance","touch_zoom","world_copy_jump","zoom","zoom_animation_threshold","zoom_delta","zoom_snap"],"panes":{},"prefer_canvas":false,"right":0,"scroll_wheel_zoom":true,"south":0,"style":"IPY_MODEL_9d0c68847ac14f50a782d924824ddc9c","tabbable":null,"tap":true,"tap_tolerance":15,"tooltip":null,"top":9007199254740991,"touch_zoom":true,"west":0,"window_url":"","world_copy_jump":false,"zoom":6,"zoom_animation_threshold":4,"zoom_delta":1,"zoom_snap":1}},"b0b54ee8bdb94239adf05f5bee7d643d":{"model_module":"jupyter-leaflet","model_module_version":"^0.17","model_name":"LeafletTileLayerModel","state":{"_model_module":"jupyter-leaflet","_model_module_version":"^0.17","_model_name":"LeafletTileLayerModel","_view_count":null,"_view_module":"jupyter-leaflet","_view_module_version":"^0.17","_view_name":"LeafletTileLayerView","attribution":"&copy; <a href=\"https://www.openstreetmap.org/copyright\">OpenStreetMap</a> contributors","base":true,"bottom":true,"bounds":null,"detect_retina":false,"loading":false,"max_native_zoom":null,"max_zoom":19,"min_native_zoom":null,"min_zoom":1,"name":"OpenStreetMap.Mapnik","no_wrap":false,"opacity":1,"options":["attribution","bounds","detect_retina","max_native_zoom","max_zoom","min_native_zoom","min_zoom","no_wrap","tile_size","tms","zoom_offset"],"pane":"","popup":null,"popup_max_height":null,"popup_max_width":300,"popup_min_width":50,"show_loading":false,"subitems":[],"tile_size":256,"tms":false,"url":"https://tile.openstreetmap.org/{z}/{x}/{y}.png","visible":true,"zoom_offset":0}},"b3e8bd505a5549f1937cc4160d9811fb":{"model_module":"jupyter-leaflet","model_module_version":"^0.17","model_name":"LeafletTileLayerModel","state":{"_model_module":"jupyter-leaflet","_model_module_version":"^0.17","_model_name":"LeafletTileLayerModel","_view_count":null,"_view_module":"jupyter-leaflet","_view_module_version":"^0.17","_view_name":"LeafletTileLayerView","attribution":null,"base":false,"bottom":true,"bounds":null,"detect_retina":false,"loading":false,"max_native_zoom":null,"max_zoom":24,"min_native_zoom":null,"min_zoom":0,"name":"","no_wrap":false,"opacity":1,"options":["attribution","bounds","detect_retina","max_native_zoom","max_zoom","min_native_zoom","min_zoom","no_wrap","tile_size","tms","zoom_offset"],"pane":"","popup":null,"popup_max_height":null,"popup_max_width":300,"popup_min_width":50,"show_loading":false,"subitems":[],"tile_size":256,"tms":false,"url":"https://staging-raster.delta-backend.com/stac/tiles/WebMercatorQuad/{z}/{x}/{y}@1x?collection=nightlights-hd-monthly&item=finalBMHD_ScaledVenice_201901&assets=cog_default&bidx=1&unscale=false&resampling=nearest&max_size=1024&rescale=0%2C255&colormap_name=inferno","visible":true,"zoom_offset":0}},"dc5b4af60e4646be87b3dd3452a0eb19":{"model_module":"jupyter-leaflet","model_module_version":"^0.17","model_name":"LeafletMapStyleModel","state":{"_model_module":"jupyter-leaflet","_model_module_version":"^0.17","_model_name":"LeafletMapStyleModel","_view_count":null,"_view_module":"@jupyter-widgets/base","_view_module_version":"2.0.0","_view_name":"StyleView","cursor":"grab"}},"f865b0617e0b4bc19f8df4a14396aa50":{"model_module":"jupyter-leaflet","model_module_version":"^0.17","model_name":"LeafletMapStyleModel","state":{"_model_module":"jupyter-leaflet","_model_module_version":"^0.17","_model_name":"LeafletMapStyleModel","_view_count":null,"_view_module":"@jupyter-widgets/base","_view_module_version":"2.0.0","_view_name":"StyleView","cursor":"move"}},"fb0a9f415233477a841aeee7014e159e":{"model_module":"jupyter-leaflet","model_module_version":"^0.17","model_name":"LeafletTileLayerModel","state":{"_model_module":"jupyter-leaflet","_model_module_version":"^0.17","_model_name":"LeafletTileLayerModel","_view_count":null,"_view_module":"jupyter-leaflet","_view_module_version":"^0.17","_view_name":"LeafletTileLayerView","attribution":"&copy; <a href=\"https://www.openstreetmap.org/copyright\">OpenStreetMap</a> contributors","base":true,"bottom":true,"bounds":null,"detect_retina":false,"loading":false,"max_native_zoom":null,"max_zoom":19,"min_native_zoom":null,"min_zoom":1,"name":"OpenStreetMap.Mapnik","no_wrap":false,"opacity":1,"options":["attribution","bounds","detect_retina","max_native_zoom","max_zoom","min_native_zoom","min_zoom","no_wrap","tile_size","tms","zoom_offset"],"pane":"","popup":null,"popup_max_height":null,"popup_max_width":300,"popup_min_width":50,"show_loading":false,"subitems":[],"tile_size":256,"tms":false,"url":"https://tile.openstreetmap.org/{z}/{x}/{y}.png","visible":true,"zoom_offset":0}}},"version_major":2,"version_minor":0}},"mdast":{"type":"root","children":[{"type":"block","kind":"notebook-code","data":{"execution":{"iopub.execute_input":"2023-03-22T13:11:57.677333Z","iopub.status.busy":"2023-03-22T13:11:57.676603Z","iopub.status.idle":"2023-03-22T13:11:57.763357Z","shell.execute_reply":"2023-03-22T13:11:57.762048Z"},"papermill":{"duration":0.109299,"end_time":"2023-03-22T13:11:57.767338","exception":false,"start_time":"2023-03-22T13:11:57.658039","status":"completed"},"tags":[]},"children":[{"type":"code","lang":"python","executable":true,"value":"from eoxhub import check_compatibility\ncheck_compatibility(\"user-2023.03-02\", dependencies=[])","visibility":"show","key":"KaaBHbCQrn"},{"type":"output","id":"qTVFfu3l89dvdxkUo4Ddh","data":[{"output_type":"display_data","metadata":{},"data":{"text/html":{"content":"<script type=\"text/javascript\">\n        function toggle(id) {\n            el = document.getElementById(id);\n            el.style.display = el.style.display === \"none\" ? \"block\" : \"none\";\n        }\n    </script>","content_type":"text/html"},"text/plain":{"content":"<IPython.core.display.HTML object>","content_type":"text/plain"}}},{"output_type":"display_data","metadata":{},"data":{"text/html":{"content":"This notebook is compatible with this base image version (user-2023.03-02).","content_type":"text/html"},"text/plain":{"content":"<IPython.core.display.HTML object>","content_type":"text/plain"}}}],"visibility":"show","key":"Bf2Uvyduh4"}],"visibility":"show","key":"YPDRsyUI7U"},{"type":"block","kind":"notebook-content","data":{"papermill":{"duration":0.018512,"end_time":"2023-03-22T13:11:57.797265","exception":false,"start_time":"2023-03-22T13:11:57.778753","status":"completed"},"tags":[]},"children":[{"type":"heading","depth":1,"position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"children":[{"type":"text","value":"Lockdown in Venice","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"ArkO8GyTNG"}],"identifier":"lockdown-in-venice","label":"Lockdown in Venice","html_id":"lockdown-in-venice","implicit":true,"key":"ZPtvWlTVdB"},{"type":"heading","depth":2,"position":{"start":{"line":2,"column":1},"end":{"line":2,"column":1}},"children":[{"type":"text","value":"Mapping the effects of mobility restriction in Venice on nightlight intensity using the NASA API","position":{"start":{"line":2,"column":1},"end":{"line":2,"column":1}},"key":"MKP70noqBG"}],"identifier":"mapping-the-effects-of-mobility-restriction-in-venice-on-nightlight-intensity-using-the-nasa-api","label":"Mapping the effects of mobility restriction in Venice on nightlight intensity using the NASA API","html_id":"mapping-the-effects-of-mobility-restriction-in-venice-on-nightlight-intensity-using-the-nasa-api","implicit":true,"key":"YmWXx439GH"},{"type":"paragraph","position":{"start":{"line":4,"column":1},"end":{"line":4,"column":1}},"children":[{"type":"text","value":"In this notebook:","position":{"start":{"line":4,"column":1},"end":{"line":4,"column":1}},"key":"UUy4Xrf3jr"}],"key":"btF5Y3zEcK"},{"type":"list","ordered":false,"spread":false,"position":{"start":{"line":5,"column":1},"end":{"line":6,"column":1}},"children":[{"type":"listItem","spread":true,"position":{"start":{"line":5,"column":1},"end":{"line":5,"column":1}},"children":[{"type":"text","value":"We use the NASA STAC API to discover available data for the Nightlights data set and plot mean nightlight intensity before and after covid lockdowns","position":{"start":{"line":5,"column":1},"end":{"line":5,"column":1}},"key":"fAnzJj3jPr"}],"key":"qKqYJrkgA5"},{"type":"listItem","spread":true,"position":{"start":{"line":6,"column":1},"end":{"line":6,"column":1}},"children":[{"type":"text","value":"We use the STAC items to access raster tiles for the Nightlights dataset, mosaic them together to create a single raster at a higher zoom level and then calculate pixel-by-pixel variance across the the timesteps to visualize which areas of Venice had the largest change in nightlight intensity throughout the lockdown period","position":{"start":{"line":6,"column":1},"end":{"line":6,"column":1}},"key":"moOL116cXX"}],"key":"eJpczx6YKa"}],"key":"kkN3ZW1DuY"}],"visibility":"show","key":"RYI7gZ7gOn"},{"type":"block","kind":"notebook-code","data":{"execution":{"iopub.execute_input":"2023-03-22T13:11:57.821944Z","iopub.status.busy":"2023-03-22T13:11:57.821378Z","iopub.status.idle":"2023-03-22T13:11:57.832839Z","shell.execute_reply":"2023-03-22T13:11:57.830530Z"},"papermill":{"duration":0.026412,"end_time":"2023-03-22T13:11:57.835782","exception":false,"start_time":"2023-03-22T13:11:57.809370","status":"completed"},"tags":[]},"children":[{"type":"code","lang":"python","executable":true,"value":"# endpoints for nasa api\nSTAC_ENDPOINT_URL = \"https://staging-stac.delta-backend.com\"\nRASTER_ENDPOINT_URL = \"https://staging-raster.delta-backend.com\"","visibility":"show","key":"Obi9Y3Fh8b"},{"type":"output","id":"GzvzO4mNcqD7CfvO1vOth","data":[],"visibility":"show","key":"xPVCCG64uo"}],"visibility":"show","key":"X2Nvco4lzB"},{"type":"block","kind":"notebook-code","data":{"execution":{"iopub.execute_input":"2023-03-22T13:11:57.859592Z","iopub.status.busy":"2023-03-22T13:11:57.858762Z","iopub.status.idle":"2023-03-22T13:11:58.615660Z","shell.execute_reply":"2023-03-22T13:11:58.613800Z"},"papermill":{"duration":0.776286,"end_time":"2023-03-22T13:11:58.622853","exception":false,"start_time":"2023-03-22T13:11:57.846567","status":"completed"},"scrolled":true,"tags":[]},"children":[{"type":"code","lang":"python","executable":true,"value":"import requests as re\n\n# Summary of the metadata for the nightlights intensity indicator\nnightlights_collection_summary = re.get(f\"{STAC_ENDPOINT_URL}/collections/nightlights-hd-monthly\").json()\nnightlights_collection_summary","visibility":"show","key":"mUffgAQTV7"},{"type":"output","id":"k3qmtcvP2zxhB74mTvd19","data":[{"output_type":"execute_result","execution_count":3,"metadata":{},"data":{"text/plain":{"content":"{'id': 'nightlights-hd-monthly',\n 'type': 'Collection',\n 'links': [{'rel': 'items',\n   'type': 'application/geo+json',\n   'href': 'https://staging-stac.delta-backend.com/collections/nightlights-hd-monthly/items'},\n  {'rel': 'parent',\n   'type': 'application/json',\n   'href': 'https://staging-stac.delta-backend.com/'},\n  {'rel': 'root',\n   'type': 'application/json',\n   'href': 'https://staging-stac.delta-backend.com/'},\n  {'rel': 'self',\n   'type': 'application/json',\n   'href': 'https://staging-stac.delta-backend.com/collections/nightlights-hd-monthly'}],\n 'title': 'Black Marble High Definition Nightlights Monthly Dataset',\n 'extent': {'spatial': {'bbox': [[-180, -90, 180, 90]]},\n  'temporal': {'interval': [['2017-07-21T00:00:00Z',\n     '2021-09-30T23:59:59Z']]}},\n 'license': 'MIT',\n 'summaries': {'datetime': ['2019-01-01T00:00:00Z', '2022-03-01T00:00:00Z'],\n  'cog_default': {'max': 255, 'min': 0}},\n 'description': 'The High Definition Nightlights dataset is processed to eliminate light sources, including moonlight reflectance and other interferences. Darker colors indicate fewer night lights and less activity. Lighter colors indicate more night lights and more activity.',\n 'item_assets': {'cog_default': {'type': 'image/tiff; application=geotiff; profile=cloud-optimized',\n   'roles': ['data', 'layer'],\n   'title': 'Default COG Layer',\n   'description': 'Cloud optimized default layer to display on map'}},\n 'stac_version': '1.0.0',\n 'stac_extensions': [],\n 'dashboard:is_periodic': True,\n 'dashboard:time_density': 'month'}","content_type":"text/plain"}}}],"visibility":"show","key":"MxAcOYacPI"}],"visibility":"show","key":"Duhfa9SJjH"},{"type":"block","kind":"notebook-code","data":{"execution":{"iopub.execute_input":"2023-03-22T13:11:58.677053Z","iopub.status.busy":"2023-03-22T13:11:58.672088Z","iopub.status.idle":"2023-03-22T13:12:04.677820Z","shell.execute_reply":"2023-03-22T13:12:04.675001Z"},"papermill":{"duration":6.084497,"end_time":"2023-03-22T13:12:04.728014","exception":false,"start_time":"2023-03-22T13:11:58.643517","status":"completed"},"tags":[]},"children":[{"type":"code","lang":"python","executable":true,"value":"import sys\n!{sys.executable} -m pip install ipyleaflet geojson\n\nfrom ipyleaflet import basemaps, Map, GeoJSON\nimport geojson\n\n# Define a bounding box for Venice: \nbbox_venice = [11.7631744, 45.06062636, 12.79039608, 45.79310055]\n[e,s,w,n] = bbox_venice\n\nm = Map(\n    basemap=basemaps.OpenStreetMap.Mapnik,\n    center=(45,14),\n    zoom=6,\n    scroll_wheel_zoom=True\n)\n\ngeo = GeoJSON(\n    data=geojson.Feature(geometry=geojson.Polygon([[(e,s), (e,n), (w,n), (w,s), (e,s)]]), properties={}),\n    style={\"color\": \"red\", \"fillOpacity\": 0}\n)\nm.add_layer(geo)\nm","visibility":"show","key":"wk5QqMGUQz"},{"type":"output","id":"QSNGSh55aEOWCnwKaWFy9","data":[{"name":"stdout","output_type":"stream","text":"Requirement already satisfied: ipyleaflet in /opt/conda/envs/edc-default-2023.03-02/lib/python3.9/site-packages (0.17.2)\r\nRequirement already satisfied: geojson in /opt/conda/envs/edc-default-2023.03-02/lib/python3.9/site-packages (3.0.1)\r\nRequirement already satisfied: branca>=0.5.0 in /opt/conda/envs/edc-default-2023.03-02/lib/python3.9/site-packages (from ipyleaflet) (0.6.0)\r\nRequirement already satisfied: xyzservices>=2021.8.1 in /opt/conda/envs/edc-default-2023.03-02/lib/python3.9/site-packages (from ipyleaflet) (2023.2.0)\r\nRequirement already satisfied: traittypes<3,>=0.2.1 in /opt/conda/envs/edc-default-2023.03-02/lib/python3.9/site-packages (from ipyleaflet) (0.2.1)\r\nRequirement already satisfied: ipywidgets<9,>=7.6.0 in /opt/conda/envs/edc-default-2023.03-02/lib/python3.9/site-packages (from ipyleaflet) (8.0.5)\r\nRequirement already satisfied: jinja2 in /opt/conda/envs/edc-default-2023.03-02/lib/python3.9/site-packages (from branca>=0.5.0->ipyleaflet) (3.1.2)\r\nRequirement already satisfied: jupyterlab-widgets~=3.0 in /opt/conda/envs/edc-default-2023.03-02/lib/python3.9/site-packages (from ipywidgets<9,>=7.6.0->ipyleaflet) (3.0.6)\r\nRequirement already satisfied: ipython>=6.1.0 in /opt/conda/envs/edc-default-2023.03-02/lib/python3.9/site-packages (from ipywidgets<9,>=7.6.0->ipyleaflet) (8.11.0)\r\nRequirement already satisfied: traitlets>=4.3.1 in /opt/conda/envs/edc-default-2023.03-02/lib/python3.9/site-packages (from ipywidgets<9,>=7.6.0->ipyleaflet) (5.9.0)\r\nRequirement already satisfied: widgetsnbextension~=4.0 in /opt/conda/envs/edc-default-2023.03-02/lib/python3.9/site-packages (from ipywidgets<9,>=7.6.0->ipyleaflet) (4.0.6)\r\n"},{"name":"stdout","output_type":"stream","text":"Requirement already satisfied: stack-data in /opt/conda/envs/edc-default-2023.03-02/lib/python3.9/site-packages (from ipython>=6.1.0->ipywidgets<9,>=7.6.0->ipyleaflet) (0.6.2)\r\nRequirement already satisfied: pickleshare in /opt/conda/envs/edc-default-2023.03-02/lib/python3.9/site-packages (from ipython>=6.1.0->ipywidgets<9,>=7.6.0->ipyleaflet) (0.7.5)\r\nRequirement already satisfied: pexpect>4.3 in /opt/conda/envs/edc-default-2023.03-02/lib/python3.9/site-packages (from ipython>=6.1.0->ipywidgets<9,>=7.6.0->ipyleaflet) (4.8.0)\r\nRequirement already satisfied: matplotlib-inline in /opt/conda/envs/edc-default-2023.03-02/lib/python3.9/site-packages (from ipython>=6.1.0->ipywidgets<9,>=7.6.0->ipyleaflet) (0.1.6)\r\nRequirement already satisfied: jedi>=0.16 in /opt/conda/envs/edc-default-2023.03-02/lib/python3.9/site-packages (from ipython>=6.1.0->ipywidgets<9,>=7.6.0->ipyleaflet) (0.18.2)\r\nRequirement already satisfied: decorator in /opt/conda/envs/edc-default-2023.03-02/lib/python3.9/site-packages (from ipython>=6.1.0->ipywidgets<9,>=7.6.0->ipyleaflet) (5.1.1)\r\nRequirement already satisfied: pygments>=2.4.0 in /opt/conda/envs/edc-default-2023.03-02/lib/python3.9/site-packages (from ipython>=6.1.0->ipywidgets<9,>=7.6.0->ipyleaflet) (2.14.0)\r\nRequirement already satisfied: backcall in /opt/conda/envs/edc-default-2023.03-02/lib/python3.9/site-packages (from ipython>=6.1.0->ipywidgets<9,>=7.6.0->ipyleaflet) (0.2.0)\r\nRequirement already satisfied: prompt-toolkit!=3.0.37,<3.1.0,>=3.0.30 in /opt/conda/envs/edc-default-2023.03-02/lib/python3.9/site-packages (from ipython>=6.1.0->ipywidgets<9,>=7.6.0->ipyleaflet) (3.0.38)\r\n"},{"name":"stdout","output_type":"stream","text":"Requirement already satisfied: MarkupSafe>=2.0 in /opt/conda/envs/edc-default-2023.03-02/lib/python3.9/site-packages (from jinja2->branca>=0.5.0->ipyleaflet) (2.1.2)\r\n"},{"name":"stdout","output_type":"stream","text":"Requirement already satisfied: parso<0.9.0,>=0.8.0 in /opt/conda/envs/edc-default-2023.03-02/lib/python3.9/site-packages (from jedi>=0.16->ipython>=6.1.0->ipywidgets<9,>=7.6.0->ipyleaflet) (0.8.3)\r\nRequirement already satisfied: ptyprocess>=0.5 in /opt/conda/envs/edc-default-2023.03-02/lib/python3.9/site-packages (from pexpect>4.3->ipython>=6.1.0->ipywidgets<9,>=7.6.0->ipyleaflet) (0.7.0)\r\nRequirement already satisfied: wcwidth in /opt/conda/envs/edc-default-2023.03-02/lib/python3.9/site-packages (from prompt-toolkit!=3.0.37,<3.1.0,>=3.0.30->ipython>=6.1.0->ipywidgets<9,>=7.6.0->ipyleaflet) (0.2.6)\r\nRequirement already satisfied: pure-eval in /opt/conda/envs/edc-default-2023.03-02/lib/python3.9/site-packages (from stack-data->ipython>=6.1.0->ipywidgets<9,>=7.6.0->ipyleaflet) (0.2.2)\r\nRequirement already satisfied: executing>=1.2.0 in /opt/conda/envs/edc-default-2023.03-02/lib/python3.9/site-packages (from stack-data->ipython>=6.1.0->ipywidgets<9,>=7.6.0->ipyleaflet) (1.2.0)\r\nRequirement already satisfied: asttokens>=2.1.0 in /opt/conda/envs/edc-default-2023.03-02/lib/python3.9/site-packages (from stack-data->ipython>=6.1.0->ipywidgets<9,>=7.6.0->ipyleaflet) (2.2.1)\r\nRequirement already satisfied: six in /opt/conda/envs/edc-default-2023.03-02/lib/python3.9/site-packages (from asttokens>=2.1.0->stack-data->ipython>=6.1.0->ipywidgets<9,>=7.6.0->ipyleaflet) (1.16.0)\r\n"},{"output_type":"execute_result","execution_count":4,"metadata":{},"data":{"application/vnd.jupyter.widget-view+json":{"content":"{\"model_id\":\"afc69bfa371744dd918a6b78879ef977\",\"version_major\":2,\"version_minor\":0}","content_type":"application/vnd.jupyter.widget-view+json"},"text/plain":{"content":"Map(center=[45, 14], controls=(ZoomControl(options=['position', 'zoom_in_text', 'zoom_in_title', 'zoom_out_tex…","content_type":"text/plain"}}}],"visibility":"show","key":"AtRL0QKUs9"}],"visibility":"show","key":"bIwXPtrYY2"},{"type":"block","kind":"notebook-code","data":{"execution":{"iopub.execute_input":"2023-03-22T13:12:04.770670Z","iopub.status.busy":"2023-03-22T13:12:04.770076Z","iopub.status.idle":"2023-03-22T13:12:05.736723Z","shell.execute_reply":"2023-03-22T13:12:05.734418Z"},"papermill":{"duration":0.992854,"end_time":"2023-03-22T13:12:05.742651","exception":false,"start_time":"2023-03-22T13:12:04.749797","status":"completed"},"tags":[]},"children":[{"type":"code","lang":"python","executable":true,"value":"# retrieve all items from the STAC API within that collection, within the Venice bounding box\nresponse_pre = re.post(\n    f\"{STAC_ENDPOINT_URL}/search\", \n    json={\n        \"collections\": [\"nightlights-hd-monthly\"],\n        \"bbox\": bbox_venice,\n        \"limit\": 100\n    }\n).json()\nfeatures = response_pre[\"features\"]\nprint(\"Number of results: \", len(features))\nprint(\"First and last dates: \", features[0][\"properties\"][\"start_datetime\"], features[-1][\"properties\"][\"start_datetime\"])","visibility":"show","key":"EKQjTOO1zg"},{"type":"output","id":"GJr0eII8JIo5qjElQHmJH","data":[{"name":"stdout","output_type":"stream","text":"Number of results:  39\nFirst and last dates:  2022-03-01T00:00:00 2019-01-01T00:00:00\n"}],"visibility":"show","key":"hyLvXRqySz"}],"visibility":"show","key":"tuSW424DzO"},{"type":"block","kind":"notebook-code","data":{"execution":{"iopub.execute_input":"2023-03-22T13:12:05.789907Z","iopub.status.busy":"2023-03-22T13:12:05.788814Z","iopub.status.idle":"2023-03-22T13:12:05.809566Z","shell.execute_reply":"2023-03-22T13:12:05.805497Z"},"papermill":{"duration":0.049917,"end_time":"2023-03-22T13:12:05.816368","exception":false,"start_time":"2023-03-22T13:12:05.766451","status":"completed"},"tags":[]},"children":[{"type":"code","lang":"python","executable":true,"value":"from datetime import datetime\n\n# filter the features to only include those from Jan 1st 2020 onwards\ncovid_features = list(filter( \n    lambda f: (\n        datetime.strptime(f[\"properties\"][\"start_datetime\"], \"%Y-%m-%dT%H:%M:%S\") >= datetime(2020, 1, 1)\n    ), \n    features\n))\nfeatures = list(sorted(features, key= lambda f: f[\"properties\"][\"start_datetime\"]))\nprint(\"First and last dates: \", covid_features[0][\"properties\"][\"start_datetime\"], features[-1][\"properties\"][\"start_datetime\"])","visibility":"show","key":"msKrPqKFIw"},{"type":"output","id":"YCjKYIQRRfMu8UV6yjQCe","data":[{"name":"stdout","output_type":"stream","text":"First and last dates:  2022-03-01T00:00:00 2022-03-01T00:00:00\n"}],"visibility":"show","key":"ShoubVPF0x"}],"visibility":"show","key":"zrLB9dVv45"},{"type":"block","kind":"notebook-code","data":{"execution":{"iopub.execute_input":"2023-03-22T13:12:05.854810Z","iopub.status.busy":"2023-03-22T13:12:05.853073Z","iopub.status.idle":"2023-03-22T13:12:05.879412Z","shell.execute_reply":"2023-03-22T13:12:05.875418Z"},"papermill":{"duration":0.047602,"end_time":"2023-03-22T13:12:05.885459","exception":false,"start_time":"2023-03-22T13:12:05.837857","status":"completed"},"tags":[]},"children":[{"type":"code","lang":"python","executable":true,"value":"# Format dates for plot and extract corresponding mean value from statistics for each STAC Item\ndates = [datetime.strptime(f[\"properties\"][\"start_datetime\"], \"%Y-%m-%dT%H:%M:%S\") for f in covid_features]\nmeans = [f[\"assets\"][\"cog_default\"][\"raster:bands\"][0][\"statistics\"][\"mean\"] for f in covid_features]","visibility":"show","key":"K1BsXluvW9"},{"type":"output","id":"Az6Fz_RBo8bFVEFK5rSyR","data":[],"visibility":"show","key":"DJCgsEflPR"}],"visibility":"show","key":"GcdG64Ua14"},{"type":"block","kind":"notebook-code","data":{"execution":{"iopub.execute_input":"2023-03-22T13:12:05.919011Z","iopub.status.busy":"2023-03-22T13:12:05.918612Z","iopub.status.idle":"2023-03-22T13:12:07.676292Z","shell.execute_reply":"2023-03-22T13:12:07.674342Z"},"papermill":{"duration":1.779248,"end_time":"2023-03-22T13:12:07.679767","exception":false,"start_time":"2023-03-22T13:12:05.900519","status":"completed"},"tags":[]},"children":[{"type":"code","lang":"python","executable":true,"value":"# Plot mean nightlights intensity values \nfrom matplotlib import pyplot as plt\n\nfig = plt.figure(figsize=(20,10))\nplt.plot(dates, means, label=\"Mean nightlights intensity (dimensionless)\")\nplt.axvline(datetime(2020,3,8).timestamp()/60/60/24, color=\"r\", label=\"First lockdown started\")\nplt.title(\"Mean Nightlight intensity in Venice\")\nplt.legend()","visibility":"show","key":"g2kpTqSUHK"},{"type":"output","id":"nJubD4SEtOWzQ7n0IaxoH","data":[{"output_type":"display_data","metadata":{},"data":{"image/png":{"content_type":"image/png","hash":"1a3fa3c265190a2ddddcd9629d232eb6","path":"/notebooks_test/build/1a3fa3c265190a2ddddcd9629d232eb6.png"},"text/plain":{"content":"<Figure size 2000x1000 with 1 Axes>","content_type":"text/plain"}}}],"visibility":"show","key":"ClNmsQJBnk"}],"visibility":"show","key":"SlCu23p09d"},{"type":"block","kind":"notebook-content","data":{"papermill":{"duration":0.021345,"end_time":"2023-03-22T13:12:07.721580","exception":false,"start_time":"2023-03-22T13:12:07.700235","status":"completed"},"tags":[]},"children":[{"type":"heading","depth":3,"position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"children":[{"type":"text","value":"In the next section we wil use the raster tiles themselves to perform a pixel-by-pixel variance calculation","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"LD2vYn6TS2"}],"identifier":"in-the-next-section-we-wil-use-the-raster-tiles-themselves-to-perform-a-pixel-by-pixel-variance-calculation","label":"In the next section we wil use the raster tiles themselves to perform a pixel-by-pixel variance calculation","html_id":"in-the-next-section-we-wil-use-the-raster-tiles-themselves-to-perform-a-pixel-by-pixel-variance-calculation","implicit":true,"key":"fldBi75Glj"}],"visibility":"show","key":"oHSVX1RKmZ"},{"type":"block","kind":"notebook-code","data":{"execution":{"iopub.execute_input":"2023-03-22T13:12:07.759363Z","iopub.status.busy":"2023-03-22T13:12:07.758647Z","iopub.status.idle":"2023-03-22T13:12:08.440273Z","shell.execute_reply":"2023-03-22T13:12:08.437877Z"},"papermill":{"duration":0.705009,"end_time":"2023-03-22T13:12:08.444908","exception":false,"start_time":"2023-03-22T13:12:07.739899","status":"completed"},"scrolled":true,"tags":[]},"children":[{"type":"code","lang":"python","executable":true,"value":"# View Tilejson for a single feature,  which includes a preformatted URL we can use to request the tiles from \n# the raster API\ntilejson = re.get(\n        f\"{RASTER_ENDPOINT_URL}/stac/tilejson.json?collection={features[0]['collection']}&item={features[0]['id']}&assets=cog_default&bidx=1&unscale=false&resampling=nearest&max_size=1024&rescale=0%2C255&colormap_name=inferno\", \n    ).json()\ntilejson\n","visibility":"show","key":"LH3xZFQLEb"},{"type":"output","id":"uM99fYpsCR9gkjXWmEDwK","data":[{"output_type":"execute_result","execution_count":9,"metadata":{},"data":{"text/plain":{"content":"{'tilejson': '2.2.0',\n 'version': '1.0.0',\n 'scheme': 'xyz',\n 'tiles': ['https://staging-raster.delta-backend.com/stac/tiles/WebMercatorQuad/{z}/{x}/{y}@1x?collection=nightlights-hd-monthly&item=finalBMHD_ScaledVenice_201901&assets=cog_default&bidx=1&unscale=false&resampling=nearest&max_size=1024&rescale=0%2C255&colormap_name=inferno'],\n 'minzoom': 0,\n 'maxzoom': 24,\n 'bounds': [11.7631744, 45.06062636, 12.79039608, 45.79310055],\n 'center': [12.27678524, 45.426863455, 0]}","content_type":"text/plain"}}}],"visibility":"show","key":"LvjZ78vgv4"}],"visibility":"show","key":"xsTiMWwwEE"},{"type":"block","kind":"notebook-code","data":{"execution":{"iopub.execute_input":"2023-03-22T13:12:08.480897Z","iopub.status.busy":"2023-03-22T13:12:08.479494Z","iopub.status.idle":"2023-03-22T13:12:08.508372Z","shell.execute_reply":"2023-03-22T13:12:08.506911Z"},"papermill":{"duration":0.087555,"end_time":"2023-03-22T13:12:08.547731","exception":false,"start_time":"2023-03-22T13:12:08.460176","status":"completed"},"tags":[]},"children":[{"type":"code","lang":"python","executable":true,"value":"from ipyleaflet import TileLayer\n\nm = Map(\n    basemap=basemaps.OpenStreetMap.Mapnik,\n    center=(45,14),\n    zoom=6,\n    scroll_wheel_zoom=True\n)\n\ntile_layer = TileLayer(url=tilejson[\"tiles\"][0], min_zoom=tilejson[\"minzoom\"], max_zoom=tilejson[\"maxzoom\"])\nm.add_layer(tile_layer)\nm\n","visibility":"show","key":"uukt5Q7WKB"},{"type":"output","id":"E9o-rPeUeHZr80WHVZkWY","data":[{"output_type":"execute_result","execution_count":10,"metadata":{},"data":{"application/vnd.jupyter.widget-view+json":{"content":"{\"model_id\":\"645d620a3cc8408799f3ecf239c05d63\",\"version_major\":2,\"version_minor\":0}","content_type":"application/vnd.jupyter.widget-view+json"},"text/plain":{"content":"Map(center=[45, 14], controls=(ZoomControl(options=['position', 'zoom_in_text', 'zoom_in_title', 'zoom_out_tex…","content_type":"text/plain"}}}],"visibility":"show","key":"oHVgWsesYI"}],"visibility":"show","key":"cFNsKf5Em3"},{"type":"block","kind":"notebook-code","data":{"execution":{"iopub.execute_input":"2023-03-22T13:12:08.585622Z","iopub.status.busy":"2023-03-22T13:12:08.583795Z","iopub.status.idle":"2023-03-22T13:12:14.268615Z","shell.execute_reply":"2023-03-22T13:12:14.266629Z"},"papermill":{"duration":5.707976,"end_time":"2023-03-22T13:12:14.272550","exception":false,"start_time":"2023-03-22T13:12:08.564574","status":"completed"},"tags":[]},"children":[{"type":"code","lang":"python","executable":true,"value":"# Use morecantile to calculate the Web mercator (row/x, column/y, zoom/z) tiles we want to query, \n# given the lat/lon bounding box\n\n!{sys.executable} -m pip install morecantile\nimport morecantile\n\nzoom_level = 5\ntms = morecantile.tms.get(\"WebMercatorQuad\")\ncorner_tiles = [tms._tile(*tms.xy(*pair),zoom_level) for pair in [(e,s), (e,n), (w,n), (w,s)]]\nmin_x, max_x = min(t.x for t in corner_tiles), max(t.x for t in corner_tiles)\nmin_y, max_y = min(t.y for t in corner_tiles), max(t.y for t in corner_tiles)\ntiles = [morecantile.Tile(x,y,zoom_level) for x in range(min_x, max_x+1) for y in range(min_y, max_y+1)]\ntiles\n","visibility":"show","key":"HMGCynrHuS"},{"type":"output","id":"zK69nemIddG8I8ylTbxuo","data":[{"name":"stdout","output_type":"stream","text":"Collecting morecantile\r\n"},{"name":"stdout","output_type":"stream","text":"  Downloading morecantile-3.3.0-py3-none-any.whl (33 kB)\r\nRequirement already satisfied: attrs in /opt/conda/envs/edc-default-2023.03-02/lib/python3.9/site-packages (from morecantile) (22.2.0)\r\nRequirement already satisfied: pydantic in /opt/conda/envs/edc-default-2023.03-02/lib/python3.9/site-packages (from morecantile) (1.10.6)\r\nRequirement already satisfied: pyproj~=3.1 in /opt/conda/envs/edc-default-2023.03-02/lib/python3.9/site-packages (from morecantile) (3.4.1)\r\n"},{"name":"stdout","output_type":"stream","text":"Requirement already satisfied: certifi in /opt/conda/envs/edc-default-2023.03-02/lib/python3.9/site-packages (from pyproj~=3.1->morecantile) (2022.12.7)\r\n"},{"name":"stdout","output_type":"stream","text":"Requirement already satisfied: typing-extensions>=4.2.0 in /opt/conda/envs/edc-default-2023.03-02/lib/python3.9/site-packages (from pydantic->morecantile) (4.5.0)\r\n"},{"name":"stdout","output_type":"stream","text":"Installing collected packages: morecantile\r\n"},{"name":"stdout","output_type":"stream","text":"Successfully installed morecantile-3.3.0\r\n"},{"output_type":"execute_result","execution_count":11,"metadata":{},"data":{"text/plain":{"content":"[Tile(x=17, y=11, z=5)]","content_type":"text/plain"}}}],"visibility":"show","key":"nsVYhWCc0s"}],"visibility":"show","key":"cd01PZRJQt"},{"type":"block","kind":"notebook-content","data":{"papermill":{"duration":0.018315,"end_time":"2023-03-22T13:12:14.305676","exception":false,"start_time":"2023-03-22T13:12:14.287361","status":"completed"},"tags":[]},"children":[{"type":"paragraph","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"children":[{"type":"text","value":"Zoom level 5 is the lowest zoom level at which the Venice bounding box is entirely contained within a single Web-mercator tile","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"pueceOXM1h"}],"key":"TBwoXRZPE7"}],"visibility":"show","key":"nVP1aQXMpF"},{"type":"block","kind":"notebook-code","data":{"execution":{"iopub.execute_input":"2023-03-22T13:12:14.338820Z","iopub.status.busy":"2023-03-22T13:12:14.338338Z","iopub.status.idle":"2023-03-22T13:12:15.355221Z","shell.execute_reply":"2023-03-22T13:12:15.353230Z"},"papermill":{"duration":1.037718,"end_time":"2023-03-22T13:12:15.360255","exception":false,"start_time":"2023-03-22T13:12:14.322537","status":"completed"},"tags":[]},"children":[{"type":"code","lang":"python","executable":true,"value":"[tile] = tiles\nr = re.get(\n       tilejson[\"tiles\"][0].replace(\"{z}/{x}/{y}\", f\"{tile.z}/{tile.x}/{tile.y}\")\n   )\nr.status_code","visibility":"show","key":"ZgJn1FHSIo"},{"type":"output","id":"cSRhLmwDhZDnqqTvlUPxF","data":[{"output_type":"execute_result","execution_count":12,"metadata":{},"data":{"text/plain":{"content":"200","content_type":"text/plain"}}}],"visibility":"show","key":"vQL7ZmlCx2"}],"visibility":"show","key":"g6Pe8IoMWo"},{"type":"block","kind":"notebook-code","data":{"execution":{"iopub.execute_input":"2023-03-22T13:12:15.400658Z","iopub.status.busy":"2023-03-22T13:12:15.399677Z","iopub.status.idle":"2023-03-22T13:12:15.452514Z","shell.execute_reply":"2023-03-22T13:12:15.450395Z"},"papermill":{"duration":0.078784,"end_time":"2023-03-22T13:12:15.457069","exception":false,"start_time":"2023-03-22T13:12:15.378285","status":"completed"},"scrolled":true,"tags":[]},"children":[{"type":"code","lang":"python","executable":true,"value":"import io\nfrom PIL import Image\n\nim = Image.open(io.BytesIO(r.content))\nim","visibility":"show","key":"oTzBDBNuT9"},{"type":"output","id":"idrZHpR5GR-pv62b_wusw","data":[{"output_type":"execute_result","execution_count":13,"metadata":{},"data":{"image/png":{"content_type":"image/png","hash":"4922eff619a8c96f8298ab1b40ef379f","path":"/notebooks_test/build/4922eff619a8c96f8298ab1b40ef379f.png"},"text/plain":{"content":"<PIL.PngImagePlugin.PngImageFile image mode=RGBA size=256x256>","content_type":"text/plain"}}}],"visibility":"show","key":"QsGDdLERcA"}],"visibility":"show","key":"uYqqotu9EB"},{"type":"block","kind":"notebook-content","data":{"papermill":{"duration":0.015914,"end_time":"2023-03-22T13:12:15.490792","exception":false,"start_time":"2023-03-22T13:12:15.474878","status":"completed"},"tags":[]},"children":[{"type":"paragraph","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"children":[{"type":"text","value":"Obviously this zoom level is too low, so we will need to request tiles for higher zoom levels and mosaic them together","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"aAGbI1Tqyg"}],"key":"GPNVl6jh00"}],"visibility":"show","key":"y2rAGp6xFV"},{"type":"block","kind":"notebook-code","data":{"execution":{"iopub.execute_input":"2023-03-22T13:12:15.534731Z","iopub.status.busy":"2023-03-22T13:12:15.533830Z","iopub.status.idle":"2023-03-22T13:12:15.558834Z","shell.execute_reply":"2023-03-22T13:12:15.556700Z"},"papermill":{"duration":0.05266,"end_time":"2023-03-22T13:12:15.563871","exception":false,"start_time":"2023-03-22T13:12:15.511211","status":"completed"},"scrolled":true,"tags":[]},"children":[{"type":"code","lang":"python","executable":true,"value":"zoom_level = 10\ntms = morecantile.tms.get(\"WebMercatorQuad\")\ncorner_tiles = [tms._tile(*tms.xy(*pair),zoom_level) for pair in [(e,s), (e,n), (w,n), (w,s)]]\nmin_x, max_x = min(t.x for t in corner_tiles), max(t.x for t in corner_tiles)\nmin_y, max_y = min(t.y for t in corner_tiles), max(t.y for t in corner_tiles)\ntiles = [morecantile.Tile(x,y,zoom_level) for x in range(min_x, max_x+1) for y in range(min_y, max_y+1)]\ntiles","visibility":"show","key":"ixluJ6Q3PM"},{"type":"output","id":"hgxdMOSStoLlWkth_Zy-L","data":[{"output_type":"execute_result","execution_count":14,"metadata":{},"data":{"text/plain":{"content":"[Tile(x=545, y=365, z=10),\n Tile(x=545, y=366, z=10),\n Tile(x=545, y=367, z=10),\n Tile(x=545, y=368, z=10),\n Tile(x=546, y=365, z=10),\n Tile(x=546, y=366, z=10),\n Tile(x=546, y=367, z=10),\n Tile(x=546, y=368, z=10),\n Tile(x=547, y=365, z=10),\n Tile(x=547, y=366, z=10),\n Tile(x=547, y=367, z=10),\n Tile(x=547, y=368, z=10),\n Tile(x=548, y=365, z=10),\n Tile(x=548, y=366, z=10),\n Tile(x=548, y=367, z=10),\n Tile(x=548, y=368, z=10)]","content_type":"text/plain"}}}],"visibility":"show","key":"Qoy0bCHciC"}],"visibility":"show","key":"R15w4oSsdt"},{"type":"block","kind":"notebook-content","data":{"papermill":{"duration":0.024836,"end_time":"2023-03-22T13:12:15.609001","exception":false,"start_time":"2023-03-22T13:12:15.584165","status":"completed"},"tags":[]},"children":[{"type":"paragraph","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"children":[{"type":"text","value":"At zoom level 10 the Venice bounding box is contained within 16 Web-mercator tiles","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"C04baZqdgs"}],"key":"bmPgw2wBEl"}],"visibility":"show","key":"p4mgBEPONz"},{"type":"block","kind":"notebook-code","data":{"execution":{"iopub.execute_input":"2023-03-22T13:12:15.651227Z","iopub.status.busy":"2023-03-22T13:12:15.650712Z","iopub.status.idle":"2023-03-22T13:12:15.682912Z","shell.execute_reply":"2023-03-22T13:12:15.675605Z"},"papermill":{"duration":0.062345,"end_time":"2023-03-22T13:12:15.692893","exception":false,"start_time":"2023-03-22T13:12:15.630548","status":"completed"},"tags":[]},"children":[{"type":"code","lang":"python","executable":true,"value":"#!{sys.executable} -m pip install numpy==1.21\nimport numpy as np\n\nfrom concurrent.futures import ThreadPoolExecutor\n\ndef _get_raster(tilejson_url, tile):\n    r = re.get(tilejson_url.replace(\"{z}/{x}/{y}\", f\"{tile.z}/{tile.x}/{tile.y}\"))\n    if not r.status_code == 200: \n        raise Exception(r.content)\n    a = np.array(Image.open(io.BytesIO(r.content)))\n    return a, (tile.y-min_y)*256, (tile.y-min_y+1)*256, (tile.x-min_x)*256, (tile.x-min_x+1)*256\n    \n    \n    \n# Define a function which will request each of the 16 web-mercator tiles and insert it into a \n# single mosaic'ed image\ndef mosaic_image(feature, tiles):\n    canvas = np.zeros(((max_x - min_x+1)*256, (max_y-min_y+1)*256))\n    \n    tilejson_url = re.get(\n            f\"{RASTER_ENDPOINT_URL}/stac/tilejson.json?collection={feature['collection']}&item={feature['id']}&assets=cog_default&bidx=1&unscale=false&resampling=nearest&max_size=1024&rescale=0%2C255\", \n    ).json()[\"tiles\"][0]\n        \n   \n    \n    with ThreadPoolExecutor(max_workers=10) as executor: \n        result = executor.map(_get_raster, [tilejson_url for _ in tiles], tiles)\n\n    for a, ymin, ymax, xmin, xmax in result: \n        canvas[ymin:ymax,xmin:xmax] = a[:,:,0]\n    return canvas\n    ","visibility":"show","key":"C7Fxq09AVg"},{"type":"output","id":"sWkji6QfISO6Meuzerzgx","data":[],"visibility":"show","key":"KslxjOb4fi"}],"visibility":"show","key":"Nm1AsncqfX"},{"type":"block","kind":"notebook-code","data":{"execution":{"iopub.execute_input":"2023-03-22T13:12:15.739638Z","iopub.status.busy":"2023-03-22T13:12:15.739114Z","iopub.status.idle":"2023-03-22T13:13:54.710423Z","shell.execute_reply":"2023-03-22T13:13:54.708905Z"},"papermill":{"duration":98.998027,"end_time":"2023-03-22T13:13:54.713751","exception":false,"start_time":"2023-03-22T13:12:15.715724","status":"completed"},"scrolled":true,"tags":[]},"children":[{"type":"code","lang":"python","executable":true,"value":"\n# define a 3D array that will hold all of the composite (mosaic) images we generate\ndatacube = np.zeros(((max_x - min_x+1)*256, (max_y-min_y+1)*256, len(features)))\n\nfor i, feature in enumerate(features): \n    print(f\"Feature {i} out of {len(features)}\")\n\n    image = mosaic_image(\n        feature = feature,\n        tiles=tiles\n    )\n    datacube[:,:,i] = image\n","visibility":"show","key":"WJdAZaXZ1f"},{"type":"output","id":"I5WYNIB4Fwmuk54UBXvXE","data":[{"name":"stdout","output_type":"stream","text":"Feature 0 out of 39\n"},{"name":"stdout","output_type":"stream","text":"Feature 1 out of 39\n"},{"name":"stdout","output_type":"stream","text":"Feature 2 out of 39\n"},{"name":"stdout","output_type":"stream","text":"Feature 3 out of 39\n"},{"name":"stdout","output_type":"stream","text":"Feature 4 out of 39\n"},{"name":"stdout","output_type":"stream","text":"Feature 5 out of 39\n"},{"name":"stdout","output_type":"stream","text":"Feature 6 out of 39\n"},{"name":"stdout","output_type":"stream","text":"Feature 7 out of 39\n"},{"name":"stdout","output_type":"stream","text":"Feature 8 out of 39\n"},{"name":"stdout","output_type":"stream","text":"Feature 9 out of 39\n"},{"name":"stdout","output_type":"stream","text":"Feature 10 out of 39\n"},{"name":"stdout","output_type":"stream","text":"Feature 11 out of 39\n"},{"name":"stdout","output_type":"stream","text":"Feature 12 out of 39\n"},{"name":"stdout","output_type":"stream","text":"Feature 13 out of 39\n"},{"name":"stdout","output_type":"stream","text":"Feature 14 out of 39\n"},{"name":"stdout","output_type":"stream","text":"Feature 15 out of 39\n"},{"name":"stdout","output_type":"stream","text":"Feature 16 out of 39\n"},{"name":"stdout","output_type":"stream","text":"Feature 17 out of 39\n"},{"name":"stdout","output_type":"stream","text":"Feature 18 out of 39\n"},{"name":"stdout","output_type":"stream","text":"Feature 19 out of 39\n"},{"name":"stdout","output_type":"stream","text":"Feature 20 out of 39\n"},{"name":"stdout","output_type":"stream","text":"Feature 21 out of 39\n"},{"name":"stdout","output_type":"stream","text":"Feature 22 out of 39\n"},{"name":"stdout","output_type":"stream","text":"Feature 23 out of 39\n"},{"name":"stdout","output_type":"stream","text":"Feature 24 out of 39\n"},{"name":"stdout","output_type":"stream","text":"Feature 25 out of 39\n"},{"name":"stdout","output_type":"stream","text":"Feature 26 out of 39\n"},{"name":"stdout","output_type":"stream","text":"Feature 27 out of 39\n"},{"name":"stdout","output_type":"stream","text":"Feature 28 out of 39\n"},{"name":"stdout","output_type":"stream","text":"Feature 29 out of 39\n"},{"name":"stdout","output_type":"stream","text":"Feature 30 out of 39\n"},{"name":"stdout","output_type":"stream","text":"Feature 31 out of 39\n"},{"name":"stdout","output_type":"stream","text":"Feature 32 out of 39\n"},{"name":"stdout","output_type":"stream","text":"Feature 33 out of 39\n"},{"name":"stdout","output_type":"stream","text":"Feature 34 out of 39\n"},{"name":"stdout","output_type":"stream","text":"Feature 35 out of 39\n"},{"name":"stdout","output_type":"stream","text":"Feature 36 out of 39\n"},{"name":"stdout","output_type":"stream","text":"Feature 37 out of 39\n"},{"name":"stdout","output_type":"stream","text":"Feature 38 out of 39\n"}],"visibility":"show","key":"mCqEG7o2Ig"}],"visibility":"show","key":"zw560J1gx7"},{"type":"block","kind":"notebook-code","data":{"execution":{"iopub.execute_input":"2023-03-22T13:13:54.753978Z","iopub.status.busy":"2023-03-22T13:13:54.753129Z","iopub.status.idle":"2023-03-22T13:13:55.385774Z","shell.execute_reply":"2023-03-22T13:13:55.382743Z"},"papermill":{"duration":0.660007,"end_time":"2023-03-22T13:13:55.390824","exception":false,"start_time":"2023-03-22T13:13:54.730817","status":"completed"},"tags":[]},"children":[{"type":"code","lang":"python","executable":true,"value":"# Calculate the variance of the 3D array along the 3rd axis (time)\n# ignoring 0/nan values \nvar_array = np.var(datacube, axis=2, where=datacube > 0)\n\nim = Image.fromarray(var_array).convert(\"RGB\")\nim","visibility":"show","key":"M0ffjiDWhK"},{"type":"output","id":"G8GgOwAXM9JELMcVMHgH2","data":[{"name":"stderr","output_type":"stream","text":"/opt/conda/envs/edc-default-2023.03-02/lib/python3.9/site-packages/numpy/core/fromnumeric.py:3715: RuntimeWarning: Degrees of freedom <= 0 for slice\n  return _methods._var(a, axis=axis, dtype=dtype, out=out, ddof=ddof,\n/opt/conda/envs/edc-default-2023.03-02/lib/python3.9/site-packages/numpy/core/_methods.py:223: RuntimeWarning: invalid value encountered in divide\n  arrmean = um.true_divide(arrmean, div, out=arrmean, casting='unsafe',\n"},{"name":"stderr","output_type":"stream","text":"/opt/conda/envs/edc-default-2023.03-02/lib/python3.9/site-packages/numpy/core/_methods.py:254: RuntimeWarning: invalid value encountered in divide\n  ret = um.true_divide(\n"},{"output_type":"execute_result","execution_count":17,"metadata":{},"data":{"image/png":{"content_type":"image/png","hash":"758033c0f5becd7b8e75e76aaeb77cd9","path":"/notebooks_test/build/758033c0f5becd7b8e75e76aaeb77cd9.png"},"text/plain":{"content":"<PIL.Image.Image image mode=RGB size=1024x1024>","content_type":"text/plain"}}}],"visibility":"show","key":"kqxj1c7ujC"}],"visibility":"show","key":"PuBeuI1kaz"},{"type":"block","kind":"notebook-content","data":{"papermill":{"duration":0.025019,"end_time":"2023-03-22T13:13:55.443204","exception":false,"start_time":"2023-03-22T13:13:55.418185","status":"completed"},"tags":[]},"children":[{"type":"paragraph","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"children":[{"type":"text","value":"Looking at the variance map above, we can see that while the city centers did not experience much change in nightlight intensity throughout the lockdown, re-opening and re-lockdown periods of 2020-2021, the areas ","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"GTerba0P1J"},{"type":"emphasis","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"children":[{"type":"text","value":"around","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"faisXW7yh8"}],"key":"tdfebaktGV"},{"type":"text","value":" the city centers display the greatest variance","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"UnztQYPqTy"}],"key":"IwvIkfLPB9"}],"visibility":"show","key":"lQ02XJRnKG"},{"type":"block","kind":"notebook-code","data":{"execution":{"iopub.execute_input":"2023-03-22T13:13:55.501693Z","iopub.status.busy":"2023-03-22T13:13:55.497143Z","iopub.status.idle":"2023-03-22T13:13:55.642141Z","shell.execute_reply":"2023-03-22T13:13:55.632552Z"},"papermill":{"duration":0.175467,"end_time":"2023-03-22T13:13:55.647172","exception":false,"start_time":"2023-03-22T13:13:55.471705","status":"completed"},"tags":[]},"children":[{"type":"code","lang":"python","executable":true,"value":"# For reference here is a image of the nightlights itensity before the lockdown\nim = Image.fromarray(datacube[:,:,0]).convert(\"RGB\")\nim","visibility":"show","key":"XULgP1xn24"},{"type":"output","id":"hZqa5a1IhM0iXRBFfyC8j","data":[{"output_type":"execute_result","execution_count":18,"metadata":{},"data":{"image/png":{"content_type":"image/png","hash":"1a835af029b5ccb3e79698a4788de5ce","path":"/notebooks_test/build/1a835af029b5ccb3e79698a4788de5ce.png"},"text/plain":{"content":"<PIL.Image.Image image mode=RGB size=1024x1024>","content_type":"text/plain"}}}],"visibility":"show","key":"pJMl8wV0v0"}],"visibility":"show","key":"hSD9R978AC"}],"key":"HazGu5oBnG"},"references":{"cite":{"order":[],"data":{}}},"footer":{"navigation":{"prev":{"title":"Environmental Impacts of Lockdown in Venice, Italy during 2020","url":"/external-notebooks/eurodatacube/notebooks/notebooks/contributions/igarss2022/igarss-22-lockdown-in-venice","group":"Contributions"},"next":{"title":"NO2 timeseries analysis","url":"/external-notebooks/eurodatacube/notebooks/notebooks/contributions/igarss2022/igarss-22-no2-timeseries-analysis","group":"Contributions"}}},"domain":"http://localhost:3000"}